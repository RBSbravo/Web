import{r as n,j as e,am as $e,an as Qe,k as ze,B as l,b as f,I as $,ao as Ye,d as L,Z as Ve,ap as He,aq as he,h as _,ar as We,as as De,P as ue,l as Ce,m as P,Y as G,at as se,au as re,ae as Pe,u as Ae,a4 as xe,v as Fe,w as Ee,x as Re,a7 as D,av as X,aw as Z,ax as ee,ay as te,z as q,az as Ke,a6 as Je,y as Ue,J as Xe,a8 as qe,a9 as Ze,aA as et,aB as tt,aC as st,aD as rt,aE as it,aF as Me,aG as U,aH as at,aI as nt,F as lt,a5 as ot}from"./mui-BfuGcMOQ.js";import{c as ve,f as Ie,u as dt,t as M,b as ct,d as Oe,L as mt}from"./index-Df56suev.js";import{g as xt,a as ht,f as ie,C as ut,F as pt}from"./FileUploadSection-SQ1O8CrH.js";import{c as gt,u as ft}from"./router-DwSTIDLU.js";import{P as jt}from"./PageHeader-BzGhKk7e.js";import"./vendor-Ckhrjn13.js";const pe=t=>{switch(t){case"high":return"error";case"medium":return"warning";case"low":return"success";default:return"default"}},ge=t=>{switch(t){case"completed":return"success";case"in_progress":return"primary";case"pending":return"warning";default:return"default"}},fe=t=>t?t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:t.firstname&&t.lastname?`${t.firstname} ${t.lastname}`:t.username||t.email||t.id:"Unassigned",_e=t=>xt({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),Be=t=>ht({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),bt=t=>{const s={};return(!t.title||t.title.trim().length<3)&&(s.title="Title must be at least 3 characters long"),(!t.description||t.description.trim().length<10)&&(s.description="Description must be at least 10 characters long"),t.dueDate||(s.dueDate="Due date is required"),(!t.priority||!["low","medium","high"].includes(t.priority))&&(s.priority="Priority must be low, medium, or high"),{isValid:Object.keys(s).length===0,errors:s}},me=()=>({title:"",description:"",priority:"medium",status:"pending",dueDate:"",assignedToId:"",attachments:[],relatedTicketId:"",remarks:""}),Ne=(t,s={})=>{const i={title:t.title?.trim(),description:t.description?.trim(),priority:t.priority,status:t.status,dueDate:t.dueDate||null,assignedToId:t.assignedToId||null,relatedTicketId:t.relatedTicketId||null,remarks:t.remarks?.trim(),...s};return Object.keys(i).forEach(m=>{(i[m]===""||i[m]===void 0)&&delete i[m]}),delete i.attachments,i},Ge=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"}],yt=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}],wt=[{value:"all",label:"All Status"},...Ge];n.memo(function({task:s,departmentUsers:i,canUpdateTask:m,selectedTasks:S,updatingStatus:B,updatingPriority:A,onSelectTask:v,onViewDetails:x,onEditTask:w,onDeleteTask:u,onUpdateStatus:y,onUpdatePriority:j}){const[T,o]=n.useState(null),[d,p]=n.useState(null),[F,k]=n.useState(null),b=R=>{switch(R){case"completed":return e.jsx(Pe,{});case"in_progress":return e.jsx(re,{});case"pending":return e.jsx(se,{});default:return e.jsx(G,{})}},I=R=>o(R.currentTarget),a=()=>o(null),h=()=>{x(s),a()},E=()=>{w(s),a()},z=()=>{u(s),a()},O=i.find(R=>R.id===s.assignedToId),W=fe(O);return e.jsxs($e,{elevation:2,sx:{p:{xs:1,sm:1.5,md:2},borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.08)",display:"flex",flexDirection:"row",alignItems:"center",minHeight:{xs:64,sm:72,md:80},mb:1,background:{xs:"rgba(0,0,0,0.01)",sm:"rgba(0,0,0,0.01)",md:"inherit"},"&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.12)",transform:"translateY(-1px)",transition:"all 0.2s ease-in-out"}},tabIndex:0,"aria-label":`Task: ${s.title}`,children:[e.jsx(Qe,{checked:S.includes(s.id),onChange:()=>v(s.id),size:"small",sx:{mr:1,flexShrink:0}}),e.jsx(ze,{sx:{bgcolor:"primary.main",width:{xs:32,sm:36,md:40},height:{xs:32,sm:36,md:40},boxShadow:"0 1px 4px rgba(0,0,0,0.08)",flexShrink:0,mr:{xs:1,sm:1.5,md:2}},children:b(s.status)}),e.jsxs(l,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:{xs:"column",md:"row"},gap:{xs:.5,sm:.8,md:1},alignItems:{md:"center"}},children:[e.jsxs(l,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:{xs:.3,sm:.4,md:.5}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx(f,{variant:"subtitle1",component:"div",sx:{fontWeight:700,fontSize:{xs:"0.98rem",sm:"1.05rem",md:"1.12rem",lg:"1.18rem"},letterSpacing:.1,lineHeight:1.2,color:"text.primary",wordBreak:"break-word",flex:1,minWidth:0},noWrap:!0,children:s.title}),e.jsx($,{sx:{color:"text.secondary","&:hover":{color:"primary.main",background:"rgba(46,125,50,0.08)"},width:{xs:28,sm:32,md:36},height:{xs:28,sm:32,md:36},borderRadius:2,border:"1px solid",borderColor:"divider",bgcolor:"background.default",boxShadow:"0 1px 4px rgba(0,0,0,0.04)",fontSize:"1rem",ml:1,flexShrink:0,display:{xs:"flex",md:"none"}},onClick:I,size:"small","aria-label":"Task actions",children:e.jsx(Ye,{fontSize:"inherit"})})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.82rem",sm:"0.85rem",md:"0.88rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxHeight:{xs:16,sm:20,md:24},overflow:"hidden",textOverflow:"ellipsis",width:"100%",display:{xs:"block",md:"-webkit-box"},WebkitLineClamp:{xs:1,md:2},WebkitBoxOrient:{xs:"horizontal",md:"vertical"}},noWrap:!1,children:s.description})]}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"flex-start",md:"center"},gap:{xs:.5,sm:.8,md:1.5},flexShrink:0,minWidth:{md:"fit-content"}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:.6,md:.8},flexWrap:"wrap",order:{xs:1,md:1}},children:[e.jsx(L,{label:s.priority,size:"small",color:pe(s.priority),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?R=>k(R.currentTarget):void 0,clickable:m,disabled:A===s.id}),e.jsx(L,{label:(s.status||"").replace("_"," "),size:"small",color:ge(s.status),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?R=>p(R.currentTarget):void 0,clickable:m,disabled:B===s.id}),(B===s.id||A===s.id)&&e.jsx(Ve,{size:12,sx:{ml:.5}})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:{xs:.7,sm:1,md:1.5},flexWrap:"wrap",order:{xs:2,md:2}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(He,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(f,{variant:"caption",color:W!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontStyle:W!=="Unassigned"?"normal":"italic",whiteSpace:"nowrap"},component:"span",children:W})]}),s.dueDate&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(he,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},whiteSpace:"nowrap"},component:"span",children:ie(s.dueDate)})]})]})]})]}),e.jsx(l,{sx:{display:{xs:"none",md:"flex"},alignItems:"center",gap:1,ml:2},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,bgcolor:"background.paper",borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.07)",px:1,py:.5,border:"1px solid",borderColor:"grey.200"},children:[e.jsx(_,{title:"View Details",children:e.jsx($,{sx:{color:"primary.main",bgcolor:"grey.100","&:hover":{bgcolor:"primary.light",color:"white"},width:32,height:32,borderRadius:2},onClick:h,size:"small",children:e.jsx(We,{fontSize:"small"})})}),e.jsx(_,{title:"Edit Task",children:e.jsx($,{sx:{color:"info.main",bgcolor:"grey.100","&:hover":{bgcolor:"info.main",color:"white"},width:32,height:32,borderRadius:2},onClick:E,size:"small",children:e.jsx(De,{fontSize:"small"})})}),e.jsx(_,{title:"Delete Task",children:e.jsx($,{sx:{color:"error.main",bgcolor:"grey.100","&:hover":{bgcolor:"error.main",color:"white"},width:32,height:32,borderRadius:2},onClick:z,size:"small",children:e.jsx(ue,{fontSize:"small"})})})]})}),e.jsxs(Ce,{anchorEl:T,open:!!T,onClose:a,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[e.jsx(P,{onClick:h,children:"View Details"}),e.jsx(P,{onClick:E,children:"Edit"}),e.jsx(P,{onClick:z,sx:{color:"error.main"},children:"Delete"})]}),e.jsxs(Ce,{anchorEl:d,open:!!d,onClose:()=>p(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(P,{onClick:()=>{y(s.id,"pending"),p(null)},disabled:s.status==="pending",children:"Pending"}),e.jsx(P,{onClick:()=>{y(s.id,"in_progress"),p(null)},disabled:s.status==="in_progress",children:"In Progress"}),e.jsx(P,{onClick:()=>{y(s.id,"completed"),p(null)},disabled:s.status==="completed",children:"Completed"})]}),e.jsxs(Ce,{anchorEl:F,open:!!F,onClose:()=>k(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(P,{onClick:()=>{j(s.id,"low"),k(null)},disabled:s.priority==="low",children:"Low"}),e.jsx(P,{onClick:()=>{j(s.id,"medium"),k(null)},disabled:s.priority==="medium",children:"Medium"}),e.jsx(P,{onClick:()=>{j(s.id,"high"),k(null)},disabled:s.priority==="high",children:"High"})]})]})});const Le=({open:t,onClose:s,onSubmit:i,initialData:m=null,departmentUsers:S=[],pendingTickets:B=[],loading:A=!1,mode:v="create"})=>{const x=Ae(),w=xe(x.breakpoints.down("sm")),[u,y]=n.useState(me()),[j,T]=n.useState({}),[o,d]=n.useState("");n.useEffect(()=>{t&&(y(m&&v==="edit"?{...me(),...m,title:m.title||"",description:m.description||"",priority:m.priority||"medium",status:m.status||"pending",dueDate:m.dueDate||"",assignedToId:m.assignedToId||"",relatedTicketId:m.relatedTicketId||"",attachments:m.attachments||[]}:me()),T({}),d(""))},[t,m,v]);const p=a=>{const{name:h,value:E}=a.target;y(z=>({...z,[h]:E})),j[h]&&T(z=>({...z,[h]:""}))},F=a=>{const h=Array.from(a.target.files||[]);if(h.length===0)return;const E=["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"],z=[],O=[];if(h.forEach(W=>{E.includes(W.type)?W.size>10*1024*1024?O.push(`${W.name}: File size must be less than 10MB`):z.push(W):O.push(`${W.name}: Only PDF and image files are allowed`)}),O.length>0){d(O.join(", "));return}y(W=>({...W,attachments:[...W.attachments,...z]}))},k=a=>{y(h=>({...h,attachments:h.attachments.filter((E,z)=>z!==a)}))},b=async a=>{a&&a.preventDefault&&a.preventDefault(),d("");const h=bt(u);if(!h.isValid){T(h.errors);return}try{await i(u),I()}catch(E){d(E.message||"An error occurred while saving the task")}},I=()=>{y(me()),T({}),d(""),s()};return e.jsxs(Fe,{open:t,onClose:I,maxWidth:"sm",fullWidth:!0,fullScreen:w,children:[e.jsx(Ee,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:v==="create"?"Create New Task":"Edit Task"}),e.jsx(Re,{sx:{pt:{xs:1,sm:2}},children:e.jsx(l,{component:"form",onSubmit:b,sx:{mt:1},children:e.jsxs(D,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(X,{fullWidth:!0,label:"Task Title",name:"title",value:u.title,onChange:p,error:!!j.title,helperText:j.title,required:!0,sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,children:e.jsx(X,{fullWidth:!0,label:"Description",name:"description",value:u.description,onChange:p,error:!!j.description,helperText:j.description,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,error:!!j.priority,children:[e.jsx(ee,{children:"Priority"}),e.jsx(te,{name:"priority",value:u.priority,label:"Priority",onChange:p,children:yt.map(a=>e.jsx(P,{value:a.value,children:a.label},a.value))})]})}),v==="edit"&&e.jsxs(e.Fragment,{children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(X,{fullWidth:!0,label:"Remarks (Required for updates)",name:"remarks",value:u.remarks||"",onChange:p,multiline:!0,rows:3,required:!0,helperText:"Please provide remarks explaining the changes made to this task",sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Status"}),e.jsx(te,{name:"status",value:u.status,label:"Status",onChange:p,children:Ge.map(a=>e.jsx(P,{value:a.value,children:a.label},a.value))})]})})]}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Assignee"}),e.jsxs(te,{name:"assignedToId",value:u.assignedToId,label:"Assignee",onChange:p,children:[e.jsx(P,{value:"",children:"Unassigned"}),S.filter(a=>a.role==="employee").map(a=>{const h=a.firstname&&a.lastname&&`${a.firstname} ${a.lastname}`||a.firstName&&a.lastName&&`${a.firstName} ${a.lastName}`||a.username||a.email||a.id;return e.jsx(P,{value:a.id,children:h},a.id)})]})]})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsx(X,{fullWidth:!0,label:"Due Date",name:"dueDate",type:"date",value:u.dueDate,onChange:p,error:!!j.dueDate,helperText:j.dueDate,InputLabelProps:{shrink:!0},required:!0})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Related Pending Ticket"}),e.jsxs(te,{name:"relatedTicketId",value:u.relatedTicketId||"",label:"Related Pending Ticket",onChange:p,children:[e.jsx(P,{value:"",children:"None"}),B.map(a=>e.jsxs(P,{value:a.id,children:[a.title," (#",a.id,")"]},a.id))]})]})}),e.jsxs(D,{item:!0,xs:12,children:[e.jsxs(q,{variant:"outlined",component:"label",startIcon:e.jsx(Ke,{}),fullWidth:!0,sx:{mb:1},children:[v==="create"?"Attach Files (PDF & Images Only)":"Upload Additional Files (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",onChange:F})]}),e.jsx(l,{sx:{mb:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"}),u.attachments&&u.attachments.length>0&&e.jsxs(l,{sx:{mt:1},children:[e.jsx(l,{sx:{fontSize:"0.875rem",fontWeight:600,mb:1,color:"text.primary"},children:v==="create"?"Files to upload:":"Additional files to upload:"}),u.attachments.map((a,h)=>e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5,p:1,bgcolor:"grey.50",borderRadius:1},children:[e.jsxs(l,{sx:{fontSize:"0.875rem",color:"text.secondary",flex:1},children:[a.name," (",(a.size/1024/1024).toFixed(2)," MB)"]}),e.jsx(q,{size:"small",color:"error",onClick:()=>k(h),startIcon:e.jsx(ue,{}),sx:{minWidth:"auto",px:1},children:"Remove"})]},h))]})]}),o&&e.jsx(D,{item:!0,xs:12,children:e.jsx(Je,{severity:"error",sx:{mt:1},children:o})})]})})}),e.jsxs(Ue,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(q,{onClick:I,disabled:A,children:"Cancel"}),e.jsx(q,{variant:"contained",onClick:b,disabled:A,sx:{minWidth:100},children:A?e.jsx(Ve,{size:22,color:"inherit"}):v==="create"?"Create Task":"Save Changes"})]})]})},Tt=({open:t,onClose:s,task:i,departmentUsers:m=[],user:S})=>{if(!i)return null;const B=i&&i.assignedToId&&m.find(x=>x.id===i.assignedToId),A=fe(B),v=async x=>{const w=x.url||`/api/files/${x.id}/download`;try{const u=localStorage.getItem("token"),y=await fetch(w,{headers:u?{Authorization:`Bearer ${u}`}:{}});if(!y.ok)throw new Error("Failed to download file");const j=await y.blob(),T=window.URL.createObjectURL(j),o=document.createElement("a");o.href=T,o.download=x.file_name||x.name||"attachment",document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(T)}catch{alert("Failed to download file")}};return e.jsxs(Fe,{open:t,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ee,{children:"Task Details"}),e.jsxs(Re,{children:[e.jsxs(l,{sx:{mb:2},children:[e.jsx(f,{variant:"h6",sx:{fontWeight:700},children:i.title}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:1},children:i.description}),e.jsx(Xe,{sx:{my:1}}),e.jsxs(l,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:1},children:[e.jsx(L,{label:i.priority,color:pe(i.priority),size:"small"}),e.jsx(L,{label:(i.status||"").replace("_"," "),color:ge(i.status),size:"small"})]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Assigned To:"})," ",A]}),i.dueDate&&e.jsxs(e.Fragment,{children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mt:1},children:[e.jsx(he,{sx:{fontSize:16},color:"action"}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",ie(i.dueDate)]})]}),(()=>{const x=_e(i),w=Be(i);return!x||!w?null:e.jsx(l,{sx:{mt:1},children:e.jsx(L,{label:w,size:"small",color:x,sx:{fontSize:"0.7rem",fontWeight:600,borderRadius:2,px:.5,height:18,boxShadow:1,minWidth:60,justifyContent:"center"}})})})()]}),i.relatedTicket&&e.jsxs(l,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Related Ticket"}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Title:"})," ",i.relatedTicket.title]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Description:"})," ",i.relatedTicket.description]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Status:"})," ",i.relatedTicket.status]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Priority:"})," ",i.relatedTicket.priority]}),i.relatedTicket.due_date&&e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",i.relatedTicket.due_date]}),Array.isArray(i.relatedTicket.attachments)&&i.relatedTicket.attachments.length>0&&e.jsxs(l,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",sx:{fontWeight:600,mb:.5},children:"Attachments:"}),i.relatedTicket.attachments.map(x=>e.jsx(l,{sx:{mb:.5},children:e.jsx("span",{style:{color:"primary.main",textDecoration:"underline",fontSize:"0.95em",cursor:"pointer"},onClick:()=>v(x),children:x.file_name||x.name})},x.id||x.file_name))]})]})]}),e.jsx(ut,{entityId:i.id,fetchComments:ve.fetchComments,addComment:ve.addComment,deleteComment:ve.deleteComment,user:S}),e.jsx(pt,{entityId:i.id,fetchFiles:x=>Ie.getByEntity("task",x),uploadFile:(x,w)=>Ie.upload(w,"task",x),deleteFile:(x,w)=>Ie.delete(w),entityType:"task"})]}),e.jsx(Ue,{children:e.jsx(q,{onClick:s,children:"Close"})})]})},St=({searchQuery:t,filter:s,onSearchChange:i,onFilterChange:m})=>e.jsx(qe,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsx(Ze,{sx:{p:{xs:2,sm:2.5,md:3}},children:e.jsxs(D,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(D,{item:!0,xs:12,sm:8,md:6,children:e.jsx(X,{fullWidth:!0,placeholder:"Search tasks...",value:t,onChange:S=>i(S.target.value),InputProps:{startAdornment:e.jsx(et,{position:"start",children:e.jsx(tt,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(D,{item:!0,xs:12,sm:4,md:3,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Status"}),e.jsx(te,{value:s,label:"Status",onChange:S=>m(S.target.value),sx:{borderRadius:2},children:wt.map(S=>e.jsx(P,{value:S.value,children:S.label},S.value))})]})})]})})}),kt=({tasks:t,departmentUsers:s,canUpdateTask:i,selectedTasks:m,updatingStatus:S,updatingPriority:B,onSelectTask:A,onViewDetails:v,onEditTask:x,onDeleteTask:w,onUpdateStatus:u,onUpdatePriority:y})=>{const j=Ae();xe(j.breakpoints.down("sm"));const T=d=>{switch(d){case"completed":return e.jsx(Pe,{});case"in_progress":return e.jsx(re,{});case"pending":return e.jsx(se,{});default:return e.jsx(G,{})}},o=d=>{switch(d){case"high":return e.jsx(re,{});case"medium":return e.jsx(se,{});case"low":return e.jsx(G,{});default:return e.jsx(G,{})}};return e.jsx(l,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(st,{component:$e,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(rt,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(it,{children:e.jsxs(Me,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Assigned To"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(U,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(at,{children:t.map((d,p)=>{const F=s.find(b=>b.id===d.assignedToId),k=fe(F);return e.jsxs(Me,{hover:!0,sx:{bgcolor:p%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(U,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(ze,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:T(d.status)})}),e.jsxs(U,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(_,{title:d.title,arrow:!0,children:e.jsx(f,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:d.title})}),e.jsx(_,{title:d.description,arrow:!0,children:e.jsx(f,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:d.description})})]}),e.jsx(U,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(L,{label:d.priority,size:"small",color:pe(d.priority),icon:o(d.priority),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})}),e.jsx(U,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(L,{label:(d.status||"").replace("_"," "),size:"small",color:ge(d.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})}),e.jsx(U,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(f,{variant:"caption",color:k!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:k!=="Unassigned"?"normal":"italic"},children:k})}),e.jsx(U,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[d.dueDate&&e.jsx(_,{title:ie(d.dueDate),arrow:!0,children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(he,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:ie(d.dueDate)})]})}),(()=>{const b=_e(d),I=Be(d);return!b||!I?null:e.jsx(_,{title:`Maturity: ${I}`,arrow:!0,children:e.jsx("span",{children:e.jsx(L,{label:I,size:"small",color:b,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(U,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(_,{title:"View Details",children:e.jsx("span",{children:e.jsx($,{color:"primary",size:"small",onClick:()=>v(d),children:e.jsx(We,{fontSize:"small"})})})}),e.jsx(_,{title:"Edit Task",children:e.jsx("span",{children:e.jsx($,{color:"secondary",size:"small",onClick:()=>x(d),children:e.jsx(De,{fontSize:"small"})})})}),e.jsx(_,{title:"Delete Task",children:e.jsx("span",{children:e.jsx($,{color:"error",size:"small",onClick:()=>w(d),children:e.jsx(ue,{fontSize:"small"})})})})]})})]},d.id)})})]})})})},Ct=({tasks:t,departmentUsers:s,canUpdateTask:i,selectedTasks:m,updatingStatus:S,updatingPriority:B,onSelectTask:A,onViewDetails:v,onEditTask:x,onDeleteTask:w,onUpdateStatus:u,onUpdatePriority:y})=>{const j=o=>{switch(o){case"completed":return e.jsx(Pe,{});case"in_progress":return e.jsx(re,{});case"pending":return e.jsx(se,{});default:return e.jsx(G,{})}},T=o=>{switch(o){case"high":return e.jsx(re,{});case"medium":return e.jsx(se,{});case"low":return e.jsx(G,{});default:return e.jsx(G,{})}};return e.jsx(l,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(D,{container:!0,spacing:2,children:t.map(o=>{const d=s.find(F=>F.id===o.assignedToId),p=fe(d);return e.jsx(D,{item:!0,xs:12,children:e.jsxs(qe,{sx:{borderRadius:3,boxShadow:3,p:2,bgcolor:"background.paper"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(ze,{sx:{bgcolor:"primary.main",width:28,height:28,boxShadow:"0 1px 4px rgba(0,0,0,0.08)",mr:1},children:j(o.status)}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:700,fontSize:"1rem",wordBreak:"break-word"},children:o.title}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.92rem",lineHeight:1.4,wordBreak:"break-word"},children:o.description})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx(L,{label:o.priority,size:"small",color:pe(o.priority),icon:T(o.priority),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),e.jsx(L,{label:(o.status||"").replace("_"," "),size:"small",color:ge(o.status),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),(()=>{const F=_e(o),k=Be(o);return!F||!k?null:e.jsx(L,{label:k,size:"small",color:F,sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}})})()]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx(He,{sx:{fontSize:16},color:"action"}),e.jsx(f,{variant:"caption",color:p!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:p!=="Unassigned"?"normal":"italic"},children:p}),o.dueDate&&e.jsxs(e.Fragment,{children:[e.jsx(he,{sx:{fontSize:16,ml:1},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.78rem"},children:ie(o.dueDate)})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5,justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(_,{title:"View Details",children:e.jsx("span",{children:e.jsx($,{color:"primary",size:"small",onClick:()=>v(o),children:e.jsx(We,{})})})}),e.jsx(_,{title:"Edit Task",children:e.jsx("span",{children:e.jsx($,{color:"secondary",size:"small",onClick:()=>x(o),children:e.jsx(De,{})})})}),e.jsx(_,{title:"Delete Task",children:e.jsx("span",{children:e.jsx($,{color:"error",size:"small",onClick:()=>w(o),children:e.jsx(ue,{})})})})]})]})},o.id)})})})},vt=()=>{const{user:t}=dt(),{id:s}=gt(),i=ft(),[m,S]=n.useState([]),[B,A]=n.useState([]),[v,x]=n.useState([]),[w,u]=n.useState(!0),[y,j]=n.useState("all"),[T,o]=n.useState(""),[d,p]=n.useState(null),[F,k]=n.useState(!1),[b,I]=n.useState([]),[a,h]=n.useState(!1),[E,z]=n.useState(null),[O,W]=n.useState(null),[R,Q]=n.useState(!1),[je,H]=n.useState(""),C=n.useCallback(async()=>{u(!0);try{let r;t?.role==="department_head"&&t?.departmentId?r=await M.getAll({departmentId:t.departmentId}):r=await M.getAll(),S(r.data)}catch(r){console.error("Failed to load tasks:",r),S([])}finally{u(!1)}},[t?.role,t?.departmentId]),Y=n.useCallback(async()=>{if(t?.departmentId)try{const r=await ct.getDepartmentUsers(t.departmentId);A(r.data)}catch(r){console.error("Failed to load department users:",r),A([])}},[t?.departmentId]),ae=n.useCallback(async()=>{if(t?.departmentId)try{const r=await Oe.getAll({departmentId:t.departmentId,status:"pending"});x(Array.isArray(r.data)?r.data:r.data.tickets||[])}catch(r){console.error("Failed to load pending tickets:",r),x([])}},[t?.departmentId]);n.useEffect(()=>{C(),Y()},[C,Y]),n.useEffect(()=>{if(s&&m.length>0){const r=m.find(c=>c.id===s);r&&(p(r),k(!0))}},[s,m]);const J=n.useCallback(async r=>{Q(!0);try{const c=Ne(r,{departmentId:t.departmentId}),g=await M.create(c),V=g.data||g;if(r.attachments&&r.attachments.length>0)try{for(const ke of r.attachments)await M.uploadAttachment(V.id,ke)}catch(ke){console.error("Error uploading files:",ke)}return await C(),H("Task created successfully!"),{success:!0}}catch(c){console.error("Error creating task:",c);const g=c?.response?.data?.error||c.message||"Failed to create task. Please try again.";throw new Error(g)}finally{setTimeout(()=>Q(!1),1e3)}},[t.departmentId,C]),be=n.useCallback(async(r,c)=>{try{if(!c?.remarks||c.remarks.trim()==="")throw new Error("Remarks are required when updating a task. Please provide remarks explaining the changes made.");const g=Ne(c);if(await M.update(r,g),c.attachments&&c.attachments.length>0)try{for(const V of c.attachments)await M.uploadAttachment(r,V)}catch(V){console.error("Error uploading files during task update:",V)}return g.relatedTicketId&&g.status&&await Oe.updateStatus(g.relatedTicketId,g.status),await C(),H("Task updated successfully!"),{success:!0}}catch(g){console.error("Error updating task:",g);const V=g?.response?.data?.error||g.message||"Failed to update task";throw new Error(V)}},[C]),K=n.useCallback(async r=>{Q(!0);try{return await M.delete(r),await C(),H("Task deleted successfully!"),{success:!0}}catch(c){console.error("Error deleting task:",c);const g=c?.response?.data?.error||c.message||"Failed to delete task";throw new Error(g)}finally{setTimeout(()=>Q(!1),1e3)}},[C]),ne=n.useCallback(async(r,c)=>{z(r);try{await M.updateStatus(r,c),await C()}catch(g){console.error("Error updating task status:",g)}finally{z(null)}},[C]),le=n.useCallback(async(r,c)=>{W(r);try{await M.updatePriority(r,c),await C()}catch(g){console.error("Error updating task priority:",g)}finally{W(null)}},[C]),ye=n.useCallback(r=>{if(Array.isArray(r)){I(r);return}const c=r;I(g=>g.includes(c)?g.filter(V=>V!==c):[...g,c])},[]),oe=n.useCallback(r=>{b.length===r.length?I([]):I(r.map(c=>c.id))},[b.length]),de=n.useCallback(async r=>{h(!0);try{await Promise.all(b.map(c=>M.updateStatus(c,r))),I([]),await C()}catch(c){console.error("Error updating bulk status:",c)}finally{h(!1)}},[b,C]),ce=n.useCallback(async r=>{h(!0);try{await Promise.all(b.map(c=>M.updatePriority(c,r))),I([]),await C()}catch(c){console.error("Error updating bulk priority:",c)}finally{h(!1)}},[b,C]),we=n.useCallback(async()=>{if(window.confirm(`Are you sure you want to delete ${b.length} tasks?`)){h(!0);try{await Promise.all(b.map(r=>M.delete(r))),I([]),await C()}catch(r){console.error("Error deleting bulk tasks:",r)}finally{h(!1)}}},[b,C]),Te=m.filter(r=>{const c=y==="all"||r.status===y,g=r.title.toLowerCase().includes(T.toLowerCase())||r.description.toLowerCase().includes(T.toLowerCase());return c&&g}),Se=n.useCallback(r=>t&&(t.role==="admin"||t.role==="department_head"||r.createdBy===t.id||r.assignedToId===t.id),[t]),N=n.useCallback(()=>{k(!1),p(null),s&&i("/app/tasks",{replace:!0})},[s,i]);return{tasks:m,filteredTasks:Te,departmentUsers:B,pendingTickets:v,loadingState:w,filter:y,searchQuery:T,selectedTask:d,detailsOpen:F,selectedTasks:b,bulkUpdating:a,updatingStatus:E,updatingPriority:O,creatingTask:R,successMessage:je,setFilter:j,setSearchQuery:o,setSelectedTask:p,setDetailsOpen:k,setSuccessMessage:H,loadPendingTickets:ae,createTask:J,updateTask:be,deleteTask:K,updateTaskStatus:ne,updateTaskPriority:le,selectTask:ye,selectAllTasks:oe,bulkUpdateStatus:de,bulkUpdatePriority:ce,bulkDeleteTasks:we,closeDetails:N,canUpdateTask:Se,user:t}},Ft=()=>{const t=Ae();xe(t.breakpoints.down("sm")),xe(t.breakpoints.between("sm","md"));const{filteredTasks:s,departmentUsers:i,pendingTickets:m,loadingState:S,filter:B,searchQuery:A,selectedTask:v,detailsOpen:x,selectedTasks:w,updatingStatus:u,updatingPriority:y,creatingTask:j,successMessage:T,setFilter:o,setSearchQuery:d,setSelectedTask:p,setDetailsOpen:F,setSuccessMessage:k,loadPendingTickets:b,createTask:I,updateTask:a,deleteTask:h,updateTaskStatus:E,updateTaskPriority:z,selectTask:O,closeDetails:W,canUpdateTask:R,user:Q}=vt(),[je,H]=n.useState(!1),[C,Y]=n.useState(!1),[ae,J]=n.useState(null),[be,K]=n.useState(!1),[ne,le]=n.useState(null),ye=()=>{b(),H(!0)},oe=N=>{J(N),b(),Y(!0)},de=N=>{le(N),K(!0)},ce=N=>{p(N),F(!0)},we=async N=>{await I(N),H(!1)},Te=async N=>{await a(ae.id,N),Y(!1),J(null)},Se=async()=>{ne&&(await h(ne.id),K(!1),le(null))};return S?e.jsx(mt,{overlay:!0,message:"Loading tasks..."}):e.jsxs(l,{sx:{flexGrow:1,pt:{xs:7,sm:3,md:4},px:{xs:1,sm:2,md:3},display:"flex",flexDirection:"column",height:"100%"},children:[e.jsx(jt,{title:"Tasks",subtitle:"Manage and track your department's tasks efficiently",emoji:"✅",color:"success",actionButton:{text:"Add Task",icon:e.jsx(nt,{}),onClick:ye}}),e.jsx(l,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(lt,{in:!0,timeout:800,children:e.jsxs(l,{children:[e.jsx(St,{searchQuery:A,filter:B,onSearchChange:d,onFilterChange:o}),e.jsxs(l,{sx:{mt:2,mb:2},children:[e.jsxs(f,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:["All Tasks (",s.length,")"]}),s.length===0?e.jsx(l,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(f,{variant:"body1",children:"No tasks found. Try adjusting your filters or add a new task."})}):e.jsxs(e.Fragment,{children:[e.jsx(l,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(kt,{tasks:s,departmentUsers:i,canUpdateTask:R,selectedTasks:w,updatingStatus:u,updatingPriority:y,onSelectTask:O,onViewDetails:ce,onEditTask:oe,onDeleteTask:de,onUpdateStatus:E,onUpdatePriority:z})}),e.jsx(l,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(Ct,{tasks:s,departmentUsers:i,canUpdateTask:R,selectedTasks:w,updatingStatus:u,updatingPriority:y,onSelectTask:O,onViewDetails:ce,onEditTask:oe,onDeleteTask:de,onUpdateStatus:E,onUpdatePriority:z})})]})]})]})})}),e.jsx(Le,{open:je,onClose:()=>H(!1),onSubmit:we,departmentUsers:i,pendingTickets:m,loading:j,mode:"create"}),e.jsx(Le,{open:C,onClose:()=>{Y(!1),J(null)},onSubmit:Te,initialData:ae,departmentUsers:i,pendingTickets:m,loading:!1,mode:"edit"}),e.jsx(Tt,{open:x,onClose:W,task:v,departmentUsers:i,user:Q}),e.jsxs(Fe,{open:be,onClose:()=>K(!1),children:[e.jsx(Ee,{children:"Delete Task"}),e.jsx(Re,{children:e.jsx(f,{children:"Are you sure you want to delete this task? This action cannot be undone."})}),e.jsxs(Ue,{children:[e.jsx(q,{onClick:()=>K(!1),children:"Cancel"}),e.jsx(q,{variant:"contained",color:"error",onClick:Se,disabled:j,children:"Delete"})]})]}),e.jsx(ot,{open:!!T,autoHideDuration:3e3,onClose:()=>k(""),message:T,anchorOrigin:{vertical:"top",horizontal:"center"},ContentProps:{sx:{backgroundColor:"success.main",color:"white",fontWeight:600}}})]})};export{Ft as default};
