import{u as ve,r,j as e,B as P,ba as Pe,S as Se,am as Re,F as S,G as Ce,H as ne,b as $,av as u,aA as n,bb as H,I as N,b8 as G,ar as U,b9 as V,bc as Ie,a6 as j,al as Y,ae as Z,z as k,Z as J,a7 as x,ap as le,aw as Le,ax as ke,ay as De,m as Ae,e as Ee,v as Te,w as Fe,x as We,y as qe}from"./mui-BvrjgOXm.js";import{u as ze,L as Be,m as Oe,l as D}from"./index-KPmqbX5J.js";import{R as de,P as Me,r as p,h as ce}from"./PasswordStrengthIndicator-CS6JG6kF.js";import{u as _e}from"./router-D0O_2iby.js";import"./vendor-Ckhrjn13.js";const Ve=()=>{const me=_e(),o=ve(),{login:ue,user:A}=ze(),[g,K]=r.useState(0),[E,pe]=r.useState(!1),[R,m]=r.useState(""),[h,T]=r.useState(!1),[w,Q]=r.useState(!1),[F,C]=r.useState(null),[y,xe]=r.useState({email:"",password:""}),[f,X]=r.useState(!1),[W,l]=r.useState(""),[d,ee]=r.useState(!1),[c,q]=r.useState(!1),[z,I]=r.useState(null),[B,ge]=r.useState([]),[i,te]=r.useState({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),[he,O]=r.useState(!1),[M,fe]=r.useState(""),[L,se]=r.useState(!1),[re,_]=r.useState(""),[ae,oe]=r.useState("");r.useEffect(()=>{A&&A.isAuthenticated&&localStorage.removeItem("loginTab")},[A]),r.useEffect(()=>{const s=setTimeout(()=>T(!1),800);return()=>clearTimeout(s)},[]),r.useEffect(()=>{g===1&&B.length===0&&(async()=>{try{const t=await D.getDepartments();ge(t.data)}catch{}})()},[g,B.length]);const ie=s=>{const{name:t,value:a}=s.target;xe(v=>({...v,[t]:a})),R&&m("")},be=async s=>{if(s.preventDefault(),!y.email||!y.password){m("Please fill in all fields");return}if(!p.canRetry("login")){const t=p.getRemainingRetryTime("login");m(`Please wait ${Math.ceil(t/1e3)} seconds before trying again.`);return}T(!0),m(""),Q(!1),C(null);try{const t=await D.login(y),{data:a}=t;if(a&&a.token){Q(!0),p.clearRetryTimer("login");const v={user:a.user,token:a.token};ue(v),setTimeout(()=>{me("/app/dashboard")},1e3)}else throw new Error("Invalid response from server")}catch(t){console.error("Login error:",t),console.log("Error response:",t.response),console.log("Error data:",t.response?.data);const a=ce(t);console.log("Error info from handleApiError:",a),a.type==="rate_limit"&&(C(t.rateLimitData),p.setRetryTimer("login",a.retryTime)),m(a.message),T(!1)}},b=s=>{const{name:t,value:a}=s.target;te(v=>({...v,[t]:a})),W&&l("")},je=()=>!i.firstname||!i.lastname||!i.email||!i.password||!i.confirmPassword||!i.departmentId?(l("Please fill in all fields"),!1):i.password!==i.confirmPassword?(l("Passwords do not match"),!1):i.password.length<8?(l("Password must be at least 8 characters long"),!1):!0,we=async s=>{if(s.preventDefault(),!!je()){if(!p.canRetry("register")){const t=p.getRemainingRetryTime("register");l(`Please wait ${Math.ceil(t/1e3)} seconds before trying again.`);return}ee(!0),l(""),q(!1),I(null);try{const t={...i};delete t.confirmPassword,(await D.register(t)).data&&(q(!0),p.clearRetryTimer("register"),te({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),setTimeout(()=>{K(0),q(!1),l("")},2e3))}catch(t){console.error("Registration error:",t),console.log("Registration error response:",t.response),console.log("Registration error data:",t.response?.data);const a=ce(t);console.log("Registration error info from handleApiError:",a),a.type==="rate_limit"&&(I(t.rateLimitData),p.setRetryTimer("register",a.retryTime)),l(a.message)}finally{ee(!1)}}},ye=(s,t)=>{K(t),m(""),l("")};return h&&!R?e.jsx(Be,{overlay:!0,message:"Loading login..."}):e.jsxs(P,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",background:o.palette.mode==="dark"?o.palette.background.default:`linear-gradient(to right bottom, ${o.palette.primary.light}, ${o.palette.primary.main})`,py:8,position:"relative",overflow:"hidden"},children:[e.jsx(Pe,{component:"main",maxWidth:"sm",children:e.jsx(Se,{direction:"up",in:!0,timeout:800,children:e.jsxs(Re,{elevation:o.palette.mode==="dark"?2:8,sx:{p:{xs:3,sm:6},display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:o.palette.mode==="dark"?o.palette.background.paper:o.palette.common.white,borderRadius:3,position:"relative",backdropFilter:"blur(10px)",border:`1px solid ${o.palette.mode==="dark"?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"}`,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"},children:[e.jsx(S,{in:!0,timeout:1200,children:e.jsx(P,{sx:{width:80,height:80,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",mb:2,boxShadow:"0 4px 20px rgba(0,0,0,0.1)"},children:e.jsx(P,{component:"img",src:Oe,alt:"Mito Logo",sx:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover"}})})}),e.jsxs(Ce,{value:g,onChange:ye,sx:{mb:3},centered:!0,children:[e.jsx(ne,{label:"Sign In"}),e.jsx(ne,{label:"Sign Up"})]}),g===0&&e.jsxs(P,{sx:{textAlign:"center",mb:2},children:[e.jsx($,{variant:"h4",color:"primary",sx:{fontWeight:"bold",fontSize:24,mt:.75},children:"Welcome Back"}),e.jsx($,{variant:"body1",color:"text.secondary",sx:{fontSize:14,mt:.25},children:"Sign in to continue"})]}),g===0&&e.jsxs("form",{onSubmit:be,style:{width:"100%"},children:[e.jsx(u,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:y.email,onChange:ie,disabled:h||w,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(H,{color:"action"})})}}),e.jsx(u,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:E?"text":"password",id:"password",autoComplete:"current-password",value:y.password,onChange:ie,disabled:h||w,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(V,{color:"action"})}),endAdornment:e.jsx(n,{position:"end",children:e.jsx(N,{"aria-label":"toggle password visibility",onClick:()=>pe(!E),edge:"end",disabled:h||w,children:E?e.jsx(G,{}):e.jsx(U,{})})})}}),e.jsx(P,{sx:{display:"flex",justifyContent:"flex-end",mt:1,mb:2},children:e.jsx(Ie,{component:"button",type:"button",variant:"body2",underline:"hover",onClick:s=>{s.preventDefault(),s.stopPropagation(),O(!0)},sx:{border:"none",background:"none",cursor:"pointer",color:o.palette.primary.main,"&:hover":{color:o.palette.primary.dark}},children:"Forgot password?"})}),e.jsx(de,{isOpen:!!F,onClose:()=>C(null),rateLimitData:F,endpoint:"login",onRetry:()=>{C(null),m("")}}),R&&!F&&e.jsx(S,{in:!0,children:e.jsx(j,{severity:"error",sx:{width:"100%",mb:2},icon:e.jsx(Y,{}),children:R})}),w&&e.jsx(S,{in:!0,children:e.jsx(j,{severity:"success",sx:{width:"100%",mb:2},icon:e.jsx(Z,{}),children:"Login successful! Redirecting..."})}),e.jsx(k,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:h||w,children:h?e.jsx(J,{size:24,color:"inherit"}):"Sign In"})]}),g===1&&e.jsxs("form",{onSubmit:we,style:{width:"100%"},children:[e.jsxs(x,{container:!0,spacing:2,children:[e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(u,{required:!0,fullWidth:!0,id:"firstname",label:"First Name",name:"firstname",autoComplete:"given-name",value:i.firstname,onChange:b,disabled:d||c,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(u,{required:!0,fullWidth:!0,id:"lastname",label:"Last Name",name:"lastname",autoComplete:"family-name",value:i.lastname,onChange:b,disabled:d||c,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(u,{required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",value:i.email,onChange:b,disabled:d||c,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(H,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,children:e.jsxs(Le,{fullWidth:!0,required:!0,children:[e.jsx(ke,{id:"department-label",children:"Department"}),e.jsx(De,{labelId:"department-label",id:"departmentId",name:"departmentId",value:i.departmentId,label:"Department",onChange:b,disabled:d||c,startAdornment:e.jsx(n,{position:"start",children:e.jsx(Ee,{color:"action"})}),children:B.map(s=>e.jsx(Ae,{value:s.id,children:s.name},s.id))})]})}),e.jsxs(x,{item:!0,xs:12,sm:6,children:[e.jsx(u,{required:!0,fullWidth:!0,name:"password",label:"Password",type:f?"text":"password",id:"register-password",autoComplete:"new-password",value:i.password,onChange:b,disabled:d||c,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(V,{color:"action"})}),endAdornment:e.jsx(n,{position:"end",children:e.jsx(N,{"aria-label":"toggle password visibility",onClick:()=>X(!f),edge:"end",disabled:d||c,children:f?e.jsx(G,{}):e.jsx(U,{})})})}}),e.jsx(Me,{password:i.password})]}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(u,{required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:f?"text":"password",id:"register-confirm-password",autoComplete:"new-password",value:i.confirmPassword,onChange:b,disabled:d||c,InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(V,{color:"action"})}),endAdornment:e.jsx(n,{position:"end",children:e.jsx(N,{"aria-label":"toggle password visibility",onClick:()=>X(!f),edge:"end",disabled:d||c,children:f?e.jsx(G,{}):e.jsx(U,{})})})}})})]}),e.jsx(de,{isOpen:!!z,onClose:()=>I(null),rateLimitData:z,endpoint:"register",onRetry:()=>{I(null),l("")}}),W&&!z&&e.jsx(S,{in:!0,children:e.jsx(j,{severity:"error",sx:{width:"100%",mt:2},icon:e.jsx(Y,{}),children:W})}),c&&e.jsx(S,{in:!0,children:e.jsx(j,{severity:"success",sx:{width:"100%",mt:2},icon:e.jsx(Z,{}),children:"Registration successful! You will be redirected to login in a few seconds..."})}),e.jsx(k,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:d||c,children:d?e.jsx(J,{size:24,color:"inherit"}):"Register"})]})]})})}),e.jsxs(Te,{open:he,onClose:()=>O(!1),maxWidth:"xs",fullWidth:!0,PaperProps:{sx:{borderRadius:3,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"}},children:[e.jsx(Fe,{sx:{pb:1,fontWeight:600,color:o.palette.text.primary},children:"Forgot Password"}),e.jsxs(We,{sx:{pt:2},children:[e.jsx($,{variant:"body2",sx:{mb:3,color:o.palette.text.secondary},children:"Enter your email address and we'll send you a link to reset your password."}),e.jsx(u,{label:"Email Address",type:"email",fullWidth:!0,margin:"normal",value:M,onChange:s=>fe(s.target.value),disabled:L,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(n,{position:"start",children:e.jsx(H,{color:"action"})})}}),re&&e.jsx(j,{severity:"error",sx:{mt:2},icon:e.jsx(Y,{}),children:re}),ae&&e.jsx(j,{severity:"success",sx:{mt:2},icon:e.jsx(Z,{}),children:ae})]}),e.jsxs(qe,{sx:{px:3,pb:3},children:[e.jsx(k,{onClick:()=>O(!1),disabled:L,sx:{color:o.palette.text.secondary,"&:hover":{color:o.palette.text.primary}},children:"Cancel"}),e.jsx(k,{onClick:async()=>{if(_(""),oe(""),!M){_("Please enter your email address.");return}se(!0);try{await D.forgotPassword({email:M}),oe("If an account with that email exists, a reset link has been sent.")}catch(s){_(s.response?.data?.error||"Failed to send reset email.")}finally{se(!1)}},variant:"contained",color:"primary",disabled:L,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:600,px:3,minWidth:"120px",height:"36px"},children:L?e.jsx(J,{size:20,color:"inherit"}):"Send Reset Link"})]})]})]})};export{Ve as default};
