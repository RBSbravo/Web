import{u as ve,j as e,a5 as jr,a6 as yr,E as Zr,G as Oe,a4 as v,as as te,ax as es,ay as rs,at as Q,au as Y,av as X,m as x,a1 as ze,az as ss,aj as ts,aA as as,aB as ns,aC as ur,aD as q,aE as is,k as br,O as Qe,ai as Ye,ab as Xe,aq as Ze,b as j,h as V,d as ie,aG as je,aH as sr,aI as tr,B as A,an as er,I as oe,ao as wr,ap as Re,J as Ie,aw as ar,y as G,aJ as os,t as ce,v as ue,w as xe,a3 as ls,V as Se,x as me,aK as Sr,aL as ds,aM as rr,r as vr,n as Cr,p as Tr,aN as Fr,q as Dr,H as kr,am as qe,aF as cs,F as us}from"./mui-DaYlJXyD.js";import{r as t,b as Wr}from"./vendor-Cr2nE3UY.js";import{e as $,g as xs,h as ge,f as ms,i as $e,u as hs,L as fs}from"./index-Cb3eoPjA.js";import{f as _e,g as Ar,a as zr,b as Ee,c as _r,d as ps,F as gs,C as js,e as ys,h as xr,i as mr,v as hr,p as fr,j as bs,k as Ve,l as Ge,m as pr,n as Je}from"./FileUploadSection-CpbjBRrf.js";import{P as ws}from"./PageHeader-DlP9MJR_.js";import{c as Ss,u as vs}from"./router-B4FNaIx_.js";const Cs=()=>{const[o,g]=t.useState([]),[r,h]=t.useState([]),[S,E]=t.useState([]),[I,P]=t.useState(!0),[M,y]=t.useState(!1),[D,W]=t.useState([]),[L,n]=t.useState([]),[p,s]=t.useState({}),[C,w]=t.useState(""),d=t.useCallback(async()=>{var l;try{const a=await $.getAll(),f=((l=a.data)==null?void 0:l.tickets)||a.tickets||a.data||a||[];if(!Array.isArray(f)){console.warn("Tickets data is not an array:",f),g([]);return}const m=f.sort((c,k)=>{const _=new Date(c.created_at||c.createdAt||0);return new Date(k.created_at||k.createdAt||0)-_});g(m)}catch(a){console.error("Error loading tickets:",a),g([])}},[]),T=t.useCallback(async()=>{try{const l=await $.getAssignedTickets(),a=l.data||l||[];if(!Array.isArray(a)){console.warn("Assigned tickets data is not an array:",a),h([]);return}const f=a.sort((m,c)=>{const k=new Date(m.created_at||m.createdAt||0);return new Date(c.created_at||c.createdAt||0)-k});h(f)}catch(l){console.error("Error loading assigned tickets:",l),h([])}},[]),R=t.useCallback(async()=>{var l;try{const[a,f]=await Promise.all([$.getAll(),$.getAssignedTickets()]),m=((l=a.data)==null?void 0:l.tickets)||a.tickets||a.data||a||[],c=f.data||f||[],k=[...Array.isArray(m)?m:[],...Array.isArray(c)?c:[]],_=JSON.parse(localStorage.getItem("user")||"{}"),J=_==null?void 0:_.id,ee=k.filter(B=>{var fe;const ne=B.forwarded_from_id||B.forwardedFromId||((fe=B.forwardedFrom)==null?void 0:fe.id),se=B.is_forwarded===!0||B.isForwarded===!0||typeof B.forward_chain_id<"u"||typeof B.forwardChainId<"u",ke=ne&&J&&String(ne)===String(J);return se&&ke}),O=new Set,De=ee.filter(B=>!B||!B.id||O.has(B.id)?!1:(O.add(B.id),!0)).sort((B,ne)=>{const se=new Date(B.created_at||B.createdAt||0);return new Date(ne.created_at||ne.createdAt||0)-se});E(De)}catch(a){console.error("Error loading forwarded-by-me tickets:",a),E([])}},[]),z=t.useCallback(async()=>{try{const l=await xs.getAll(),a=l.data||l||[];W(a)}catch(l){console.error("Error loading departments:",l),W([])}},[]),b=t.useCallback(async()=>{try{const l=await ge.getAll(),a=l.data||l||[];n(a)}catch(l){console.error("Error loading users:",l),n([])}},[]),U=t.useCallback(async()=>{try{P(!0),w(""),await Promise.all([d(),T(),R(),z(),b()])}catch(l){console.error("Error loading initial data:",l),w("Failed to load data. Please try again.")}finally{P(!1)}},[d,T,R,z,b]),Z=t.useCallback(async(l,a=[])=>{var f,m;y(!0);try{const c=await $.create(l),k=c.data||c;if(a&&a.length>0)try{for(const _ of a)_.file?await $.uploadAttachment(k.id,_.file):await $.uploadAttachment(k.id,_)}catch(_){console.error("Error uploading files:",_)}return g(_=>[k,..._]),{success:!0,ticket:k}}catch(c){return console.error("Error creating ticket:",c),{success:!1,error:((m=(f=c.response)==null?void 0:f.data)==null?void 0:m.message)||"Failed to create ticket."}}finally{y(!1)}},[]),Pe=t.useCallback(async l=>{var a,f;y(!0);try{const m=await $.update(l.id,l),c=m.data||m;return g(k=>k.map(_=>_.id===c.id?c:_)),{success:!0,ticket:c}}catch(m){return console.error("Error updating ticket:",m),{success:!1,error:((f=(a=m.response)==null?void 0:a.data)==null?void 0:f.message)||"Failed to update ticket."}}finally{y(!1)}},[]),Ce=t.useCallback(async l=>{var a,f;if(!l)return{success:!1,error:"Invalid ticket ID for deletion."};y(!0);try{return await $.delete(l),g(m=>m.filter(c=>c.id!==l)),{success:!0}}catch(m){return console.error("Error deleting ticket:",m),{success:!1,error:((f=(a=m.response)==null?void 0:a.data)==null?void 0:f.message)||"Failed to delete ticket."}}finally{y(!1)}},[]),Le=t.useCallback(async(l,a)=>{var f,m,c;y(!0);try{const k=await $.forwardTicket(l,a);try{const _=JSON.parse(localStorage.getItem("user")||"{}"),J=_==null?void 0:_.id,ee=await $.getById(l),O=ee.data||ee||null;if(O&&J){const de=O.forwarded_from_id||O.forwardedFromId||((f=O.forwardedFrom)==null?void 0:f.id);(O.is_forwarded===!0||O.isForwarded===!0||typeof O.forward_chain_id<"u"||typeof O.forwardChainId<"u")&&de&&String(de)===String(J)&&E(B=>B.some(se=>se.id===O.id)?B:[O,...B])}}catch{}return await d(),await R(),{success:!0,data:k.data||k}}catch(k){return console.error("Error forwarding ticket:",k),{success:!1,error:((c=(m=k.response)==null?void 0:m.data)==null?void 0:c.message)||"Failed to forward ticket."}}finally{y(!1)}},[d,R]),Te=t.useCallback(async l=>{try{const a=await $.getAttachments(l),f=a.data||a||[];return s(m=>({...m,[l]:f})),f}catch(a){return console.error("Error loading ticket files:",a),s(f=>({...f,[l]:[]})),[]}},[]),Ne=t.useCallback(async(l,a)=>{var f;try{const m=await $.uploadAttachment(a,l),c=m.data||m;return s(k=>({...k,[a]:[...k[a]||[],c]})),c}catch(m){if(console.error("File upload error:",m),((f=m.response)==null?void 0:f.status)===500){console.warn("Server returned 500 but file may have been uploaded successfully");try{const c=await $.getAttachments(a);if(c.data&&c.data.length>0)return s(k=>({...k,[a]:c.data})),c.data[c.data.length-1]}catch(c){console.error("Error refreshing file list:",c)}}throw new Error("Failed to upload file.")}},[]),ae=t.useCallback(async(l,a)=>{try{await $.deleteAttachment(l,a),s(f=>{var m;return{...f,[l]:((m=f[l])==null?void 0:m.filter(c=>c.id!==a))||[]}})}catch{throw new Error("Failed to delete file.")}},[]),Be=t.useCallback(async(l,a)=>{try{const f=await ms.download(a),m=new Blob([f.data]),c=window.URL.createObjectURL(m),k=document.createElement("a");k.href=c;const _=f.headers["content-disposition"];let J="download";if(_){const ee=_.match(/filename="(.+)"/);ee&&(J=ee[1])}k.download=J,document.body.appendChild(k),k.click(),document.body.removeChild(k),window.URL.revokeObjectURL(c)}catch{throw new Error("Failed to download file.")}},[]),he=t.useCallback(l=>p[l]||[],[p]),Fe=t.useCallback(async(l,a)=>{var f,m;try{const c=await $e.addTicketComment(l,a);return{success:!0,comment:c.data||c}}catch(c){return console.error("Error adding comment:",c),{success:!1,error:((m=(f=c.response)==null?void 0:f.data)==null?void 0:m.message)||"Failed to add comment."}}},[]),re=t.useCallback(async l=>{try{const a=await $e.fetchTicketComments(l);return a.data||a||[]}catch(a){return console.error("useTickets: Error loading comments:",a),[]}},[]),ye=t.useCallback(async l=>{var a,f;try{return await $e.deleteComment(l),{success:!0}}catch(m){return console.error("Error deleting comment:",m),{success:!1,error:((f=(a=m.response)==null?void 0:a.data)==null?void 0:f.message)||"Failed to delete comment."}}},[]),le=t.useCallback(async()=>{try{await Promise.all([d(),T(),R()])}catch(l){console.error("Error refreshing tickets:",l)}},[d,T,R]);return t.useEffect(()=>{U()},[U]),{tickets:o,assignedTickets:r,forwardedTickets:S,loading:I,actionLoading:M,departments:D,users:L,error:C,loadTickets:d,loadAssignedTickets:T,loadForwardedTickets:R,createTicket:Z,updateTicket:Pe,deleteTicket:Ce,forwardTicket:Le,loadTicketFiles:Te,uploadTicketFile:Ne,deleteTicketFile:ae,downloadTicketFile:Be,getTicketFiles:he,addComment:Fe,loadComments:re,deleteComment:ye,refreshTickets:le,setError:w}},Ts=({activeTab:o,setActiveTab:g,searchQuery:r,setSearchQuery:h,filter:S,setFilter:E,priorityFilter:I,setPriorityFilter:P,isMobile:M})=>(ve(),e.jsx(jr,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsxs(yr,{sx:{p:{xs:2,sm:2.5,md:3}},children:[e.jsxs(Zr,{value:o,onChange:(y,D)=>g(D),variant:"fullWidth",sx:{mb:2,"& .MuiTab-root":{fontSize:{xs:"0.95rem",sm:"1.05rem"},fontWeight:600,textTransform:"none",minHeight:{xs:44,sm:52}},"& .Mui-selected":{color:"primary.main"}},children:[e.jsx(Oe,{label:M?"Sent":"Sent Tickets"}),e.jsx(Oe,{label:M?"Received":"Received Tickets"}),e.jsx(Oe,{label:M?"Forwarded":"Forwarded by Me"})]}),e.jsxs(v,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(v,{item:!0,xs:12,sm:6,md:4,children:e.jsx(te,{fullWidth:!0,placeholder:"Search tickets...",value:r,onChange:y=>h(y.target.value),InputProps:{startAdornment:e.jsx(es,{position:"start",children:e.jsx(rs,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{value:S,label:"Status",onChange:y=>E(y.target.value),sx:{borderRadius:2},children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"declined",children:"Declined"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{value:I,label:"Priority",onChange:y=>P(y.target.value),sx:{borderRadius:2},children:[e.jsx(x,{value:"all",children:"All Priority"}),e.jsx(x,{value:"high",children:"High"}),e.jsx(x,{value:"medium",children:"Medium"}),e.jsx(x,{value:"low",children:"Low"})]})]})})]})]})}));function Ke({title:o,children:g,...r}){const h=t.useRef(null),[S,E]=t.useState(!1);return t.useEffect(()=>{const I=h.current;I&&E(I.scrollWidth>I.clientWidth)},[g,o]),S?e.jsx(V,{title:o,arrow:!0,...r,children:e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:g})}):e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:g})}const Fs=({tickets:o,users:g,activeTab:r,onViewTicket:h,onEditTicket:S,onDeleteTicket:E,getStatusColor:I,getStatusIcon:P,getPriorityColor:M,getPriorityIcon:y})=>{const D=ve(),W=ze(D.breakpoints.down("sm")),[L,n]=t.useState({});t.useEffect(()=>{if(r!==2||!Array.isArray(o))return;const s=new Set((Array.isArray(g)?g:[]).map(d=>String(d.id))),C=new Set(Object.keys(L)),w=new Set;o.forEach(d=>{const T=d.forwardedTo||d.forwarded_to||d.forwarded_to_id||d.current_handler_id;if(T&&typeof T!="object"){const R=String(T);!s.has(R)&&!C.has(R)&&w.add(R)}}),w.size!==0&&(async()=>{const d=await Promise.all(Array.from(w).map(async T=>{try{const R=await ge.getById(T),z=R.data||R||null;return[T,z]}catch{return[T,null]}}));n(T=>{const R={...T};return d.forEach(([z,b])=>{R[z]=b}),R})})()},[r,o,g,L]);const p=s=>{if(!s)return"Unknown User";if(typeof s=="object")return Ee(s);const C=String(s),w=g.find(d=>String(d.id)===C)||L[C];return w?Ee(w):C};return W?null:e.jsx(ss,{component:ts,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(as,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(ns,{children:e.jsxs(ur,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(q,{padding:"checkbox",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(q,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(q,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(q,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(q,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(q,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:r===0?"Send To":r===1?"Sent By":r===2?"Forwarded To":"Created By"}),e.jsx(q,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(q,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(is,{children:o.map((s,C)=>e.jsxs(ur,{hover:!0,sx:{bgcolor:C%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(q,{padding:"checkbox",sx:{px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(q,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(br,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:(()=>{switch(P(s.status)){case"Schedule":return e.jsx(Ze,{sx:{fontSize:{md:14,lg:18}}});case"CheckCircle":return e.jsx(Xe,{sx:{fontSize:{md:14,lg:18}}});case"Error":return e.jsx(Ye,{sx:{fontSize:{md:14,lg:18}}});default:return e.jsx(Qe,{sx:{fontSize:{md:14,lg:18}}})}})()})}),e.jsxs(q,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(Ke,{title:s.title,children:e.jsx(j,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.title})}),e.jsx(Ke,{title:s.description,children:e.jsx(j,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.description})})]}),e.jsx(q,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(V,{title:`Priority: ${s.priority}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ie,{label:s.priority,size:"small",color:M(s.priority),icon:(()=>{switch(y(s.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:{md:12,lg:16}}});case"Remove":return e.jsx(je,{sx:{fontSize:{md:12,lg:16}}});case"LowPriority":return e.jsx(sr,{sx:{fontSize:{md:12,lg:16}}});default:return e.jsx(je,{sx:{fontSize:{md:12,lg:16}}})}})(),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})})})}),e.jsx(q,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(V,{title:`Status: ${s.status.replace("_"," ")}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ie,{label:s.status.replace("_"," "),size:"small",color:I(s.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})})})}),e.jsx(q,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(Ke,{title:(()=>{if(r===0)return p(s.ticketAssignee||s.assignedTo||s.assigned_to);if(r===1)return p(s.ticketCreator||s.createdBy||s.created_by);if(r===2){const w=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return p(w)}return p(s.ticketCreator||s.createdBy||s.created_by)})(),children:e.jsx(j,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:"0.78rem",overflow:"hidden",textOverflow:"ellipsis"},children:(()=>{if(r===0)return p(s.ticketAssignee||s.assignedTo||s.assigned_to);if(r===1)return p(s.ticketCreator||s.createdBy||s.created_by);if(r===2){const w=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return p(w)}return p(s.ticketCreator||s.createdBy||s.created_by)})()})})}),e.jsx(q,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(A,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[s.due_date&&e.jsx(V,{title:_e(s.due_date),arrow:!0,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(er,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(j,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:_e(s.due_date)})]})}),(()=>{const w=Ar(s),d=zr(s);return!w||!d?null:e.jsx(V,{title:`Maturity: ${d}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ie,{label:d,size:"small",color:w,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(q,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsx(A,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(V,{title:"View Details",children:e.jsx("span",{children:e.jsx(oe,{color:"primary",size:"small",onClick:()=>h(s),children:e.jsx(wr,{fontSize:"small"})})})}),e.jsx(V,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"secondary",size:"small",onClick:()=>S(s),children:e.jsx(Re,{fontSize:"small"})})})}),e.jsx(V,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"error",size:"small",onClick:()=>E(s),children:e.jsx(Ie,{fontSize:"small"})})})})]})})})]},s.id))})]})})},Ds=({ticket:o,departments:g,users:r,activeTab:h,onViewTicket:S,onEditTicket:E,onDeleteTicket:I,getPriorityColor:P,getPriorityIcon:M,getStatusColor:y,getTicketFiles:D})=>{const W=ve(),L=ze(W.breakpoints.down("sm")),n=p=>{if(!p)return"Unknown";if(typeof p=="object"&&p.firstname)return Ee(p);const s=r.find(C=>C.id===p);return Ee(s)};return L?e.jsx(jr,{sx:{borderRadius:3,boxShadow:2,overflow:"hidden"},children:e.jsxs(yr,{sx:{p:3},children:[e.jsx(A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:e.jsxs(A,{sx:{flex:1,minWidth:0},children:[e.jsx(j,{variant:"h6",sx:{fontWeight:700,mb:1,wordBreak:"break-word"},children:o.title}),e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:2,lineHeight:1.5},children:o.description})]})}),e.jsxs(A,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(ie,{label:o.priority,size:"small",color:P(o.priority),icon:(()=>{switch(M(o.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:14}});case"Remove":return e.jsx(je,{sx:{fontSize:14}});case"LowPriority":return e.jsx(sr,{sx:{fontSize:14}});default:return e.jsx(je,{sx:{fontSize:14}})}})(),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),e.jsx(ie,{label:o.status.replace("_"," "),size:"small",color:y(o.status),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),(()=>{const p=Ar(o),s=zr(o);return!p||!s?null:e.jsx(ie,{label:s,size:"small",color:p,sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}})})()]}),e.jsxs(A,{sx:{display:"flex",flexDirection:"column",gap:1,mb:2},children:[e.jsxs(j,{variant:"body2",color:"text.secondary",children:[e.jsxs("strong",{children:[h===0?"Send To":h===1?"Sent By":h===2?"Forwarded To":"Created By",":"]})," ",n(h===0?o.ticketAssignee||o.assignedTo||o.assigned_to:h===1?o.ticketCreator||o.createdBy||o.created_by:h===2?o.forwarded_to_id:o.ticketCreator||o.createdBy||o.created_by)]}),o.due_date&&e.jsxs(j,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Due Date:"})," ",_e(o.due_date)]})]}),D(o.id).length>0&&e.jsxs(A,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(ar,{fontSize:"small",sx:{mr:1,color:"text.secondary"}}),e.jsxs(j,{variant:"caption",color:"text.secondary",children:[D(o.id).length," file(s) attached"]})]}),e.jsx(A,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(V,{title:"View Details",children:e.jsx("span",{children:e.jsx(oe,{color:"primary",size:"small",onClick:()=>S(o),children:e.jsx(wr,{fontSize:"small"})})})}),e.jsx(V,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"secondary",size:"small",onClick:()=>E(o),children:e.jsx(Re,{fontSize:"small"})})})}),e.jsx(V,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"error",size:"small",onClick:()=>I(o),children:e.jsx(Ie,{fontSize:"small"})})})})]})})]})}):null},ks=({ticket:o,onForward:g,disabled:r=!1})=>{const[h,S]=t.useState(!1),[E,I]=t.useState([]),[P,M]=t.useState(""),[y,D]=t.useState(""),[W,L]=t.useState(!1),[n,p]=t.useState("");t.useEffect(()=>{h&&s()},[h]);const s=async()=>{try{L(!0),p("");let d=[];try{const z=await ge.getAll({role:"department_head"}),b=await ge.getAll({role:"admin"}),U=z.data||z||[],Z=b.data||b||[];d=[...U,...Z],console.log("Department heads and admins fetched with role param:",d)}catch(z){console.log("Role-based fetch failed, trying all users:",z);const b=await ge.getAll();d=b.data||b||[],console.log("All users fetched:",d)}let T=d;d.length>0&&!d.some(z=>z.role==="department_head"||z.role==="admin")&&(T=d.filter(z=>{var U;const b=(U=z.role)==null?void 0:U.toLowerCase();return b==="admin"||b==="department_head"||b==="departmenthead"||b==="dept_head"||b==="head"||z.role&&z.role.includes("head")})),console.log("Eligible users found:",T);const R=T.map(z=>{const b=z.role==="admin"?"Admin":"Dept Head";return{...z,displayName:`${z.firstname||z.firstName||"Unknown"} ${z.lastname||z.lastName||"User"} (${b})`}});R.length===0?p("No department heads or admins found in the system. Please ensure there are users with appropriate roles."):(I(R),p(""))}catch(d){console.error("Error loading recipients:",d),p("Failed to load recipients. Please try again.")}finally{L(!1)}},C=async()=>{var d,T;if(!P||!y.trim()){p("Please select a recipient and provide a reason");return}L(!0),p("");try{await $.forwardTicket(o.id,{toUserId:P,reason:y.trim()}),g&&g(),S(!1),M(""),D("")}catch(R){console.error("Error forwarding ticket:",R),p(((T=(d=R.response)==null?void 0:d.data)==null?void 0:T.error)||"Failed to forward ticket")}finally{L(!1)}},w=()=>{S(!1),M(""),D(""),p("")};return e.jsxs(e.Fragment,{children:[e.jsx(G,{variant:"outlined",startIcon:e.jsx(os,{}),onClick:()=>S(!0),disabled:r,sx:{mr:1},children:"Forward"}),e.jsxs(ce,{open:h,onClose:w,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ue,{children:["Forward Ticket #",o==null?void 0:o.id]}),e.jsxs(xe,{children:[n&&e.jsx(ls,{severity:"error",sx:{mb:2},children:n}),e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Forwarding ticket to a department head or admin"}),e.jsxs(Q,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Y,{children:"Forward To"}),e.jsx(X,{value:P,onChange:d=>M(d.target.value),label:"Forward To",disabled:W||E.length===0,children:W?e.jsx(x,{disabled:!0,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Se,{size:16}),"Loading recipients..."]})}):E.length===0?e.jsx(x,{disabled:!0,children:"No recipients available"}):E.map(d=>e.jsx(x,{value:d.id,children:d.displayName},d.id))})]}),e.jsx(te,{fullWidth:!0,label:"Reason for Forwarding",value:y,onChange:d=>D(d.target.value),multiline:!0,rows:3,required:!0,disabled:W,sx:{mb:2}})]}),e.jsxs(me,{children:[e.jsx(G,{onClick:w,disabled:W,children:"Cancel"}),e.jsx(G,{onClick:C,variant:"contained",disabled:!P||!y.trim()||W,children:W?e.jsx(Se,{size:20}):"Forward Ticket"})]})]})]})},Ws=({open:o,message:g,onClose:r})=>e.jsxs(ce,{open:o,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ue,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(Sr,{color:"error",sx:{fontSize:32}}),"Error"]}),e.jsx(xe,{children:e.jsx(j,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:g})}),e.jsx(me,{children:e.jsx(G,{onClick:r,variant:"contained",color:"error",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),As=({open:o,message:g,onClose:r})=>e.jsxs(ce,{open:o,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ue,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main",fontWeight:700},children:[e.jsx(ds,{color:"success",sx:{fontSize:32}}),"Success"]}),e.jsx(xe,{children:e.jsx(j,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:g})}),e.jsx(me,{children:e.jsx(G,{onClick:r,variant:"contained",color:"success",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),zs=({open:o,ticket:g,onClose:r,onConfirm:h,loading:S})=>e.jsxs(ce,{open:o,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ue,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(Sr,{color:"error",sx:{fontSize:32}}),"Confirm Deletion"]}),e.jsxs(xe,{children:[e.jsx(j,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:2},children:"Are you sure you want to delete this ticket? This action cannot be undone."}),e.jsx(j,{variant:"body1",sx:{fontWeight:"bold",color:"text.primary",bgcolor:"action.hover",p:2,borderRadius:1,fontSize:"1.1rem"},children:g==null?void 0:g.title})]}),e.jsxs(me,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:r,sx:{minWidth:100},children:"Cancel"}),e.jsx(G,{onClick:h,color:"error",variant:"contained",disabled:S,sx:{minWidth:100},children:S?e.jsx(Se,{size:20}):"Delete"})]})]}),_s=({open:o,onClose:g,newTicket:r,onTicketChange:h,newTicketFiles:S,onFileUpload:E,onFileDelete:I,departments:P,users:M,onSubmit:y,loading:D,isMobile:W,currentUserId:L})=>e.jsxs(ce,{open:o,onClose:g,maxWidth:"sm",fullWidth:!0,fullScreen:W,children:[e.jsx(ue,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:"Create New Ticket"}),e.jsx(xe,{sx:{pt:{xs:1,sm:2}},children:e.jsx(A,{component:"form",onSubmit:n=>{n.preventDefault(),y()},sx:{mt:1},children:e.jsxs(v,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Ticket Title",name:"title",value:r.title,onChange:h,required:!0,sx:{mb:2}})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Description",name:"description",value:r.description,onChange:h,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Desired Action"}),e.jsxs(X,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,children:[e.jsx(x,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(x,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(x,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(x,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(x,{value:"Dispatch",children:"Dispatch"}),e.jsx(x,{value:"File",children:"File"}),e.jsx(x,{value:"Mis routed",children:"Mis routed"}),e.jsx(x,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(x,{value:"photocopy file",children:"Photocopy file"}),e.jsx(x,{value:"Study",children:"Study"}),e.jsx(x,{value:"Staff action",children:"Staff action"}),e.jsx(x,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{name:"priority",value:r.priority,label:"Priority",onChange:h,children:[e.jsx(x,{value:"Low",children:"Low"}),e.jsx(x,{value:"Medium",children:"Medium"}),e.jsx(x,{value:"High",children:"High"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{name:"status",value:r.status||"pending",label:"Status",onChange:h,children:[e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"declined",children:"Declined"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Send To"}),e.jsxs(X,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,children:[e.jsx(rr,{children:"Admins"}),M.filter(n=>n.role==="admin").filter(n=>n.id!==L).map(n=>e.jsxs(x,{value:n.id,children:[n.firstname," ",n.lastname," (Admin)"]},n.id)),e.jsx(rr,{children:"Department Heads"}),P.filter(n=>n.head).filter(n=>n.head.id!==L).map(n=>e.jsxs(x,{value:n.head.id,children:[n.head.firstname," ",n.head.lastname," (Dept Head, ",n.name,")"]},n.head.id))]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(te,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(A,{sx:{mt:3},children:[e.jsx(j,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),S.length===0&&e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),S.length>0&&e.jsx(vr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:S.map(n=>{const p=n.file_name||n.name||"Unknown File";return e.jsxs(Wr.Fragment,{children:[e.jsxs(Cr,{secondaryAction:e.jsx(V,{title:"Delete file",arrow:!0,children:e.jsx(oe,{edge:"end",onClick:()=>I(n.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(Ie,{fontSize:"small"})})}),children:[e.jsx(Tr,{children:e.jsx(Fr,{})}),e.jsx(Dr,{primary:e.jsx(V,{title:"Click to download file",arrow:!0,children:e.jsx(j,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(n.file){const s=URL.createObjectURL(n.file),C=document.createElement("a");C.href=s,C.download=n.name,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(s)}},children:p})}),secondary:e.jsxs(j,{variant:"caption",color:"text.disabled",children:[n.uploadedAt?new Date(n.uploadedAt).toLocaleString():"â€”"," â€¢ ",_r(n.file_size||n.size||0)]})})]}),e.jsx(kr,{variant:"inset",component:"li"})]},n.id)})}),e.jsxs(G,{variant:"outlined",component:"label",startIcon:e.jsx(ar,{}),disabled:D||S.length>=5,sx:{mt:1},children:[D?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:n=>{const p=n.target.files[0];p&&E(p)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:D||S.length>=5})]}),e.jsx(A,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(me,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:g,children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:y,disabled:D,sx:{minWidth:100},children:D?e.jsx(Se,{size:20}):"Create Ticket"})]})]}),Es=({open:o,onClose:g,ticket:r,departments:h,users:S=[],getStatusColor:E,getStatusIcon:I,getPriorityColor:P,getPriorityIcon:M,onRefresh:y,getTicketFiles:D,onFileDelete:W,onEdit:L,isMobile:n,addComment:p,loadComments:s,deleteComment:C})=>{var T,R,z;ve();const w=b=>{if(!b)return"Unknown";if(typeof b=="object"&&b.firstname)return`${b.firstname} ${b.lastname}`.trim()||b.email||b.username||"Unknown";const U=S.find(Z=>Z.id===b);return U&&(`${U.firstname} ${U.lastname}`.trim()||U.email||U.username)||b},d=b=>{if(!b)return"N/A";const U=h.find(Z=>Z.id===b);return U?U.name:b};return r?e.jsxs(ce,{open:o,onClose:g,maxWidth:"md",fullWidth:!0,fullScreen:n,children:[e.jsxs(ue,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2},display:"flex",alignItems:"center",gap:2},children:[e.jsx(br,{sx:{bgcolor:`${E(r.status)}.light`,color:`${E(r.status)}.main`,width:{xs:32,sm:40},height:{xs:32,sm:40}},children:(()=>{switch(I(r.status)){case"Schedule":return e.jsx(Ze,{sx:{fontSize:{xs:16,sm:20}}});case"CheckCircle":return e.jsx(Xe,{sx:{fontSize:{xs:16,sm:20}}});case"Error":return e.jsx(Ye,{sx:{fontSize:{xs:16,sm:20}}});default:return e.jsx(Qe,{sx:{fontSize:{xs:16,sm:20}}})}})()}),e.jsxs(A,{sx:{flex:1},children:[e.jsx(j,{variant:"h6",sx:{fontWeight:600},children:r.title}),e.jsxs(j,{variant:"body2",color:"text.secondary",children:["Ticket #",r.id]})]})]}),e.jsxs(xe,{sx:{pt:{xs:1,sm:2}},children:[e.jsxs(v,{container:!0,spacing:3,children:[e.jsxs(v,{item:!0,xs:12,children:[e.jsx(j,{variant:"h6",sx:{mb:2,fontWeight:600},children:"Description"}),e.jsx(A,{sx:{mb:3},children:e.jsx(j,{variant:"body1",children:r.description})})]}),(r.desired_action||r.desiredAction)&&e.jsxs(v,{item:!0,xs:12,children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Desired Action"}),e.jsx(j,{variant:"body1",children:r.desired_action||r.desiredAction})]}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",children:"Priority"}),e.jsx(ie,{label:r.priority,color:P(r.priority),icon:(()=>{switch(M(r.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:16}});case"Remove":return e.jsx(je,{sx:{fontSize:16}});case"LowPriority":return e.jsx(sr,{sx:{fontSize:16}});default:return e.jsx(je,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx(ie,{label:r.status.replace("_"," "),color:E(r.status),icon:(()=>{switch(I(r.status)){case"Schedule":return e.jsx(Ze,{sx:{fontSize:16}});case"CheckCircle":return e.jsx(Xe,{sx:{fontSize:16}});case"Error":return e.jsx(Ye,{sx:{fontSize:16}});default:return e.jsx(Qe,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created By"}),e.jsxs(j,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qe,{sx:{fontSize:20},color:"action"}),w(r.ticketCreator||r.createdBy||r.created_by)]})]}),e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Department"}),e.jsxs(j,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qe,{sx:{fontSize:20},color:"action"}),d(r.departmentId||r.department_id)]})]}),(r.ticketAssignee||r.assignedTo||r.assigned_to)&&e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Assigned To"}),e.jsxs(j,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qe,{sx:{fontSize:20},color:"action"}),w(r.ticketAssignee||r.assignedTo||r.assigned_to)]})]}),r.due_date&&e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Due Date"}),e.jsxs(j,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(er,{sx:{fontSize:20},color:"action"}),_e(r.due_date)]})]}),e.jsxs(v,{item:!0,xs:12,children:[e.jsx(j,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created"}),e.jsxs(j,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(er,{sx:{fontSize:20},color:"action"}),ps(r.created_at||r.createdAt)]})]})]}),D(r.id).length>0&&e.jsx(A,{sx:{mt:3},children:e.jsx(gs,{entityId:r.id,fetchFiles:async()=>({data:D(r.id)}),uploadFile:()=>{},deleteFile:W,maxFiles:5,maxFileSize:10*1024*1024,acceptedTypes:["*/*"],disabled:!1,readOnly:!0})}),e.jsx(js,{entityId:r==null?void 0:r.id,user:JSON.parse(localStorage.getItem("user")||"{}"),users:S,fetchComments:s,addComment:p,deleteComment:C})]}),e.jsxs(me,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:g,children:"Close"}),e.jsx(ks,{ticket:r,disabled:!((r==null?void 0:r.assigned_to)===((T=JSON.parse(localStorage.getItem("user")||"{}"))==null?void 0:T.id)||(r==null?void 0:r.forwarded_to_id)===((R=JSON.parse(localStorage.getItem("user")||"{}"))==null?void 0:R.id)||(r==null?void 0:r.current_handler_id)===((z=JSON.parse(localStorage.getItem("user")||"{}"))==null?void 0:z.id)),onForward:()=>{g(),typeof y=="function"&&y()}}),e.jsx(G,{variant:"contained",startIcon:e.jsx(Re,{}),onClick:()=>{g(),L(r)},sx:{minWidth:100},children:"Edit Ticket"})]})]}):null},Rs=({open:o,onClose:g,ticket:r,onTicketChange:h,editingTicketFiles:S,onFileUpload:E,onFileDelete:I,departments:P,onSubmit:M,loading:y,fileOperationsCount:D=0})=>{var W,L;return r?e.jsxs(ce,{open:o,onClose:g,maxWidth:"md",fullWidth:!0,children:[e.jsx(ue,{children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Re,{color:"primary"}),e.jsx(j,{variant:"h6",children:"Edit Ticket"})]})}),e.jsx(xe,{dividers:!0,children:r&&e.jsx(A,{sx:{pt:1},children:e.jsxs(v,{container:!0,spacing:3,children:[e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Title",name:"title",value:r.title||"",onChange:h,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Description",name:"description",value:r.description||"",onChange:h,multiline:!0,rows:4,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Desired Action"}),e.jsxs(X,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,sx:{borderRadius:2},children:[e.jsx(x,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(x,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(x,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(x,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(x,{value:"Dispatch",children:"Dispatch"}),e.jsx(x,{value:"File",children:"File"}),e.jsx(x,{value:"Mis routed",children:"Mis routed"}),e.jsx(x,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(x,{value:"photocopy file",children:"Photocopy file"}),e.jsx(x,{value:"Study",children:"Study"}),e.jsx(x,{value:"Staff action",children:"Staff action"}),e.jsx(x,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:D!==0?"Remarks (Required - File operations performed)":"Remarks (Required for updates)",name:"remarks",value:(r==null?void 0:r.remarks)||"",onChange:h,multiline:!0,rows:3,required:!0,error:D!==0&&!((W=r==null?void 0:r.remarks)!=null&&W.trim()),helperText:D!==0?"Remarks are required when file operations are performed":"Please provide remarks explaining the changes made to this ticket",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{name:"priority",value:r.priority||"Medium",label:"Priority",onChange:h,sx:{borderRadius:2},children:[e.jsx(x,{value:"Low",children:"Low"}),e.jsx(x,{value:"Medium",children:"Medium"}),e.jsx(x,{value:"High",children:"High"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{name:"status",value:r.status||"pending",label:"Status",onChange:h,sx:{borderRadius:2},children:[e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"declined",children:"Declined"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Send To"}),e.jsxs(X,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,sx:{borderRadius:2},children:[e.jsx(rr,{children:"Department Heads"}),P.filter(n=>n.head).map(n=>e.jsxs(x,{value:n.head.id,children:[n.head.firstname," ",n.head.lastname," (Dept Head, ",n.name,")"]},n.head.id))]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(te,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(A,{sx:{mt:3},children:[e.jsx(j,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),S.length===0&&e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),S.length>0&&e.jsx(vr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:S.map(n=>{const p=n.file_name||n.name||"Unknown File";return e.jsxs(Wr.Fragment,{children:[e.jsxs(Cr,{secondaryAction:e.jsx(V,{title:"Delete file",arrow:!0,children:e.jsx(oe,{edge:"end",onClick:()=>I(n.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(Ie,{fontSize:"small"})})}),children:[e.jsx(Tr,{children:e.jsx(Fr,{})}),e.jsx(Dr,{primary:e.jsx(V,{title:"Click to download file",arrow:!0,children:e.jsx(j,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(n.file){const s=URL.createObjectURL(n.file),C=document.createElement("a");C.href=s,C.download=n.name,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(s)}else{const s=localStorage.getItem("token"),C=`/api/files/${n.id}/download`;fetch(C,{headers:{Authorization:`Bearer ${s}`}}).then(w=>{if(w.ok)return w.blob();throw new Error("Download failed")}).then(w=>{const d=URL.createObjectURL(w),T=document.createElement("a");T.href=d,T.download=n.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(d)}).catch(w=>{console.error("Download error:",w)})}},children:p})}),secondary:e.jsxs(j,{variant:"caption",color:"text.disabled",children:[n.uploadedAt?new Date(n.uploadedAt).toLocaleString():"â€”"," â€¢ ",_r(n.file_size||n.size||0)]})})]}),e.jsx(kr,{variant:"inset",component:"li"})]},n.id)})}),e.jsxs(G,{variant:"outlined",component:"label",startIcon:e.jsx(ar,{}),disabled:y||S.length>=5,sx:{mt:1},children:[y?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:n=>{const p=n.target.files[0];p&&E(p)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:y||S.length>=5})]}),e.jsx(A,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(me,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:g,disabled:D!==0,children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:M,disabled:y||D!==0&&!((L=r==null?void 0:r.remarks)!=null&&L.trim()),sx:{minWidth:100},children:y?e.jsx(Se,{size:20}):"Update Ticket"})]})]}):null},gr={title:"",description:"",priority:"Medium",status:"pending",sendTo:"",due_date:"",departmentId:"",desired_action:"",remarks:""},Us=()=>{const o=ve(),g=ze(o.breakpoints.down("sm"));ze(o.breakpoints.between("sm","md"));const{user:r}=hs(),{id:h}=Ss(),S=vs(),{tickets:E,assignedTickets:I,forwardedTickets:P,loading:M,actionLoading:y,departments:D,users:W,createTicket:L,updateTicket:n,deleteTicket:p,loadTicketFiles:s,uploadTicketFile:C,deleteTicketFile:w,downloadTicketFile:d,getTicketFiles:T,addComment:R,loadComments:z,deleteComment:b,refreshTickets:U}=Cs(),[Z,Pe]=t.useState(""),[Ce,Le]=t.useState("all"),[Te,Ne]=t.useState("all"),[ae,Be]=t.useState(0),[he,Fe]=t.useState(gr),[re,ye]=t.useState([]),[le,l]=t.useState(null),[a,f]=t.useState(null),[m,c]=t.useState([]),[k,_]=t.useState(0),[J,ee]=t.useState(null),[O,de]=t.useState(!1),[De,B]=t.useState(W),[ne,se]=t.useState(!1),[ke,fe]=t.useState(!1),[Er,Me]=t.useState(!1),[nr,N]=t.useState({open:!1,message:""}),[ir,be]=t.useState({open:!1,message:""}),We=(r==null?void 0:r.role)==="department_head"||(r==null?void 0:r.role)==="Department Head",we=r==null?void 0:r.id,Ae=ys(E,I,P,Z,Ce,Te,ae,we);t.useEffect(()=>{if(h&&(E.length>0||I.length>0||P.length>0)){const u=[...E,...I,...P].find(F=>F.id===h);u?(l(u),se(!0)):S("/app/tickets")}},[h,E,I,P,S]),t.useEffect(()=>{O&&(async()=>{try{const u=Array.isArray(W)?W:[];let F=[];try{F=(await ge.getAll({role:"admin"})).data||[]}catch{F=u.filter(He=>(He.role||"").toLowerCase()==="admin")}const H=[...u];F.forEach(pe=>{H.some(He=>He.id===pe.id)||H.push(pe)});const K=H.filter(pe=>pe.id!==we);B(K)}catch{const u=Array.isArray(W)?W:[];B(u.filter(F=>F.id!==we))}})()},[O,W,we]);const or=t.useCallback(()=>{Fe(gr),ye([])},[]),Rr=t.useCallback(i=>{const{name:u,value:F}=i.target;Fe(H=>({...H,[u]:F}))},[]),Ir=t.useCallback(async i=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(i.type)){N({open:!0,message:"Only PDF and image files are allowed."});return}const F=10*1024*1024;if(i.size>F){N({open:!0,message:"File size must be less than 10MB."});return}if(re.length>=5){N({open:!0,message:"Maximum 5 files allowed."});return}const H=xr(i,r);ye(K=>[...K,H])}catch{N({open:!0,message:"Failed to prepare file for upload."})}},[r,re.length]),Pr=t.useCallback(async i=>{try{ye(u=>u.filter(F=>F.id!==i))}catch{N({open:!0,message:"Failed to remove file."})}},[]),Lr=t.useCallback(async i=>{try{const u=re.find(F=>F.id===i);mr(u)}catch{N({open:!0,message:"Failed to download file."})}},[re]),Nr=t.useCallback(async()=>{const i=hr(he,!1);if(i.length>0){N({open:!0,message:i[0]});return}try{const u=fr(he,We,r),F=await L(u,re);F.success?(or(),de(!1),be({open:!0,message:"Ticket created successfully!"})):N({open:!0,message:F.error})}catch(u){N({open:!0,message:u.message||"Failed to create ticket. Please try again."})}},[he,re,We,r,L,or]),Br=t.useCallback(async i=>{try{const u=await p(i);u.success?(Me(!1),ee(null),be({open:!0,message:"Ticket deleted successfully!"})):N({open:!0,message:u.error||"Failed to delete ticket"})}catch(u){console.error("Delete ticket error:",u),N({open:!0,message:u.message||"Failed to delete ticket. Please try again."})}},[p]),lr=t.useCallback(async i=>{l(i),await s(i.id),se(!0)},[s]),Ue=t.useCallback(async i=>{const u=bs(i);f(u),_(0);try{const F=await s(i.id);c(Array.isArray(F)?F:[])}catch(F){console.error("Error loading ticket files:",F),c([])}fe(!0)},[s]),Mr=t.useCallback(i=>{const{name:u,value:F}=i.target;f(H=>({...H,[u]:F}))},[]),Ur=t.useCallback(async()=>{const i=hr(a,!0);if(i.length>0){N({open:!0,message:i[0]});return}try{const u=fr(a,We,r),F=await n(u);if(F.success){const H=m.filter(K=>K.id.startsWith("temp-"));if(H.length>0&&(a!=null&&a.id))try{for(const K of H)await C(K.file,a.id)}catch(K){console.error("Error uploading temp files:",K)}fe(!1),f(null),c([]),be({open:!0,message:"Ticket updated successfully!"})}else N({open:!0,message:F.error})}catch(u){N({open:!0,message:u.message||"Failed to update ticket. Please try again."})}},[a,m,We,r,n,C]),dr=t.useCallback(async()=>{try{await U()}catch(i){console.error("Error refreshing tickets:",i)}},[U]),Hr=t.useCallback(async i=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(i.type)){N({open:!0,message:"Only PDF and image files are allowed."});return}const F=10*1024*1024;if(i.size>F){N({open:!0,message:"File size must be less than 10MB."});return}if(m.length>=5){N({open:!0,message:"Maximum 5 files allowed."});return}if(a!=null&&a.id){await C(i,a.id);const H=await s(a.id);c(Array.isArray(H)?H:[])}else{const H=xr(i,r);c(K=>[...K,H])}_(H=>H+1)}catch(u){console.error("Error uploading file:",u),N({open:!0,message:"Failed to upload file."})}},[a,m.length,r,C,s]),Or=t.useCallback(async i=>{try{if(a!=null&&a.id){await w(a.id,i);const u=await s(a.id);c(Array.isArray(u)?u:[])}else c(u=>u.filter(F=>F.id!==i));_(u=>u-1)}catch(u){console.error("Error deleting file:",u),N({open:!0,message:"Failed to delete file."})}},[a,w,s]),qr=t.useCallback(async i=>{try{if(a!=null&&a.id)await d(a.id,i);else{const u=m.find(F=>F.id===i);mr(u)}}catch(u){console.error("Error downloading file:",u),N({open:!0,message:"Failed to download file."})}},[a,m,d]),$r=t.useCallback(async i=>{try{await w(le.id,i),be({open:!0,message:"File deleted successfully!"})}catch{N({open:!0,message:"Failed to delete file."})}},[le,w]),Vr=t.useCallback(async i=>{try{await d(le.id,i)}catch{N({open:!0,message:"Failed to download file."})}},[le,d]),cr=t.useCallback(i=>{ee(i),Me(!0)},[]),Gr=t.useCallback(()=>{N({open:!1,message:""})},[]),Jr=t.useCallback(()=>{be({open:!1,message:""})},[]),Kr=t.useCallback(()=>{Me(!1)},[]),Qr=t.useCallback(()=>{de(!1)},[]),Yr=t.useCallback(()=>{se(!1),l(null),h&&S("/app/tickets")},[h,S]),Xr=t.useCallback(()=>{fe(!1),_(0)},[]);return t.useEffect(()=>{const i=()=>{U()};return window.addEventListener("ticket_update",i),window.addEventListener("new_comment",i),window.addEventListener("notification",i),window.addEventListener("user_update",i),window.addEventListener("task_update",i),()=>{window.removeEventListener("ticket_update",i),window.removeEventListener("new_comment",i),window.removeEventListener("notification",i),window.removeEventListener("user_update",i),window.removeEventListener("task_update",i)}},[U]),M?e.jsx(fs,{message:"Loading tickets...",size:"large"}):e.jsxs(A,{sx:{p:{xs:2,md:4},backgroundColor:o.palette.background.default,minHeight:"100vh"},children:[e.jsx(ws,{title:"Tickets Management",subtitle:"Track and manage support tickets and requests for your department",emoji:"ðŸŽ«",color:"primary",onRefresh:dr,actionButton:{text:"New Ticket",icon:e.jsx(cs,{}),onClick:()=>de(!0),disabled:y}}),e.jsx(Ws,{open:nr.open,message:nr.message,onClose:Gr}),e.jsx(As,{open:ir.open,message:ir.message,onClose:Jr}),e.jsx(A,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(us,{in:!0,timeout:800,children:e.jsxs(A,{children:[e.jsx(Ts,{activeTab:ae,setActiveTab:Be,searchQuery:Z,setSearchQuery:Pe,filter:Ce,setFilter:Le,priorityFilter:Te,setPriorityFilter:Ne,isMobile:g}),e.jsxs(A,{sx:{mt:2,mb:2},children:[e.jsxs(j,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:[ae===0?"Sent Tickets":ae===1?"Received Tickets":"Forwarded by Me"," (",Ae.length,")"]}),Ae.length===0?e.jsx(A,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(j,{variant:"body1",children:E.length===0?"No tickets found. Create your first ticket to get started.":"No tickets match your current filters. Try adjusting your search criteria."})}):e.jsxs(e.Fragment,{children:[e.jsx(A,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(Fs,{tickets:Ae,departments:D,users:W,activeTab:ae,onViewTicket:lr,onEditTicket:Ue,onDeleteTicket:cr,getStatusColor:Je,getStatusIcon:pr,getPriorityColor:Ge,getPriorityIcon:Ve})}),e.jsx(A,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(v,{container:!0,spacing:2,children:Ae.map(i=>e.jsx(v,{item:!0,xs:12,children:e.jsx(Ds,{ticket:i,departments:D,users:W,activeTab:ae,onViewTicket:lr,onEditTicket:Ue,onDeleteTicket:cr,getPriorityColor:Ge,getPriorityIcon:Ve,getStatusColor:Je,getTicketFiles:T})},i.id))})})]})]})]})})}),e.jsx(zs,{open:Er,ticket:J,onClose:Kr,onConfirm:()=>Br(J==null?void 0:J.id),loading:y}),e.jsx(_s,{open:O,onClose:Qr,newTicket:he,onTicketChange:Rr,newTicketFiles:re,onFileUpload:Ir,onFileDelete:Pr,onFileDownload:Lr,departments:D,users:De,onSubmit:Nr,loading:y,isMobile:g,currentUserId:we}),e.jsx(Es,{open:ne,onClose:Yr,ticket:le,departments:D,users:W,getStatusColor:Je,getStatusIcon:pr,getPriorityColor:Ge,getPriorityIcon:Ve,getTicketFiles:T,onRefresh:dr,onFileDelete:$r,onFileDownload:Vr,onEdit:Ue,isMobile:g,addComment:R,loadComments:z,deleteComment:b}),e.jsx(Rs,{open:ke,onClose:Xr,ticket:a,onTicketChange:Mr,editingTicketFiles:m,onFileUpload:Hr,onFileDelete:Or,onFileDownload:qr,departments:D,users:W,onSubmit:Ur,loading:y,fileOperationsCount:k})]})};export{Us as default};
