import{r,u as ve,j as e,a8 as pt,a9 as gt,G as Yt,H as Ue,a7 as v,av as te,aA as Xt,aB as Zt,aw as J,ax as K,ay as Q,m as c,a4 as Ze,aC as er,am as tr,aD as rr,aE as sr,aF as dt,aG as H,aH as ar,k as jt,V as Ge,al as Je,ae as Ke,at as Qe,b as p,h as q,d as se,aJ as pe,aK as et,aL as tt,B as A,aq as Ye,I as ae,ar as yt,as as ze,P as _e,az as rt,z as $,aM as nr,v as ie,w as oe,x as le,a6 as ir,Z as Se,y as de,aN as bt,aO as or,aP as Xe,s as wt,K as St,n as vt,p as Ct,aQ as kt,q as Tt,J as Dt,ap as Me,aI as lr,F as dr}from"./mui-DmyK1VYO.js";import{e as O,g as cr,h as fe,f as ur,i as He,u as xr,L as mr}from"./index-CA0ysn5D.js";import{f as We,g as Ft,a as Wt,b as Ae,c as At,d as hr,F as fr,C as pr,e as gr,h as ct,i as ut,v as xt,p as mt,j as jr,k as Oe,l as qe,m as ht,n as $e}from"./FileUploadSection-s95ZT1pL.js";import{P as yr}from"./PageHeader-DsP3YEjW.js";import{c as br,u as wr}from"./router-ViNET1Ki.js";import"./vendor-Ckhrjn13.js";const Sr=()=>{const[l,g]=r.useState([]),[t,h]=r.useState([]),[S,z]=r.useState([]),[_,R]=r.useState(!0),[P,y]=r.useState(!1),[u,k]=r.useState([]),[E,i]=r.useState([]),[f,s]=r.useState({}),[T,W]=r.useState(""),x=r.useCallback(async()=>{try{const n=await O.getAll(),a=n.data?.tickets||n.tickets||n.data||n||[];if(!Array.isArray(a)){console.warn("Tickets data is not an array:",a),g([]);return}const d=a.sort((j,w)=>{const M=new Date(j.created_at||j.createdAt||0);return new Date(w.created_at||w.createdAt||0)-M});g(d)}catch(n){console.error("Error loading tickets:",n),g([])}},[]),b=r.useCallback(async()=>{try{const n=await O.getAssignedTickets(),a=n.data||n||[];if(!Array.isArray(a)){console.warn("Assigned tickets data is not an array:",a),h([]);return}const d=a.sort((j,w)=>{const M=new Date(j.created_at||j.createdAt||0);return new Date(w.created_at||w.createdAt||0)-M});h(d)}catch(n){console.error("Error loading assigned tickets:",n),h([])}},[]),D=r.useCallback(async()=>{try{const[n,a]=await Promise.all([O.getAll(),O.getAssignedTickets()]),d=n.data?.tickets||n.tickets||n.data||n||[],j=a.data||a||[],w=[...Array.isArray(d)?d:[],...Array.isArray(j)?j:[]],L=JSON.parse(localStorage.getItem("user")||"{}")?.id,V=w.filter(B=>{const ee=B.forwarded_from_id||B.forwardedFromId||B.forwardedFrom?.id,ye=B.is_forwarded===!0||B.isForwarded===!0||typeof B.forward_chain_id<"u"||typeof B.forwardChainId<"u",me=ee&&L&&String(ee)===String(L);return ye&&me}),Y=new Set,je=V.filter(B=>!B||!B.id||Y.has(B.id)?!1:(Y.add(B.id),!0)).sort((B,ee)=>{const ye=new Date(B.created_at||B.createdAt||0);return new Date(ee.created_at||ee.createdAt||0)-ye});z(je)}catch(n){console.error("Error loading forwarded-by-me tickets:",n),z([])}},[]),F=r.useCallback(async()=>{try{const n=await cr.getAll(),a=n.data||n||[];k(a)}catch(n){console.error("Error loading departments:",n),k([])}},[]),N=r.useCallback(async()=>{try{const n=await fe.getAll(),a=n.data||n||[];i(a)}catch(n){console.error("Error loading users:",n),i([])}},[]),X=r.useCallback(async()=>{try{R(!0),W(""),await Promise.all([x(),b(),D(),F(),N()])}catch(n){console.error("Error loading initial data:",n),W("Failed to load data. Please try again.")}finally{R(!1)}},[x,b,D,F,N]),ce=r.useCallback(async(n,a=[])=>{y(!0);try{const d=await O.create(n),j=d.data||d;if(a&&a.length>0)try{for(const w of a)w.file?await O.uploadAttachment(j.id,w.file):await O.uploadAttachment(j.id,w)}catch(w){console.error("Error uploading files:",w)}return g(w=>[j,...w]),{success:!0,ticket:j}}catch(d){return console.error("Error creating ticket:",d),{success:!1,error:d.response?.data?.message||"Failed to create ticket."}}finally{y(!1)}},[]),Ee=r.useCallback(async n=>{y(!0);try{const a=await O.update(n.id,n),d=a.data||a;return g(j=>j.map(w=>w.id===d.id?d:w)),{success:!0,ticket:d}}catch(a){return console.error("Error updating ticket:",a),{success:!1,error:a.response?.data?.message||"Failed to update ticket."}}finally{y(!1)}},[]),Ce=r.useCallback(async n=>{if(!n)return{success:!1,error:"Invalid ticket ID for deletion."};y(!0);try{return await O.delete(n),g(a=>a.filter(d=>d.id!==n)),{success:!0}}catch(a){return console.error("Error deleting ticket:",a),{success:!1,error:a.response?.data?.message||"Failed to delete ticket."}}finally{y(!1)}},[]),Re=r.useCallback(async(n,a)=>{y(!0);try{const d=await O.forwardTicket(n,a);try{const w=JSON.parse(localStorage.getItem("user")||"{}")?.id,M=await O.getById(n),L=M.data||M||null;if(L&&w){const V=L.forwarded_from_id||L.forwardedFromId||L.forwardedFrom?.id;(L.is_forwarded===!0||L.isForwarded===!0||typeof L.forward_chain_id<"u"||typeof L.forwardChainId<"u")&&V&&String(V)===String(w)&&z(xe=>xe.some(B=>B.id===L.id)?xe:[L,...xe])}}catch{}return await x(),await D(),{success:!0,data:d.data||d}}catch(d){return console.error("Error forwarding ticket:",d),{success:!1,error:d.response?.data?.message||"Failed to forward ticket."}}finally{y(!1)}},[x,D]),ke=r.useCallback(async n=>{try{const a=await O.getAttachments(n),d=a.data||a||[];return s(j=>({...j,[n]:d})),d}catch(a){return console.error("Error loading ticket files:",a),s(d=>({...d,[n]:[]})),[]}},[]),Ie=r.useCallback(async(n,a)=>{try{const d=await O.uploadAttachment(a,n),j=d.data||d;return s(w=>({...w,[a]:[...w[a]||[],j]})),j}catch(d){if(console.error("File upload error:",d),d.response?.status===500){console.warn("Server returned 500 but file may have been uploaded successfully");try{const j=await O.getAttachments(a);if(j.data&&j.data.length>0)return s(w=>({...w,[a]:j.data})),j.data[j.data.length-1]}catch(j){console.error("Error refreshing file list:",j)}}throw new Error("Failed to upload file.")}},[]),re=r.useCallback(async(n,a)=>{try{await O.deleteAttachment(n,a),s(d=>({...d,[n]:d[n]?.filter(j=>j.id!==a)||[]}))}catch{throw new Error("Failed to delete file.")}},[]),Pe=r.useCallback(async(n,a)=>{try{const d=await ur.download(a),j=new Blob([d.data]),w=window.URL.createObjectURL(j),M=document.createElement("a");M.href=w;const L=d.headers["content-disposition"];let V="download";if(L){const Y=L.match(/filename="(.+)"/);Y&&(V=Y[1])}M.download=V,document.body.appendChild(M),M.click(),document.body.removeChild(M),window.URL.revokeObjectURL(w)}catch{throw new Error("Failed to download file.")}},[]),ue=r.useCallback(n=>f[n]||[],[f]),Te=r.useCallback(async(n,a)=>{try{const d=await He.addTicketComment(n,a);return{success:!0,comment:d.data||d}}catch(d){return console.error("Error adding comment:",d),{success:!1,error:d.response?.data?.message||"Failed to add comment."}}},[]),Z=r.useCallback(async n=>{try{const a=await He.fetchTicketComments(n);return a.data||a||[]}catch(a){return console.error("useTickets: Error loading comments:",a),[]}},[]),ge=r.useCallback(async n=>{try{return await He.deleteComment(n),{success:!0}}catch(a){return console.error("Error deleting comment:",a),{success:!1,error:a.response?.data?.message||"Failed to delete comment."}}},[]),ne=r.useCallback(async()=>{try{await Promise.all([x(),b(),D()])}catch(n){console.error("Error refreshing tickets:",n)}},[x,b,D]);return r.useEffect(()=>{X()},[X]),{tickets:l,assignedTickets:t,forwardedTickets:S,loading:_,actionLoading:P,departments:u,users:E,error:T,loadTickets:x,loadAssignedTickets:b,loadForwardedTickets:D,createTicket:ce,updateTicket:Ee,deleteTicket:Ce,forwardTicket:Re,loadTicketFiles:ke,uploadTicketFile:Ie,deleteTicketFile:re,downloadTicketFile:Pe,getTicketFiles:ue,addComment:Te,loadComments:Z,deleteComment:ge,refreshTickets:ne,setError:W}},vr=({activeTab:l,setActiveTab:g,searchQuery:t,setSearchQuery:h,filter:S,setFilter:z,priorityFilter:_,setPriorityFilter:R,isMobile:P})=>(ve(),e.jsx(pt,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsxs(gt,{sx:{p:{xs:2,sm:2.5,md:3}},children:[e.jsxs(Yt,{value:l,onChange:(y,u)=>g(u),variant:"fullWidth",sx:{mb:2,"& .MuiTab-root":{fontSize:{xs:"0.95rem",sm:"1.05rem"},fontWeight:600,textTransform:"none",minHeight:{xs:44,sm:52}},"& .Mui-selected":{color:"primary.main"}},children:[e.jsx(Ue,{label:P?"Sent":"Sent Tickets"}),e.jsx(Ue,{label:P?"Received":"Received Tickets"}),e.jsx(Ue,{label:P?"Forwarded":"Forwarded by Me"})]}),e.jsxs(v,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(v,{item:!0,xs:12,sm:6,md:4,children:e.jsx(te,{fullWidth:!0,placeholder:"Search tickets...",value:t,onChange:y=>h(y.target.value),InputProps:{startAdornment:e.jsx(Xt,{position:"start",children:e.jsx(Zt,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"Status"}),e.jsxs(Q,{value:S,label:"Status",onChange:y=>z(y.target.value),sx:{borderRadius:2},children:[e.jsx(c,{value:"all",children:"All Status"}),e.jsx(c,{value:"pending",children:"Pending"}),e.jsx(c,{value:"in_progress",children:"In Progress"}),e.jsx(c,{value:"completed",children:"Completed"}),e.jsx(c,{value:"declined",children:"Declined"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"Priority"}),e.jsxs(Q,{value:_,label:"Priority",onChange:y=>R(y.target.value),sx:{borderRadius:2},children:[e.jsx(c,{value:"all",children:"All Priority"}),e.jsx(c,{value:"high",children:"High"}),e.jsx(c,{value:"medium",children:"Medium"}),e.jsx(c,{value:"low",children:"Low"})]})]})})]})]})}));function Ve({title:l,children:g,...t}){const h=r.useRef(null),[S,z]=r.useState(!1);return r.useEffect(()=>{const _=h.current;_&&z(_.scrollWidth>_.clientWidth)},[g,l]),S?e.jsx(q,{title:l,arrow:!0,...t,children:e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:g})}):e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:g})}const Cr=({tickets:l,users:g,activeTab:t,onViewTicket:h,onEditTicket:S,onDeleteTicket:z,getStatusColor:_,getStatusIcon:R,getPriorityColor:P,getPriorityIcon:y})=>{const u=ve(),k=Ze(u.breakpoints.down("sm")),[E,i]=r.useState({});r.useEffect(()=>{if(t!==2||!Array.isArray(l))return;const s=new Set((Array.isArray(g)?g:[]).map(x=>String(x.id))),T=new Set(Object.keys(E)),W=new Set;l.forEach(x=>{const b=x.forwardedTo||x.forwarded_to||x.forwarded_to_id||x.current_handler_id;if(b&&typeof b!="object"){const D=String(b);!s.has(D)&&!T.has(D)&&W.add(D)}}),W.size!==0&&(async()=>{const x=await Promise.all(Array.from(W).map(async b=>{try{const D=await fe.getById(b),F=D.data||D||null;return[b,F]}catch{return[b,null]}}));i(b=>{const D={...b};return x.forEach(([F,N])=>{D[F]=N}),D})})()},[t,l,g,E]);const f=s=>{if(!s)return"Unknown User";if(typeof s=="object")return Ae(s);const T=String(s),W=g.find(x=>String(x.id)===T)||E[T];return W?Ae(W):T};return k?null:e.jsx(er,{component:tr,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(rr,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(sr,{children:e.jsxs(dt,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(H,{padding:"checkbox",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(H,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(H,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(H,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(H,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(H,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:t===0?"Send To":t===1?"Sent By":t===2?"Forwarded To":"Created By"}),e.jsx(H,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(H,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(ar,{children:l.map((s,T)=>e.jsxs(dt,{hover:!0,sx:{bgcolor:T%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(H,{padding:"checkbox",sx:{px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(H,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(jt,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:(()=>{switch(R(s.status)){case"Schedule":return e.jsx(Qe,{sx:{fontSize:{md:14,lg:18}}});case"CheckCircle":return e.jsx(Ke,{sx:{fontSize:{md:14,lg:18}}});case"Error":return e.jsx(Je,{sx:{fontSize:{md:14,lg:18}}});default:return e.jsx(Ge,{sx:{fontSize:{md:14,lg:18}}})}})()})}),e.jsxs(H,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(Ve,{title:s.title,children:e.jsx(p,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.title})}),e.jsx(Ve,{title:s.description,children:e.jsx(p,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.description})})]}),e.jsx(H,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(q,{title:`Priority: ${s.priority}`,arrow:!0,children:e.jsx("span",{children:e.jsx(se,{label:s.priority,size:"small",color:P(s.priority),icon:(()=>{switch(y(s.priority)){case"PriorityHigh":return e.jsx(tt,{sx:{fontSize:{md:12,lg:16}}});case"Remove":return e.jsx(pe,{sx:{fontSize:{md:12,lg:16}}});case"LowPriority":return e.jsx(et,{sx:{fontSize:{md:12,lg:16}}});default:return e.jsx(pe,{sx:{fontSize:{md:12,lg:16}}})}})(),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})})})}),e.jsx(H,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(q,{title:`Status: ${s.status.replace("_"," ")}`,arrow:!0,children:e.jsx("span",{children:e.jsx(se,{label:s.status.replace("_"," "),size:"small",color:_(s.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})})})}),e.jsx(H,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(Ve,{title:(()=>{if(t===0)return f(s.ticketAssignee||s.assignedTo||s.assigned_to);if(t===1)return f(s.ticketCreator||s.createdBy||s.created_by);if(t===2){const W=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return f(W)}return f(s.ticketCreator||s.createdBy||s.created_by)})(),children:e.jsx(p,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:"0.78rem",overflow:"hidden",textOverflow:"ellipsis"},children:(()=>{if(t===0)return f(s.ticketAssignee||s.assignedTo||s.assigned_to);if(t===1)return f(s.ticketCreator||s.createdBy||s.created_by);if(t===2){const W=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return f(W)}return f(s.ticketCreator||s.createdBy||s.created_by)})()})})}),e.jsx(H,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(A,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[s.due_date&&e.jsx(q,{title:We(s.due_date),arrow:!0,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Ye,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(p,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:We(s.due_date)})]})}),(()=>{const W=Ft(s),x=Wt(s);return!W||!x?null:e.jsx(q,{title:`Maturity: ${x}`,arrow:!0,children:e.jsx("span",{children:e.jsx(se,{label:x,size:"small",color:W,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(H,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsx(A,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(q,{title:"View Details",children:e.jsx("span",{children:e.jsx(ae,{color:"primary",size:"small",onClick:()=>h(s),children:e.jsx(yt,{fontSize:"small"})})})}),e.jsx(q,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"secondary",size:"small",onClick:()=>S(s),children:e.jsx(ze,{fontSize:"small"})})})}),e.jsx(q,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"error",size:"small",onClick:()=>z(s),children:e.jsx(_e,{fontSize:"small"})})})})]})})})]},s.id))})]})})},kr=({ticket:l,departments:g,users:t,activeTab:h,onViewTicket:S,onEditTicket:z,onDeleteTicket:_,getPriorityColor:R,getPriorityIcon:P,getStatusColor:y,getTicketFiles:u})=>{const k=ve(),E=Ze(k.breakpoints.down("sm")),i=f=>{if(!f)return"Unknown";if(typeof f=="object"&&f.firstname)return Ae(f);const s=t.find(T=>T.id===f);return Ae(s)};return E?e.jsx(pt,{sx:{borderRadius:3,boxShadow:2,overflow:"hidden"},children:e.jsxs(gt,{sx:{p:3},children:[e.jsx(A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:e.jsxs(A,{sx:{flex:1,minWidth:0},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:700,mb:1,wordBreak:"break-word"},children:l.title}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2,lineHeight:1.5},children:l.description})]})}),e.jsxs(A,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(se,{label:l.priority,size:"small",color:R(l.priority),icon:(()=>{switch(P(l.priority)){case"PriorityHigh":return e.jsx(tt,{sx:{fontSize:14}});case"Remove":return e.jsx(pe,{sx:{fontSize:14}});case"LowPriority":return e.jsx(et,{sx:{fontSize:14}});default:return e.jsx(pe,{sx:{fontSize:14}})}})(),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),e.jsx(se,{label:l.status.replace("_"," "),size:"small",color:y(l.status),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),(()=>{const f=Ft(l),s=Wt(l);return!f||!s?null:e.jsx(se,{label:s,size:"small",color:f,sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}})})()]}),e.jsxs(A,{sx:{display:"flex",flexDirection:"column",gap:1,mb:2},children:[e.jsxs(p,{variant:"body2",color:"text.secondary",children:[e.jsxs("strong",{children:[h===0?"Send To":h===1?"Sent By":h===2?"Forwarded To":"Created By",":"]})," ",i(h===0?l.ticketAssignee||l.assignedTo||l.assigned_to:h===1?l.ticketCreator||l.createdBy||l.created_by:h===2?l.forwarded_to_id:l.ticketCreator||l.createdBy||l.created_by)]}),l.due_date&&e.jsxs(p,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Due Date:"})," ",We(l.due_date)]})]}),u(l.id).length>0&&e.jsxs(A,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(rt,{fontSize:"small",sx:{mr:1,color:"text.secondary"}}),e.jsxs(p,{variant:"caption",color:"text.secondary",children:[u(l.id).length," file(s) attached"]})]}),e.jsx(A,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(q,{title:"View Details",children:e.jsx("span",{children:e.jsx(ae,{color:"primary",size:"small",onClick:()=>S(l),children:e.jsx(yt,{fontSize:"small"})})})}),e.jsx(q,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"secondary",size:"small",onClick:()=>z(l),children:e.jsx(ze,{fontSize:"small"})})})}),e.jsx(q,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"error",size:"small",onClick:()=>_(l),children:e.jsx(_e,{fontSize:"small"})})})})]})})]})}):null},Tr=({ticket:l,onForward:g,disabled:t=!1})=>{const[h,S]=r.useState(!1),[z,_]=r.useState([]),[R,P]=r.useState(""),[y,u]=r.useState(""),[k,E]=r.useState(!1),[i,f]=r.useState("");r.useEffect(()=>{h&&s()},[h]);const s=async()=>{try{E(!0),f("");let x=[];try{const F=await fe.getAll({role:"department_head"}),N=await fe.getAll({role:"admin"}),X=F.data||F||[],ce=N.data||N||[];x=[...X,...ce],console.log("Department heads and admins fetched with role param:",x)}catch(F){console.log("Role-based fetch failed, trying all users:",F);const N=await fe.getAll();x=N.data||N||[],console.log("All users fetched:",x)}let b=x;x.length>0&&!x.some(F=>F.role==="department_head"||F.role==="admin")&&(b=x.filter(F=>{const N=F.role?.toLowerCase();return N==="admin"||N==="department_head"||N==="departmenthead"||N==="dept_head"||N==="head"||F.role&&F.role.includes("head")})),console.log("Eligible users found:",b);const D=b.map(F=>{const N=F.role==="admin"?"Admin":"Dept Head";return{...F,displayName:`${F.firstname||F.firstName||"Unknown"} ${F.lastname||F.lastName||"User"} (${N})`}});D.length===0?f("No department heads or admins found in the system. Please ensure there are users with appropriate roles."):(_(D),f(""))}catch(x){console.error("Error loading recipients:",x),f("Failed to load recipients. Please try again.")}finally{E(!1)}},T=async()=>{if(!R||!y.trim()){f("Please select a recipient and provide a reason");return}E(!0),f("");try{await O.forwardTicket(l.id,{toUserId:R,reason:y.trim()}),g&&g(),S(!1),P(""),u("")}catch(x){console.error("Error forwarding ticket:",x),f(x.response?.data?.error||"Failed to forward ticket")}finally{E(!1)}},W=()=>{S(!1),P(""),u(""),f("")};return e.jsxs(e.Fragment,{children:[e.jsx($,{variant:"outlined",startIcon:e.jsx(nr,{}),onClick:()=>S(!0),disabled:t,sx:{mr:1},children:"Forward"}),e.jsxs(ie,{open:h,onClose:W,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(oe,{children:["Forward Ticket #",l?.id]}),e.jsxs(le,{children:[i&&e.jsx(ir,{severity:"error",sx:{mb:2},children:i}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Forwarding ticket to a department head or admin"}),e.jsxs(J,{fullWidth:!0,sx:{mb:2},children:[e.jsx(K,{children:"Forward To"}),e.jsx(Q,{value:R,onChange:x=>P(x.target.value),label:"Forward To",disabled:k||z.length===0,children:k?e.jsx(c,{disabled:!0,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Se,{size:16}),"Loading recipients..."]})}):z.length===0?e.jsx(c,{disabled:!0,children:"No recipients available"}):z.map(x=>e.jsx(c,{value:x.id,children:x.displayName},x.id))})]}),e.jsx(te,{fullWidth:!0,label:"Reason for Forwarding",value:y,onChange:x=>u(x.target.value),multiline:!0,rows:3,required:!0,disabled:k,sx:{mb:2}})]}),e.jsxs(de,{children:[e.jsx($,{onClick:W,disabled:k,children:"Cancel"}),e.jsx($,{onClick:T,variant:"contained",disabled:!R||!y.trim()||k,children:k?e.jsx(Se,{size:20}):"Forward Ticket"})]})]})]})},Dr=({open:l,message:g,onClose:t})=>e.jsxs(ie,{open:l,onClose:t,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(oe,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(bt,{color:"error",sx:{fontSize:32}}),"Error"]}),e.jsx(le,{children:e.jsx(p,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:g})}),e.jsx(de,{children:e.jsx($,{onClick:t,variant:"contained",color:"error",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),Fr=({open:l,message:g,onClose:t})=>e.jsxs(ie,{open:l,onClose:t,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(oe,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main",fontWeight:700},children:[e.jsx(or,{color:"success",sx:{fontSize:32}}),"Success"]}),e.jsx(le,{children:e.jsx(p,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:g})}),e.jsx(de,{children:e.jsx($,{onClick:t,variant:"contained",color:"success",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),Wr=({open:l,ticket:g,onClose:t,onConfirm:h,loading:S})=>e.jsxs(ie,{open:l,onClose:t,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(oe,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(bt,{color:"error",sx:{fontSize:32}}),"Confirm Deletion"]}),e.jsxs(le,{children:[e.jsx(p,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:2},children:"Are you sure you want to delete this ticket? This action cannot be undone."}),e.jsx(p,{variant:"body1",sx:{fontWeight:"bold",color:"text.primary",bgcolor:"action.hover",p:2,borderRadius:1,fontSize:"1.1rem"},children:g?.title})]}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:t,sx:{minWidth:100},children:"Cancel"}),e.jsx($,{onClick:h,color:"error",variant:"contained",disabled:S,sx:{minWidth:100},children:S?e.jsx(Se,{size:20}):"Delete"})]})]}),Ar=({open:l,onClose:g,newTicket:t,onTicketChange:h,newTicketFiles:S,onFileUpload:z,onFileDelete:_,departments:R,users:P,onSubmit:y,loading:u,isMobile:k,currentUserId:E})=>e.jsxs(ie,{open:l,onClose:g,maxWidth:"sm",fullWidth:!0,fullScreen:k,children:[e.jsx(oe,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:"Create New Ticket"}),e.jsx(le,{sx:{pt:{xs:1,sm:2}},children:e.jsx(A,{component:"form",onSubmit:i=>{i.preventDefault(),y()},sx:{mt:1},children:e.jsxs(v,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Ticket Title",name:"title",value:t.title,onChange:h,required:!0,sx:{mb:2}})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Description",name:"description",value:t.description,onChange:h,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(J,{fullWidth:!0,required:!0,children:[e.jsx(K,{children:"Desired Action"}),e.jsxs(Q,{name:"desired_action",value:t.desired_action||"",label:"Desired Action",onChange:h,children:[e.jsx(c,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(c,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(c,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(c,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(c,{value:"Dispatch",children:"Dispatch"}),e.jsx(c,{value:"File",children:"File"}),e.jsx(c,{value:"Mis routed",children:"Mis routed"}),e.jsx(c,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(c,{value:"photocopy file",children:"Photocopy file"}),e.jsx(c,{value:"Study",children:"Study"}),e.jsx(c,{value:"Staff action",children:"Staff action"}),e.jsx(c,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"Priority"}),e.jsxs(Q,{name:"priority",value:t.priority,label:"Priority",onChange:h,children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"}),e.jsx(c,{value:"High",children:"High"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"Status"}),e.jsxs(Q,{name:"status",value:t.status||"pending",label:"Status",onChange:h,children:[e.jsx(c,{value:"pending",children:"Pending"}),e.jsx(c,{value:"in_progress",children:"In Progress"}),e.jsx(c,{value:"completed",children:"Completed"}),e.jsx(c,{value:"declined",children:"Declined"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(J,{fullWidth:!0,required:!0,children:[e.jsx(K,{children:"Send To"}),e.jsxs(Q,{name:"sendTo",value:t.sendTo||"",label:"Send To",onChange:h,children:[e.jsx(Xe,{children:"Admins"}),P.filter(i=>i.role==="admin").filter(i=>i.id!==E).map(i=>e.jsxs(c,{value:i.id,children:[i.firstname," ",i.lastname," (Admin)"]},i.id)),e.jsx(Xe,{children:"Department Heads"}),R.filter(i=>i.head).filter(i=>i.head.id!==E).map(i=>e.jsxs(c,{value:i.head.id,children:[i.head.firstname," ",i.head.lastname," (Dept Head, ",i.name,")"]},i.head.id))]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(te,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:t.due_date||"",onChange:h,InputLabelProps:{shrink:!0}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(A,{sx:{mt:3},children:[e.jsx(p,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),S.length===0&&e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),S.length>0&&e.jsx(wt,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:S.map(i=>{const f=i.file_name||i.name||"Unknown File";return e.jsxs(St.Fragment,{children:[e.jsxs(vt,{secondaryAction:e.jsx(q,{title:"Delete file",arrow:!0,children:e.jsx(ae,{edge:"end",onClick:()=>_(i.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(_e,{fontSize:"small"})})}),children:[e.jsx(Ct,{children:e.jsx(kt,{})}),e.jsx(Tt,{primary:e.jsx(q,{title:"Click to download file",arrow:!0,children:e.jsx(p,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(i.file){const s=URL.createObjectURL(i.file),T=document.createElement("a");T.href=s,T.download=i.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(s)}},children:f})}),secondary:e.jsxs(p,{variant:"caption",color:"text.disabled",children:[i.uploadedAt?new Date(i.uploadedAt).toLocaleString():"â€”"," â€¢ ",At(i.file_size||i.size||0)]})})]}),e.jsx(Dt,{variant:"inset",component:"li"})]},i.id)})}),e.jsxs($,{variant:"outlined",component:"label",startIcon:e.jsx(rt,{}),disabled:u||S.length>=5,sx:{mt:1},children:[u?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:i=>{const f=i.target.files[0];f&&z(f)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:u||S.length>=5})]}),e.jsx(A,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:g,children:"Cancel"}),e.jsx($,{variant:"contained",onClick:y,disabled:u,sx:{minWidth:100},children:u?e.jsx(Se,{size:20}):"Create Ticket"})]})]}),zr=({open:l,onClose:g,ticket:t,departments:h,users:S=[],getStatusColor:z,getStatusIcon:_,getPriorityColor:R,getPriorityIcon:P,onRefresh:y,getTicketFiles:u,onFileDelete:k,onEdit:E,isMobile:i,addComment:f,loadComments:s,deleteComment:T})=>{ve();const W=b=>{if(!b)return"Unknown";if(typeof b=="object"&&b.firstname)return`${b.firstname} ${b.lastname}`.trim()||b.email||b.username||"Unknown";const D=S.find(F=>F.id===b);return D&&(`${D.firstname} ${D.lastname}`.trim()||D.email||D.username)||b},x=b=>{if(!b)return"N/A";const D=h.find(F=>F.id===b);return D?D.name:b};return t?e.jsxs(ie,{open:l,onClose:g,maxWidth:"md",fullWidth:!0,fullScreen:i,children:[e.jsxs(oe,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2},display:"flex",alignItems:"center",gap:2},children:[e.jsx(jt,{sx:{bgcolor:`${z(t.status)}.light`,color:`${z(t.status)}.main`,width:{xs:32,sm:40},height:{xs:32,sm:40}},children:(()=>{switch(_(t.status)){case"Schedule":return e.jsx(Qe,{sx:{fontSize:{xs:16,sm:20}}});case"CheckCircle":return e.jsx(Ke,{sx:{fontSize:{xs:16,sm:20}}});case"Error":return e.jsx(Je,{sx:{fontSize:{xs:16,sm:20}}});default:return e.jsx(Ge,{sx:{fontSize:{xs:16,sm:20}}})}})()}),e.jsxs(A,{sx:{flex:1},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:600},children:t.title}),e.jsxs(p,{variant:"body2",color:"text.secondary",children:["Ticket #",t.id]})]})]}),e.jsxs(le,{sx:{pt:{xs:1,sm:2}},children:[e.jsxs(v,{container:!0,spacing:3,children:[e.jsxs(v,{item:!0,xs:12,children:[e.jsx(p,{variant:"h6",sx:{mb:2,fontWeight:600},children:"Description"}),e.jsx(A,{sx:{mb:3},children:e.jsx(p,{variant:"body1",children:t.description})})]}),(t.desired_action||t.desiredAction)&&e.jsxs(v,{item:!0,xs:12,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Desired Action"}),e.jsx(p,{variant:"body1",children:t.desired_action||t.desiredAction})]}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",children:"Priority"}),e.jsx(se,{label:t.priority,color:R(t.priority),icon:(()=>{switch(P(t.priority)){case"PriorityHigh":return e.jsx(tt,{sx:{fontSize:16}});case"Remove":return e.jsx(pe,{sx:{fontSize:16}});case"LowPriority":return e.jsx(et,{sx:{fontSize:16}});default:return e.jsx(pe,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx(se,{label:t.status.replace("_"," "),color:z(t.status),icon:(()=>{switch(_(t.status)){case"Schedule":return e.jsx(Qe,{sx:{fontSize:16}});case"CheckCircle":return e.jsx(Ke,{sx:{fontSize:16}});case"Error":return e.jsx(Je,{sx:{fontSize:16}});default:return e.jsx(Ge,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created By"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Me,{sx:{fontSize:20},color:"action"}),W(t.ticketCreator||t.createdBy||t.created_by)]})]}),e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Department"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Me,{sx:{fontSize:20},color:"action"}),x(t.departmentId||t.department_id)]})]}),(t.ticketAssignee||t.assignedTo||t.assigned_to)&&e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Assigned To"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Me,{sx:{fontSize:20},color:"action"}),W(t.ticketAssignee||t.assignedTo||t.assigned_to)]})]}),t.due_date&&e.jsxs(v,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Due Date"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ye,{sx:{fontSize:20},color:"action"}),We(t.due_date)]})]}),e.jsxs(v,{item:!0,xs:12,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ye,{sx:{fontSize:20},color:"action"}),hr(t.created_at||t.createdAt)]})]})]}),u(t.id).length>0&&e.jsx(A,{sx:{mt:3},children:e.jsx(fr,{entityId:t.id,fetchFiles:async()=>({data:u(t.id)}),uploadFile:()=>{},deleteFile:k,maxFiles:5,maxFileSize:10*1024*1024,acceptedTypes:["*/*"],disabled:!1,readOnly:!0})}),e.jsx(pr,{entityId:t?.id,user:JSON.parse(localStorage.getItem("user")||"{}"),users:S,fetchComments:s,addComment:f,deleteComment:T})]}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:g,children:"Close"}),e.jsx(Tr,{ticket:t,disabled:!(t?.forwarded_to_id===JSON.parse(localStorage.getItem("user")||"{}")?.id||t?.current_handler_id===JSON.parse(localStorage.getItem("user")||"{}")?.id),onForward:()=>{g(),typeof y=="function"&&y()}}),e.jsx($,{variant:"contained",startIcon:e.jsx(ze,{}),onClick:()=>{g(),E(t)},sx:{minWidth:100},children:"Edit Ticket"})]})]}):null},_r=({open:l,onClose:g,ticket:t,onTicketChange:h,editingTicketFiles:S,onFileUpload:z,onFileDelete:_,departments:R,onSubmit:P,loading:y})=>e.jsxs(ie,{open:l,onClose:g,maxWidth:"md",fullWidth:!0,children:[e.jsx(oe,{children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ze,{color:"primary"}),e.jsx(p,{variant:"h6",children:"Edit Ticket"})]})}),e.jsx(le,{dividers:!0,children:t&&e.jsx(A,{sx:{pt:1},children:e.jsxs(v,{container:!0,spacing:3,children:[e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Title",name:"title",value:t.title||"",onChange:h,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Description",name:"description",value:t.description||"",onChange:h,multiline:!0,rows:4,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(J,{fullWidth:!0,required:!0,children:[e.jsx(K,{children:"Desired Action"}),e.jsxs(Q,{name:"desired_action",value:t.desired_action||"",label:"Desired Action",onChange:h,sx:{borderRadius:2},children:[e.jsx(c,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(c,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(c,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(c,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(c,{value:"Dispatch",children:"Dispatch"}),e.jsx(c,{value:"File",children:"File"}),e.jsx(c,{value:"Mis routed",children:"Mis routed"}),e.jsx(c,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(c,{value:"photocopy file",children:"Photocopy file"}),e.jsx(c,{value:"Study",children:"Study"}),e.jsx(c,{value:"Staff action",children:"Staff action"}),e.jsx(c,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Remarks (Required for updates)",name:"remarks",value:t.remarks||"",onChange:h,multiline:!0,rows:3,required:!0,helperText:"Please provide remarks explaining the changes made to this ticket",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(J,{fullWidth:!0,required:!0,children:[e.jsx(K,{children:"Priority"}),e.jsxs(Q,{name:"priority",value:t.priority||"Medium",label:"Priority",onChange:h,sx:{borderRadius:2},children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"}),e.jsx(c,{value:"High",children:"High"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(J,{fullWidth:!0,children:[e.jsx(K,{children:"Status"}),e.jsxs(Q,{name:"status",value:t.status||"pending",label:"Status",onChange:h,sx:{borderRadius:2},children:[e.jsx(c,{value:"pending",children:"Pending"}),e.jsx(c,{value:"in_progress",children:"In Progress"}),e.jsx(c,{value:"completed",children:"Completed"}),e.jsx(c,{value:"declined",children:"Declined"})]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsxs(J,{fullWidth:!0,required:!0,children:[e.jsx(K,{children:"Send To"}),e.jsxs(Q,{name:"sendTo",value:t.sendTo||"",label:"Send To",onChange:h,sx:{borderRadius:2},children:[e.jsx(Xe,{children:"Department Heads"}),R.filter(u=>u.head).map(u=>e.jsxs(c,{value:u.head.id,children:[u.head.firstname," ",u.head.lastname," (Dept Head, ",u.name,")"]},u.head.id))]})]})}),e.jsx(v,{item:!0,xs:12,sm:6,children:e.jsx(te,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:t.due_date||"",onChange:h,InputLabelProps:{shrink:!0},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(v,{item:!0,xs:12,children:e.jsxs(A,{sx:{mt:3},children:[e.jsx(p,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),S.length===0&&e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),S.length>0&&e.jsx(wt,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:S.map(u=>{const k=u.file_name||u.name||"Unknown File";return e.jsxs(St.Fragment,{children:[e.jsxs(vt,{secondaryAction:e.jsx(q,{title:"Delete file",arrow:!0,children:e.jsx(ae,{edge:"end",onClick:()=>_(u.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(_e,{fontSize:"small"})})}),children:[e.jsx(Ct,{children:e.jsx(kt,{})}),e.jsx(Tt,{primary:e.jsx(q,{title:"Click to download file",arrow:!0,children:e.jsx(p,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(u.file){const E=URL.createObjectURL(u.file),i=document.createElement("a");i.href=E,i.download=u.name,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(E)}else{const E=localStorage.getItem("token"),i=`/api/files/${u.id}/download`;fetch(i,{headers:{Authorization:`Bearer ${E}`}}).then(f=>{if(f.ok)return f.blob();throw new Error("Download failed")}).then(f=>{const s=URL.createObjectURL(f),T=document.createElement("a");T.href=s,T.download=u.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(s)}).catch(f=>{console.error("Download error:",f)})}},children:k})}),secondary:e.jsxs(p,{variant:"caption",color:"text.disabled",children:[u.uploadedAt?new Date(u.uploadedAt).toLocaleString():"â€”"," â€¢ ",At(u.file_size||u.size||0)]})})]}),e.jsx(Dt,{variant:"inset",component:"li"})]},u.id)})}),e.jsxs($,{variant:"outlined",component:"label",startIcon:e.jsx(rt,{}),disabled:y||S.length>=5,sx:{mt:1},children:[y?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:u=>{const k=u.target.files[0];k&&z(k)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:y||S.length>=5})]}),e.jsx(A,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:g,children:"Cancel"}),e.jsx($,{variant:"contained",onClick:P,disabled:y,sx:{minWidth:100},children:y?e.jsx(Se,{size:20}):"Update Ticket"})]})]}),ft={title:"",description:"",priority:"Medium",status:"pending",sendTo:"",due_date:"",departmentId:"",desired_action:"",remarks:""},Br=()=>{const l=ve(),g=Ze(l.breakpoints.down("sm")),{user:t}=xr(),{id:h}=br(),S=wr(),{tickets:z,assignedTickets:_,forwardedTickets:R,loading:P,actionLoading:y,departments:u,users:k,createTicket:E,updateTicket:i,deleteTicket:f,loadTicketFiles:s,uploadTicketFile:T,deleteTicketFile:W,downloadTicketFile:x,getTicketFiles:b,addComment:D,loadComments:F,deleteComment:N,refreshTickets:X}=Sr(),[ce,Ee]=r.useState(""),[Ce,Re]=r.useState("all"),[ke,Ie]=r.useState("all"),[re,Pe]=r.useState(0),[ue,Te]=r.useState(ft),[Z,ge]=r.useState([]),[ne,n]=r.useState(null),[a,d]=r.useState(null),[j,w]=r.useState([]),[M,L]=r.useState(null),[V,Y]=r.useState(!1),[xe,je]=r.useState(k),[B,ee]=r.useState(!1),[ye,me]=r.useState(!1),[zt,Le]=r.useState(!1),[st,I]=r.useState({open:!1,message:""}),[at,be]=r.useState({open:!1,message:""}),De=t?.role==="department_head"||t?.role==="Department Head",we=t?.id,Fe=gr(z,_,R,ce,Ce,ke,re,we);r.useEffect(()=>{if(h&&(z.length>0||_.length>0||R.length>0)){const m=[...z,..._,...R].find(C=>C.id===h);m?(n(m),ee(!0)):S("/app/tickets")}},[h,z,_,R,S]),r.useEffect(()=>{V&&(async()=>{try{const m=Array.isArray(k)?k:[];let C=[];try{C=(await fe.getAll({role:"admin"})).data||[]}catch{C=m.filter(Be=>(Be.role||"").toLowerCase()==="admin")}const U=[...m];C.forEach(he=>{U.some(Be=>Be.id===he.id)||U.push(he)});const G=U.filter(he=>he.id!==we);je(G)}catch{const m=Array.isArray(k)?k:[];je(m.filter(C=>C.id!==we))}})()},[V,k,we]);const nt=r.useCallback(()=>{Te(ft),ge([])},[]),_t=r.useCallback(o=>{const{name:m,value:C}=o.target;Te(U=>({...U,[m]:C}))},[]),Et=r.useCallback(async o=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(o.type)){I({open:!0,message:"Only PDF and image files are allowed."});return}const C=10*1024*1024;if(o.size>C){I({open:!0,message:"File size must be less than 10MB."});return}if(Z.length>=5){I({open:!0,message:"Maximum 5 files allowed."});return}const U=ct(o,t);ge(G=>[...G,U])}catch{I({open:!0,message:"Failed to prepare file for upload."})}},[t,Z.length]),Rt=r.useCallback(async o=>{try{ge(m=>m.filter(C=>C.id!==o))}catch{I({open:!0,message:"Failed to remove file."})}},[]),It=r.useCallback(async o=>{try{const m=Z.find(C=>C.id===o);ut(m)}catch{I({open:!0,message:"Failed to download file."})}},[Z]),Pt=r.useCallback(async()=>{const o=xt(ue,!1);if(o.length>0){I({open:!0,message:o[0]});return}try{const m=mt(ue,De,t),C=await E(m,Z);C.success?(nt(),Y(!1),be({open:!0,message:"Ticket created successfully!"})):I({open:!0,message:C.error})}catch(m){I({open:!0,message:m.message||"Failed to create ticket. Please try again."})}},[ue,Z,De,t,E,nt]),Lt=r.useCallback(async o=>{try{const m=await f(o);m.success?(Le(!1),L(null),be({open:!0,message:"Ticket deleted successfully!"})):I({open:!0,message:m.error||"Failed to delete ticket"})}catch(m){console.error("Delete ticket error:",m),I({open:!0,message:m.message||"Failed to delete ticket. Please try again."})}},[f]),it=r.useCallback(async o=>{n(o),await s(o.id),ee(!0)},[s]),Ne=r.useCallback(async o=>{const m=jr(o);d(m);try{const C=await s(o.id);w(Array.isArray(C)?C:[])}catch(C){console.error("Error loading ticket files:",C),w([])}me(!0)},[s]),Nt=r.useCallback(o=>{const{name:m,value:C}=o.target;d(U=>({...U,[m]:C}))},[]),Bt=r.useCallback(async()=>{const o=xt(a,!0);if(o.length>0){I({open:!0,message:o[0]});return}try{const m=mt(a,De,t),C=await i(m);if(C.success){const U=j.filter(G=>G.id.startsWith("temp-"));if(U.length>0&&a?.id)try{for(const G of U)await T(G.file,a.id)}catch(G){console.error("Error uploading temp files:",G)}me(!1),d(null),w([]),be({open:!0,message:"Ticket updated successfully!"})}else I({open:!0,message:C.error})}catch(m){I({open:!0,message:m.message||"Failed to update ticket. Please try again."})}},[a,j,De,t,i,T]),ot=r.useCallback(async()=>{try{await X()}catch(o){console.error("Error refreshing tickets:",o)}},[X]),Ut=r.useCallback(async o=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(o.type)){I({open:!0,message:"Only PDF and image files are allowed."});return}const C=10*1024*1024;if(o.size>C){I({open:!0,message:"File size must be less than 10MB."});return}if(j.length>=5){I({open:!0,message:"Maximum 5 files allowed."});return}if(a?.id){await T(o,a.id);const U=await s(a.id);w(Array.isArray(U)?U:[])}else{const U=ct(o,t);w(G=>[...G,U])}}catch(m){console.error("Error uploading file:",m),I({open:!0,message:"Failed to upload file."})}},[a,j.length,t,T,s]),Mt=r.useCallback(async o=>{try{if(a?.id){await W(a.id,o);const m=await s(a.id);w(Array.isArray(m)?m:[])}else w(m=>m.filter(C=>C.id!==o))}catch(m){console.error("Error deleting file:",m),I({open:!0,message:"Failed to delete file."})}},[a,W,s]),Ht=r.useCallback(async o=>{try{if(a?.id)await x(a.id,o);else{const m=j.find(C=>C.id===o);ut(m)}}catch(m){console.error("Error downloading file:",m),I({open:!0,message:"Failed to download file."})}},[a,j,x]),Ot=r.useCallback(async o=>{try{await W(ne.id,o),be({open:!0,message:"File deleted successfully!"})}catch{I({open:!0,message:"Failed to delete file."})}},[ne,W]),qt=r.useCallback(async o=>{try{await x(ne.id,o)}catch{I({open:!0,message:"Failed to download file."})}},[ne,x]),lt=r.useCallback(o=>{L(o),Le(!0)},[]),$t=r.useCallback(()=>{I({open:!1,message:""})},[]),Vt=r.useCallback(()=>{be({open:!1,message:""})},[]),Gt=r.useCallback(()=>{Le(!1)},[]),Jt=r.useCallback(()=>{Y(!1)},[]),Kt=r.useCallback(()=>{ee(!1),n(null),h&&S("/app/tickets")},[h,S]),Qt=r.useCallback(()=>{me(!1)},[]);return r.useEffect(()=>{const o=()=>{X()};return window.addEventListener("ticket_update",o),window.addEventListener("new_comment",o),window.addEventListener("notification",o),window.addEventListener("user_update",o),window.addEventListener("task_update",o),()=>{window.removeEventListener("ticket_update",o),window.removeEventListener("new_comment",o),window.removeEventListener("notification",o),window.removeEventListener("user_update",o),window.removeEventListener("task_update",o)}},[X]),P?e.jsx(mr,{message:"Loading tickets...",size:"large"}):e.jsxs(A,{sx:{p:{xs:2,md:4},backgroundColor:l.palette.background.default,minHeight:"100vh"},children:[e.jsx(yr,{title:"Tickets Management",subtitle:"Track and manage support tickets and requests for your department",emoji:"ðŸŽ«",color:"primary",onRefresh:ot,actionButton:{text:"New Ticket",icon:e.jsx(lr,{}),onClick:()=>Y(!0),disabled:y}}),e.jsx(Dr,{open:st.open,message:st.message,onClose:$t}),e.jsx(Fr,{open:at.open,message:at.message,onClose:Vt}),e.jsx(A,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(dr,{in:!0,timeout:800,children:e.jsxs(A,{children:[e.jsx(vr,{activeTab:re,setActiveTab:Pe,searchQuery:ce,setSearchQuery:Ee,filter:Ce,setFilter:Re,priorityFilter:ke,setPriorityFilter:Ie,isMobile:g}),e.jsxs(A,{sx:{mt:2,mb:2},children:[e.jsxs(p,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:[re===0?"Sent Tickets":re===1?"Received Tickets":"Forwarded by Me"," (",Fe.length,")"]}),Fe.length===0?e.jsx(A,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(p,{variant:"body1",children:z.length===0?"No tickets found. Create your first ticket to get started.":"No tickets match your current filters. Try adjusting your search criteria."})}):e.jsxs(e.Fragment,{children:[e.jsx(Cr,{tickets:Fe,departments:u,users:k,activeTab:re,onViewTicket:it,onEditTicket:Ne,onDeleteTicket:lt,getStatusColor:$e,getStatusIcon:ht,getPriorityColor:qe,getPriorityIcon:Oe}),e.jsx(A,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(v,{container:!0,spacing:2,children:Fe.map(o=>e.jsx(v,{item:!0,xs:12,children:e.jsx(kr,{ticket:o,departments:u,users:k,activeTab:re,onViewTicket:it,onEditTicket:Ne,onDeleteTicket:lt,getPriorityColor:qe,getPriorityIcon:Oe,getStatusColor:$e,getTicketFiles:b})},o.id))})})]})]})]})})}),e.jsx(Wr,{open:zt,ticket:M,onClose:Gt,onConfirm:()=>Lt(M?.id),loading:y}),e.jsx(Ar,{open:V,onClose:Jt,newTicket:ue,onTicketChange:_t,newTicketFiles:Z,onFileUpload:Et,onFileDelete:Rt,onFileDownload:It,departments:u,users:xe,onSubmit:Pt,loading:y,isMobile:g,currentUserId:we}),e.jsx(zr,{open:B,onClose:Kt,ticket:ne,departments:u,users:k,getStatusColor:$e,getStatusIcon:ht,getPriorityColor:qe,getPriorityIcon:Oe,getTicketFiles:b,onRefresh:ot,onFileDelete:Ot,onFileDownload:qt,onEdit:Ne,isMobile:g,addComment:D,loadComments:F,deleteComment:N}),e.jsx(_r,{open:ye,onClose:Qt,ticket:a,onTicketChange:Nt,editingTicketFiles:j,onFileUpload:Ut,onFileDelete:Mt,onFileDownload:Ht,departments:u,users:k,onSubmit:Bt,loading:y})]})};export{Br as default};
