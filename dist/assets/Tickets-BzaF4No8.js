import{u as Se,j as e,a5 as gr,a6 as jr,E as Zr,G as Me,a4 as C,as as se,ax as es,ay as rs,at as Q,au as Y,av as X,m as u,a1 as Ze,az as ss,aj as ts,aA as as,aB as ns,aC as cr,aD as O,aE as os,k as yr,O as Ge,ai as Je,ab as Ke,aq as Qe,b as y,h as V,d as te,aG as fe,aH as er,aI as rr,B as k,an as Ye,I as ae,ao as br,ap as Ae,J as ke,aw as sr,y as G,aJ as is,t as oe,v as ie,w as le,a3 as ls,V as we,x as de,aK as wr,aL as ds,aM as Xe,r as Sr,n as vr,p as Cr,aN as Tr,q as Fr,H as Dr,am as Ue,aF as cs,F as xs}from"./mui-DaYlJXyD.js";import{r as t,b as Wr}from"./vendor-Cr2nE3UY.js";import{e as $,g as us,h as he,f as ms,i as He,u as hs,L as fs}from"./index-B2R0mN4_.js";import{f as We,g as zr,a as Ar,b as ze,c as kr,d as ps,F as gs,C as js,e as ys,h as xr,i as ur,v as mr,p as hr,j as bs,k as Oe,l as qe,m as fr,n as $e}from"./FileUploadSection-BRV5pRdO.js";import{P as ws}from"./PageHeader-DlP9MJR_.js";import{c as Ss,u as vs}from"./router-B4FNaIx_.js";const Cs=()=>{const[l,j]=t.useState([]),[r,h]=t.useState([]),[v,_]=t.useState([]),[I,P]=t.useState(!0),[B,b]=t.useState(!1),[D,A]=t.useState([]),[L,n]=t.useState([]),[g,s]=t.useState({}),[T,S]=t.useState(""),d=t.useCallback(async()=>{var i;try{const a=await $.getAll(),p=((i=a.data)==null?void 0:i.tickets)||a.tickets||a.data||a||[];if(!Array.isArray(p)){console.warn("Tickets data is not an array:",p),j([]);return}const m=p.sort((c,z)=>{const E=new Date(c.created_at||c.createdAt||0);return new Date(z.created_at||z.createdAt||0)-E});j(m)}catch(a){console.error("Error loading tickets:",a),j([])}},[]),W=t.useCallback(async()=>{try{const i=await $.getAssignedTickets(),a=i.data||i||[];if(!Array.isArray(a)){console.warn("Assigned tickets data is not an array:",a),h([]);return}const p=a.sort((m,c)=>{const z=new Date(m.created_at||m.createdAt||0);return new Date(c.created_at||c.createdAt||0)-z});h(p)}catch(i){console.error("Error loading assigned tickets:",i),h([])}},[]),f=t.useCallback(async()=>{var i;try{console.log("Loading forwarded tickets...");const a=await $.getAll(),p=((i=a.data)==null?void 0:i.tickets)||a.tickets||a.data||a||[],m=JSON.parse(localStorage.getItem("user")||"{}"),c=m==null?void 0:m.id;console.log("All tickets loaded:",{allTickets:p.length,currentUserId:c});const z=p.filter(M=>{var ge;const q=M.forwarded_from_id||M.forwardedFromId||((ge=M.forwardedFrom)==null?void 0:ge.id),H=M.is_forwarded===!0||M.isForwarded===!0,Z=q&&c&&String(q)===String(c);return console.log("Checking ticket:",{ticketId:M.id,forwardedFromId:q,isForwarded:H,forwardedByMatch:Z,currentUserId:c}),Z});console.log("Forwarded by me tickets found:",z.length);const E=z.sort((M,q)=>{const H=new Date(M.created_at||M.createdAt||0);return new Date(q.created_at||q.createdAt||0)-H});_(E)}catch(a){console.error("Error loading forwarded-by-me tickets:",a),_([])}},[]),w=t.useCallback(async()=>{try{const i=await us.getAll(),a=i.data||i||[];A(a)}catch(i){console.error("Error loading departments:",i),A([])}},[]),R=t.useCallback(async()=>{try{const i=await he.getAll(),a=i.data||i||[];n(a)}catch(i){console.error("Error loading users:",i),n([])}},[]),J=t.useCallback(async()=>{try{P(!0),S(""),await Promise.all([d(),W(),f(),w(),R()])}catch(i){console.error("Error loading initial data:",i),S("Failed to load data. Please try again.")}finally{P(!1)}},[d,W,f,w,R]),ce=t.useCallback(async(i,a=[])=>{var p,m;b(!0);try{const c=await $.create(i),z=c.data||c;if(a&&a.length>0)try{for(const E of a)E.file?await $.uploadAttachment(z.id,E.file):await $.uploadAttachment(z.id,E)}catch(E){console.error("Error uploading files:",E)}return j(E=>[z,...E]),{success:!0,ticket:z}}catch(c){return console.error("Error creating ticket:",c),{success:!1,error:((m=(p=c.response)==null?void 0:p.data)==null?void 0:m.message)||"Failed to create ticket."}}finally{b(!1)}},[]),_e=t.useCallback(async i=>{var a,p;b(!0);try{const m=await $.update(i.id,i),c=m.data||m;return j(z=>z.map(E=>E.id===c.id?c:E)),{success:!0,ticket:c}}catch(m){return console.error("Error updating ticket:",m),{success:!1,error:((p=(a=m.response)==null?void 0:a.data)==null?void 0:p.message)||"Failed to update ticket."}}finally{b(!1)}},[]),ve=t.useCallback(async i=>{var a,p;if(!i)return{success:!1,error:"Invalid ticket ID for deletion."};b(!0);try{return await $.delete(i),j(m=>m.filter(c=>c.id!==i)),{success:!0}}catch(m){return console.error("Error deleting ticket:",m),{success:!1,error:((p=(a=m.response)==null?void 0:a.data)==null?void 0:p.message)||"Failed to delete ticket."}}finally{b(!1)}},[]),Ee=t.useCallback(async(i,a)=>{var p,m,c;b(!0);try{const z=await $.forwardTicket(i,a);try{const E=JSON.parse(localStorage.getItem("user")||"{}"),M=E==null?void 0:E.id,q=await $.getById(i),H=q.data||q||null;if(H&&M){const Z=H.forwarded_from_id||H.forwardedFromId||((p=H.forwardedFrom)==null?void 0:p.id);(H.is_forwarded===!0||H.isForwarded===!0||typeof H.forward_chain_id<"u"||typeof H.forwardChainId<"u")&&Z&&String(Z)===String(M)&&_(ue=>ue.some(je=>je.id===H.id)?ue:[H,...ue])}}catch{}return await d(),await f(),{success:!0,data:z.data||z}}catch(z){return console.error("Error forwarding ticket:",z),{success:!1,error:((c=(m=z.response)==null?void 0:m.data)==null?void 0:c.message)||"Failed to forward ticket."}}finally{b(!1)}},[d,f]),Ce=t.useCallback(async i=>{try{const a=await $.getAttachments(i),p=a.data||a||[];return s(m=>({...m,[i]:p})),p}catch(a){return console.error("Error loading ticket files:",a),s(p=>({...p,[i]:[]})),[]}},[]),Re=t.useCallback(async(i,a)=>{var p;try{const m=await $.uploadAttachment(a,i),c=m.data||m;return s(z=>({...z,[a]:[...z[a]||[],c]})),c}catch(m){if(console.error("File upload error:",m),((p=m.response)==null?void 0:p.status)===500){console.warn("Server returned 500 but file may have been uploaded successfully");try{const c=await $.getAttachments(a);if(c.data&&c.data.length>0)return s(z=>({...z,[a]:c.data})),c.data[c.data.length-1]}catch(c){console.error("Error refreshing file list:",c)}}throw new Error("Failed to upload file.")}},[]),ee=t.useCallback(async(i,a)=>{try{await $.deleteAttachment(i,a),s(p=>{var m;return{...p,[i]:((m=p[i])==null?void 0:m.filter(c=>c.id!==a))||[]}})}catch{throw new Error("Failed to delete file.")}},[]),Ie=t.useCallback(async(i,a)=>{try{const p=await ms.download(a),m=new Blob([p.data]),c=window.URL.createObjectURL(m),z=document.createElement("a");z.href=c;const E=p.headers["content-disposition"];let M="download";if(E){const q=E.match(/filename="(.+)"/);q&&(M=q[1])}z.download=M,document.body.appendChild(z),z.click(),document.body.removeChild(z),window.URL.revokeObjectURL(c)}catch{throw new Error("Failed to download file.")}},[]),xe=t.useCallback(i=>g[i]||[],[g]),Te=t.useCallback(async(i,a)=>{var p,m;try{const c=await He.addTicketComment(i,a);return{success:!0,comment:c.data||c}}catch(c){return console.error("Error adding comment:",c),{success:!1,error:((m=(p=c.response)==null?void 0:p.data)==null?void 0:m.message)||"Failed to add comment."}}},[]),re=t.useCallback(async i=>{try{const a=await He.fetchTicketComments(i);return a.data||a||[]}catch(a){return console.error("useTickets: Error loading comments:",a),[]}},[]),pe=t.useCallback(async i=>{var a,p;try{return await He.deleteComment(i),{success:!0}}catch(m){return console.error("Error deleting comment:",m),{success:!1,error:((p=(a=m.response)==null?void 0:a.data)==null?void 0:p.message)||"Failed to delete comment."}}},[]),ne=t.useCallback(async()=>{try{await Promise.all([d(),W(),f()])}catch(i){console.error("Error refreshing tickets:",i)}},[d,W,f]);return t.useEffect(()=>{J()},[J]),{tickets:l,assignedTickets:r,forwardedTickets:v,loading:I,actionLoading:B,departments:D,users:L,error:T,loadTickets:d,loadAssignedTickets:W,loadForwardedTickets:f,createTicket:ce,updateTicket:_e,deleteTicket:ve,forwardTicket:Ee,loadTicketFiles:Ce,uploadTicketFile:Re,deleteTicketFile:ee,downloadTicketFile:Ie,getTicketFiles:xe,addComment:Te,loadComments:re,deleteComment:pe,refreshTickets:ne,setError:S}},Ts=({activeTab:l,setActiveTab:j,searchQuery:r,setSearchQuery:h,filter:v,setFilter:_,priorityFilter:I,setPriorityFilter:P,isMobile:B})=>(Se(),e.jsx(gr,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsxs(jr,{sx:{p:{xs:2,sm:2.5,md:3}},children:[e.jsxs(Zr,{value:l,onChange:(b,D)=>j(D),variant:"fullWidth",sx:{mb:2,"& .MuiTab-root":{fontSize:{xs:"0.95rem",sm:"1.05rem"},fontWeight:600,textTransform:"none",minHeight:{xs:44,sm:52}},"& .Mui-selected":{color:"primary.main"}},children:[e.jsx(Me,{label:B?"Sent":"Sent Tickets"}),e.jsx(Me,{label:B?"Received":"Received Tickets"}),e.jsx(Me,{label:B?"Forwarded":"Forwarded by Me"})]}),e.jsxs(C,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(C,{item:!0,xs:12,sm:6,md:4,children:e.jsx(se,{fullWidth:!0,placeholder:"Search tickets...",value:r,onChange:b=>h(b.target.value),InputProps:{startAdornment:e.jsx(es,{position:"start",children:e.jsx(rs,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{value:v,label:"Status",onChange:b=>_(b.target.value),sx:{borderRadius:2},children:[e.jsx(u,{value:"all",children:"All Status"}),e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"in_progress",children:"In Progress"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{value:I,label:"Priority",onChange:b=>P(b.target.value),sx:{borderRadius:2},children:[e.jsx(u,{value:"all",children:"All Priority"}),e.jsx(u,{value:"high",children:"High"}),e.jsx(u,{value:"medium",children:"Medium"}),e.jsx(u,{value:"low",children:"Low"})]})]})})]})]})}));function Ve({title:l,children:j,...r}){const h=t.useRef(null),[v,_]=t.useState(!1);return t.useEffect(()=>{const I=h.current;I&&_(I.scrollWidth>I.clientWidth)},[j,l]),v?e.jsx(V,{title:l,arrow:!0,...r,children:e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:j})}):e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:j})}const Fs=({tickets:l,users:j,activeTab:r,onViewTicket:h,onEditTicket:v,onDeleteTicket:_,getStatusColor:I,getStatusIcon:P,getPriorityColor:B,getPriorityIcon:b})=>{const D=Se(),A=Ze(D.breakpoints.down("sm")),[L,n]=t.useState({});t.useEffect(()=>{if(r!==2||!Array.isArray(l))return;const s=new Set((Array.isArray(j)?j:[]).map(d=>String(d.id))),T=new Set(Object.keys(L)),S=new Set;l.forEach(d=>{const W=d.forwardedTo||d.forwarded_to||d.forwarded_to_id||d.current_handler_id;if(W&&typeof W!="object"){const f=String(W);!s.has(f)&&!T.has(f)&&S.add(f)}}),S.size!==0&&(async()=>{const d=await Promise.all(Array.from(S).map(async W=>{try{const f=await he.getById(W),w=f.data||f||null;return[W,w]}catch{return[W,null]}}));n(W=>{const f={...W};return d.forEach(([w,R])=>{f[w]=R}),f})})()},[r,l,j,L]);const g=s=>{if(!s)return"Unknown User";if(typeof s=="object")return ze(s);const T=String(s),S=j.find(d=>String(d.id)===T)||L[T];return S?ze(S):T};return A?null:e.jsx(ss,{component:ts,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(as,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(ns,{children:e.jsxs(cr,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(O,{padding:"checkbox",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(O,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(O,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:r===0?"Send To":r===1?"Sent By":r===2?"Forwarded To":"Created By"}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(O,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(os,{children:l.map((s,T)=>e.jsxs(cr,{hover:!0,sx:{bgcolor:T%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(O,{padding:"checkbox",sx:{px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(O,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(yr,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:(()=>{switch(P(s.status)){case"Schedule":return e.jsx(Qe,{sx:{fontSize:{md:14,lg:18}}});case"CheckCircle":return e.jsx(Ke,{sx:{fontSize:{md:14,lg:18}}});case"Error":return e.jsx(Je,{sx:{fontSize:{md:14,lg:18}}});default:return e.jsx(Ge,{sx:{fontSize:{md:14,lg:18}}})}})()})}),e.jsxs(O,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(Ve,{title:s.title,children:e.jsx(y,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.title})}),e.jsx(Ve,{title:s.description,children:e.jsx(y,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.description})})]}),e.jsx(O,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(V,{title:`Priority: ${s.priority}`,arrow:!0,children:e.jsx("span",{children:e.jsx(te,{label:s.priority,size:"small",color:B(s.priority),icon:(()=>{switch(b(s.priority)){case"PriorityHigh":return e.jsx(rr,{sx:{fontSize:{md:12,lg:16}}});case"Remove":return e.jsx(fe,{sx:{fontSize:{md:12,lg:16}}});case"LowPriority":return e.jsx(er,{sx:{fontSize:{md:12,lg:16}}});default:return e.jsx(fe,{sx:{fontSize:{md:12,lg:16}}})}})(),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})})})}),e.jsx(O,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(V,{title:`Status: ${s.status.replace("_"," ")}`,arrow:!0,children:e.jsx("span",{children:e.jsx(te,{label:s.status.replace("_"," "),size:"small",color:I(s.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})})})}),e.jsx(O,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(Ve,{title:(()=>{if(r===0)return g(s.ticketAssignee||s.assignedTo||s.assigned_to);if(r===1)return g(s.ticketCreator||s.createdBy||s.created_by);if(r===2){const S=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return g(S)}return g(s.ticketCreator||s.createdBy||s.created_by)})(),children:e.jsx(y,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:"0.78rem",overflow:"hidden",textOverflow:"ellipsis"},children:(()=>{if(r===0)return g(s.ticketAssignee||s.assignedTo||s.assigned_to);if(r===1)return g(s.ticketCreator||s.createdBy||s.created_by);if(r===2){const S=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return g(S)}return g(s.ticketCreator||s.createdBy||s.created_by)})()})})}),e.jsx(O,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[s.due_date&&e.jsx(V,{title:We(s.due_date),arrow:!0,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Ye,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(y,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:We(s.due_date)})]})}),(()=>{const S=zr(s),d=Ar(s);return!S||!d?null:e.jsx(V,{title:`Maturity: ${d}`,arrow:!0,children:e.jsx("span",{children:e.jsx(te,{label:d,size:"small",color:S,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(O,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsx(k,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(V,{title:"View Details",children:e.jsx("span",{children:e.jsx(ae,{color:"primary",size:"small",onClick:()=>h(s),children:e.jsx(br,{fontSize:"small"})})})}),e.jsx(V,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"secondary",size:"small",onClick:()=>v(s),children:e.jsx(Ae,{fontSize:"small"})})})}),e.jsx(V,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"error",size:"small",onClick:()=>_(s),children:e.jsx(ke,{fontSize:"small"})})})})]})})})]},s.id))})]})})},Ds=({ticket:l,departments:j,users:r,activeTab:h,onViewTicket:v,onEditTicket:_,onDeleteTicket:I,getPriorityColor:P,getPriorityIcon:B,getStatusColor:b,getTicketFiles:D})=>{const A=Se(),L=Ze(A.breakpoints.down("sm")),n=g=>{if(!g)return"Unknown";if(typeof g=="object"&&g.firstname)return ze(g);const s=r.find(T=>T.id===g);return ze(s)};return L?e.jsx(gr,{sx:{borderRadius:3,boxShadow:2,overflow:"hidden"},children:e.jsxs(jr,{sx:{p:3},children:[e.jsx(k,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:e.jsxs(k,{sx:{flex:1,minWidth:0},children:[e.jsx(y,{variant:"h6",sx:{fontWeight:700,mb:1,wordBreak:"break-word"},children:l.title}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2,lineHeight:1.5},children:l.description})]})}),e.jsxs(k,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(te,{label:l.priority,size:"small",color:P(l.priority),icon:(()=>{switch(B(l.priority)){case"PriorityHigh":return e.jsx(rr,{sx:{fontSize:14}});case"Remove":return e.jsx(fe,{sx:{fontSize:14}});case"LowPriority":return e.jsx(er,{sx:{fontSize:14}});default:return e.jsx(fe,{sx:{fontSize:14}})}})(),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),e.jsx(te,{label:l.status.replace("_"," "),size:"small",color:b(l.status),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),(()=>{const g=zr(l),s=Ar(l);return!g||!s?null:e.jsx(te,{label:s,size:"small",color:g,sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}})})()]}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",gap:1,mb:2},children:[e.jsxs(y,{variant:"body2",color:"text.secondary",children:[e.jsxs("strong",{children:[h===0?"Send To":h===1?"Sent By":h===2?"Forwarded To":"Created By",":"]})," ",n(h===0?l.ticketAssignee||l.assignedTo||l.assigned_to:h===1?l.ticketCreator||l.createdBy||l.created_by:h===2?l.forwarded_to_id:l.ticketCreator||l.createdBy||l.created_by)]}),l.due_date&&e.jsxs(y,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Due Date:"})," ",We(l.due_date)]})]}),D(l.id).length>0&&e.jsxs(k,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(sr,{fontSize:"small",sx:{mr:1,color:"text.secondary"}}),e.jsxs(y,{variant:"caption",color:"text.secondary",children:[D(l.id).length," file(s) attached"]})]}),e.jsx(k,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(V,{title:"View Details",children:e.jsx("span",{children:e.jsx(ae,{color:"primary",size:"small",onClick:()=>v(l),children:e.jsx(br,{fontSize:"small"})})})}),e.jsx(V,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"secondary",size:"small",onClick:()=>_(l),children:e.jsx(Ae,{fontSize:"small"})})})}),e.jsx(V,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(ae,{color:"error",size:"small",onClick:()=>I(l),children:e.jsx(ke,{fontSize:"small"})})})})]})})]})}):null},Ws=({ticket:l,onForward:j,disabled:r=!1})=>{const[h,v]=t.useState(!1),[_,I]=t.useState([]),[P,B]=t.useState(""),[b,D]=t.useState(""),[A,L]=t.useState(!1),[n,g]=t.useState("");t.useEffect(()=>{h&&s()},[h]);const s=async()=>{try{L(!0),g("");let d=[];try{const w=await he.getAll({role:"department_head"}),R=await he.getAll({role:"admin"}),J=w.data||w||[],ce=R.data||R||[];d=[...J,...ce],console.log("Department heads and admins fetched with role param:",d)}catch(w){console.log("Role-based fetch failed, trying all users:",w);const R=await he.getAll();d=R.data||R||[],console.log("All users fetched:",d)}let W=d;d.length>0&&!d.some(w=>w.role==="department_head"||w.role==="admin")&&(W=d.filter(w=>{var J;const R=(J=w.role)==null?void 0:J.toLowerCase();return R==="admin"||R==="department_head"||R==="departmenthead"||R==="dept_head"||R==="head"||w.role&&w.role.includes("head")})),console.log("Eligible users found:",W);const f=W.map(w=>{const R=w.role==="admin"?"Admin":"Dept Head";return{...w,displayName:`${w.firstname||w.firstName||"Unknown"} ${w.lastname||w.lastName||"User"} (${R})`}});f.length===0?g("No department heads or admins found in the system. Please ensure there are users with appropriate roles."):(I(f),g(""))}catch(d){console.error("Error loading recipients:",d),g("Failed to load recipients. Please try again.")}finally{L(!1)}},T=async()=>{var d,W;if(!P||!b.trim()){g("Please select a recipient and provide a reason");return}L(!0),g("");try{await $.forwardTicket(l.id,{toUserId:P,reason:b.trim()}),j&&j(),v(!1),B(""),D("")}catch(f){console.error("Error forwarding ticket:",f),g(((W=(d=f.response)==null?void 0:d.data)==null?void 0:W.error)||"Failed to forward ticket")}finally{L(!1)}},S=()=>{v(!1),B(""),D(""),g("")};return e.jsxs(e.Fragment,{children:[e.jsx(G,{variant:"outlined",startIcon:e.jsx(is,{}),onClick:()=>v(!0),disabled:r,sx:{mr:1},children:"Forward"}),e.jsxs(oe,{open:h,onClose:S,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ie,{children:["Forward Ticket #",l==null?void 0:l.id]}),e.jsxs(le,{children:[n&&e.jsx(ls,{severity:"error",sx:{mb:2},children:n}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Forwarding ticket to a department head or admin"}),e.jsxs(Q,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Y,{children:"Forward To"}),e.jsx(X,{value:P,onChange:d=>B(d.target.value),label:"Forward To",disabled:A||_.length===0,children:A?e.jsx(u,{disabled:!0,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(we,{size:16}),"Loading recipients..."]})}):_.length===0?e.jsx(u,{disabled:!0,children:"No recipients available"}):_.map(d=>e.jsx(u,{value:d.id,children:d.displayName},d.id))})]}),e.jsx(se,{fullWidth:!0,label:"Reason for Forwarding",value:b,onChange:d=>D(d.target.value),multiline:!0,rows:3,required:!0,disabled:A,sx:{mb:2}})]}),e.jsxs(de,{children:[e.jsx(G,{onClick:S,disabled:A,children:"Cancel"}),e.jsx(G,{onClick:T,variant:"contained",disabled:!P||!b.trim()||A,children:A?e.jsx(we,{size:20}):"Forward Ticket"})]})]})]})},zs=({open:l,message:j,onClose:r})=>e.jsxs(oe,{open:l,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ie,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(wr,{color:"error",sx:{fontSize:32}}),"Error"]}),e.jsx(le,{children:e.jsx(y,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:j})}),e.jsx(de,{children:e.jsx(G,{onClick:r,variant:"contained",color:"error",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),As=({open:l,message:j,onClose:r})=>e.jsxs(oe,{open:l,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ie,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main",fontWeight:700},children:[e.jsx(ds,{color:"success",sx:{fontSize:32}}),"Success"]}),e.jsx(le,{children:e.jsx(y,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:j})}),e.jsx(de,{children:e.jsx(G,{onClick:r,variant:"contained",color:"success",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),ks=({open:l,ticket:j,onClose:r,onConfirm:h,loading:v})=>e.jsxs(oe,{open:l,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ie,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(wr,{color:"error",sx:{fontSize:32}}),"Confirm Deletion"]}),e.jsxs(le,{children:[e.jsx(y,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:2},children:"Are you sure you want to delete this ticket? This action cannot be undone."}),e.jsx(y,{variant:"body1",sx:{fontWeight:"bold",color:"text.primary",bgcolor:"action.hover",p:2,borderRadius:1,fontSize:"1.1rem"},children:j==null?void 0:j.title})]}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:r,sx:{minWidth:100},children:"Cancel"}),e.jsx(G,{onClick:h,color:"error",variant:"contained",disabled:v,sx:{minWidth:100},children:v?e.jsx(we,{size:20}):"Delete"})]})]}),_s=({open:l,onClose:j,newTicket:r,onTicketChange:h,newTicketFiles:v,onFileUpload:_,onFileDelete:I,departments:P,users:B,onSubmit:b,loading:D,isMobile:A,currentUserId:L})=>e.jsxs(oe,{open:l,onClose:j,maxWidth:"sm",fullWidth:!0,fullScreen:A,children:[e.jsx(ie,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:"Create New Ticket"}),e.jsx(le,{sx:{pt:{xs:1,sm:2}},children:e.jsx(k,{component:"form",onSubmit:n=>{n.preventDefault(),b()},sx:{mt:1},children:e.jsxs(C,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(se,{fullWidth:!0,label:"Ticket Title",name:"title",value:r.title,onChange:h,required:!0,sx:{mb:2}})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(se,{fullWidth:!0,label:"Description",name:"description",value:r.description,onChange:h,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Desired Action"}),e.jsxs(X,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,children:[e.jsx(u,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(u,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(u,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(u,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(u,{value:"Dispatch",children:"Dispatch"}),e.jsx(u,{value:"File",children:"File"}),e.jsx(u,{value:"Mis routed",children:"Mis routed"}),e.jsx(u,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(u,{value:"photocopy file",children:"Photocopy file"}),e.jsx(u,{value:"Study",children:"Study"}),e.jsx(u,{value:"Staff action",children:"Staff action"}),e.jsx(u,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{name:"priority",value:r.priority,label:"Priority",onChange:h,children:[e.jsx(u,{value:"Low",children:"Low"}),e.jsx(u,{value:"Medium",children:"Medium"}),e.jsx(u,{value:"High",children:"High"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{name:"status",value:r.status||"pending",label:"Status",onChange:h,children:[e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"in_progress",children:"In Progress"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Send To"}),e.jsxs(X,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,children:[e.jsx(Xe,{children:"Admins"}),B.filter(n=>n.role==="admin").filter(n=>n.id!==L).map(n=>e.jsxs(u,{value:n.id,children:[n.firstname," ",n.lastname," (Admin)"]},n.id)),e.jsx(Xe,{children:"Department Heads"}),P.filter(n=>n.head).filter(n=>n.head.id!==L).map(n=>e.jsxs(u,{value:n.head.id,children:[n.head.firstname," ",n.head.lastname," (Dept Head, ",n.name,")"]},n.head.id))]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(se,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(k,{sx:{mt:3},children:[e.jsx(y,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),v.length===0&&e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),v.length>0&&e.jsx(Sr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:v.map(n=>{const g=n.file_name||n.name||"Unknown File";return e.jsxs(Wr.Fragment,{children:[e.jsxs(vr,{secondaryAction:e.jsx(V,{title:"Delete file",arrow:!0,children:e.jsx(ae,{edge:"end",onClick:()=>I(n.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(ke,{fontSize:"small"})})}),children:[e.jsx(Cr,{children:e.jsx(Tr,{})}),e.jsx(Fr,{primary:e.jsx(V,{title:"Click to download file",arrow:!0,children:e.jsx(y,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(n.file){const s=URL.createObjectURL(n.file),T=document.createElement("a");T.href=s,T.download=n.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(s)}},children:g})}),secondary:e.jsxs(y,{variant:"caption",color:"text.disabled",children:[n.uploadedAt?new Date(n.uploadedAt).toLocaleString():"â€”"," â€¢ ",kr(n.file_size||n.size||0)]})})]}),e.jsx(Dr,{variant:"inset",component:"li"})]},n.id)})}),e.jsxs(G,{variant:"outlined",component:"label",startIcon:e.jsx(sr,{}),disabled:D||v.length>=5,sx:{mt:1},children:[D?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:n=>{const g=n.target.files[0];g&&_(g)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:D||v.length>=5})]}),e.jsx(k,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:j,children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:b,disabled:D,sx:{minWidth:100},children:D?e.jsx(we,{size:20}):"Create Ticket"})]})]}),Es=({open:l,onClose:j,ticket:r,departments:h,users:v=[],getStatusColor:_,getStatusIcon:I,getPriorityColor:P,getPriorityIcon:B,onRefresh:b,getTicketFiles:D,onFileDelete:A,onEdit:L,isMobile:n,addComment:g,loadComments:s,deleteComment:T,activeTab:S=0})=>{Se();const d=f=>{if(!f)return"Unknown";if(typeof f=="object"&&f.firstname)return`${f.firstname} ${f.lastname}`.trim()||f.email||f.username||"Unknown";const w=v.find(R=>R.id===f);return w&&(`${w.firstname} ${w.lastname}`.trim()||w.email||w.username)||f},W=f=>{if(!f)return"N/A";const w=h.find(R=>R.id===f);return w?w.name:f};return r?e.jsxs(oe,{open:l,onClose:j,maxWidth:"md",fullWidth:!0,fullScreen:n,children:[e.jsxs(ie,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2},display:"flex",alignItems:"center",gap:2},children:[e.jsx(yr,{sx:{bgcolor:`${_(r.status)}.light`,color:`${_(r.status)}.main`,width:{xs:32,sm:40},height:{xs:32,sm:40}},children:(()=>{switch(I(r.status)){case"Schedule":return e.jsx(Qe,{sx:{fontSize:{xs:16,sm:20}}});case"CheckCircle":return e.jsx(Ke,{sx:{fontSize:{xs:16,sm:20}}});case"Error":return e.jsx(Je,{sx:{fontSize:{xs:16,sm:20}}});default:return e.jsx(Ge,{sx:{fontSize:{xs:16,sm:20}}})}})()}),e.jsxs(k,{sx:{flex:1},children:[e.jsx(y,{variant:"h6",sx:{fontWeight:600},children:r.title}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Ticket #",r.id]})]})]}),e.jsxs(le,{sx:{pt:{xs:1,sm:2}},children:[e.jsxs(C,{container:!0,spacing:3,children:[e.jsxs(C,{item:!0,xs:12,children:[e.jsx(y,{variant:"h6",sx:{mb:2,fontWeight:600},children:"Description"}),e.jsx(k,{sx:{mb:3},children:e.jsx(y,{variant:"body1",children:r.description})})]}),(r.desired_action||r.desiredAction)&&e.jsxs(C,{item:!0,xs:12,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Desired Action"}),e.jsx(y,{variant:"body1",children:r.desired_action||r.desiredAction})]}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Priority"}),e.jsx(te,{label:r.priority,color:P(r.priority),icon:(()=>{switch(B(r.priority)){case"PriorityHigh":return e.jsx(rr,{sx:{fontSize:16}});case"Remove":return e.jsx(fe,{sx:{fontSize:16}});case"LowPriority":return e.jsx(er,{sx:{fontSize:16}});default:return e.jsx(fe,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx(te,{label:r.status.replace("_"," "),color:_(r.status),icon:(()=>{switch(I(r.status)){case"Schedule":return e.jsx(Qe,{sx:{fontSize:16}});case"CheckCircle":return e.jsx(Ke,{sx:{fontSize:16}});case"Error":return e.jsx(Je,{sx:{fontSize:16}});default:return e.jsx(Ge,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created By"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ue,{sx:{fontSize:20},color:"action"}),d(r.ticketCreator||r.createdBy||r.created_by)]})]}),e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Department"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ue,{sx:{fontSize:20},color:"action"}),W(r.departmentId||r.department_id)]})]}),(r.ticketAssignee||r.assignedTo||r.assigned_to)&&e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Assigned To"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ue,{sx:{fontSize:20},color:"action"}),d(r.ticketAssignee||r.assignedTo||r.assigned_to)]})]}),r.due_date&&e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Due Date"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ye,{sx:{fontSize:20},color:"action"}),We(r.due_date)]})]}),e.jsxs(C,{item:!0,xs:12,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ye,{sx:{fontSize:20},color:"action"}),ps(r.created_at||r.createdAt)]})]})]}),D(r.id).length>0&&e.jsx(k,{sx:{mt:3},children:e.jsx(gs,{entityId:r.id,fetchFiles:async()=>({data:D(r.id)}),uploadFile:()=>{},deleteFile:A,maxFiles:5,maxFileSize:10*1024*1024,acceptedTypes:["*/*"],disabled:!1,readOnly:!0})}),e.jsx(js,{entityId:r==null?void 0:r.id,user:JSON.parse(localStorage.getItem("user")||"{}"),users:v,fetchComments:s,addComment:g,deleteComment:T})]}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:j,children:"Close"}),e.jsx(Ws,{ticket:r,disabled:(()=>{const f=S===2,w=S===1&&!!(r!=null&&r.forwarded_to_id||r!=null&&r.is_forwarded||r!=null&&r.forwardedToId),R=f||w;return console.log("Forward button logic:",{activeTab:S,ticketId:r==null?void 0:r.id,forwarded_to_id:r==null?void 0:r.forwarded_to_id,is_forwarded:r==null?void 0:r.is_forwarded,forwardedToId:r==null?void 0:r.forwardedToId,isTab2:f,isTab1AndForwarded:w,shouldDisable:R}),R})(),onForward:()=>{j(),typeof b=="function"&&b()}}),e.jsx(G,{variant:"contained",startIcon:e.jsx(Ae,{}),onClick:()=>{j(),L(r)},sx:{minWidth:100},children:"Edit Ticket"})]})]}):null},Rs=({open:l,onClose:j,ticket:r,onTicketChange:h,editingTicketFiles:v,onFileUpload:_,onFileDelete:I,departments:P,onSubmit:B,loading:b,fileOperationsCount:D=0})=>{var A,L;return r?e.jsxs(oe,{open:l,onClose:j,maxWidth:"md",fullWidth:!0,children:[e.jsx(ie,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ae,{color:"primary"}),e.jsx(y,{variant:"h6",children:"Edit Ticket"})]})}),e.jsx(le,{dividers:!0,children:r&&e.jsx(k,{sx:{pt:1},children:e.jsxs(C,{container:!0,spacing:3,children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(se,{fullWidth:!0,label:"Title",name:"title",value:r.title||"",onChange:h,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(se,{fullWidth:!0,label:"Description",name:"description",value:r.description||"",onChange:h,multiline:!0,rows:4,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Desired Action"}),e.jsxs(X,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,sx:{borderRadius:2},children:[e.jsx(u,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(u,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(u,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(u,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(u,{value:"Dispatch",children:"Dispatch"}),e.jsx(u,{value:"File",children:"File"}),e.jsx(u,{value:"Mis routed",children:"Mis routed"}),e.jsx(u,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(u,{value:"photocopy file",children:"Photocopy file"}),e.jsx(u,{value:"Study",children:"Study"}),e.jsx(u,{value:"Staff action",children:"Staff action"}),e.jsx(u,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(se,{fullWidth:!0,label:D!==0?"Remarks (Required - File operations performed)":"Remarks (Required for updates)",name:"remarks",value:(r==null?void 0:r.remarks)||"",onChange:h,multiline:!0,rows:3,required:!0,error:D!==0&&!((A=r==null?void 0:r.remarks)!=null&&A.trim()),helperText:D!==0?"Remarks are required when file operations are performed":"Please provide remarks explaining the changes made to this ticket",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{name:"priority",value:r.priority||"Medium",label:"Priority",onChange:h,sx:{borderRadius:2},children:[e.jsx(u,{value:"Low",children:"Low"}),e.jsx(u,{value:"Medium",children:"Medium"}),e.jsx(u,{value:"High",children:"High"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{name:"status",value:r.status||"pending",label:"Status",onChange:h,sx:{borderRadius:2},children:[e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"in_progress",children:"In Progress"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Send To"}),e.jsxs(X,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,sx:{borderRadius:2},children:[e.jsx(Xe,{children:"Department Heads"}),P.filter(n=>n.head).map(n=>e.jsxs(u,{value:n.head.id,children:[n.head.firstname," ",n.head.lastname," (Dept Head, ",n.name,")"]},n.head.id))]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(se,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(k,{sx:{mt:3},children:[e.jsx(y,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),v.length===0&&e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),v.length>0&&e.jsx(Sr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:v.map(n=>{const g=n.file_name||n.name||"Unknown File";return e.jsxs(Wr.Fragment,{children:[e.jsxs(vr,{secondaryAction:e.jsx(V,{title:"Delete file",arrow:!0,children:e.jsx(ae,{edge:"end",onClick:()=>I(n.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(ke,{fontSize:"small"})})}),children:[e.jsx(Cr,{children:e.jsx(Tr,{})}),e.jsx(Fr,{primary:e.jsx(V,{title:"Click to download file",arrow:!0,children:e.jsx(y,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(n.file){const s=URL.createObjectURL(n.file),T=document.createElement("a");T.href=s,T.download=n.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(s)}else{const s=localStorage.getItem("token"),T=`/api/files/${n.id}/download`;fetch(T,{headers:{Authorization:`Bearer ${s}`}}).then(S=>{if(S.ok)return S.blob();throw new Error("Download failed")}).then(S=>{const d=URL.createObjectURL(S),W=document.createElement("a");W.href=d,W.download=n.name,document.body.appendChild(W),W.click(),document.body.removeChild(W),URL.revokeObjectURL(d)}).catch(S=>{console.error("Download error:",S)})}},children:g})}),secondary:e.jsxs(y,{variant:"caption",color:"text.disabled",children:[n.uploadedAt?new Date(n.uploadedAt).toLocaleString():"â€”"," â€¢ ",kr(n.file_size||n.size||0)]})})]}),e.jsx(Dr,{variant:"inset",component:"li"})]},n.id)})}),e.jsxs(G,{variant:"outlined",component:"label",startIcon:e.jsx(sr,{}),disabled:b||v.length>=5,sx:{mt:1},children:[b?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:n=>{const g=n.target.files[0];g&&_(g)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:b||v.length>=5})]}),e.jsx(k,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(de,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(G,{onClick:j,disabled:D!==0,children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:B,disabled:b||D!==0&&!((L=r==null?void 0:r.remarks)!=null&&L.trim()),sx:{minWidth:100},children:b?e.jsx(we,{size:20}):"Update Ticket"})]})]}):null},pr={title:"",description:"",priority:"Medium",status:"pending",sendTo:"",due_date:"",departmentId:"",desired_action:"",remarks:""},Us=()=>{const l=Se(),j=Ze(l.breakpoints.down("sm")),{user:r}=hs(),{id:h}=Ss(),v=vs(),{tickets:_,assignedTickets:I,forwardedTickets:P,loading:B,actionLoading:b,departments:D,users:A,createTicket:L,updateTicket:n,deleteTicket:g,loadTicketFiles:s,uploadTicketFile:T,deleteTicketFile:S,downloadTicketFile:d,getTicketFiles:W,addComment:f,loadComments:w,deleteComment:R,refreshTickets:J}=Cs(),[ce,_e]=t.useState(""),[ve,Ee]=t.useState("all"),[Ce,Re]=t.useState("all"),[ee,Ie]=t.useState(0),[xe,Te]=t.useState(pr),[re,pe]=t.useState([]),[ne,i]=t.useState(null),[a,p]=t.useState(null),[m,c]=t.useState([]),[z,E]=t.useState(0),[M,q]=t.useState(null),[H,Z]=t.useState(!1),[ge,ue]=t.useState(A),[tr,je]=t.useState(!1),[_r,Pe]=t.useState(!1),[Er,Le]=t.useState(!1),[ar,N]=t.useState({open:!1,message:""}),[nr,ye]=t.useState({open:!1,message:""}),Fe=(r==null?void 0:r.role)==="department_head"||(r==null?void 0:r.role)==="Department Head",be=r==null?void 0:r.id,De=ys(_,I,P,ce,ve,Ce,ee,be);t.useEffect(()=>{if(h&&(_.length>0||I.length>0||P.length>0)){const x=[..._,...I,...P].find(F=>F.id===h);x?(i(x),je(!0)):v("/app/tickets")}},[h,_,I,P,v]),t.useEffect(()=>{H&&(async()=>{try{const x=Array.isArray(A)?A:[];let F=[];try{F=(await he.getAll({role:"admin"})).data||[]}catch{F=x.filter(Be=>(Be.role||"").toLowerCase()==="admin")}const U=[...x];F.forEach(me=>{U.some(Be=>Be.id===me.id)||U.push(me)});const K=U.filter(me=>me.id!==be);ue(K)}catch{const x=Array.isArray(A)?A:[];ue(x.filter(F=>F.id!==be))}})()},[H,A,be]);const or=t.useCallback(()=>{Te(pr),pe([])},[]),Rr=t.useCallback(o=>{const{name:x,value:F}=o.target;Te(U=>({...U,[x]:F}))},[]),Ir=t.useCallback(async o=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(o.type)){N({open:!0,message:"Only PDF and image files are allowed."});return}const F=10*1024*1024;if(o.size>F){N({open:!0,message:"File size must be less than 10MB."});return}if(re.length>=5){N({open:!0,message:"Maximum 5 files allowed."});return}const U=xr(o,r);pe(K=>[...K,U])}catch{N({open:!0,message:"Failed to prepare file for upload."})}},[r,re.length]),Pr=t.useCallback(async o=>{try{pe(x=>x.filter(F=>F.id!==o))}catch{N({open:!0,message:"Failed to remove file."})}},[]),Lr=t.useCallback(async o=>{try{const x=re.find(F=>F.id===o);ur(x)}catch{N({open:!0,message:"Failed to download file."})}},[re]),Nr=t.useCallback(async()=>{const o=mr(xe,!1);if(o.length>0){N({open:!0,message:o[0]});return}try{const x=hr(xe,Fe,r),F=await L(x,re);F.success?(or(),Z(!1),ye({open:!0,message:"Ticket created successfully!"})):N({open:!0,message:F.error})}catch(x){N({open:!0,message:x.message||"Failed to create ticket. Please try again."})}},[xe,re,Fe,r,L,or]),Br=t.useCallback(async o=>{try{const x=await g(o);x.success?(Le(!1),q(null),ye({open:!0,message:"Ticket deleted successfully!"})):N({open:!0,message:x.error||"Failed to delete ticket"})}catch(x){console.error("Delete ticket error:",x),N({open:!0,message:x.message||"Failed to delete ticket. Please try again."})}},[g]),ir=t.useCallback(async o=>{i(o),await s(o.id),je(!0)},[s]),Ne=t.useCallback(async o=>{const x=bs(o);p(x),E(0);try{const F=await s(o.id);c(Array.isArray(F)?F:[])}catch(F){console.error("Error loading ticket files:",F),c([])}Pe(!0)},[s]),Mr=t.useCallback(o=>{const{name:x,value:F}=o.target;p(U=>({...U,[x]:F}))},[]),Ur=t.useCallback(async()=>{const o=mr(a,!0);if(o.length>0){N({open:!0,message:o[0]});return}try{const x=hr(a,Fe,r),F=await n(x);if(F.success){const U=m.filter(K=>K.id.startsWith("temp-"));if(U.length>0&&(a!=null&&a.id))try{for(const K of U)await T(K.file,a.id)}catch(K){console.error("Error uploading temp files:",K)}Pe(!1),p(null),c([]),ye({open:!0,message:"Ticket updated successfully!"})}else N({open:!0,message:F.error})}catch(x){N({open:!0,message:x.message||"Failed to update ticket. Please try again."})}},[a,m,Fe,r,n,T]),lr=t.useCallback(async()=>{try{await J()}catch(o){console.error("Error refreshing tickets:",o)}},[J]),Hr=t.useCallback(async o=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(o.type)){N({open:!0,message:"Only PDF and image files are allowed."});return}const F=10*1024*1024;if(o.size>F){N({open:!0,message:"File size must be less than 10MB."});return}if(m.length>=5){N({open:!0,message:"Maximum 5 files allowed."});return}if(a!=null&&a.id){await T(o,a.id);const U=await s(a.id);c(Array.isArray(U)?U:[])}else{const U=xr(o,r);c(K=>[...K,U])}E(U=>U+1)}catch(x){console.error("Error uploading file:",x),N({open:!0,message:"Failed to upload file."})}},[a,m.length,r,T,s]),Or=t.useCallback(async o=>{try{if(a!=null&&a.id){await S(a.id,o);const x=await s(a.id);c(Array.isArray(x)?x:[])}else c(x=>x.filter(F=>F.id!==o));E(x=>x-1)}catch(x){console.error("Error deleting file:",x),N({open:!0,message:"Failed to delete file."})}},[a,S,s]),qr=t.useCallback(async o=>{try{if(a!=null&&a.id)await d(a.id,o);else{const x=m.find(F=>F.id===o);ur(x)}}catch(x){console.error("Error downloading file:",x),N({open:!0,message:"Failed to download file."})}},[a,m,d]),$r=t.useCallback(async o=>{try{await S(ne.id,o),ye({open:!0,message:"File deleted successfully!"})}catch{N({open:!0,message:"Failed to delete file."})}},[ne,S]),Vr=t.useCallback(async o=>{try{await d(ne.id,o)}catch{N({open:!0,message:"Failed to download file."})}},[ne,d]),dr=t.useCallback(o=>{q(o),Le(!0)},[]),Gr=t.useCallback(()=>{N({open:!1,message:""})},[]),Jr=t.useCallback(()=>{ye({open:!1,message:""})},[]),Kr=t.useCallback(()=>{Le(!1)},[]),Qr=t.useCallback(()=>{Z(!1)},[]),Yr=t.useCallback(()=>{je(!1),i(null),h&&v("/app/tickets")},[h,v]),Xr=t.useCallback(()=>{Pe(!1),E(0)},[]);return t.useEffect(()=>{const o=()=>{J()};return window.addEventListener("ticket_update",o),window.addEventListener("new_comment",o),window.addEventListener("notification",o),window.addEventListener("user_update",o),window.addEventListener("task_update",o),()=>{window.removeEventListener("ticket_update",o),window.removeEventListener("new_comment",o),window.removeEventListener("notification",o),window.removeEventListener("user_update",o),window.removeEventListener("task_update",o)}},[J]),B?e.jsx(fs,{message:"Loading tickets...",size:"large"}):e.jsxs(k,{sx:{p:{xs:2,md:4},backgroundColor:l.palette.background.default,minHeight:"100vh"},children:[e.jsx(ws,{title:"Tickets Management",subtitle:"Track and manage support tickets and requests for your department",emoji:"ðŸŽ«",color:"primary",onRefresh:lr,actionButton:{text:"New Ticket",icon:e.jsx(cs,{}),onClick:()=>Z(!0),disabled:b}}),e.jsx(zs,{open:ar.open,message:ar.message,onClose:Gr}),e.jsx(As,{open:nr.open,message:nr.message,onClose:Jr}),e.jsx(k,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(xs,{in:!0,timeout:800,children:e.jsxs(k,{children:[e.jsx(Ts,{activeTab:ee,setActiveTab:Ie,searchQuery:ce,setSearchQuery:_e,filter:ve,setFilter:Ee,priorityFilter:Ce,setPriorityFilter:Re,isMobile:j}),e.jsxs(k,{sx:{mt:2,mb:2},children:[e.jsxs(y,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:[ee===0?"Sent Tickets":ee===1?"Received Tickets":"Forwarded by Me"," (",De.length,")"]}),De.length===0?e.jsx(k,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(y,{variant:"body1",children:_.length===0?"No tickets found. Create your first ticket to get started.":"No tickets match your current filters. Try adjusting your search criteria."})}):e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(Fs,{tickets:De,departments:D,users:A,activeTab:ee,onViewTicket:ir,onEditTicket:Ne,onDeleteTicket:dr,getStatusColor:$e,getStatusIcon:fr,getPriorityColor:qe,getPriorityIcon:Oe})}),e.jsx(k,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(C,{container:!0,spacing:2,children:De.map(o=>e.jsx(C,{item:!0,xs:12,children:e.jsx(Ds,{ticket:o,departments:D,users:A,activeTab:ee,onViewTicket:ir,onEditTicket:Ne,onDeleteTicket:dr,getPriorityColor:qe,getPriorityIcon:Oe,getStatusColor:$e,getTicketFiles:W})},o.id))})})]})]})]})})}),e.jsx(ks,{open:Er,ticket:M,onClose:Kr,onConfirm:()=>Br(M==null?void 0:M.id),loading:b}),e.jsx(_s,{open:H,onClose:Qr,newTicket:xe,onTicketChange:Rr,newTicketFiles:re,onFileUpload:Ir,onFileDelete:Pr,onFileDownload:Lr,departments:D,users:ge,onSubmit:Nr,loading:b,isMobile:j,currentUserId:be}),e.jsx(Es,{open:tr,onClose:Yr,ticket:ne,departments:D,users:A,getStatusColor:$e,getStatusIcon:fr,getPriorityColor:qe,getPriorityIcon:Oe,getTicketFiles:W,onRefresh:lr,onFileDelete:$r,onFileDownload:Vr,onEdit:Ne,isMobile:j,addComment:f,loadComments:w,deleteComment:R,activeTab:ee}),e.jsx(Rs,{open:_r,onClose:Xr,ticket:a,onTicketChange:Mr,editingTicketFiles:m,onFileUpload:Hr,onFileDelete:Or,onFileDownload:qr,departments:D,users:A,onSubmit:Ur,loading:b,fileOperationsCount:z})]})};export{Us as default};
