import{u as Pe,r as a,j as e,B as C,bd as Se,S as Re,am as Ce,F as I,G as Ie,H as le,b as N,av as p,aA as d,be as G,I as U,b9 as V,ar as Y,ba as Z,bf as Le,a6 as v,al as J,ae as K,z as D,Z as Q,a7 as x,ap as de,aw as Te,ax as Ae,ay as De,m as ke,e as Ee,v as Fe,w as We,x as qe,y as ze}from"./mui-BfuGcMOQ.js";import{u as Be,L as Oe,m as He,l as k}from"./index-zj4GpNED.js";import{R as ce,P as Me,r as g,h as me}from"./PasswordStrengthIndicator-BMm_ZNnI.js";import{u as _e}from"./router-DwSTIDLU.js";import"./vendor-Ckhrjn13.js";const Ye=()=>{const ue=_e(),o=Pe(),{login:pe,user:E}=Be(),[h,X]=a.useState(0),[F,ge]=a.useState(!1),[L,u]=a.useState(""),[f,T]=a.useState(!1),[P,ee]=a.useState(!1),[W,b]=a.useState(null),[S,xe]=a.useState({email:"",password:""}),[j,te]=a.useState(!1),[q,l]=a.useState(""),[c,z]=a.useState(!1),[m,B]=a.useState(!1),[O,w]=a.useState(null),[H,he]=a.useState([]),[i,re]=a.useState({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),[fe,M]=a.useState(!1),[_,be]=a.useState(""),[A,se]=a.useState(!1),[ae,$]=a.useState(""),[oe,ie]=a.useState("");a.useEffect(()=>{E&&E.isAuthenticated&&localStorage.removeItem("loginTab")},[E]),a.useEffect(()=>{const r=setTimeout(()=>T(!1),800);return()=>clearTimeout(r)},[]),a.useEffect(()=>{h===1&&H.length===0&&(async()=>{try{const n=await k.getDepartments();he(n.data)}catch{}})()},[h,H.length]);const ne=r=>{const{name:n,value:s}=r.target;xe(t=>({...t,[n]:s})),L&&u("")},je=async r=>{if(r.preventDefault(),!S.email||!S.password){u("Please fill in all fields");return}if(!g.canRetry("login")){const s=g.getRemainingRetryTime("login");u(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}T(!0),u(""),ee(!1),b(null);const n=setTimeout(()=>{T(!1)},3e4);try{const s=await k.login(S),{data:t}=s;if(t&&t.token){clearTimeout(n),ee(!0),g.clearRetryTimer("login");const R={user:t.user,token:t.token};pe(R),setTimeout(()=>{ue("/app/dashboard")},1e3)}else throw new Error("Invalid response from server")}catch(s){console.error("Login error:",s),console.log("Error response:",s.response),console.log("Error data:",s.response?.data),clearTimeout(n),T(!1);try{const t=me(s);if(console.log("Error info from handleApiError:",t),t.type==="rate_limit"){const R=t.rateLimitData||{error:"Too many authentication attempts, please try again later",retryAfter:"15 minutes",limit:void 0,remaining:void 0,reset:void 0};b(R),g.setRetryTimer("login",t.retryTime||900*1e3),u("")}else u(t.message),b(null)}catch(t){console.error("Error handling failed:",t),u("An error occurred. Please try again later."),b(null)}}},y=r=>{const{name:n,value:s}=r.target;re(t=>({...t,[n]:s})),q&&l("")},we=()=>!i.firstname||!i.lastname||!i.email||!i.password||!i.confirmPassword||!i.departmentId?(l("Please fill in all fields"),!1):i.password!==i.confirmPassword?(l("Passwords do not match"),!1):i.password.length<8?(l("Password must be at least 8 characters long"),!1):!0,ye=async r=>{if(r.preventDefault(),!we())return;if(!g.canRetry("register")){const s=g.getRemainingRetryTime("register");l(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}z(!0),l(""),B(!1),w(null);const n=setTimeout(()=>{z(!1)},3e4);try{const s={...i};delete s.confirmPassword,(await k.register(s)).data&&(clearTimeout(n),B(!0),g.clearRetryTimer("register"),re({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),setTimeout(()=>{X(0),B(!1),l("")},2e3))}catch(s){console.error("Registration error:",s),console.log("Registration error response:",s.response),console.log("Registration error data:",s.response?.data),clearTimeout(n),z(!1);try{const t=me(s);if(console.log("Registration error info from handleApiError:",t),t.type==="rate_limit"){const R=t.rateLimitData||{error:"Too many registration attempts, please try again later",retryAfter:"15 minutes",limit:void 0,remaining:void 0,reset:void 0};w(R),g.setRetryTimer("register",t.retryTime||900*1e3),l("")}else l(t.message),w(null)}catch(t){console.error("Registration error handling failed:",t),l("An error occurred. Please try again later."),w(null)}}},ve=(r,n)=>{X(n),u(""),l("")};return f&&!L?e.jsx(Oe,{overlay:!0,message:"Loading login..."}):e.jsxs(C,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",background:o.palette.mode==="dark"?o.palette.background.default:`linear-gradient(to right bottom, ${o.palette.primary.light}, ${o.palette.primary.main})`,py:8,position:"relative",overflow:"hidden"},children:[e.jsx(Se,{component:"main",maxWidth:"sm",children:e.jsx(Re,{direction:"up",in:!0,timeout:800,children:e.jsxs(Ce,{elevation:o.palette.mode==="dark"?2:8,sx:{p:{xs:3,sm:6},display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:o.palette.mode==="dark"?o.palette.background.paper:o.palette.common.white,borderRadius:3,position:"relative",backdropFilter:"blur(10px)",border:`1px solid ${o.palette.mode==="dark"?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"}`,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"},children:[e.jsx(I,{in:!0,timeout:1200,children:e.jsx(C,{sx:{width:80,height:80,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",mb:2,boxShadow:"0 4px 20px rgba(0,0,0,0.1)"},children:e.jsx(C,{component:"img",src:He,alt:"Mito Logo",sx:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover"}})})}),e.jsxs(Ie,{value:h,onChange:ve,sx:{mb:3},centered:!0,children:[e.jsx(le,{label:"Sign In"}),e.jsx(le,{label:"Sign Up"})]}),h===0&&e.jsxs(C,{sx:{textAlign:"center",mb:2},children:[e.jsx(N,{variant:"h4",color:"primary",sx:{fontWeight:"bold",fontSize:24,mt:.75},children:"Welcome Back"}),e.jsx(N,{variant:"body1",color:"text.secondary",sx:{fontSize:14,mt:.25},children:"Sign in to continue"})]}),h===0&&e.jsxs("form",{onSubmit:je,style:{width:"100%"},children:[e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:S.email,onChange:ne,disabled:f||P,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}}),e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:F?"text":"password",id:"password",autoComplete:"current-password",value:S.password,onChange:ne,disabled:f||P,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Z,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>ge(!F),edge:"end",disabled:f||P,children:F?e.jsx(V,{}):e.jsx(Y,{})})})}}),e.jsx(C,{sx:{display:"flex",justifyContent:"flex-end",mt:1,mb:2},children:e.jsx(Le,{component:"button",type:"button",variant:"body2",underline:"hover",onClick:r=>{r.preventDefault(),r.stopPropagation(),M(!0)},sx:{border:"none",background:"none",cursor:"pointer",color:o.palette.primary.main,"&:hover":{color:o.palette.primary.dark}},children:"Forgot password?"})}),e.jsx(ce,{isOpen:!!W,onClose:()=>b(null),rateLimitData:W,endpoint:"login",onRetry:()=>{b(null),u("")}}),L&&!W&&e.jsx(I,{in:!0,children:e.jsx(v,{severity:"error",sx:{width:"100%",mb:2},icon:e.jsx(J,{}),children:L})}),P&&e.jsx(I,{in:!0,children:e.jsx(v,{severity:"success",sx:{width:"100%",mb:2},icon:e.jsx(K,{}),children:"Login successful! Redirecting..."})}),e.jsx(D,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:f||P,children:f?e.jsx(Q,{size:24,color:"inherit"}):"Sign In"})]}),h===1&&e.jsxs("form",{onSubmit:ye,style:{width:"100%"},children:[e.jsxs(x,{container:!0,spacing:2,children:[e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"firstname",label:"First Name",name:"firstname",autoComplete:"given-name",value:i.firstname,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(de,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"lastname",label:"Last Name",name:"lastname",autoComplete:"family-name",value:i.lastname,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(de,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(p,{required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",value:i.email,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,children:e.jsxs(Te,{fullWidth:!0,required:!0,children:[e.jsx(Ae,{id:"department-label",children:"Department"}),e.jsx(De,{labelId:"department-label",id:"departmentId",name:"departmentId",value:i.departmentId,label:"Department",onChange:y,disabled:c||m,startAdornment:e.jsx(d,{position:"start",children:e.jsx(Ee,{color:"action"})}),children:H.map(r=>e.jsx(ke,{value:r.id,children:r.name},r.id))})]})}),e.jsxs(x,{item:!0,xs:12,sm:6,children:[e.jsx(p,{required:!0,fullWidth:!0,name:"password",label:"Password",type:j?"text":"password",id:"register-password",autoComplete:"new-password",value:i.password,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Z,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>te(!j),edge:"end",disabled:c||m,children:j?e.jsx(V,{}):e.jsx(Y,{})})})}}),e.jsx(Me,{password:i.password})]}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:j?"text":"password",id:"register-confirm-password",autoComplete:"new-password",value:i.confirmPassword,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Z,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>te(!j),edge:"end",disabled:c||m,children:j?e.jsx(V,{}):e.jsx(Y,{})})})}})})]}),e.jsx(ce,{isOpen:!!O,onClose:()=>w(null),rateLimitData:O,endpoint:"register",onRetry:()=>{w(null),l("")}}),q&&!O&&e.jsx(I,{in:!0,children:e.jsx(v,{severity:"error",sx:{width:"100%",mt:2},icon:e.jsx(J,{}),children:q})}),m&&e.jsx(I,{in:!0,children:e.jsx(v,{severity:"success",sx:{width:"100%",mt:2},icon:e.jsx(K,{}),children:"Registration successful! You will be redirected to login in a few seconds..."})}),e.jsx(D,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:c||m,children:c?e.jsx(Q,{size:24,color:"inherit"}):"Register"})]})]})})}),e.jsxs(Fe,{open:fe,onClose:()=>M(!1),maxWidth:"xs",fullWidth:!0,PaperProps:{sx:{borderRadius:3,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"}},children:[e.jsx(We,{sx:{pb:1,fontWeight:600,color:o.palette.text.primary},children:"Forgot Password"}),e.jsxs(qe,{sx:{pt:2},children:[e.jsx(N,{variant:"body2",sx:{mb:3,color:o.palette.text.secondary},children:"Enter your email address and we'll send you a link to reset your password."}),e.jsx(p,{label:"Email Address",type:"email",fullWidth:!0,margin:"normal",value:_,onChange:r=>be(r.target.value),disabled:A,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}}),ae&&e.jsx(v,{severity:"error",sx:{mt:2},icon:e.jsx(J,{}),children:ae}),oe&&e.jsx(v,{severity:"success",sx:{mt:2},icon:e.jsx(K,{}),children:oe})]}),e.jsxs(ze,{sx:{px:3,pb:3},children:[e.jsx(D,{onClick:()=>M(!1),disabled:A,sx:{color:o.palette.text.secondary,"&:hover":{color:o.palette.text.primary}},children:"Cancel"}),e.jsx(D,{onClick:async()=>{if($(""),ie(""),!_){$("Please enter your email address.");return}se(!0);try{await k.forgotPassword({email:_}),ie("If an account with that email exists, a reset link has been sent.")}catch(r){$(r.response?.data?.error||"Failed to send reset email.")}finally{se(!1)}},variant:"contained",color:"primary",disabled:A,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:600,px:3,minWidth:"120px",height:"36px"},children:A?e.jsx(Q,{size:20,color:"inherit"}):"Send Reset Link"})]})]})]})};export{Ye as default};
