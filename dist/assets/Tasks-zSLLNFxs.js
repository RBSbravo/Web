import{j as e,aj as He,ak as Ye,k as Pe,B as o,b as g,I as q,al as Je,d as $,V as qe,am as Ge,an as pe,h as O,ao as De,ap as Ae,J as ge,l as Ie,m as R,Q as K,aq as ie,ar as ae,ab as Fe,u as Ee,a1 as ue,t as Re,v as Ue,w as _e,a4 as E,as as ee,at as te,au as se,av as re,y as Q,aw as Xe,a3 as Ze,x as Be,H as et,a5 as Qe,a6 as tt,ax as st,ay as rt,az as it,aA as at,aB as nt,aC as Le,aD as M,aE as lt,aF as ot,F as dt,a2 as ct}from"./mui-DaYlJXyD.js";import{r as n}from"./vendor-Cr2nE3UY.js";import{c as ze,f as We,u as mt,t as L,b as xt,d as Ne,L as ht}from"./index-B2R0mN4_.js";import{g as ut,a as pt,f as ne,C as gt,F as ft}from"./FileUploadSection-BRV5pRdO.js";import{c as jt,u as bt}from"./router-B4FNaIx_.js";import{P as yt}from"./PageHeader-DlP9MJR_.js";const fe=t=>{switch(t){case"high":return"error";case"medium":return"warning";case"low":return"success";default:return"default"}},je=t=>{switch(t){case"completed":return"success";case"in_progress":return"primary";case"pending":return"warning";default:return"default"}},be=t=>t?t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:t.firstname&&t.lastname?`${t.firstname} ${t.lastname}`:t.username||t.email||t.id:"Unassigned",Me=t=>ut({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),Oe=t=>pt({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),wt=t=>{const s={};return(!t.title||t.title.trim().length<3)&&(s.title="Title must be at least 3 characters long"),(!t.description||t.description.trim().length<10)&&(s.description="Description must be at least 10 characters long"),t.dueDate||(s.dueDate="Due date is required"),(!t.priority||!["low","medium","high"].includes(t.priority))&&(s.priority="Priority must be low, medium, or high"),{isValid:Object.keys(s).length===0,errors:s}},he=()=>({title:"",description:"",priority:"medium",status:"pending",dueDate:"",assignedToId:"",attachments:[],relatedTicketId:"",remarks:""}),Ve=(t,s={})=>{var m,f,F;const i={title:(m=t.title)==null?void 0:m.trim(),description:(f=t.description)==null?void 0:f.trim(),priority:t.priority,status:t.status,dueDate:t.dueDate||null,assignedToId:t.assignedToId||null,relatedTicketId:t.relatedTicketId||null,remarks:(F=t.remarks)==null?void 0:F.trim(),...s};return Object.keys(i).forEach(I=>{(i[I]===""||i[I]===void 0)&&delete i[I]}),delete i.attachments,i},Ke=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"}],Tt=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}],St=[{value:"all",label:"All Status"},...Ke];n.memo(function({task:s,departmentUsers:i,canUpdateTask:m,selectedTasks:f,updatingStatus:F,updatingPriority:I,onSelectTask:z,onViewDetails:x,onEditTask:T,onDeleteTask:u,onUpdateStatus:y,onUpdatePriority:j}){const[S,d]=n.useState(null),[c,p]=n.useState(null),[U,k]=n.useState(null),b=B=>{switch(B){case"completed":return e.jsx(Fe,{});case"in_progress":return e.jsx(ae,{});case"pending":return e.jsx(ie,{});default:return e.jsx(K,{})}},W=B=>d(B.currentTarget),a=()=>d(null),h=()=>{x(s),a()},_=()=>{T(s),a()},D=()=>{u(s),a()},N=i.find(B=>B.id===s.assignedToId),A=be(N);return e.jsxs(He,{elevation:2,sx:{p:{xs:1,sm:1.5,md:2},borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.08)",display:"flex",flexDirection:"row",alignItems:"center",minHeight:{xs:64,sm:72,md:80},mb:1,background:{xs:"rgba(0,0,0,0.01)",sm:"rgba(0,0,0,0.01)",md:"inherit"},"&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.12)",transform:"translateY(-1px)",transition:"all 0.2s ease-in-out"}},tabIndex:0,"aria-label":`Task: ${s.title}`,children:[e.jsx(Ye,{checked:f.includes(s.id),onChange:()=>z(s.id),size:"small",sx:{mr:1,flexShrink:0}}),e.jsx(Pe,{sx:{bgcolor:"primary.main",width:{xs:32,sm:36,md:40},height:{xs:32,sm:36,md:40},boxShadow:"0 1px 4px rgba(0,0,0,0.08)",flexShrink:0,mr:{xs:1,sm:1.5,md:2}},children:b(s.status)}),e.jsxs(o,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:{xs:"column",md:"row"},gap:{xs:.5,sm:.8,md:1},alignItems:{md:"center"}},children:[e.jsxs(o,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:{xs:.3,sm:.4,md:.5}},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx(g,{variant:"subtitle1",component:"div",sx:{fontWeight:700,fontSize:{xs:"0.98rem",sm:"1.05rem",md:"1.12rem",lg:"1.18rem"},letterSpacing:.1,lineHeight:1.2,color:"text.primary",wordBreak:"break-word",flex:1,minWidth:0},noWrap:!0,children:s.title}),e.jsx(q,{sx:{color:"text.secondary","&:hover":{color:"primary.main",background:"rgba(46,125,50,0.08)"},width:{xs:28,sm:32,md:36},height:{xs:28,sm:32,md:36},borderRadius:2,border:"1px solid",borderColor:"divider",bgcolor:"background.default",boxShadow:"0 1px 4px rgba(0,0,0,0.04)",fontSize:"1rem",ml:1,flexShrink:0,display:{xs:"flex",md:"none"}},onClick:W,size:"small","aria-label":"Task actions",children:e.jsx(Je,{fontSize:"inherit"})})]}),e.jsx(g,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.82rem",sm:"0.85rem",md:"0.88rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxHeight:{xs:16,sm:20,md:24},overflow:"hidden",textOverflow:"ellipsis",width:"100%",display:{xs:"block",md:"-webkit-box"},WebkitLineClamp:{xs:1,md:2},WebkitBoxOrient:{xs:"horizontal",md:"vertical"}},noWrap:!1,children:s.description})]}),e.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"flex-start",md:"center"},gap:{xs:.5,sm:.8,md:1.5},flexShrink:0,minWidth:{md:"fit-content"}},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:.6,md:.8},flexWrap:"wrap",order:{xs:1,md:1}},children:[e.jsx($,{label:s.priority,size:"small",color:fe(s.priority),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?B=>k(B.currentTarget):void 0,clickable:m,disabled:I===s.id}),e.jsx($,{label:(s.status||"").replace("_"," "),size:"small",color:je(s.status),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?B=>p(B.currentTarget):void 0,clickable:m,disabled:F===s.id}),(F===s.id||I===s.id)&&e.jsx(qe,{size:12,sx:{ml:.5}})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.7,sm:1,md:1.5},flexWrap:"wrap",order:{xs:2,md:2}},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(Ge,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(g,{variant:"caption",color:A!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontStyle:A!=="Unassigned"?"normal":"italic",whiteSpace:"nowrap"},component:"span",children:A})]}),s.dueDate&&e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(pe,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(g,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},whiteSpace:"nowrap"},component:"span",children:ne(s.dueDate)})]})]})]})]}),e.jsx(o,{sx:{display:{xs:"none",md:"flex"},alignItems:"center",gap:1,ml:2},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5,bgcolor:"background.paper",borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.07)",px:1,py:.5,border:"1px solid",borderColor:"grey.200"},children:[e.jsx(O,{title:"View Details",children:e.jsx(q,{sx:{color:"primary.main",bgcolor:"grey.100","&:hover":{bgcolor:"primary.light",color:"white"},width:32,height:32,borderRadius:2},onClick:h,size:"small",children:e.jsx(De,{fontSize:"small"})})}),e.jsx(O,{title:"Edit Task",children:e.jsx(q,{sx:{color:"info.main",bgcolor:"grey.100","&:hover":{bgcolor:"info.main",color:"white"},width:32,height:32,borderRadius:2},onClick:_,size:"small",children:e.jsx(Ae,{fontSize:"small"})})}),e.jsx(O,{title:"Delete Task",children:e.jsx(q,{sx:{color:"error.main",bgcolor:"grey.100","&:hover":{bgcolor:"error.main",color:"white"},width:32,height:32,borderRadius:2},onClick:D,size:"small",children:e.jsx(ge,{fontSize:"small"})})})]})}),e.jsxs(Ie,{anchorEl:S,open:!!S,onClose:a,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[e.jsx(R,{onClick:h,children:"View Details"}),e.jsx(R,{onClick:_,children:"Edit"}),e.jsx(R,{onClick:D,sx:{color:"error.main"},children:"Delete"})]}),e.jsxs(Ie,{anchorEl:c,open:!!c,onClose:()=>p(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(R,{onClick:()=>{y(s.id,"pending"),p(null)},disabled:s.status==="pending",children:"Pending"}),e.jsx(R,{onClick:()=>{y(s.id,"in_progress"),p(null)},disabled:s.status==="in_progress",children:"In Progress"}),e.jsx(R,{onClick:()=>{y(s.id,"completed"),p(null)},disabled:s.status==="completed",children:"Completed"})]}),e.jsxs(Ie,{anchorEl:U,open:!!U,onClose:()=>k(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(R,{onClick:()=>{j(s.id,"low"),k(null)},disabled:s.priority==="low",children:"Low"}),e.jsx(R,{onClick:()=>{j(s.id,"medium"),k(null)},disabled:s.priority==="medium",children:"Medium"}),e.jsx(R,{onClick:()=>{j(s.id,"high"),k(null)},disabled:s.priority==="high",children:"High"})]})]})});const $e=({open:t,onClose:s,onSubmit:i,initialData:m=null,departmentUsers:f=[],pendingTickets:F=[],loading:I=!1,mode:z="create"})=>{const x=Ee(),T=ue(x.breakpoints.down("sm")),[u,y]=n.useState(he()),[j,S]=n.useState({}),[d,c]=n.useState("");n.useEffect(()=>{t&&(console.log("TaskForm opened with pendingTickets:",F),y(m&&z==="edit"?{...he(),...m,title:m.title||"",description:m.description||"",priority:m.priority||"medium",status:m.status||"pending",dueDate:m.dueDate||"",assignedToId:m.assignedToId||"",relatedTicketId:m.relatedTicketId||"",attachments:m.attachments||[]}:he()),S({}),c(""))},[t,m,z]);const p=a=>{const{name:h,value:_}=a.target;y(D=>({...D,[h]:_})),j[h]&&S(D=>({...D,[h]:""}))},U=a=>{const h=Array.from(a.target.files||[]);if(h.length===0)return;const _=["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"],D=[],N=[];if(h.forEach(A=>{_.includes(A.type)?A.size>10*1024*1024?N.push(`${A.name}: File size must be less than 10MB`):D.push(A):N.push(`${A.name}: Only PDF and image files are allowed`)}),N.length>0){c(N.join(", "));return}y(A=>({...A,attachments:[...A.attachments,...D]}))},k=a=>{y(h=>({...h,attachments:h.attachments.filter((_,D)=>D!==a)}))},b=async a=>{a&&a.preventDefault&&a.preventDefault(),c("");const h=wt(u);if(!h.isValid){S(h.errors);return}try{await i(u),W()}catch(_){c(_.message||"An error occurred while saving the task")}},W=()=>{y(he()),S({}),c(""),s()};return e.jsxs(Re,{open:t,onClose:W,maxWidth:"sm",fullWidth:!0,fullScreen:T,children:[e.jsx(Ue,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:z==="create"?"Create New Task":"Edit Task"}),e.jsx(_e,{sx:{pt:{xs:1,sm:2}},children:e.jsx(o,{component:"form",onSubmit:b,sx:{mt:1},children:e.jsxs(E,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(E,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Task Title",name:"title",value:u.title,onChange:p,error:!!j.title,helperText:j.title,required:!0,sx:{mb:2}})}),e.jsx(E,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Description",name:"description",value:u.description,onChange:p,error:!!j.description,helperText:j.description,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(E,{item:!0,xs:12,sm:6,children:e.jsxs(te,{fullWidth:!0,error:!!j.priority,children:[e.jsx(se,{children:"Priority"}),e.jsx(re,{name:"priority",value:u.priority,label:"Priority",onChange:p,children:Tt.map(a=>e.jsx(R,{value:a.value,children:a.label},a.value))})]})}),z==="edit"&&e.jsxs(e.Fragment,{children:[e.jsx(E,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Remarks (Required for updates)",name:"remarks",value:u.remarks||"",onChange:p,multiline:!0,rows:3,required:!0,helperText:"Please provide remarks explaining the changes made to this task",sx:{mb:2}})}),e.jsx(E,{item:!0,xs:12,sm:6,children:e.jsxs(te,{fullWidth:!0,children:[e.jsx(se,{children:"Status"}),e.jsx(re,{name:"status",value:u.status,label:"Status",onChange:p,children:Ke.map(a=>e.jsx(R,{value:a.value,children:a.label},a.value))})]})})]}),e.jsx(E,{item:!0,xs:12,sm:6,children:e.jsxs(te,{fullWidth:!0,children:[e.jsx(se,{children:"Assignee"}),e.jsxs(re,{name:"assignedToId",value:u.assignedToId,label:"Assignee",onChange:p,children:[e.jsx(R,{value:"",children:"Unassigned"}),f.filter(a=>a.role==="employee").map(a=>{const h=a.firstname&&a.lastname&&`${a.firstname} ${a.lastname}`||a.firstName&&a.lastName&&`${a.firstName} ${a.lastName}`||a.username||a.email||a.id;return e.jsx(R,{value:a.id,children:h},a.id)})]})]})}),e.jsx(E,{item:!0,xs:12,sm:6,children:e.jsx(ee,{fullWidth:!0,label:"Due Date",name:"dueDate",type:"date",value:u.dueDate,onChange:p,error:!!j.dueDate,helperText:j.dueDate,InputLabelProps:{shrink:!0},required:!0})}),e.jsx(E,{item:!0,xs:12,sm:6,children:e.jsxs(te,{fullWidth:!0,children:[e.jsx(se,{children:"Related Pending Ticket"}),e.jsxs(re,{name:"relatedTicketId",value:u.relatedTicketId||"",label:"Related Pending Ticket",onChange:p,children:[e.jsx(R,{value:"",children:"None"}),F.map(a=>e.jsxs(R,{value:a.id,children:[a.title," (#",a.id,")"]},a.id))]})]})}),e.jsxs(E,{item:!0,xs:12,children:[e.jsxs(Q,{variant:"outlined",component:"label",startIcon:e.jsx(Xe,{}),fullWidth:!0,sx:{mb:1},children:[z==="create"?"Attach Files (PDF & Images Only)":"Upload Additional Files (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",onChange:U})]}),e.jsx(o,{sx:{mb:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"}),u.attachments&&u.attachments.length>0&&e.jsxs(o,{sx:{mt:1},children:[e.jsx(o,{sx:{fontSize:"0.875rem",fontWeight:600,mb:1,color:"text.primary"},children:z==="create"?"Files to upload:":"Additional files to upload:"}),u.attachments.map((a,h)=>e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5,p:1,bgcolor:"grey.50",borderRadius:1},children:[e.jsxs(o,{sx:{fontSize:"0.875rem",color:"text.secondary",flex:1},children:[a.name," (",(a.size/1024/1024).toFixed(2)," MB)"]}),e.jsx(Q,{size:"small",color:"error",onClick:()=>k(h),startIcon:e.jsx(ge,{}),sx:{minWidth:"auto",px:1},children:"Remove"})]},h))]})]}),d&&e.jsx(E,{item:!0,xs:12,children:e.jsx(Ze,{severity:"error",sx:{mt:1},children:d})})]})})}),e.jsxs(Be,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(Q,{onClick:W,disabled:I,children:"Cancel"}),e.jsx(Q,{variant:"contained",onClick:b,disabled:I,sx:{minWidth:100},children:I?e.jsx(qe,{size:22,color:"inherit"}):z==="create"?"Create Task":"Save Changes"})]})]})},kt=({open:t,onClose:s,task:i,departmentUsers:m=[],user:f})=>{if(!i)return null;const F=i&&i.assignedToId&&m.find(x=>x.id===i.assignedToId),I=be(F),z=async x=>{const T=x.url||`/api/files/${x.id}/download`;try{const u=localStorage.getItem("token"),y=await fetch(T,{headers:u?{Authorization:`Bearer ${u}`}:{}});if(!y.ok)throw new Error("Failed to download file");const j=await y.blob(),S=window.URL.createObjectURL(j),d=document.createElement("a");d.href=S,d.download=x.file_name||x.name||"attachment",document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(S)}catch{alert("Failed to download file")}};return e.jsxs(Re,{open:t,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ue,{children:"Task Details"}),e.jsxs(_e,{children:[e.jsxs(o,{sx:{mb:2},children:[e.jsx(g,{variant:"h6",sx:{fontWeight:700},children:i.title}),e.jsx(g,{variant:"body2",color:"text.secondary",sx:{mb:1},children:i.description}),e.jsx(et,{sx:{my:1}}),e.jsxs(o,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:1},children:[e.jsx($,{label:i.priority,color:fe(i.priority),size:"small"}),e.jsx($,{label:(i.status||"").replace("_"," "),color:je(i.status),size:"small"})]}),e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Assigned To:"})," ",I]}),i.dueDate&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mt:1},children:[e.jsx(pe,{sx:{fontSize:16},color:"action"}),e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",ne(i.dueDate)]})]}),(()=>{const x=Me(i),T=Oe(i);return!x||!T?null:e.jsx(o,{sx:{mt:1},children:e.jsx($,{label:T,size:"small",color:x,sx:{fontSize:"0.7rem",fontWeight:600,borderRadius:2,px:.5,height:18,boxShadow:1,minWidth:60,justifyContent:"center"}})})})()]}),i.relatedTicket&&e.jsxs(o,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(g,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Related Ticket"}),e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Title:"})," ",i.relatedTicket.title]}),e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Description:"})," ",i.relatedTicket.description]}),e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Status:"})," ",i.relatedTicket.status]}),e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Priority:"})," ",i.relatedTicket.priority]}),i.relatedTicket.due_date&&e.jsxs(g,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",i.relatedTicket.due_date]}),Array.isArray(i.relatedTicket.attachments)&&i.relatedTicket.attachments.length>0&&e.jsxs(o,{sx:{mt:1},children:[e.jsx(g,{variant:"body2",sx:{fontWeight:600,mb:.5},children:"Attachments:"}),i.relatedTicket.attachments.map(x=>e.jsx(o,{sx:{mb:.5},children:e.jsx("span",{style:{color:"primary.main",textDecoration:"underline",fontSize:"0.95em",cursor:"pointer"},onClick:()=>z(x),children:x.file_name||x.name})},x.id||x.file_name))]})]})]}),e.jsx(gt,{entityId:i.id,fetchComments:ze.fetchComments,addComment:ze.addComment,deleteComment:ze.deleteComment,user:f}),e.jsx(ft,{entityId:i.id,fetchFiles:x=>We.getByEntity("task",x),uploadFile:(x,T)=>We.upload(T,"task",x),deleteFile:(x,T)=>We.delete(T),entityType:"task"})]}),e.jsx(Be,{children:e.jsx(Q,{onClick:s,children:"Close"})})]})},Ct=({searchQuery:t,filter:s,onSearchChange:i,onFilterChange:m})=>e.jsx(Qe,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsx(tt,{sx:{p:{xs:2,sm:2.5,md:3}},children:e.jsxs(E,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(E,{item:!0,xs:12,sm:8,md:6,children:e.jsx(ee,{fullWidth:!0,placeholder:"Search tasks...",value:t,onChange:f=>i(f.target.value),InputProps:{startAdornment:e.jsx(st,{position:"start",children:e.jsx(rt,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(E,{item:!0,xs:12,sm:4,md:3,children:e.jsxs(te,{fullWidth:!0,children:[e.jsx(se,{children:"Status"}),e.jsx(re,{value:s,label:"Status",onChange:f=>m(f.target.value),sx:{borderRadius:2},children:St.map(f=>e.jsx(R,{value:f.value,children:f.label},f.value))})]})})]})})}),vt=({tasks:t,departmentUsers:s,canUpdateTask:i,selectedTasks:m,updatingStatus:f,updatingPriority:F,onSelectTask:I,onViewDetails:z,onEditTask:x,onDeleteTask:T,onUpdateStatus:u,onUpdatePriority:y})=>{const j=Ee();ue(j.breakpoints.down("sm"));const S=c=>{switch(c){case"completed":return e.jsx(Fe,{});case"in_progress":return e.jsx(ae,{});case"pending":return e.jsx(ie,{});default:return e.jsx(K,{})}},d=c=>{switch(c){case"high":return e.jsx(ae,{});case"medium":return e.jsx(ie,{});case"low":return e.jsx(K,{});default:return e.jsx(K,{})}};return e.jsx(o,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(it,{component:He,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(at,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(nt,{children:e.jsxs(Le,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Assigned To"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(M,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(lt,{children:t.map((c,p)=>{const U=s.find(b=>b.id===c.assignedToId),k=be(U);return e.jsxs(Le,{hover:!0,sx:{bgcolor:p%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(M,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(Pe,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:S(c.status)})}),e.jsxs(M,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(O,{title:c.title,arrow:!0,children:e.jsx(g,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:c.title})}),e.jsx(O,{title:c.description,arrow:!0,children:e.jsx(g,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:c.description})})]}),e.jsx(M,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx($,{label:c.priority,size:"small",color:fe(c.priority),icon:d(c.priority),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})}),e.jsx(M,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx($,{label:(c.status||"").replace("_"," "),size:"small",color:je(c.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})}),e.jsx(M,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(g,{variant:"caption",color:k!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:k!=="Unassigned"?"normal":"italic"},children:k})}),e.jsx(M,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[c.dueDate&&e.jsx(O,{title:ne(c.dueDate),arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(pe,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(g,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:ne(c.dueDate)})]})}),(()=>{const b=Me(c),W=Oe(c);return!b||!W?null:e.jsx(O,{title:`Maturity: ${W}`,arrow:!0,children:e.jsx("span",{children:e.jsx($,{label:W,size:"small",color:b,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(M,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(O,{title:"View Details",children:e.jsx("span",{children:e.jsx(q,{color:"primary",size:"small",onClick:()=>z(c),children:e.jsx(De,{fontSize:"small"})})})}),e.jsx(O,{title:"Edit Task",children:e.jsx("span",{children:e.jsx(q,{color:"secondary",size:"small",onClick:()=>x(c),children:e.jsx(Ae,{fontSize:"small"})})})}),e.jsx(O,{title:"Delete Task",children:e.jsx("span",{children:e.jsx(q,{color:"error",size:"small",onClick:()=>T(c),children:e.jsx(ge,{fontSize:"small"})})})})]})})]},c.id)})})]})})})},It=({tasks:t,departmentUsers:s,canUpdateTask:i,selectedTasks:m,updatingStatus:f,updatingPriority:F,onSelectTask:I,onViewDetails:z,onEditTask:x,onDeleteTask:T,onUpdateStatus:u,onUpdatePriority:y})=>{const j=d=>{switch(d){case"completed":return e.jsx(Fe,{});case"in_progress":return e.jsx(ae,{});case"pending":return e.jsx(ie,{});default:return e.jsx(K,{})}},S=d=>{switch(d){case"high":return e.jsx(ae,{});case"medium":return e.jsx(ie,{});case"low":return e.jsx(K,{});default:return e.jsx(K,{})}};return e.jsx(o,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(E,{container:!0,spacing:2,children:t.map(d=>{const c=s.find(U=>U.id===d.assignedToId),p=be(c);return e.jsx(E,{item:!0,xs:12,children:e.jsxs(Qe,{sx:{borderRadius:3,boxShadow:3,p:2,bgcolor:"background.paper"},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(Pe,{sx:{bgcolor:"primary.main",width:28,height:28,boxShadow:"0 1px 4px rgba(0,0,0,0.08)",mr:1},children:j(d.status)}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(g,{variant:"subtitle1",sx:{fontWeight:700,fontSize:"1rem",wordBreak:"break-word"},children:d.title}),e.jsx(g,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.92rem",lineHeight:1.4,wordBreak:"break-word"},children:d.description})]})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx($,{label:d.priority,size:"small",color:fe(d.priority),icon:S(d.priority),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),e.jsx($,{label:(d.status||"").replace("_"," "),size:"small",color:je(d.status),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),(()=>{const U=Me(d),k=Oe(d);return!U||!k?null:e.jsx($,{label:k,size:"small",color:U,sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}})})()]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx(Ge,{sx:{fontSize:16},color:"action"}),e.jsx(g,{variant:"caption",color:p!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:p!=="Unassigned"?"normal":"italic"},children:p}),d.dueDate&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{sx:{fontSize:16,ml:1},color:"action"}),e.jsx(g,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.78rem"},children:ne(d.dueDate)})]})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5,justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(O,{title:"View Details",children:e.jsx("span",{children:e.jsx(q,{color:"primary",size:"small",onClick:()=>z(d),children:e.jsx(De,{})})})}),e.jsx(O,{title:"Edit Task",children:e.jsx("span",{children:e.jsx(q,{color:"secondary",size:"small",onClick:()=>x(d),children:e.jsx(Ae,{})})})}),e.jsx(O,{title:"Delete Task",children:e.jsx("span",{children:e.jsx(q,{color:"error",size:"small",onClick:()=>T(d),children:e.jsx(ge,{})})})})]})]})},d.id)})})})},zt=()=>{const{user:t}=mt(),{id:s}=jt(),i=bt(),[m,f]=n.useState([]),[F,I]=n.useState([]),[z,x]=n.useState([]),[T,u]=n.useState(!0),[y,j]=n.useState("all"),[S,d]=n.useState(""),[c,p]=n.useState(null),[U,k]=n.useState(!1),[b,W]=n.useState([]),[a,h]=n.useState(!1),[_,D]=n.useState(null),[N,A]=n.useState(null),[B,Y]=n.useState(!1),[ye,G]=n.useState(""),C=n.useCallback(async()=>{u(!0);try{let r;(t==null?void 0:t.role)==="department_head"&&(t!=null&&t.departmentId)?r=await L.getAll({departmentId:t.departmentId}):r=await L.getAll(),f(r.data)}catch(r){console.error("Failed to load tasks:",r),f([])}finally{u(!1)}},[t==null?void 0:t.role,t==null?void 0:t.departmentId]),J=n.useCallback(async()=>{if(t!=null&&t.departmentId)try{const r=await xt.getDepartmentUsers(t.departmentId);I(r.data)}catch(r){console.error("Failed to load department users:",r),I([])}},[t==null?void 0:t.departmentId]),le=n.useCallback(async()=>{try{const r=await Ne.getAssignedTickets(),l=Array.isArray(r.data)?r.data:r.data||[];console.log("Assigned tickets loaded:",l.length,l);const w=l.filter(v=>{var H;return((H=v.status)==null?void 0:H.toLowerCase())==="pending"});console.log("Pending tickets filtered:",w.length,w),x(w)}catch(r){console.error("Failed to load pending tickets:",r),x([])}},[]);n.useEffect(()=>{C(),J()},[C,J]),n.useEffect(()=>{if(s&&m.length>0){const r=m.find(l=>l.id===s);r&&(p(r),k(!0))}},[s,m]);const Z=n.useCallback(async r=>{var l,w;Y(!0);try{const v=Ve(r,{departmentId:t.departmentId}),P=await L.create(v),H=P.data||P;if(r.attachments&&r.attachments.length>0)try{for(const ve of r.attachments)await L.uploadAttachment(H.id,ve)}catch(ve){console.error("Error uploading files:",ve)}return await C(),G("Task created successfully!"),{success:!0}}catch(v){console.error("Error creating task:",v);const P=((w=(l=v==null?void 0:v.response)==null?void 0:l.data)==null?void 0:w.error)||v.message||"Failed to create task. Please try again.";throw new Error(P)}finally{setTimeout(()=>Y(!1),1e3)}},[t.departmentId,C]),we=n.useCallback(async(r,l)=>{var w,v;try{if(!(l!=null&&l.remarks)||l.remarks.trim()==="")throw new Error("Remarks are required when updating a task. Please provide remarks explaining the changes made.");const P=Ve(l);if(await L.update(r,P),l.attachments&&l.attachments.length>0)try{for(const H of l.attachments)await L.uploadAttachment(r,H)}catch(H){console.error("Error uploading files during task update:",H)}return P.relatedTicketId&&P.status&&await Ne.updateStatus(P.relatedTicketId,P.status),await C(),G("Task updated successfully!"),{success:!0}}catch(P){console.error("Error updating task:",P);const H=((v=(w=P==null?void 0:P.response)==null?void 0:w.data)==null?void 0:v.error)||P.message||"Failed to update task";throw new Error(H)}},[C]),X=n.useCallback(async r=>{var l,w;Y(!0);try{return await L.delete(r),await C(),G("Task deleted successfully!"),{success:!0}}catch(v){console.error("Error deleting task:",v);const P=((w=(l=v==null?void 0:v.response)==null?void 0:l.data)==null?void 0:w.error)||v.message||"Failed to delete task";throw new Error(P)}finally{setTimeout(()=>Y(!1),1e3)}},[C]),oe=n.useCallback(async(r,l)=>{D(r);try{await L.updateStatus(r,l),await C()}catch(w){console.error("Error updating task status:",w)}finally{D(null)}},[C]),de=n.useCallback(async(r,l)=>{A(r);try{await L.updatePriority(r,l),await C()}catch(w){console.error("Error updating task priority:",w)}finally{A(null)}},[C]),Te=n.useCallback(r=>{if(Array.isArray(r)){W(r);return}const l=r;W(w=>w.includes(l)?w.filter(v=>v!==l):[...w,l])},[]),ce=n.useCallback(r=>{b.length===r.length?W([]):W(r.map(l=>l.id))},[b.length]),me=n.useCallback(async r=>{h(!0);try{await Promise.all(b.map(l=>L.updateStatus(l,r))),W([]),await C()}catch(l){console.error("Error updating bulk status:",l)}finally{h(!1)}},[b,C]),xe=n.useCallback(async r=>{h(!0);try{await Promise.all(b.map(l=>L.updatePriority(l,r))),W([]),await C()}catch(l){console.error("Error updating bulk priority:",l)}finally{h(!1)}},[b,C]),Se=n.useCallback(async()=>{if(window.confirm(`Are you sure you want to delete ${b.length} tasks?`)){h(!0);try{await Promise.all(b.map(r=>L.delete(r))),W([]),await C()}catch(r){console.error("Error deleting bulk tasks:",r)}finally{h(!1)}}},[b,C]),ke=m.filter(r=>{const l=y==="all"||r.status===y,w=r.title.toLowerCase().includes(S.toLowerCase())||r.description.toLowerCase().includes(S.toLowerCase());return l&&w}),Ce=n.useCallback(r=>t&&(t.role==="admin"||t.role==="department_head"||r.createdBy===t.id||r.assignedToId===t.id),[t]),V=n.useCallback(()=>{k(!1),p(null),s&&i("/app/tasks",{replace:!0})},[s,i]);return{tasks:m,filteredTasks:ke,departmentUsers:F,pendingTickets:z,loadingState:T,filter:y,searchQuery:S,selectedTask:c,detailsOpen:U,selectedTasks:b,bulkUpdating:a,updatingStatus:_,updatingPriority:N,creatingTask:B,successMessage:ye,setFilter:j,setSearchQuery:d,setSelectedTask:p,setDetailsOpen:k,setSuccessMessage:G,loadPendingTickets:le,createTask:Z,updateTask:we,deleteTask:X,updateTaskStatus:oe,updateTaskPriority:de,selectTask:Te,selectAllTasks:ce,bulkUpdateStatus:me,bulkUpdatePriority:xe,bulkDeleteTasks:Se,closeDetails:V,canUpdateTask:Ce,user:t}},Rt=()=>{const t=Ee();ue(t.breakpoints.down("sm")),ue(t.breakpoints.between("sm","md"));const{filteredTasks:s,departmentUsers:i,pendingTickets:m,loadingState:f,filter:F,searchQuery:I,selectedTask:z,detailsOpen:x,selectedTasks:T,updatingStatus:u,updatingPriority:y,creatingTask:j,successMessage:S,setFilter:d,setSearchQuery:c,setSelectedTask:p,setDetailsOpen:U,setSuccessMessage:k,loadPendingTickets:b,createTask:W,updateTask:a,deleteTask:h,updateTaskStatus:_,updateTaskPriority:D,selectTask:N,closeDetails:A,canUpdateTask:B,user:Y}=zt(),[ye,G]=n.useState(!1),[C,J]=n.useState(!1),[le,Z]=n.useState(null),[we,X]=n.useState(!1),[oe,de]=n.useState(null),Te=()=>{b(),G(!0)},ce=V=>{Z(V),b(),J(!0)},me=V=>{de(V),X(!0)},xe=V=>{p(V),U(!0)},Se=async V=>{await W(V),G(!1)},ke=async V=>{await a(le.id,V),J(!1),Z(null)},Ce=async()=>{oe&&(await h(oe.id),X(!1),de(null))};return f?e.jsx(ht,{overlay:!0,message:"Loading tasks..."}):e.jsxs(o,{sx:{flexGrow:1,pt:{xs:7,sm:3,md:4},px:{xs:1,sm:2,md:3},display:"flex",flexDirection:"column",height:"100%"},children:[e.jsx(yt,{title:"Tasks",subtitle:"Manage and track your department's tasks efficiently",emoji:"âœ…",color:"success",actionButton:{text:"Add Task",icon:e.jsx(ot,{}),onClick:Te}}),e.jsx(o,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(dt,{in:!0,timeout:800,children:e.jsxs(o,{children:[e.jsx(Ct,{searchQuery:I,filter:F,onSearchChange:c,onFilterChange:d}),e.jsxs(o,{sx:{mt:2,mb:2},children:[e.jsxs(g,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:["All Tasks (",s.length,")"]}),s.length===0?e.jsx(o,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(g,{variant:"body1",children:"No tasks found. Try adjusting your filters or add a new task."})}):e.jsxs(e.Fragment,{children:[e.jsx(o,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(vt,{tasks:s,departmentUsers:i,canUpdateTask:B,selectedTasks:T,updatingStatus:u,updatingPriority:y,onSelectTask:N,onViewDetails:xe,onEditTask:ce,onDeleteTask:me,onUpdateStatus:_,onUpdatePriority:D})}),e.jsx(o,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(It,{tasks:s,departmentUsers:i,canUpdateTask:B,selectedTasks:T,updatingStatus:u,updatingPriority:y,onSelectTask:N,onViewDetails:xe,onEditTask:ce,onDeleteTask:me,onUpdateStatus:_,onUpdatePriority:D})})]})]})]})})}),e.jsx($e,{open:ye,onClose:()=>G(!1),onSubmit:Se,departmentUsers:i,pendingTickets:m,loading:j,mode:"create"}),e.jsx($e,{open:C,onClose:()=>{J(!1),Z(null)},onSubmit:ke,initialData:le,departmentUsers:i,pendingTickets:m,loading:!1,mode:"edit"}),e.jsx(kt,{open:x,onClose:A,task:z,departmentUsers:i,user:Y}),e.jsxs(Re,{open:we,onClose:()=>X(!1),children:[e.jsx(Ue,{children:"Delete Task"}),e.jsx(_e,{children:e.jsx(g,{children:"Are you sure you want to delete this task? This action cannot be undone."})}),e.jsxs(Be,{children:[e.jsx(Q,{onClick:()=>X(!1),children:"Cancel"}),e.jsx(Q,{variant:"contained",color:"error",onClick:Ce,disabled:j,children:"Delete"})]})]}),e.jsx(ct,{open:!!S,autoHideDuration:3e3,onClose:()=>k(""),message:S,anchorOrigin:{vertical:"top",horizontal:"center"},ContentProps:{sx:{backgroundColor:"success.main",color:"white",fontWeight:600}}})]})};export{Rt as default};
