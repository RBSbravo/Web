import{u as Se,j as e,B as S,b8 as Re,S as Ce,aj as Ie,F as I,E as Le,G as le,b as E,as as g,ax as d,b9 as G,I as U,b4 as Y,ao as J,b5 as K,ak as ke,ba as Te,a3 as R,ai as Q,ab as X,y as D,V as Z,a4 as f,am as de,at as Ee,au as De,av as Ae,m as Fe,e as We,t as Me,v as qe,w as ze,x as Be}from"./mui-DaYlJXyD.js";import{r as s}from"./vendor-Cr2nE3UY.js";import{u as Oe,L as _e,m as $e,l as A}from"./index-xE_H2rg0.js";import{R as ce,P as He,r as x,h as me}from"./PasswordStrengthIndicator-q3Saj6TO.js";import{u as Ne}from"./router-B4FNaIx_.js";const Ke=()=>{const ue=Ne(),o=Se(),{login:pe,user:F}=Oe(),[b,ee]=s.useState(0),[W,ge]=s.useState(!1),[L,p]=s.useState(""),[j,k]=s.useState(!1),[C,te]=s.useState(!1),[M,w]=s.useState(null),[h,xe]=s.useState({email:"",password:"",rememberMe:!1}),[y,re]=s.useState(!1),[q,l]=s.useState(""),[m,z]=s.useState(!1),[u,B]=s.useState(!1),[O,v]=s.useState(null),[_,he]=s.useState([]),[n,se]=s.useState({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),[fe,$]=s.useState(!1),[H,be]=s.useState(""),[T,ae]=s.useState(!1),[oe,N]=s.useState(""),[ne,ie]=s.useState("");s.useEffect(()=>{F&&F.isAuthenticated&&localStorage.removeItem("loginTab")},[F]),s.useEffect(()=>{const t=setTimeout(()=>k(!1),800);return()=>clearTimeout(t)},[]),s.useEffect(()=>{b===1&&_.length===0&&(async()=>{try{const i=await A.getDepartments();he(i.data)}catch{}})()},[b,_.length]);const V=t=>{const{name:i,value:c}=t.target;xe(r=>({...r,[i]:c})),L&&p("")},je=async t=>{var c;if(t.preventDefault(),!h.email||!h.password){p("Please fill in all fields");return}if(!x.canRetry("login")){const r=x.getRemainingRetryTime("login");p(`Please wait ${Math.ceil(r/1e3)} seconds before trying again.`);return}k(!0),p(""),te(!1),w(null);const i=setTimeout(()=>{k(!1)},3e4);try{const r=await A.login(h),{data:a}=r;if(a&&a.token){clearTimeout(i),te(!0),x.clearRetryTimer("login");const Pe={user:a.user,token:a.token};pe(Pe,h.rememberMe),setTimeout(()=>{ue("/app/dashboard")},1e3)}else throw new Error("Invalid response from server")}catch(r){console.error("Login error:",r),console.log("Error response:",r.response),console.log("Error data:",(c=r.response)==null?void 0:c.data),clearTimeout(i),k(!1);try{const a=me(r);console.log("Error info from handleApiError:",a),a.type==="rate_limit"?(w(a.rateLimitData),x.setRetryTimer("login",a.retryTime||15*60*1e3),p("")):(p(a.message),w(null))}catch(a){console.error("Error handling failed:",a),p("An error occurred. Please try again later."),w(null)}}},P=t=>{const{name:i,value:c}=t.target;se(r=>({...r,[i]:c})),q&&l("")},we=()=>!n.firstname||!n.lastname||!n.email||!n.password||!n.confirmPassword||!n.departmentId?(l("Please fill in all fields"),!1):n.password!==n.confirmPassword?(l("Passwords do not match"),!1):n.password.length<8?(l("Password must be at least 8 characters long"),!1):!0,ye=async t=>{var c;if(t.preventDefault(),!we())return;if(!x.canRetry("register")){const r=x.getRemainingRetryTime("register");l(`Please wait ${Math.ceil(r/1e3)} seconds before trying again.`);return}z(!0),l(""),B(!1),v(null);const i=setTimeout(()=>{z(!1)},3e4);try{const r={...n};delete r.confirmPassword,(await A.register(r)).data&&(clearTimeout(i),B(!0),x.clearRetryTimer("register"),se({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),setTimeout(()=>{ee(0),B(!1),l("")},2e3))}catch(r){console.error("Registration error:",r),console.log("Registration error response:",r.response),console.log("Registration error data:",(c=r.response)==null?void 0:c.data),clearTimeout(i),z(!1);try{const a=me(r);console.log("Registration error info from handleApiError:",a),a.type==="rate_limit"?(v(a.rateLimitData),x.setRetryTimer("register",a.retryTime||15*60*1e3),l("")):(l(a.message),v(null))}catch(a){console.error("Registration error handling failed:",a),l("An error occurred. Please try again later."),v(null)}}},ve=(t,i)=>{ee(i),p(""),l("")};return j&&!L?e.jsx(_e,{overlay:!0,message:"Loading login..."}):e.jsxs(S,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",background:o.palette.mode==="dark"?o.palette.background.default:`linear-gradient(to right bottom, ${o.palette.primary.light}, ${o.palette.primary.main})`,py:8,position:"relative",overflow:"hidden"},children:[e.jsx(Re,{component:"main",maxWidth:"sm",children:e.jsx(Ce,{direction:"up",in:!0,timeout:800,children:e.jsxs(Ie,{elevation:o.palette.mode==="dark"?2:8,sx:{p:{xs:3,sm:6},display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:o.palette.mode==="dark"?o.palette.background.paper:o.palette.common.white,borderRadius:3,position:"relative",backdropFilter:"blur(10px)",border:`1px solid ${o.palette.mode==="dark"?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"}`,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"},children:[e.jsx(I,{in:!0,timeout:1200,children:e.jsx(S,{sx:{width:80,height:80,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",mb:2,boxShadow:"0 4px 20px rgba(0,0,0,0.1)"},children:e.jsx(S,{component:"img",src:$e,alt:"Mito Logo",sx:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover"}})})}),e.jsxs(Le,{value:b,onChange:ve,sx:{mb:3},centered:!0,children:[e.jsx(le,{label:"Sign In"}),e.jsx(le,{label:"Sign Up"})]}),b===0&&e.jsxs(S,{sx:{textAlign:"center",mb:2},children:[e.jsx(E,{variant:"h4",color:"primary",sx:{fontWeight:"bold",fontSize:24,mt:.75},children:"Welcome Back"}),e.jsx(E,{variant:"body1",color:"text.secondary",sx:{fontSize:14,mt:.25},children:"Sign in to continue"})]}),b===0&&e.jsxs("form",{onSubmit:je,style:{width:"100%"},children:[e.jsx(g,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:h.email,onChange:V,disabled:j||C,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}}),e.jsx(g,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:W?"text":"password",id:"password",autoComplete:"current-password",value:h.password,onChange:V,disabled:j||C,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(K,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>ge(!W),edge:"end",disabled:j||C,children:W?e.jsx(Y,{}):e.jsx(J,{})})})}}),e.jsxs(S,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:1,mb:2},children:[e.jsxs(S,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ke,{checked:h.rememberMe,onChange:t=>V({target:{name:"rememberMe",value:t.target.checked}}),color:"primary",size:"small"}),e.jsx(E,{variant:"body2",sx:{color:o.palette.text.secondary},children:"Remember me"})]}),e.jsx(Te,{component:"button",type:"button",variant:"body2",underline:"hover",onClick:t=>{t.preventDefault(),t.stopPropagation(),$(!0)},sx:{border:"none",background:"none",cursor:"pointer",color:o.palette.primary.main,"&:hover":{color:o.palette.primary.dark}},children:"Forgot password?"})]}),e.jsx(ce,{isOpen:!!M,onClose:()=>w(null),rateLimitData:M,endpoint:"login",onRetry:()=>{w(null),p("")}}),L&&!M&&e.jsx(I,{in:!0,children:e.jsx(R,{severity:"error",sx:{width:"100%",mb:2},icon:e.jsx(Q,{}),children:L})}),C&&e.jsx(I,{in:!0,children:e.jsx(R,{severity:"success",sx:{width:"100%",mb:2},icon:e.jsx(X,{}),children:"Login successful! Redirecting..."})}),e.jsx(D,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:j||C,children:j?e.jsx(Z,{size:24,color:"inherit"}):"Sign In"})]}),b===1&&e.jsxs("form",{onSubmit:ye,style:{width:"100%"},children:[e.jsxs(f,{container:!0,spacing:2,children:[e.jsx(f,{item:!0,xs:12,sm:6,children:e.jsx(g,{required:!0,fullWidth:!0,id:"firstname",label:"First Name",name:"firstname",autoComplete:"given-name",value:n.firstname,onChange:P,disabled:m||u,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(de,{color:"action"})})}})}),e.jsx(f,{item:!0,xs:12,sm:6,children:e.jsx(g,{required:!0,fullWidth:!0,id:"lastname",label:"Last Name",name:"lastname",autoComplete:"family-name",value:n.lastname,onChange:P,disabled:m||u,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(de,{color:"action"})})}})}),e.jsx(f,{item:!0,xs:12,children:e.jsx(g,{required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",value:n.email,onChange:P,disabled:m||u,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}})}),e.jsx(f,{item:!0,xs:12,children:e.jsxs(Ee,{fullWidth:!0,required:!0,children:[e.jsx(De,{id:"department-label",children:"Department"}),e.jsx(Ae,{labelId:"department-label",id:"departmentId",name:"departmentId",value:n.departmentId,label:"Department",onChange:P,disabled:m||u,startAdornment:e.jsx(d,{position:"start",children:e.jsx(We,{color:"action"})}),children:_.map(t=>e.jsx(Fe,{value:t.id,children:t.name},t.id))})]})}),e.jsxs(f,{item:!0,xs:12,sm:6,children:[e.jsx(g,{required:!0,fullWidth:!0,name:"password",label:"Password",type:y?"text":"password",id:"register-password",autoComplete:"new-password",value:n.password,onChange:P,disabled:m||u,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(K,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>re(!y),edge:"end",disabled:m||u,children:y?e.jsx(Y,{}):e.jsx(J,{})})})}}),e.jsx(He,{password:n.password})]}),e.jsx(f,{item:!0,xs:12,sm:6,children:e.jsx(g,{required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:y?"text":"password",id:"register-confirm-password",autoComplete:"new-password",value:n.confirmPassword,onChange:P,disabled:m||u,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(K,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>re(!y),edge:"end",disabled:m||u,children:y?e.jsx(Y,{}):e.jsx(J,{})})})}})})]}),e.jsx(ce,{isOpen:!!O,onClose:()=>v(null),rateLimitData:O,endpoint:"register",onRetry:()=>{v(null),l("")}}),q&&!O&&e.jsx(I,{in:!0,children:e.jsx(R,{severity:"error",sx:{width:"100%",mt:2},icon:e.jsx(Q,{}),children:q})}),u&&e.jsx(I,{in:!0,children:e.jsx(R,{severity:"success",sx:{width:"100%",mt:2},icon:e.jsx(X,{}),children:"Registration successful! You will be redirected to login in a few seconds..."})}),e.jsx(D,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:m||u,children:m?e.jsx(Z,{size:24,color:"inherit"}):"Register"})]})]})})}),e.jsxs(Me,{open:fe,onClose:()=>$(!1),maxWidth:"xs",fullWidth:!0,PaperProps:{sx:{borderRadius:3,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"}},children:[e.jsx(qe,{sx:{pb:1,fontWeight:600,color:o.palette.text.primary},children:"Forgot Password"}),e.jsxs(ze,{sx:{pt:2},children:[e.jsx(E,{variant:"body2",sx:{mb:3,color:o.palette.text.secondary},children:"Enter your email address and we'll send you a link to reset your password."}),e.jsx(g,{label:"Email Address",type:"email",fullWidth:!0,margin:"normal",value:H,onChange:t=>be(t.target.value),disabled:T,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}}),oe&&e.jsx(R,{severity:"error",sx:{mt:2},icon:e.jsx(Q,{}),children:oe}),ne&&e.jsx(R,{severity:"success",sx:{mt:2},icon:e.jsx(X,{}),children:ne})]}),e.jsxs(Be,{sx:{px:3,pb:3},children:[e.jsx(D,{onClick:()=>$(!1),disabled:T,sx:{color:o.palette.text.secondary,"&:hover":{color:o.palette.text.primary}},children:"Cancel"}),e.jsx(D,{onClick:async()=>{var t,i;if(N(""),ie(""),!H){N("Please enter your email address.");return}ae(!0);try{await A.forgotPassword({email:H}),ie("If an account with that email exists, a reset link has been sent.")}catch(c){N(((i=(t=c.response)==null?void 0:t.data)==null?void 0:i.error)||"Failed to send reset email.")}finally{ae(!1)}},variant:"contained",color:"primary",disabled:T,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:600,px:3,minWidth:"120px",height:"36px"},children:T?e.jsx(Z,{size:20,color:"inherit"}):"Send Reset Link"})]})]})]})};export{Ke as default};
