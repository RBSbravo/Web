import{r as n,j as e,B as i,a6 as P,a8 as re,a9 as te,G as ae,H as G,ap as ne,b6 as J,a7 as o,k as oe,b as w,J as ie,z as v,as as le,E as de,b7 as ce,av as l,aA as h,I as O,b8 as W,ar as R,b9 as L,Z as ue}from"./mui-DmyK1VYO.js";import{h as xe,l as Y}from"./index-Cwx5atet.js";import{P as me}from"./PageHeader-DsP3YEjW.js";import{P as we,p as he}from"./PasswordStrengthIndicator-CcrqGHKl.js";import{u as pe}from"./router-ViNET1Ki.js";import"./vendor-Ckhrjn13.js";const $=y=>{const{children:p,value:g,index:u,...j}=y;return e.jsx("div",{role:"tabpanel",hidden:g!==u,id:`settings-tabpanel-${u}`,"aria-labelledby":`settings-tab-${u}`,...j,children:g===u&&e.jsx(i,{sx:{py:4,px:1,minHeight:"400px",width:"100%"},children:p})})},ye=()=>{const y=pe(),[p,g]=n.useState(0),[u,j]=n.useState(!1),[t,Z]=n.useState(JSON.parse(localStorage.getItem("user")||"{}")),[d,C]=n.useState(!1),[x,B]=n.useState({firstname:t.firstname||"",lastname:t.lastname||"",email:t.email||""}),[F,H]=n.useState(!1),[S,b]=n.useState(""),[a,U]=n.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[m,V]=n.useState({current:!1,new:!1,confirm:!1}),[c,z]=n.useState({}),[I,D]=n.useState(!1),[q,A]=n.useState(!1),[T,E]=n.useState(""),K=(s,r)=>{g(r)},k=(s,r)=>{B(f=>({...f,[s]:r})),S&&b("")},Q=()=>{C(!0)},X=()=>{B({firstname:t.firstname||"",lastname:t.lastname||"",email:t.email||""}),C(!1),b("")},_=async()=>{H(!0),b("");try{const s={firstname:(x.firstname||"").trim(),lastname:(x.lastname||"").trim(),email:(x.email||"").trim()};await xe.update(t.id,s);const r={...t,...s};Z(r),localStorage.setItem("user",JSON.stringify(r)),C(!1),j(!0),setTimeout(()=>j(!1),3e3)}catch(s){b(s.response?.data?.error||"Failed to update profile")}finally{H(!1)}},M=(s,r)=>{U(f=>({...f,[s]:r})),c[s]&&z(f=>({...f,[s]:""})),q&&A(!1),T&&E("")},ee=()=>{const s={};if(a.currentPassword||(s.currentPassword="Current password is required"),!a.newPassword)s.newPassword="New password is required";else{const r=he.validate(a.newPassword);r.isValid||(s.newPassword=r.errors[0])}return a.confirmPassword?a.newPassword!==a.confirmPassword&&(s.confirmPassword="Passwords do not match"):s.confirmPassword="Please confirm your new password",a.currentPassword===a.newPassword&&(s.newPassword="New password must be different from current password"),z(s),Object.keys(s).length===0},se=async()=>{if(ee()){D(!0),E("");try{await Y.changePassword({currentPassword:a.currentPassword,newPassword:a.newPassword}),A(!0),U({currentPassword:"",newPassword:"",confirmPassword:""}),V({current:!1,new:!1,confirm:!1}),setTimeout(async()=>{A(!1);try{await Y.logout()}catch{console.warn("Logout API call failed, but continuing with local cleanup")}localStorage.removeItem("user"),localStorage.removeItem("token"),y("/login")},3e3)}catch(s){let r=s.response?.data?.error||s.message||"Failed to change password";r.toLowerCase().includes("incorrect")?r="Your current password is incorrect.":r.toLowerCase().includes("at least 6 characters")?r="New password must be at least 6 characters.":r.toLowerCase().includes("not found")?r="User not found. Please re-login.":r.toLowerCase().includes("required")?r="Please fill in all password fields.":r.toLowerCase().includes("server error")?r="A server error occurred. Please try again later.":r.toLowerCase().includes("same as current")&&(r="New password must be different from the current password."),E(r)}finally{D(!1)}}},N=s=>{V(r=>({...r,[s]:!r[s]}))};return e.jsxs(i,{sx:{flexGrow:1,pt:{xs:7,sm:3,md:4},px:{xs:1,sm:2,md:3},display:"flex",flexDirection:"column",minHeight:"100vh",height:"auto",overflowY:"auto"},children:[e.jsx(me,{title:"Settings",subtitle:"Customize your application preferences",emoji:"⚙️",color:"warning"}),u&&e.jsx(P,{severity:"success",sx:{mb:3},children:"Settings saved successfully!"}),e.jsx(re,{sx:{minHeight:"500px"},children:e.jsxs(te,{sx:{p:0},children:[e.jsx(i,{sx:{px:3,pt:2},children:e.jsxs(ae,{value:p,onChange:K,variant:"scrollable",scrollButtons:"auto",sx:{borderBottom:1,borderColor:"divider","& .MuiTab-root":{textTransform:"uppercase",fontWeight:600,fontSize:"0.875rem",letterSpacing:"0.5px",minHeight:48,"&.Mui-selected":{color:"primary.main"}},"& .MuiTabs-indicator":{backgroundColor:"primary.main",height:3}},children:[e.jsx(G,{icon:e.jsx(ne,{}),label:"Account"}),e.jsx(G,{icon:e.jsx(J,{}),label:"Security"})]})}),e.jsx($,{value:p,index:0,children:e.jsx(i,{sx:{px:{xs:2,md:4},py:{xs:2,md:3}},children:e.jsx(o,{container:!0,spacing:4,children:e.jsxs(o,{item:!0,xs:12,children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:4},children:[e.jsxs(oe,{sx:{width:80,height:80,bgcolor:"primary.main",fontSize:"2rem",mr:3,fontWeight:"bold"},children:[t.firstname?.[0]?.toUpperCase(),t.lastname?.[0]?.toUpperCase()]}),e.jsxs(i,{children:[e.jsxs(w,{variant:"h6",sx:{fontWeight:600,mb:.5},children:[t.firstname," ",t.lastname]}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:.5},children:t.role}),e.jsx(w,{variant:"body2",color:"text.secondary",children:t.email})]})]}),e.jsx(ie,{sx:{my:4}}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsx(w,{variant:"h6",sx:{fontWeight:600},children:"Account Information"}),d?e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx(v,{onClick:X,startIcon:e.jsx(de,{}),children:"Cancel"}),e.jsx(v,{variant:"contained",onClick:_,disabled:F,startIcon:e.jsx(ce,{}),children:F?"Saving...":"Save"})]}):e.jsx(v,{variant:"outlined",onClick:Q,startIcon:e.jsx(le,{}),children:"Edit"})]}),S&&e.jsx(P,{severity:"error",sx:{mb:2},children:S}),e.jsxs(o,{container:!0,spacing:3,children:[e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(l,{fullWidth:!0,label:"First Name",value:d?x.firstname:t.firstname||"",onChange:s=>k("firstname",s.target.value),disabled:!d,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(l,{fullWidth:!0,label:"Last Name",value:d?x.lastname:t.lastname||"",onChange:s=>k("lastname",s.target.value),disabled:!d,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(o,{item:!0,xs:12,children:e.jsx(l,{fullWidth:!0,label:"Email",value:d?x.email:t.email||"",onChange:s=>k("email",s.target.value),disabled:!d,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(l,{fullWidth:!0,label:"Role",value:t.role||"",disabled:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(l,{fullWidth:!0,label:"Department",value:t.department?.name||t.department||"N/A",disabled:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})})]})]})})})}),e.jsx($,{value:p,index:1,children:e.jsx(i,{sx:{px:{xs:2,md:4},py:{xs:2,md:3}},children:e.jsx(o,{container:!0,spacing:4,children:e.jsxs(o,{item:!0,xs:12,children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"Change Password"}),q&&e.jsx(P,{severity:"success",sx:{mb:2},children:"Password changed successfully! You will be logged out for security."}),T&&e.jsx(P,{severity:"error",sx:{mb:2},children:T}),e.jsx(l,{fullWidth:!0,type:m.current?"text":"password",label:"Current Password",variant:"outlined",value:a.currentPassword,onChange:s=>M("currentPassword",s.target.value),error:!!c.currentPassword,helperText:c.currentPassword,sx:{mb:2,"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(h,{position:"start",children:e.jsx(L,{color:"action"})}),endAdornment:e.jsx(h,{position:"end",children:e.jsx(O,{onClick:()=>N("current"),edge:"end",children:m.current?e.jsx(W,{}):e.jsx(R,{})})})}}),e.jsx(l,{fullWidth:!0,type:m.new?"text":"password",label:"New Password",variant:"outlined",value:a.newPassword,onChange:s=>M("newPassword",s.target.value),error:!!c.newPassword,helperText:c.newPassword,sx:{mb:2,"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(h,{position:"start",children:e.jsx(L,{color:"action"})}),endAdornment:e.jsx(h,{position:"end",children:e.jsx(O,{onClick:()=>N("new"),edge:"end",children:m.new?e.jsx(W,{}):e.jsx(R,{})})})}}),e.jsx(we,{password:a.newPassword}),e.jsx(l,{fullWidth:!0,type:m.confirm?"text":"password",label:"Confirm New Password",variant:"outlined",value:a.confirmPassword,onChange:s=>M("confirmPassword",s.target.value),error:!!c.confirmPassword,helperText:c.confirmPassword,sx:{mb:2,"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(h,{position:"start",children:e.jsx(L,{color:"action"})}),endAdornment:e.jsx(h,{position:"end",children:e.jsx(O,{onClick:()=>N("confirm"),edge:"end",children:m.confirm?e.jsx(W,{}):e.jsx(R,{})})})}}),e.jsx(v,{variant:"contained",color:"primary",onClick:se,disabled:I,startIcon:I?e.jsx(ue,{size:20}):e.jsx(J,{}),children:I?"Changing Password...":"Update Password"}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"After changing your password, you will be automatically logged out for security purposes."})]})})})})]})})]})};export{ye as default};
