import{u as Pe,r as a,j as e,B as R,bd as Se,S as Re,am as Ce,F as C,G as Ie,H as ne,b as $,av as p,aA as d,be as N,I as G,b9 as U,ar as V,ba as Y,bf as Le,a6 as v,al as Z,ae as J,z as k,Z as K,a7 as x,ap as le,aw as Te,ax as ke,ay as Ee,m as Ae,e as De,v as Fe,w as We,x as qe,y as ze}from"./mui-BfuGcMOQ.js";import{u as Be,L as Oe,m as He,l as E}from"./index-IHJtBAHg.js";import{R as de,P as Me,r as g,h as ce}from"./PasswordStrengthIndicator-BB1K_etI.js";import{u as _e}from"./router-DwSTIDLU.js";import"./vendor-Ckhrjn13.js";const Ye=()=>{const me=_e(),o=Pe(),{login:ue,user:A}=Be(),[h,Q]=a.useState(0),[D,pe]=a.useState(!1),[I,u]=a.useState(""),[f,L]=a.useState(!1),[P,X]=a.useState(!1),[F,b]=a.useState(null),[S,ge]=a.useState({email:"",password:""}),[j,ee]=a.useState(!1),[W,l]=a.useState(""),[c,q]=a.useState(!1),[m,z]=a.useState(!1),[B,w]=a.useState(null),[O,xe]=a.useState([]),[i,te]=a.useState({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),[he,H]=a.useState(!1),[M,fe]=a.useState(""),[T,re]=a.useState(!1),[se,_]=a.useState(""),[ae,oe]=a.useState("");a.useEffect(()=>{A&&A.isAuthenticated&&localStorage.removeItem("loginTab")},[A]),a.useEffect(()=>{const r=setTimeout(()=>L(!1),800);return()=>clearTimeout(r)},[]),a.useEffect(()=>{h===1&&O.length===0&&(async()=>{try{const n=await E.getDepartments();xe(n.data)}catch{}})()},[h,O.length]);const ie=r=>{const{name:n,value:s}=r.target;ge(t=>({...t,[n]:s})),I&&u("")},be=async r=>{if(r.preventDefault(),!S.email||!S.password){u("Please fill in all fields");return}if(!g.canRetry("login")){const s=g.getRemainingRetryTime("login");u(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}L(!0),u(""),X(!1),b(null);const n=setTimeout(()=>{L(!1)},3e4);try{const s=await E.login(S),{data:t}=s;if(t&&t.token){clearTimeout(n),X(!0),g.clearRetryTimer("login");const ve={user:t.user,token:t.token};ue(ve),setTimeout(()=>{me("/app/dashboard")},1e3)}else throw new Error("Invalid response from server")}catch(s){console.error("Login error:",s),console.log("Error response:",s.response),console.log("Error data:",s.response?.data),clearTimeout(n),L(!1);try{const t=ce(s);console.log("Error info from handleApiError:",t),t.type==="rate_limit"?(b(t.rateLimitData),g.setRetryTimer("login",t.retryTime||900*1e3),u("")):(u(t.message),b(null))}catch(t){console.error("Error handling failed:",t),u("An error occurred. Please try again later."),b(null)}}},y=r=>{const{name:n,value:s}=r.target;te(t=>({...t,[n]:s})),W&&l("")},je=()=>!i.firstname||!i.lastname||!i.email||!i.password||!i.confirmPassword||!i.departmentId?(l("Please fill in all fields"),!1):i.password!==i.confirmPassword?(l("Passwords do not match"),!1):i.password.length<8?(l("Password must be at least 8 characters long"),!1):!0,we=async r=>{if(r.preventDefault(),!je())return;if(!g.canRetry("register")){const s=g.getRemainingRetryTime("register");l(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}q(!0),l(""),z(!1),w(null);const n=setTimeout(()=>{q(!1)},3e4);try{const s={...i};delete s.confirmPassword,(await E.register(s)).data&&(clearTimeout(n),z(!0),g.clearRetryTimer("register"),te({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),setTimeout(()=>{Q(0),z(!1),l("")},2e3))}catch(s){console.error("Registration error:",s),console.log("Registration error response:",s.response),console.log("Registration error data:",s.response?.data),clearTimeout(n),q(!1);try{const t=ce(s);console.log("Registration error info from handleApiError:",t),t.type==="rate_limit"?(w(t.rateLimitData),g.setRetryTimer("register",t.retryTime||900*1e3),l("")):(l(t.message),w(null))}catch(t){console.error("Registration error handling failed:",t),l("An error occurred. Please try again later."),w(null)}}},ye=(r,n)=>{Q(n),u(""),l("")};return f&&!I?e.jsx(Oe,{overlay:!0,message:"Loading login..."}):e.jsxs(R,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",background:o.palette.mode==="dark"?o.palette.background.default:`linear-gradient(to right bottom, ${o.palette.primary.light}, ${o.palette.primary.main})`,py:8,position:"relative",overflow:"hidden"},children:[e.jsx(Se,{component:"main",maxWidth:"sm",children:e.jsx(Re,{direction:"up",in:!0,timeout:800,children:e.jsxs(Ce,{elevation:o.palette.mode==="dark"?2:8,sx:{p:{xs:3,sm:6},display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:o.palette.mode==="dark"?o.palette.background.paper:o.palette.common.white,borderRadius:3,position:"relative",backdropFilter:"blur(10px)",border:`1px solid ${o.palette.mode==="dark"?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"}`,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"},children:[e.jsx(C,{in:!0,timeout:1200,children:e.jsx(R,{sx:{width:80,height:80,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",mb:2,boxShadow:"0 4px 20px rgba(0,0,0,0.1)"},children:e.jsx(R,{component:"img",src:He,alt:"Mito Logo",sx:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover"}})})}),e.jsxs(Ie,{value:h,onChange:ye,sx:{mb:3},centered:!0,children:[e.jsx(ne,{label:"Sign In"}),e.jsx(ne,{label:"Sign Up"})]}),h===0&&e.jsxs(R,{sx:{textAlign:"center",mb:2},children:[e.jsx($,{variant:"h4",color:"primary",sx:{fontWeight:"bold",fontSize:24,mt:.75},children:"Welcome Back"}),e.jsx($,{variant:"body1",color:"text.secondary",sx:{fontSize:14,mt:.25},children:"Sign in to continue"})]}),h===0&&e.jsxs("form",{onSubmit:be,style:{width:"100%"},children:[e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:S.email,onChange:ie,disabled:f||P,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(N,{color:"action"})})}}),e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:D?"text":"password",id:"password",autoComplete:"current-password",value:S.password,onChange:ie,disabled:f||P,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Y,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(G,{"aria-label":"toggle password visibility",onClick:()=>pe(!D),edge:"end",disabled:f||P,children:D?e.jsx(U,{}):e.jsx(V,{})})})}}),e.jsx(R,{sx:{display:"flex",justifyContent:"flex-end",mt:1,mb:2},children:e.jsx(Le,{component:"button",type:"button",variant:"body2",underline:"hover",onClick:r=>{r.preventDefault(),r.stopPropagation(),H(!0)},sx:{border:"none",background:"none",cursor:"pointer",color:o.palette.primary.main,"&:hover":{color:o.palette.primary.dark}},children:"Forgot password?"})}),e.jsx(de,{isOpen:!!F,onClose:()=>b(null),rateLimitData:F,endpoint:"login",onRetry:()=>{b(null),u("")}}),I&&!F&&e.jsx(C,{in:!0,children:e.jsx(v,{severity:"error",sx:{width:"100%",mb:2},icon:e.jsx(Z,{}),children:I})}),P&&e.jsx(C,{in:!0,children:e.jsx(v,{severity:"success",sx:{width:"100%",mb:2},icon:e.jsx(J,{}),children:"Login successful! Redirecting..."})}),e.jsx(k,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:f||P,children:f?e.jsx(K,{size:24,color:"inherit"}):"Sign In"})]}),h===1&&e.jsxs("form",{onSubmit:we,style:{width:"100%"},children:[e.jsxs(x,{container:!0,spacing:2,children:[e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"firstname",label:"First Name",name:"firstname",autoComplete:"given-name",value:i.firstname,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"lastname",label:"Last Name",name:"lastname",autoComplete:"family-name",value:i.lastname,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(p,{required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",value:i.email,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(N,{color:"action"})})}})}),e.jsx(x,{item:!0,xs:12,children:e.jsxs(Te,{fullWidth:!0,required:!0,children:[e.jsx(ke,{id:"department-label",children:"Department"}),e.jsx(Ee,{labelId:"department-label",id:"departmentId",name:"departmentId",value:i.departmentId,label:"Department",onChange:y,disabled:c||m,startAdornment:e.jsx(d,{position:"start",children:e.jsx(De,{color:"action"})}),children:O.map(r=>e.jsx(Ae,{value:r.id,children:r.name},r.id))})]})}),e.jsxs(x,{item:!0,xs:12,sm:6,children:[e.jsx(p,{required:!0,fullWidth:!0,name:"password",label:"Password",type:j?"text":"password",id:"register-password",autoComplete:"new-password",value:i.password,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Y,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(G,{"aria-label":"toggle password visibility",onClick:()=>ee(!j),edge:"end",disabled:c||m,children:j?e.jsx(U,{}):e.jsx(V,{})})})}}),e.jsx(Me,{password:i.password})]}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:j?"text":"password",id:"register-confirm-password",autoComplete:"new-password",value:i.confirmPassword,onChange:y,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Y,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(G,{"aria-label":"toggle password visibility",onClick:()=>ee(!j),edge:"end",disabled:c||m,children:j?e.jsx(U,{}):e.jsx(V,{})})})}})})]}),e.jsx(de,{isOpen:!!B,onClose:()=>w(null),rateLimitData:B,endpoint:"register",onRetry:()=>{w(null),l("")}}),W&&!B&&e.jsx(C,{in:!0,children:e.jsx(v,{severity:"error",sx:{width:"100%",mt:2},icon:e.jsx(Z,{}),children:W})}),m&&e.jsx(C,{in:!0,children:e.jsx(v,{severity:"success",sx:{width:"100%",mt:2},icon:e.jsx(J,{}),children:"Registration successful! You will be redirected to login in a few seconds..."})}),e.jsx(k,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:c||m,children:c?e.jsx(K,{size:24,color:"inherit"}):"Register"})]})]})})}),e.jsxs(Fe,{open:he,onClose:()=>H(!1),maxWidth:"xs",fullWidth:!0,PaperProps:{sx:{borderRadius:3,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"}},children:[e.jsx(We,{sx:{pb:1,fontWeight:600,color:o.palette.text.primary},children:"Forgot Password"}),e.jsxs(qe,{sx:{pt:2},children:[e.jsx($,{variant:"body2",sx:{mb:3,color:o.palette.text.secondary},children:"Enter your email address and we'll send you a link to reset your password."}),e.jsx(p,{label:"Email Address",type:"email",fullWidth:!0,margin:"normal",value:M,onChange:r=>fe(r.target.value),disabled:T,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(N,{color:"action"})})}}),se&&e.jsx(v,{severity:"error",sx:{mt:2},icon:e.jsx(Z,{}),children:se}),ae&&e.jsx(v,{severity:"success",sx:{mt:2},icon:e.jsx(J,{}),children:ae})]}),e.jsxs(ze,{sx:{px:3,pb:3},children:[e.jsx(k,{onClick:()=>H(!1),disabled:T,sx:{color:o.palette.text.secondary,"&:hover":{color:o.palette.text.primary}},children:"Cancel"}),e.jsx(k,{onClick:async()=>{if(_(""),oe(""),!M){_("Please enter your email address.");return}re(!0);try{await E.forgotPassword({email:M}),oe("If an account with that email exists, a reset link has been sent.")}catch(r){_(r.response?.data?.error||"Failed to send reset email.")}finally{re(!1)}},variant:"contained",color:"primary",disabled:T,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:600,px:3,minWidth:"120px",height:"36px"},children:T?e.jsx(K,{size:20,color:"inherit"}):"Send Reset Link"})]})]})]})};export{Ye as default};
