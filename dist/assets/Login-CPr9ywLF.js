import{u as Pe,r,j as e,B as R,bd as Se,S as Re,am as Ce,F as C,G as Ie,H as ne,b as H,av as p,aA as l,be as N,I as G,b9 as U,ar as V,ba as Y,bf as Le,a6 as w,al as Z,ae as J,z as k,Z as K,a7 as g,ap as le,aw as Te,ax as ke,ay as De,m as Ae,e as Ee,v as Fe,w as We,x as qe,y as ze}from"./mui-BfuGcMOQ.js";import{u as Be,L as Oe,m as Me,l as D}from"./index-Df56suev.js";import{R as de,P as _e,r as x,h as ce}from"./PasswordStrengthIndicator-D8PwV_Es.js";import{u as $e}from"./router-DwSTIDLU.js";import"./vendor-Ckhrjn13.js";const Ye=()=>{const me=$e(),o=Pe(),{login:ue,user:A}=Be(),[h,Q]=r.useState(0),[E,pe]=r.useState(!1),[I,u]=r.useState(""),[f,L]=r.useState(!1),[y,X]=r.useState(!1),[F,v]=r.useState(null),[P,xe]=r.useState({email:"",password:""}),[b,ee]=r.useState(!1),[W,d]=r.useState(""),[c,q]=r.useState(!1),[m,z]=r.useState(!1),[B,S]=r.useState(null),[O,ge]=r.useState([]),[i,te]=r.useState({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),[he,M]=r.useState(!1),[_,fe]=r.useState(""),[T,se]=r.useState(!1),[re,$]=r.useState(""),[ae,oe]=r.useState("");r.useEffect(()=>{A&&A.isAuthenticated&&localStorage.removeItem("loginTab")},[A]),r.useEffect(()=>{const t=setTimeout(()=>L(!1),800);return()=>clearTimeout(t)},[]),r.useEffect(()=>{h===1&&O.length===0&&(async()=>{try{const n=await D.getDepartments();ge(n.data)}catch{}})()},[h,O.length]);const ie=t=>{const{name:n,value:s}=t.target;xe(a=>({...a,[n]:s})),I&&u("")},be=async t=>{if(t.preventDefault(),!P.email||!P.password){u("Please fill in all fields");return}if(!x.canRetry("login")){const s=x.getRemainingRetryTime("login");u(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}L(!0),u(""),X(!1),v(null);const n=setTimeout(()=>{L(!1)},3e4);try{const s=await D.login(P),{data:a}=s;if(a&&a.token){clearTimeout(n),X(!0),x.clearRetryTimer("login");const ve={user:a.user,token:a.token};ue(ve),setTimeout(()=>{me("/app/dashboard")},1e3)}else throw new Error("Invalid response from server")}catch(s){console.error("Login error:",s),console.log("Error response:",s.response),console.log("Error data:",s.response?.data);const a=ce(s);console.log("Error info from handleApiError:",a),clearTimeout(n),L(!1),a.type==="rate_limit"?(v(a.rateLimitData),x.setRetryTimer("login",a.retryTime),u("")):(u(a.message),v(null))}},j=t=>{const{name:n,value:s}=t.target;te(a=>({...a,[n]:s})),W&&d("")},je=()=>!i.firstname||!i.lastname||!i.email||!i.password||!i.confirmPassword||!i.departmentId?(d("Please fill in all fields"),!1):i.password!==i.confirmPassword?(d("Passwords do not match"),!1):i.password.length<8?(d("Password must be at least 8 characters long"),!1):!0,we=async t=>{if(t.preventDefault(),!je())return;if(!x.canRetry("register")){const s=x.getRemainingRetryTime("register");d(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}q(!0),d(""),z(!1),S(null);const n=setTimeout(()=>{q(!1)},3e4);try{const s={...i};delete s.confirmPassword,(await D.register(s)).data&&(clearTimeout(n),z(!0),x.clearRetryTimer("register"),te({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),setTimeout(()=>{Q(0),z(!1),d("")},2e3))}catch(s){console.error("Registration error:",s),console.log("Registration error response:",s.response),console.log("Registration error data:",s.response?.data);const a=ce(s);console.log("Registration error info from handleApiError:",a),clearTimeout(n),q(!1),a.type==="rate_limit"?(S(a.rateLimitData),x.setRetryTimer("register",a.retryTime),d("")):(d(a.message),S(null))}},ye=(t,n)=>{Q(n),u(""),d("")};return f&&!I?e.jsx(Oe,{overlay:!0,message:"Loading login..."}):e.jsxs(R,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",background:o.palette.mode==="dark"?o.palette.background.default:`linear-gradient(to right bottom, ${o.palette.primary.light}, ${o.palette.primary.main})`,py:8,position:"relative",overflow:"hidden"},children:[e.jsx(Se,{component:"main",maxWidth:"sm",children:e.jsx(Re,{direction:"up",in:!0,timeout:800,children:e.jsxs(Ce,{elevation:o.palette.mode==="dark"?2:8,sx:{p:{xs:3,sm:6},display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:o.palette.mode==="dark"?o.palette.background.paper:o.palette.common.white,borderRadius:3,position:"relative",backdropFilter:"blur(10px)",border:`1px solid ${o.palette.mode==="dark"?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"}`,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"},children:[e.jsx(C,{in:!0,timeout:1200,children:e.jsx(R,{sx:{width:80,height:80,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",mb:2,boxShadow:"0 4px 20px rgba(0,0,0,0.1)"},children:e.jsx(R,{component:"img",src:Me,alt:"Mito Logo",sx:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover"}})})}),e.jsxs(Ie,{value:h,onChange:ye,sx:{mb:3},centered:!0,children:[e.jsx(ne,{label:"Sign In"}),e.jsx(ne,{label:"Sign Up"})]}),h===0&&e.jsxs(R,{sx:{textAlign:"center",mb:2},children:[e.jsx(H,{variant:"h4",color:"primary",sx:{fontWeight:"bold",fontSize:24,mt:.75},children:"Welcome Back"}),e.jsx(H,{variant:"body1",color:"text.secondary",sx:{fontSize:14,mt:.25},children:"Sign in to continue"})]}),h===0&&e.jsxs("form",{onSubmit:be,style:{width:"100%"},children:[e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:P.email,onChange:ie,disabled:f||y,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(N,{color:"action"})})}}),e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:E?"text":"password",id:"password",autoComplete:"current-password",value:P.password,onChange:ie,disabled:f||y,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(Y,{color:"action"})}),endAdornment:e.jsx(l,{position:"end",children:e.jsx(G,{"aria-label":"toggle password visibility",onClick:()=>pe(!E),edge:"end",disabled:f||y,children:E?e.jsx(U,{}):e.jsx(V,{})})})}}),e.jsx(R,{sx:{display:"flex",justifyContent:"flex-end",mt:1,mb:2},children:e.jsx(Le,{component:"button",type:"button",variant:"body2",underline:"hover",onClick:t=>{t.preventDefault(),t.stopPropagation(),M(!0)},sx:{border:"none",background:"none",cursor:"pointer",color:o.palette.primary.main,"&:hover":{color:o.palette.primary.dark}},children:"Forgot password?"})}),e.jsx(de,{isOpen:!!F,onClose:()=>v(null),rateLimitData:F,endpoint:"login",onRetry:()=>{v(null),u("")}}),I&&!F&&e.jsx(C,{in:!0,children:e.jsx(w,{severity:"error",sx:{width:"100%",mb:2},icon:e.jsx(Z,{}),children:I})}),y&&e.jsx(C,{in:!0,children:e.jsx(w,{severity:"success",sx:{width:"100%",mb:2},icon:e.jsx(J,{}),children:"Login successful! Redirecting..."})}),e.jsx(k,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:f||y,children:f?e.jsx(K,{size:24,color:"inherit"}):"Sign In"})]}),h===1&&e.jsxs("form",{onSubmit:we,style:{width:"100%"},children:[e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"firstname",label:"First Name",name:"firstname",autoComplete:"given-name",value:i.firstname,onChange:j,disabled:c||m,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"lastname",label:"Last Name",name:"lastname",autoComplete:"family-name",value:i.lastname,onChange:j,disabled:c||m,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(p,{required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",value:i.email,onChange:j,disabled:c||m,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(N,{color:"action"})})}})}),e.jsx(g,{item:!0,xs:12,children:e.jsxs(Te,{fullWidth:!0,required:!0,children:[e.jsx(ke,{id:"department-label",children:"Department"}),e.jsx(De,{labelId:"department-label",id:"departmentId",name:"departmentId",value:i.departmentId,label:"Department",onChange:j,disabled:c||m,startAdornment:e.jsx(l,{position:"start",children:e.jsx(Ee,{color:"action"})}),children:O.map(t=>e.jsx(Ae,{value:t.id,children:t.name},t.id))})]})}),e.jsxs(g,{item:!0,xs:12,sm:6,children:[e.jsx(p,{required:!0,fullWidth:!0,name:"password",label:"Password",type:b?"text":"password",id:"register-password",autoComplete:"new-password",value:i.password,onChange:j,disabled:c||m,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(Y,{color:"action"})}),endAdornment:e.jsx(l,{position:"end",children:e.jsx(G,{"aria-label":"toggle password visibility",onClick:()=>ee(!b),edge:"end",disabled:c||m,children:b?e.jsx(U,{}):e.jsx(V,{})})})}}),e.jsx(_e,{password:i.password})]}),e.jsx(g,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:b?"text":"password",id:"register-confirm-password",autoComplete:"new-password",value:i.confirmPassword,onChange:j,disabled:c||m,InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(Y,{color:"action"})}),endAdornment:e.jsx(l,{position:"end",children:e.jsx(G,{"aria-label":"toggle password visibility",onClick:()=>ee(!b),edge:"end",disabled:c||m,children:b?e.jsx(U,{}):e.jsx(V,{})})})}})})]}),e.jsx(de,{isOpen:!!B,onClose:()=>S(null),rateLimitData:B,endpoint:"register",onRetry:()=>{S(null),d("")}}),W&&!B&&e.jsx(C,{in:!0,children:e.jsx(w,{severity:"error",sx:{width:"100%",mt:2},icon:e.jsx(Z,{}),children:W})}),m&&e.jsx(C,{in:!0,children:e.jsx(w,{severity:"success",sx:{width:"100%",mt:2},icon:e.jsx(J,{}),children:"Registration successful! You will be redirected to login in a few seconds..."})}),e.jsx(k,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:c||m,children:c?e.jsx(K,{size:24,color:"inherit"}):"Register"})]})]})})}),e.jsxs(Fe,{open:he,onClose:()=>M(!1),maxWidth:"xs",fullWidth:!0,PaperProps:{sx:{borderRadius:3,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"}},children:[e.jsx(We,{sx:{pb:1,fontWeight:600,color:o.palette.text.primary},children:"Forgot Password"}),e.jsxs(qe,{sx:{pt:2},children:[e.jsx(H,{variant:"body2",sx:{mb:3,color:o.palette.text.secondary},children:"Enter your email address and we'll send you a link to reset your password."}),e.jsx(p,{label:"Email Address",type:"email",fullWidth:!0,margin:"normal",value:_,onChange:t=>fe(t.target.value),disabled:T,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(l,{position:"start",children:e.jsx(N,{color:"action"})})}}),re&&e.jsx(w,{severity:"error",sx:{mt:2},icon:e.jsx(Z,{}),children:re}),ae&&e.jsx(w,{severity:"success",sx:{mt:2},icon:e.jsx(J,{}),children:ae})]}),e.jsxs(ze,{sx:{px:3,pb:3},children:[e.jsx(k,{onClick:()=>M(!1),disabled:T,sx:{color:o.palette.text.secondary,"&:hover":{color:o.palette.text.primary}},children:"Cancel"}),e.jsx(k,{onClick:async()=>{if($(""),oe(""),!_){$("Please enter your email address.");return}se(!0);try{await D.forgotPassword({email:_}),oe("If an account with that email exists, a reset link has been sent.")}catch(t){$(t.response?.data?.error||"Failed to send reset email.")}finally{se(!1)}},variant:"contained",color:"primary",disabled:T,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:600,px:3,minWidth:"120px",height:"36px"},children:T?e.jsx(K,{size:20,color:"inherit"}):"Send Reset Link"})]})]})]})};export{Ye as default};
