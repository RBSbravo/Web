import{r as s,u as ve,j as e,a8 as gr,a9 as jr,G as Zr,H as He,a7 as C,av as ee,aA as et,aB as rt,aw as G,ax as J,ay as K,m as u,a4 as We,aC as tt,am as st,aD as at,aE as nt,aF as cr,aG as M,aH as it,k as yr,V as Ke,al as Qe,ae as Ye,at as Xe,b as p,h as q,d as ae,aJ as ge,aK as rr,aL as tr,B as W,aq as Ze,I as ne,ar as br,as as _e,P as Ee,az as sr,z as $,aM as ot,v as oe,w as le,x as de,a6 as lt,Z as Se,y as ce,aN as wr,aO as dt,aP as er,s as Sr,K as vr,n as Cr,p as kr,aQ as Tr,q as Dr,J as Fr,ap as Oe,aI as ct,F as ut}from"./mui-BfuGcMOQ.js";import{e as H,g as xt,h as pe,f as mt,i as qe,u as ht,L as ft}from"./index-CrljLHvE.js";import{f as Ae,g as Wr,a as Ar,b as ze,c as zr,d as pt,F as gt,C as jt,e as yt,h as ur,i as xr,v as mr,p as hr,j as bt,k as $e,l as Ve,m as fr,n as Ge}from"./FileUploadSection-SQ1O8CrH.js";import{P as wt}from"./PageHeader-BzGhKk7e.js";import{c as St,u as vt}from"./router-DwSTIDLU.js";import"./vendor-Ckhrjn13.js";const Ct=()=>{const[o,g]=s.useState([]),[r,h]=s.useState([]),[S,A]=s.useState([]),[_,R]=s.useState(!0),[L,y]=s.useState(!1),[T,x]=s.useState([]),[E,l]=s.useState([]),[f,t]=s.useState({}),[z,v]=s.useState(""),m=s.useCallback(async()=>{try{const n=await H.getAll(),a=n.data?.tickets||n.tickets||n.data||n||[];if(!Array.isArray(a)){console.warn("Tickets data is not an array:",a),g([]);return}const d=a.sort((j,w)=>{const O=new Date(j.created_at||j.createdAt||0);return new Date(w.created_at||w.createdAt||0)-O});g(d)}catch(n){console.error("Error loading tickets:",n),g([])}},[]),b=s.useCallback(async()=>{try{const n=await H.getAssignedTickets(),a=n.data||n||[];if(!Array.isArray(a)){console.warn("Assigned tickets data is not an array:",a),h([]);return}const d=a.sort((j,w)=>{const O=new Date(j.created_at||j.createdAt||0);return new Date(w.created_at||w.createdAt||0)-O});h(d)}catch(n){console.error("Error loading assigned tickets:",n),h([])}},[]),D=s.useCallback(async()=>{try{const[n,a]=await Promise.all([H.getAll(),H.getAssignedTickets()]),d=n.data?.tickets||n.tickets||n.data||n||[],j=a.data||a||[],w=[...Array.isArray(d)?d:[],...Array.isArray(j)?j:[]],I=JSON.parse(localStorage.getItem("user")||"{}")?.id,Q=w.filter(B=>{const se=B.forwarded_from_id||B.forwardedFromId||B.forwardedFrom?.id,ye=B.is_forwarded===!0||B.isForwarded===!0||typeof B.forward_chain_id<"u"||typeof B.forwardChainId<"u",he=se&&I&&String(se)===String(I);return ye&&he}),Z=new Set,me=Q.filter(B=>!B||!B.id||Z.has(B.id)?!1:(Z.add(B.id),!0)).sort((B,se)=>{const ye=new Date(B.created_at||B.createdAt||0);return new Date(se.created_at||se.createdAt||0)-ye});A(me)}catch(n){console.error("Error loading forwarded-by-me tickets:",n),A([])}},[]),F=s.useCallback(async()=>{try{const n=await xt.getAll(),a=n.data||n||[];x(a)}catch(n){console.error("Error loading departments:",n),x([])}},[]),N=s.useCallback(async()=>{try{const n=await pe.getAll(),a=n.data||n||[];l(a)}catch(n){console.error("Error loading users:",n),l([])}},[]),Y=s.useCallback(async()=>{try{R(!0),v(""),await Promise.all([m(),b(),D(),F(),N()])}catch(n){console.error("Error loading initial data:",n),v("Failed to load data. Please try again.")}finally{R(!1)}},[m,b,D,F,N]),ue=s.useCallback(async(n,a=[])=>{y(!0);try{const d=await H.create(n),j=d.data||d;if(a&&a.length>0)try{for(const w of a)w.file?await H.uploadAttachment(j.id,w.file):await H.uploadAttachment(j.id,w)}catch(w){console.error("Error uploading files:",w)}return g(w=>[j,...w]),{success:!0,ticket:j}}catch(d){return console.error("Error creating ticket:",d),{success:!1,error:d.response?.data?.message||"Failed to create ticket."}}finally{y(!1)}},[]),Re=s.useCallback(async n=>{y(!0);try{const a=await H.update(n.id,n),d=a.data||a;return g(j=>j.map(w=>w.id===d.id?d:w)),{success:!0,ticket:d}}catch(a){return console.error("Error updating ticket:",a),{success:!1,error:a.response?.data?.message||"Failed to update ticket."}}finally{y(!1)}},[]),Ce=s.useCallback(async n=>{if(!n)return{success:!1,error:"Invalid ticket ID for deletion."};y(!0);try{return await H.delete(n),g(a=>a.filter(d=>d.id!==n)),{success:!0}}catch(a){return console.error("Error deleting ticket:",a),{success:!1,error:a.response?.data?.message||"Failed to delete ticket."}}finally{y(!1)}},[]),Ie=s.useCallback(async(n,a)=>{y(!0);try{const d=await H.forwardTicket(n,a);try{const w=JSON.parse(localStorage.getItem("user")||"{}")?.id,O=await H.getById(n),I=O.data||O||null;if(I&&w){const Q=I.forwarded_from_id||I.forwardedFromId||I.forwardedFrom?.id;(I.is_forwarded===!0||I.isForwarded===!0||typeof I.forward_chain_id<"u"||typeof I.forwardChainId<"u")&&Q&&String(Q)===String(w)&&A(te=>te.some(B=>B.id===I.id)?te:[I,...te])}}catch{}return await m(),await D(),{success:!0,data:d.data||d}}catch(d){return console.error("Error forwarding ticket:",d),{success:!1,error:d.response?.data?.message||"Failed to forward ticket."}}finally{y(!1)}},[m,D]),ke=s.useCallback(async n=>{try{const a=await H.getAttachments(n),d=a.data||a||[];return t(j=>({...j,[n]:d})),d}catch(a){return console.error("Error loading ticket files:",a),t(d=>({...d,[n]:[]})),[]}},[]),Pe=s.useCallback(async(n,a)=>{try{const d=await H.uploadAttachment(a,n),j=d.data||d;return t(w=>({...w,[a]:[...w[a]||[],j]})),j}catch(d){if(console.error("File upload error:",d),d.response?.status===500){console.warn("Server returned 500 but file may have been uploaded successfully");try{const j=await H.getAttachments(a);if(j.data&&j.data.length>0)return t(w=>({...w,[a]:j.data})),j.data[j.data.length-1]}catch(j){console.error("Error refreshing file list:",j)}}throw new Error("Failed to upload file.")}},[]),re=s.useCallback(async(n,a)=>{try{await H.deleteAttachment(n,a),t(d=>({...d,[n]:d[n]?.filter(j=>j.id!==a)||[]}))}catch{throw new Error("Failed to delete file.")}},[]),Le=s.useCallback(async(n,a)=>{try{const d=await mt.download(a),j=new Blob([d.data]),w=window.URL.createObjectURL(j),O=document.createElement("a");O.href=w;const I=d.headers["content-disposition"];let Q="download";if(I){const Z=I.match(/filename="(.+)"/);Z&&(Q=Z[1])}O.download=Q,document.body.appendChild(O),O.click(),document.body.removeChild(O),window.URL.revokeObjectURL(w)}catch{throw new Error("Failed to download file.")}},[]),xe=s.useCallback(n=>f[n]||[],[f]),Te=s.useCallback(async(n,a)=>{try{const d=await qe.addTicketComment(n,a);return{success:!0,comment:d.data||d}}catch(d){return console.error("Error adding comment:",d),{success:!1,error:d.response?.data?.message||"Failed to add comment."}}},[]),X=s.useCallback(async n=>{try{const a=await qe.fetchTicketComments(n);return a.data||a||[]}catch(a){return console.error("useTickets: Error loading comments:",a),[]}},[]),je=s.useCallback(async n=>{try{return await qe.deleteComment(n),{success:!0}}catch(a){return console.error("Error deleting comment:",a),{success:!1,error:a.response?.data?.message||"Failed to delete comment."}}},[]),ie=s.useCallback(async()=>{try{await Promise.all([m(),b(),D()])}catch(n){console.error("Error refreshing tickets:",n)}},[m,b,D]);return s.useEffect(()=>{Y()},[Y]),{tickets:o,assignedTickets:r,forwardedTickets:S,loading:_,actionLoading:L,departments:T,users:E,error:z,loadTickets:m,loadAssignedTickets:b,loadForwardedTickets:D,createTicket:ue,updateTicket:Re,deleteTicket:Ce,forwardTicket:Ie,loadTicketFiles:ke,uploadTicketFile:Pe,deleteTicketFile:re,downloadTicketFile:Le,getTicketFiles:xe,addComment:Te,loadComments:X,deleteComment:je,refreshTickets:ie,setError:v}},kt=({activeTab:o,setActiveTab:g,searchQuery:r,setSearchQuery:h,filter:S,setFilter:A,priorityFilter:_,setPriorityFilter:R,isMobile:L})=>(ve(),e.jsx(gr,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsxs(jr,{sx:{p:{xs:2,sm:2.5,md:3}},children:[e.jsxs(Zr,{value:o,onChange:(y,T)=>g(T),variant:"fullWidth",sx:{mb:2,"& .MuiTab-root":{fontSize:{xs:"0.95rem",sm:"1.05rem"},fontWeight:600,textTransform:"none",minHeight:{xs:44,sm:52}},"& .Mui-selected":{color:"primary.main"}},children:[e.jsx(He,{label:L?"Sent":"Sent Tickets"}),e.jsx(He,{label:L?"Received":"Received Tickets"}),e.jsx(He,{label:L?"Forwarded":"Forwarded by Me"})]}),e.jsxs(C,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(C,{item:!0,xs:12,sm:6,md:4,children:e.jsx(ee,{fullWidth:!0,placeholder:"Search tickets...",value:r,onChange:y=>h(y.target.value),InputProps:{startAdornment:e.jsx(et,{position:"start",children:e.jsx(rt,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(G,{fullWidth:!0,children:[e.jsx(J,{children:"Status"}),e.jsxs(K,{value:S,label:"Status",onChange:y=>A(y.target.value),sx:{borderRadius:2},children:[e.jsx(u,{value:"all",children:"All Status"}),e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"in_progress",children:"In Progress"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(G,{fullWidth:!0,children:[e.jsx(J,{children:"Priority"}),e.jsxs(K,{value:_,label:"Priority",onChange:y=>R(y.target.value),sx:{borderRadius:2},children:[e.jsx(u,{value:"all",children:"All Priority"}),e.jsx(u,{value:"high",children:"High"}),e.jsx(u,{value:"medium",children:"Medium"}),e.jsx(u,{value:"low",children:"Low"})]})]})})]})]})}));function Je({title:o,children:g,...r}){const h=s.useRef(null),[S,A]=s.useState(!1);return s.useEffect(()=>{const _=h.current;_&&A(_.scrollWidth>_.clientWidth)},[g,o]),S?e.jsx(q,{title:o,arrow:!0,...r,children:e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:g})}):e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:g})}const Tt=({tickets:o,users:g,activeTab:r,onViewTicket:h,onEditTicket:S,onDeleteTicket:A,getStatusColor:_,getStatusIcon:R,getPriorityColor:L,getPriorityIcon:y})=>{const T=ve(),x=We(T.breakpoints.down("sm")),[E,l]=s.useState({});s.useEffect(()=>{if(r!==2||!Array.isArray(o))return;const t=new Set((Array.isArray(g)?g:[]).map(m=>String(m.id))),z=new Set(Object.keys(E)),v=new Set;o.forEach(m=>{const b=m.forwardedTo||m.forwarded_to||m.forwarded_to_id||m.current_handler_id;if(b&&typeof b!="object"){const D=String(b);!t.has(D)&&!z.has(D)&&v.add(D)}}),v.size!==0&&(async()=>{const m=await Promise.all(Array.from(v).map(async b=>{try{const D=await pe.getById(b),F=D.data||D||null;return[b,F]}catch{return[b,null]}}));l(b=>{const D={...b};return m.forEach(([F,N])=>{D[F]=N}),D})})()},[r,o,g,E]);const f=t=>{if(!t)return"Unknown User";if(typeof t=="object")return ze(t);const z=String(t),v=g.find(m=>String(m.id)===z)||E[z];return v?ze(v):z};return x?null:e.jsx(tt,{component:st,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(at,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(nt,{children:e.jsxs(cr,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(M,{padding:"checkbox",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(M,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(M,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:r===0?"Send To":r===1?"Sent By":r===2?"Forwarded To":"Created By"}),e.jsx(M,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(M,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(it,{children:o.map((t,z)=>e.jsxs(cr,{hover:!0,sx:{bgcolor:z%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(M,{padding:"checkbox",sx:{px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(M,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(yr,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:(()=>{switch(R(t.status)){case"Schedule":return e.jsx(Xe,{sx:{fontSize:{md:14,lg:18}}});case"CheckCircle":return e.jsx(Ye,{sx:{fontSize:{md:14,lg:18}}});case"Error":return e.jsx(Qe,{sx:{fontSize:{md:14,lg:18}}});default:return e.jsx(Ke,{sx:{fontSize:{md:14,lg:18}}})}})()})}),e.jsxs(M,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(Je,{title:t.title,children:e.jsx(p,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:t.title})}),e.jsx(Je,{title:t.description,children:e.jsx(p,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:t.description})})]}),e.jsx(M,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(q,{title:`Priority: ${t.priority}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ae,{label:t.priority,size:"small",color:L(t.priority),icon:(()=>{switch(y(t.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:{md:12,lg:16}}});case"Remove":return e.jsx(ge,{sx:{fontSize:{md:12,lg:16}}});case"LowPriority":return e.jsx(rr,{sx:{fontSize:{md:12,lg:16}}});default:return e.jsx(ge,{sx:{fontSize:{md:12,lg:16}}})}})(),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})})})}),e.jsx(M,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(q,{title:`Status: ${t.status.replace("_"," ")}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ae,{label:t.status.replace("_"," "),size:"small",color:_(t.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})})})}),e.jsx(M,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(Je,{title:(()=>{if(r===0)return f(t.ticketAssignee||t.assignedTo||t.assigned_to);if(r===1)return f(t.ticketCreator||t.createdBy||t.created_by);if(r===2){const v=t.forwardedTo||t.forwarded_to||t.forwarded_to_id||t.current_handler_id;return f(v)}return f(t.ticketCreator||t.createdBy||t.created_by)})(),children:e.jsx(p,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:"0.78rem",overflow:"hidden",textOverflow:"ellipsis"},children:(()=>{if(r===0)return f(t.ticketAssignee||t.assignedTo||t.assigned_to);if(r===1)return f(t.ticketCreator||t.createdBy||t.created_by);if(r===2){const v=t.forwardedTo||t.forwarded_to||t.forwarded_to_id||t.current_handler_id;return f(v)}return f(t.ticketCreator||t.createdBy||t.created_by)})()})})}),e.jsx(M,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[t.due_date&&e.jsx(q,{title:Ae(t.due_date),arrow:!0,children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Ze,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(p,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:Ae(t.due_date)})]})}),(()=>{const v=Wr(t),m=Ar(t);return!v||!m?null:e.jsx(q,{title:`Maturity: ${m}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ae,{label:m,size:"small",color:v,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(M,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsx(W,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(q,{title:"View Details",children:e.jsx("span",{children:e.jsx(ne,{color:"primary",size:"small",onClick:()=>h(t),children:e.jsx(br,{fontSize:"small"})})})}),e.jsx(q,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(ne,{color:"secondary",size:"small",onClick:()=>S(t),children:e.jsx(_e,{fontSize:"small"})})})}),e.jsx(q,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(ne,{color:"error",size:"small",onClick:()=>A(t),children:e.jsx(Ee,{fontSize:"small"})})})})]})})})]},t.id))})]})})},Dt=({ticket:o,departments:g,users:r,activeTab:h,onViewTicket:S,onEditTicket:A,onDeleteTicket:_,getPriorityColor:R,getPriorityIcon:L,getStatusColor:y,getTicketFiles:T})=>{const x=ve(),E=We(x.breakpoints.down("sm")),l=f=>{if(!f)return"Unknown";if(typeof f=="object"&&f.firstname)return ze(f);const t=r.find(z=>z.id===f);return ze(t)};return E?e.jsx(gr,{sx:{borderRadius:3,boxShadow:2,overflow:"hidden"},children:e.jsxs(jr,{sx:{p:3},children:[e.jsx(W,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:e.jsxs(W,{sx:{flex:1,minWidth:0},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:700,mb:1,wordBreak:"break-word"},children:o.title}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2,lineHeight:1.5},children:o.description})]})}),e.jsxs(W,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(ae,{label:o.priority,size:"small",color:R(o.priority),icon:(()=>{switch(L(o.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:14}});case"Remove":return e.jsx(ge,{sx:{fontSize:14}});case"LowPriority":return e.jsx(rr,{sx:{fontSize:14}});default:return e.jsx(ge,{sx:{fontSize:14}})}})(),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),e.jsx(ae,{label:o.status.replace("_"," "),size:"small",color:y(o.status),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),(()=>{const f=Wr(o),t=Ar(o);return!f||!t?null:e.jsx(ae,{label:t,size:"small",color:f,sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}})})()]}),e.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1,mb:2},children:[e.jsxs(p,{variant:"body2",color:"text.secondary",children:[e.jsxs("strong",{children:[h===0?"Send To":h===1?"Sent By":h===2?"Forwarded To":"Created By",":"]})," ",l(h===0?o.ticketAssignee||o.assignedTo||o.assigned_to:h===1?o.ticketCreator||o.createdBy||o.created_by:h===2?o.forwarded_to_id:o.ticketCreator||o.createdBy||o.created_by)]}),o.due_date&&e.jsxs(p,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Due Date:"})," ",Ae(o.due_date)]})]}),T(o.id).length>0&&e.jsxs(W,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(sr,{fontSize:"small",sx:{mr:1,color:"text.secondary"}}),e.jsxs(p,{variant:"caption",color:"text.secondary",children:[T(o.id).length," file(s) attached"]})]}),e.jsx(W,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(q,{title:"View Details",children:e.jsx("span",{children:e.jsx(ne,{color:"primary",size:"small",onClick:()=>S(o),children:e.jsx(br,{fontSize:"small"})})})}),e.jsx(q,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(ne,{color:"secondary",size:"small",onClick:()=>A(o),children:e.jsx(_e,{fontSize:"small"})})})}),e.jsx(q,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(ne,{color:"error",size:"small",onClick:()=>_(o),children:e.jsx(Ee,{fontSize:"small"})})})})]})})]})}):null},Ft=({ticket:o,onForward:g,disabled:r=!1})=>{const[h,S]=s.useState(!1),[A,_]=s.useState([]),[R,L]=s.useState(""),[y,T]=s.useState(""),[x,E]=s.useState(!1),[l,f]=s.useState("");s.useEffect(()=>{h&&t()},[h]);const t=async()=>{try{E(!0),f("");let m=[];try{const F=await pe.getAll({role:"department_head"}),N=await pe.getAll({role:"admin"}),Y=F.data||F||[],ue=N.data||N||[];m=[...Y,...ue],console.log("Department heads and admins fetched with role param:",m)}catch(F){console.log("Role-based fetch failed, trying all users:",F);const N=await pe.getAll();m=N.data||N||[],console.log("All users fetched:",m)}let b=m;m.length>0&&!m.some(F=>F.role==="department_head"||F.role==="admin")&&(b=m.filter(F=>{const N=F.role?.toLowerCase();return N==="admin"||N==="department_head"||N==="departmenthead"||N==="dept_head"||N==="head"||F.role&&F.role.includes("head")})),console.log("Eligible users found:",b);const D=b.map(F=>{const N=F.role==="admin"?"Admin":"Dept Head";return{...F,displayName:`${F.firstname||F.firstName||"Unknown"} ${F.lastname||F.lastName||"User"} (${N})`}});D.length===0?f("No department heads or admins found in the system. Please ensure there are users with appropriate roles."):(_(D),f(""))}catch(m){console.error("Error loading recipients:",m),f("Failed to load recipients. Please try again.")}finally{E(!1)}},z=async()=>{if(!R||!y.trim()){f("Please select a recipient and provide a reason");return}E(!0),f("");try{await H.forwardTicket(o.id,{toUserId:R,reason:y.trim()}),g&&g(),S(!1),L(""),T("")}catch(m){console.error("Error forwarding ticket:",m),f(m.response?.data?.error||"Failed to forward ticket")}finally{E(!1)}},v=()=>{S(!1),L(""),T(""),f("")};return e.jsxs(e.Fragment,{children:[e.jsx($,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:()=>S(!0),disabled:r,sx:{mr:1},children:"Forward"}),e.jsxs(oe,{open:h,onClose:v,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(le,{children:["Forward Ticket #",o?.id]}),e.jsxs(de,{children:[l&&e.jsx(lt,{severity:"error",sx:{mb:2},children:l}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Forwarding ticket to a department head or admin"}),e.jsxs(G,{fullWidth:!0,sx:{mb:2},children:[e.jsx(J,{children:"Forward To"}),e.jsx(K,{value:R,onChange:m=>L(m.target.value),label:"Forward To",disabled:x||A.length===0,children:x?e.jsx(u,{disabled:!0,children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Se,{size:16}),"Loading recipients..."]})}):A.length===0?e.jsx(u,{disabled:!0,children:"No recipients available"}):A.map(m=>e.jsx(u,{value:m.id,children:m.displayName},m.id))})]}),e.jsx(ee,{fullWidth:!0,label:"Reason for Forwarding",value:y,onChange:m=>T(m.target.value),multiline:!0,rows:3,required:!0,disabled:x,sx:{mb:2}})]}),e.jsxs(ce,{children:[e.jsx($,{onClick:v,disabled:x,children:"Cancel"}),e.jsx($,{onClick:z,variant:"contained",disabled:!R||!y.trim()||x,children:x?e.jsx(Se,{size:20}):"Forward Ticket"})]})]})]})},Wt=({open:o,message:g,onClose:r})=>e.jsxs(oe,{open:o,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(le,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(wr,{color:"error",sx:{fontSize:32}}),"Error"]}),e.jsx(de,{children:e.jsx(p,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:g})}),e.jsx(ce,{children:e.jsx($,{onClick:r,variant:"contained",color:"error",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),At=({open:o,message:g,onClose:r})=>e.jsxs(oe,{open:o,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(le,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main",fontWeight:700},children:[e.jsx(dt,{color:"success",sx:{fontSize:32}}),"Success"]}),e.jsx(de,{children:e.jsx(p,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:g})}),e.jsx(ce,{children:e.jsx($,{onClick:r,variant:"contained",color:"success",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),zt=({open:o,ticket:g,onClose:r,onConfirm:h,loading:S})=>e.jsxs(oe,{open:o,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(le,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(wr,{color:"error",sx:{fontSize:32}}),"Confirm Deletion"]}),e.jsxs(de,{children:[e.jsx(p,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:2},children:"Are you sure you want to delete this ticket? This action cannot be undone."}),e.jsx(p,{variant:"body1",sx:{fontWeight:"bold",color:"text.primary",bgcolor:"action.hover",p:2,borderRadius:1,fontSize:"1.1rem"},children:g?.title})]}),e.jsxs(ce,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:r,sx:{minWidth:100},children:"Cancel"}),e.jsx($,{onClick:h,color:"error",variant:"contained",disabled:S,sx:{minWidth:100},children:S?e.jsx(Se,{size:20}):"Delete"})]})]}),_t=({open:o,onClose:g,newTicket:r,onTicketChange:h,newTicketFiles:S,onFileUpload:A,onFileDelete:_,departments:R,users:L,onSubmit:y,loading:T,isMobile:x,currentUserId:E})=>e.jsxs(oe,{open:o,onClose:g,maxWidth:"sm",fullWidth:!0,fullScreen:x,children:[e.jsx(le,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:"Create New Ticket"}),e.jsx(de,{sx:{pt:{xs:1,sm:2}},children:e.jsx(W,{component:"form",onSubmit:l=>{l.preventDefault(),y()},sx:{mt:1},children:e.jsxs(C,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Ticket Title",name:"title",value:r.title,onChange:h,required:!0,sx:{mb:2}})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Description",name:"description",value:r.description,onChange:h,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(G,{fullWidth:!0,required:!0,children:[e.jsx(J,{children:"Desired Action"}),e.jsxs(K,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,children:[e.jsx(u,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(u,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(u,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(u,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(u,{value:"Dispatch",children:"Dispatch"}),e.jsx(u,{value:"File",children:"File"}),e.jsx(u,{value:"Mis routed",children:"Mis routed"}),e.jsx(u,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(u,{value:"photocopy file",children:"Photocopy file"}),e.jsx(u,{value:"Study",children:"Study"}),e.jsx(u,{value:"Staff action",children:"Staff action"}),e.jsx(u,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(G,{fullWidth:!0,children:[e.jsx(J,{children:"Priority"}),e.jsxs(K,{name:"priority",value:r.priority,label:"Priority",onChange:h,children:[e.jsx(u,{value:"Low",children:"Low"}),e.jsx(u,{value:"Medium",children:"Medium"}),e.jsx(u,{value:"High",children:"High"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(G,{fullWidth:!0,children:[e.jsx(J,{children:"Status"}),e.jsxs(K,{name:"status",value:r.status||"pending",label:"Status",onChange:h,children:[e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"in_progress",children:"In Progress"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(G,{fullWidth:!0,required:!0,children:[e.jsx(J,{children:"Send To"}),e.jsxs(K,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,children:[e.jsx(er,{children:"Admins"}),L.filter(l=>l.role==="admin").filter(l=>l.id!==E).map(l=>e.jsxs(u,{value:l.id,children:[l.firstname," ",l.lastname," (Admin)"]},l.id)),e.jsx(er,{children:"Department Heads"}),R.filter(l=>l.head).filter(l=>l.head.id!==E).map(l=>e.jsxs(u,{value:l.head.id,children:[l.head.firstname," ",l.head.lastname," (Dept Head, ",l.name,")"]},l.head.id))]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(ee,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(W,{sx:{mt:3},children:[e.jsx(p,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),S.length===0&&e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),S.length>0&&e.jsx(Sr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:S.map(l=>{const f=l.file_name||l.name||"Unknown File";return e.jsxs(vr.Fragment,{children:[e.jsxs(Cr,{secondaryAction:e.jsx(q,{title:"Delete file",arrow:!0,children:e.jsx(ne,{edge:"end",onClick:()=>_(l.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(Ee,{fontSize:"small"})})}),children:[e.jsx(kr,{children:e.jsx(Tr,{})}),e.jsx(Dr,{primary:e.jsx(q,{title:"Click to download file",arrow:!0,children:e.jsx(p,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(l.file){const t=URL.createObjectURL(l.file),z=document.createElement("a");z.href=t,z.download=l.name,document.body.appendChild(z),z.click(),document.body.removeChild(z),URL.revokeObjectURL(t)}},children:f})}),secondary:e.jsxs(p,{variant:"caption",color:"text.disabled",children:[l.uploadedAt?new Date(l.uploadedAt).toLocaleString():"—"," • ",zr(l.file_size||l.size||0)]})})]}),e.jsx(Fr,{variant:"inset",component:"li"})]},l.id)})}),e.jsxs($,{variant:"outlined",component:"label",startIcon:e.jsx(sr,{}),disabled:T||S.length>=5,sx:{mt:1},children:[T?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:l=>{const f=l.target.files[0];f&&A(f)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:T||S.length>=5})]}),e.jsx(W,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(ce,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:g,children:"Cancel"}),e.jsx($,{variant:"contained",onClick:y,disabled:T,sx:{minWidth:100},children:T?e.jsx(Se,{size:20}):"Create Ticket"})]})]}),Et=({open:o,onClose:g,ticket:r,departments:h,users:S=[],getStatusColor:A,getStatusIcon:_,getPriorityColor:R,getPriorityIcon:L,onRefresh:y,getTicketFiles:T,onFileDelete:x,onEdit:E,isMobile:l,addComment:f,loadComments:t,deleteComment:z})=>{ve();const v=b=>{if(!b)return"Unknown";if(typeof b=="object"&&b.firstname)return`${b.firstname} ${b.lastname}`.trim()||b.email||b.username||"Unknown";const D=S.find(F=>F.id===b);return D&&(`${D.firstname} ${D.lastname}`.trim()||D.email||D.username)||b},m=b=>{if(!b)return"N/A";const D=h.find(F=>F.id===b);return D?D.name:b};return r?e.jsxs(oe,{open:o,onClose:g,maxWidth:"md",fullWidth:!0,fullScreen:l,children:[e.jsxs(le,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2},display:"flex",alignItems:"center",gap:2},children:[e.jsx(yr,{sx:{bgcolor:`${A(r.status)}.light`,color:`${A(r.status)}.main`,width:{xs:32,sm:40},height:{xs:32,sm:40}},children:(()=>{switch(_(r.status)){case"Schedule":return e.jsx(Xe,{sx:{fontSize:{xs:16,sm:20}}});case"CheckCircle":return e.jsx(Ye,{sx:{fontSize:{xs:16,sm:20}}});case"Error":return e.jsx(Qe,{sx:{fontSize:{xs:16,sm:20}}});default:return e.jsx(Ke,{sx:{fontSize:{xs:16,sm:20}}})}})()}),e.jsxs(W,{sx:{flex:1},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:600},children:r.title}),e.jsxs(p,{variant:"body2",color:"text.secondary",children:["Ticket #",r.id]})]})]}),e.jsxs(de,{sx:{pt:{xs:1,sm:2}},children:[e.jsxs(C,{container:!0,spacing:3,children:[e.jsxs(C,{item:!0,xs:12,children:[e.jsx(p,{variant:"h6",sx:{mb:2,fontWeight:600},children:"Description"}),e.jsx(W,{sx:{mb:3},children:e.jsx(p,{variant:"body1",children:r.description})})]}),(r.desired_action||r.desiredAction)&&e.jsxs(C,{item:!0,xs:12,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Desired Action"}),e.jsx(p,{variant:"body1",children:r.desired_action||r.desiredAction})]}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",children:"Priority"}),e.jsx(ae,{label:r.priority,color:R(r.priority),icon:(()=>{switch(L(r.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:16}});case"Remove":return e.jsx(ge,{sx:{fontSize:16}});case"LowPriority":return e.jsx(rr,{sx:{fontSize:16}});default:return e.jsx(ge,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx(ae,{label:r.status.replace("_"," "),color:A(r.status),icon:(()=>{switch(_(r.status)){case"Schedule":return e.jsx(Xe,{sx:{fontSize:16}});case"CheckCircle":return e.jsx(Ye,{sx:{fontSize:16}});case"Error":return e.jsx(Qe,{sx:{fontSize:16}});default:return e.jsx(Ke,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created By"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Oe,{sx:{fontSize:20},color:"action"}),v(r.ticketCreator||r.createdBy||r.created_by)]})]}),e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Department"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Oe,{sx:{fontSize:20},color:"action"}),m(r.departmentId||r.department_id)]})]}),(r.ticketAssignee||r.assignedTo||r.assigned_to)&&e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Assigned To"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Oe,{sx:{fontSize:20},color:"action"}),v(r.ticketAssignee||r.assignedTo||r.assigned_to)]})]}),r.due_date&&e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Due Date"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ze,{sx:{fontSize:20},color:"action"}),Ae(r.due_date)]})]}),e.jsxs(C,{item:!0,xs:12,children:[e.jsx(p,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created"}),e.jsxs(p,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ze,{sx:{fontSize:20},color:"action"}),pt(r.created_at||r.createdAt)]})]})]}),T(r.id).length>0&&e.jsx(W,{sx:{mt:3},children:e.jsx(gt,{entityId:r.id,fetchFiles:async()=>({data:T(r.id)}),uploadFile:()=>{},deleteFile:x,maxFiles:5,maxFileSize:10*1024*1024,acceptedTypes:["*/*"],disabled:!1,readOnly:!0})}),e.jsx(jt,{entityId:r?.id,user:JSON.parse(localStorage.getItem("user")||"{}"),users:S,fetchComments:t,addComment:f,deleteComment:z})]}),e.jsxs(ce,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:g,children:"Close"}),e.jsx(Ft,{ticket:r,disabled:!(r?.forwarded_to_id===JSON.parse(localStorage.getItem("user")||"{}")?.id||r?.current_handler_id===JSON.parse(localStorage.getItem("user")||"{}")?.id),onForward:()=>{g(),typeof y=="function"&&y()}}),e.jsx($,{variant:"contained",startIcon:e.jsx(_e,{}),onClick:()=>{g(),E(r)},sx:{minWidth:100},children:"Edit Ticket"})]})]}):null},Rt=({open:o,onClose:g,ticket:r,onTicketChange:h,editingTicketFiles:S,onFileUpload:A,onFileDelete:_,departments:R,onSubmit:L,loading:y,fileOperationsCount:T=0})=>r?e.jsxs(oe,{open:o,onClose:g,maxWidth:"md",fullWidth:!0,children:[e.jsx(le,{children:e.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(_e,{color:"primary"}),e.jsx(p,{variant:"h6",children:"Edit Ticket"})]})}),e.jsx(de,{dividers:!0,children:r&&e.jsx(W,{sx:{pt:1},children:e.jsxs(C,{container:!0,spacing:3,children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Title",name:"title",value:r.title||"",onChange:h,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:"Description",name:"description",value:r.description||"",onChange:h,multiline:!0,rows:4,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(G,{fullWidth:!0,required:!0,children:[e.jsx(J,{children:"Desired Action"}),e.jsxs(K,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,sx:{borderRadius:2},children:[e.jsx(u,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(u,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(u,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(u,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(u,{value:"Dispatch",children:"Dispatch"}),e.jsx(u,{value:"File",children:"File"}),e.jsx(u,{value:"Mis routed",children:"Mis routed"}),e.jsx(u,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(u,{value:"photocopy file",children:"Photocopy file"}),e.jsx(u,{value:"Study",children:"Study"}),e.jsx(u,{value:"Staff action",children:"Staff action"}),e.jsx(u,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(ee,{fullWidth:!0,label:T!==0?"Remarks (Required - File operations performed)":"Remarks (Required for updates)",name:"remarks",value:r?.remarks||"",onChange:h,multiline:!0,rows:3,required:!0,error:T!==0&&!r?.remarks?.trim(),helperText:T!==0?"Remarks are required when file operations are performed":"Please provide remarks explaining the changes made to this ticket",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(G,{fullWidth:!0,required:!0,children:[e.jsx(J,{children:"Priority"}),e.jsxs(K,{name:"priority",value:r.priority||"Medium",label:"Priority",onChange:h,sx:{borderRadius:2},children:[e.jsx(u,{value:"Low",children:"Low"}),e.jsx(u,{value:"Medium",children:"Medium"}),e.jsx(u,{value:"High",children:"High"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(G,{fullWidth:!0,children:[e.jsx(J,{children:"Status"}),e.jsxs(K,{name:"status",value:r.status||"pending",label:"Status",onChange:h,sx:{borderRadius:2},children:[e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"in_progress",children:"In Progress"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(G,{fullWidth:!0,required:!0,children:[e.jsx(J,{children:"Send To"}),e.jsxs(K,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,sx:{borderRadius:2},children:[e.jsx(er,{children:"Department Heads"}),R.filter(x=>x.head).map(x=>e.jsxs(u,{value:x.head.id,children:[x.head.firstname," ",x.head.lastname," (Dept Head, ",x.name,")"]},x.head.id))]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(ee,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(W,{sx:{mt:3},children:[e.jsx(p,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),S.length===0&&e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),S.length>0&&e.jsx(Sr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:S.map(x=>{const E=x.file_name||x.name||"Unknown File";return e.jsxs(vr.Fragment,{children:[e.jsxs(Cr,{secondaryAction:e.jsx(q,{title:"Delete file",arrow:!0,children:e.jsx(ne,{edge:"end",onClick:()=>_(x.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(Ee,{fontSize:"small"})})}),children:[e.jsx(kr,{children:e.jsx(Tr,{})}),e.jsx(Dr,{primary:e.jsx(q,{title:"Click to download file",arrow:!0,children:e.jsx(p,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(x.file){const l=URL.createObjectURL(x.file),f=document.createElement("a");f.href=l,f.download=x.name,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(l)}else{const l=localStorage.getItem("token"),f=`/api/files/${x.id}/download`;fetch(f,{headers:{Authorization:`Bearer ${l}`}}).then(t=>{if(t.ok)return t.blob();throw new Error("Download failed")}).then(t=>{const z=URL.createObjectURL(t),v=document.createElement("a");v.href=z,v.download=x.name,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(z)}).catch(t=>{console.error("Download error:",t)})}},children:E})}),secondary:e.jsxs(p,{variant:"caption",color:"text.disabled",children:[x.uploadedAt?new Date(x.uploadedAt).toLocaleString():"—"," • ",zr(x.file_size||x.size||0)]})})]}),e.jsx(Fr,{variant:"inset",component:"li"})]},x.id)})}),e.jsxs($,{variant:"outlined",component:"label",startIcon:e.jsx(sr,{}),disabled:y||S.length>=5,sx:{mt:1},children:[y?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:x=>{const E=x.target.files[0];E&&A(E)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:y||S.length>=5})]}),e.jsx(W,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(ce,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx($,{onClick:g,disabled:T!==0,children:"Cancel"}),e.jsx($,{variant:"contained",onClick:L,disabled:y||T!==0&&!r?.remarks?.trim(),sx:{minWidth:100},children:y?e.jsx(Se,{size:20}):"Update Ticket"})]})]}):null,pr={title:"",description:"",priority:"Medium",status:"pending",sendTo:"",due_date:"",departmentId:"",desired_action:"",remarks:""},Mt=()=>{const o=ve(),g=We(o.breakpoints.down("sm"));We(o.breakpoints.between("sm","md"));const{user:r}=ht(),{id:h}=St(),S=vt(),{tickets:A,assignedTickets:_,forwardedTickets:R,loading:L,actionLoading:y,departments:T,users:x,createTicket:E,updateTicket:l,deleteTicket:f,loadTicketFiles:t,uploadTicketFile:z,deleteTicketFile:v,downloadTicketFile:m,getTicketFiles:b,addComment:D,loadComments:F,deleteComment:N,refreshTickets:Y}=Ct(),[ue,Re]=s.useState(""),[Ce,Ie]=s.useState("all"),[ke,Pe]=s.useState("all"),[re,Le]=s.useState(0),[xe,Te]=s.useState(pr),[X,je]=s.useState([]),[ie,n]=s.useState(null),[a,d]=s.useState(null),[j,w]=s.useState([]),[O,I]=s.useState(0),[Q,Z]=s.useState(null),[te,me]=s.useState(!1),[B,se]=s.useState(x),[ye,he]=s.useState(!1),[_r,Ne]=s.useState(!1),[Er,Be]=s.useState(!1),[ar,P]=s.useState({open:!1,message:""}),[nr,be]=s.useState({open:!1,message:""}),De=r?.role==="department_head"||r?.role==="Department Head",we=r?.id,Fe=yt(A,_,R,ue,Ce,ke,re,we);s.useEffect(()=>{if(h&&(A.length>0||_.length>0||R.length>0)){const c=[...A,..._,...R].find(k=>k.id===h);c?(n(c),he(!0)):S("/app/tickets")}},[h,A,_,R,S]),s.useEffect(()=>{te&&(async()=>{try{const c=Array.isArray(x)?x:[];let k=[];try{k=(await pe.getAll({role:"admin"})).data||[]}catch{k=c.filter(Me=>(Me.role||"").toLowerCase()==="admin")}const U=[...c];k.forEach(fe=>{U.some(Me=>Me.id===fe.id)||U.push(fe)});const V=U.filter(fe=>fe.id!==we);se(V)}catch{const c=Array.isArray(x)?x:[];se(c.filter(k=>k.id!==we))}})()},[te,x,we]);const ir=s.useCallback(()=>{Te(pr),je([])},[]),Rr=s.useCallback(i=>{const{name:c,value:k}=i.target;Te(U=>({...U,[c]:k}))},[]),Ir=s.useCallback(async i=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(i.type)){P({open:!0,message:"Only PDF and image files are allowed."});return}const k=10*1024*1024;if(i.size>k){P({open:!0,message:"File size must be less than 10MB."});return}if(X.length>=5){P({open:!0,message:"Maximum 5 files allowed."});return}const U=ur(i,r);je(V=>[...V,U])}catch{P({open:!0,message:"Failed to prepare file for upload."})}},[r,X.length]),Pr=s.useCallback(async i=>{try{je(c=>c.filter(k=>k.id!==i))}catch{P({open:!0,message:"Failed to remove file."})}},[]),Lr=s.useCallback(async i=>{try{const c=X.find(k=>k.id===i);xr(c)}catch{P({open:!0,message:"Failed to download file."})}},[X]),Nr=s.useCallback(async()=>{const i=mr(xe,!1);if(i.length>0){P({open:!0,message:i[0]});return}try{const c=hr(xe,De,r),k=await E(c,X);k.success?(ir(),me(!1),be({open:!0,message:"Ticket created successfully!"})):P({open:!0,message:k.error})}catch(c){P({open:!0,message:c.message||"Failed to create ticket. Please try again."})}},[xe,X,De,r,E,ir]),Br=s.useCallback(async i=>{try{const c=await f(i);c.success?(Be(!1),Z(null),be({open:!0,message:"Ticket deleted successfully!"})):P({open:!0,message:c.error||"Failed to delete ticket"})}catch(c){console.error("Delete ticket error:",c),P({open:!0,message:c.message||"Failed to delete ticket. Please try again."})}},[f]),or=s.useCallback(async i=>{n(i),await t(i.id),he(!0)},[t]),Ue=s.useCallback(async i=>{const c=bt(i);d(c),I(0);try{const k=await t(i.id);w(Array.isArray(k)?k:[])}catch(k){console.error("Error loading ticket files:",k),w([])}Ne(!0)},[t]),Ur=s.useCallback(i=>{const{name:c,value:k}=i.target;d(U=>({...U,[c]:k}))},[]),Mr=s.useCallback(async()=>{const i=mr(a,!0);if(i.length>0){P({open:!0,message:i[0]});return}try{const c=hr(a,De,r),k=await l(c);if(k.success){const U=j.filter(V=>V.id.startsWith("temp-"));if(U.length>0&&a?.id)try{for(const V of U)await z(V.file,a.id)}catch(V){console.error("Error uploading temp files:",V)}Ne(!1),d(null),w([]),be({open:!0,message:"Ticket updated successfully!"})}else P({open:!0,message:k.error})}catch(c){P({open:!0,message:c.message||"Failed to update ticket. Please try again."})}},[a,j,De,r,l,z]),lr=s.useCallback(async()=>{try{await Y()}catch(i){console.error("Error refreshing tickets:",i)}},[Y]),Hr=s.useCallback(async i=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(i.type)){P({open:!0,message:"Only PDF and image files are allowed."});return}const k=10*1024*1024;if(i.size>k){P({open:!0,message:"File size must be less than 10MB."});return}if(j.length>=5){P({open:!0,message:"Maximum 5 files allowed."});return}if(a?.id){await z(i,a.id);const U=await t(a.id);w(Array.isArray(U)?U:[])}else{const U=ur(i,r);w(V=>[...V,U])}I(U=>U+1)}catch(c){console.error("Error uploading file:",c),P({open:!0,message:"Failed to upload file."})}},[a,j.length,r,z,t]),Or=s.useCallback(async i=>{try{if(a?.id){await v(a.id,i);const c=await t(a.id);w(Array.isArray(c)?c:[])}else w(c=>c.filter(k=>k.id!==i));I(c=>c-1)}catch(c){console.error("Error deleting file:",c),P({open:!0,message:"Failed to delete file."})}},[a,v,t]),qr=s.useCallback(async i=>{try{if(a?.id)await m(a.id,i);else{const c=j.find(k=>k.id===i);xr(c)}}catch(c){console.error("Error downloading file:",c),P({open:!0,message:"Failed to download file."})}},[a,j,m]),$r=s.useCallback(async i=>{try{await v(ie.id,i),be({open:!0,message:"File deleted successfully!"})}catch{P({open:!0,message:"Failed to delete file."})}},[ie,v]),Vr=s.useCallback(async i=>{try{await m(ie.id,i)}catch{P({open:!0,message:"Failed to download file."})}},[ie,m]),dr=s.useCallback(i=>{Z(i),Be(!0)},[]),Gr=s.useCallback(()=>{P({open:!1,message:""})},[]),Jr=s.useCallback(()=>{be({open:!1,message:""})},[]),Kr=s.useCallback(()=>{Be(!1)},[]),Qr=s.useCallback(()=>{me(!1)},[]),Yr=s.useCallback(()=>{he(!1),n(null),h&&S("/app/tickets")},[h,S]),Xr=s.useCallback(()=>{Ne(!1),I(0)},[]);return s.useEffect(()=>{const i=()=>{Y()};return window.addEventListener("ticket_update",i),window.addEventListener("new_comment",i),window.addEventListener("notification",i),window.addEventListener("user_update",i),window.addEventListener("task_update",i),()=>{window.removeEventListener("ticket_update",i),window.removeEventListener("new_comment",i),window.removeEventListener("notification",i),window.removeEventListener("user_update",i),window.removeEventListener("task_update",i)}},[Y]),L?e.jsx(ft,{message:"Loading tickets...",size:"large"}):e.jsxs(W,{sx:{p:{xs:2,md:4},backgroundColor:o.palette.background.default,minHeight:"100vh"},children:[e.jsx(wt,{title:"Tickets Management",subtitle:"Track and manage support tickets and requests for your department",emoji:"🎫",color:"primary",onRefresh:lr,actionButton:{text:"New Ticket",icon:e.jsx(ct,{}),onClick:()=>me(!0),disabled:y}}),e.jsx(Wt,{open:ar.open,message:ar.message,onClose:Gr}),e.jsx(At,{open:nr.open,message:nr.message,onClose:Jr}),e.jsx(W,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(ut,{in:!0,timeout:800,children:e.jsxs(W,{children:[e.jsx(kt,{activeTab:re,setActiveTab:Le,searchQuery:ue,setSearchQuery:Re,filter:Ce,setFilter:Ie,priorityFilter:ke,setPriorityFilter:Pe,isMobile:g}),e.jsxs(W,{sx:{mt:2,mb:2},children:[e.jsxs(p,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:[re===0?"Sent Tickets":re===1?"Received Tickets":"Forwarded by Me"," (",Fe.length,")"]}),Fe.length===0?e.jsx(W,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(p,{variant:"body1",children:A.length===0?"No tickets found. Create your first ticket to get started.":"No tickets match your current filters. Try adjusting your search criteria."})}):e.jsxs(e.Fragment,{children:[e.jsx(W,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(Tt,{tickets:Fe,departments:T,users:x,activeTab:re,onViewTicket:or,onEditTicket:Ue,onDeleteTicket:dr,getStatusColor:Ge,getStatusIcon:fr,getPriorityColor:Ve,getPriorityIcon:$e})}),e.jsx(W,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(C,{container:!0,spacing:2,children:Fe.map(i=>e.jsx(C,{item:!0,xs:12,children:e.jsx(Dt,{ticket:i,departments:T,users:x,activeTab:re,onViewTicket:or,onEditTicket:Ue,onDeleteTicket:dr,getPriorityColor:Ve,getPriorityIcon:$e,getStatusColor:Ge,getTicketFiles:b})},i.id))})})]})]})]})})}),e.jsx(zt,{open:Er,ticket:Q,onClose:Kr,onConfirm:()=>Br(Q?.id),loading:y}),e.jsx(_t,{open:te,onClose:Qr,newTicket:xe,onTicketChange:Rr,newTicketFiles:X,onFileUpload:Ir,onFileDelete:Pr,onFileDownload:Lr,departments:T,users:B,onSubmit:Nr,loading:y,isMobile:g,currentUserId:we}),e.jsx(Et,{open:ye,onClose:Yr,ticket:ie,departments:T,users:x,getStatusColor:Ge,getStatusIcon:fr,getPriorityColor:Ve,getPriorityIcon:$e,getTicketFiles:b,onRefresh:lr,onFileDelete:$r,onFileDownload:Vr,onEdit:Ue,isMobile:g,addComment:D,loadComments:F,deleteComment:N}),e.jsx(Rt,{open:_r,onClose:Xr,ticket:a,onTicketChange:Ur,editingTicketFiles:j,onFileUpload:Hr,onFileDelete:Or,onFileDownload:qr,departments:T,users:x,onSubmit:Mr,loading:y,fileOperationsCount:O})]})};export{Mt as default};
