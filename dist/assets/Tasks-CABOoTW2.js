import{r as n,j as e,am as $e,an as Qe,k as ze,B as o,b as f,I as V,ao as Ye,d as $,Z as Ve,ap as He,aq as ue,h as B,ar as We,as as De,P as pe,l as Ce,m as P,Y as G,at as se,au as re,ae as Pe,u as Ae,a4 as he,v as Fe,w as Ee,x as Re,a7 as D,av as X,aw as Z,ax as ee,ay as te,z as q,az as Ke,a6 as Je,y as Ue,J as Xe,a8 as qe,a9 as Ze,aA as et,aB as tt,aC as st,aD as rt,aE as it,aF as Me,aG as U,aH as at,aI as nt,F as lt,a5 as ot}from"./mui-BfuGcMOQ.js";import{c as ve,f as Ie,u as dt,t as M,b as ct,d as Oe,L as mt}from"./index-XpWxWMIU.js";import{g as xt,a as ht,f as ie,C as ut,F as pt}from"./FileUploadSection-SQ1O8CrH.js";import{c as gt,u as ft}from"./router-DwSTIDLU.js";import{P as jt}from"./PageHeader-BzGhKk7e.js";import"./vendor-Ckhrjn13.js";const ge=t=>{switch(t){case"high":return"error";case"medium":return"warning";case"low":return"success";default:return"default"}},fe=t=>{switch(t){case"completed":return"success";case"in_progress":return"primary";case"pending":return"warning";default:return"default"}},je=t=>t?t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:t.firstname&&t.lastname?`${t.firstname} ${t.lastname}`:t.username||t.email||t.id:"Unassigned",_e=t=>xt({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),Be=t=>ht({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),bt=t=>{const s={};return(!t.title||t.title.trim().length<3)&&(s.title="Title must be at least 3 characters long"),(!t.description||t.description.trim().length<10)&&(s.description="Description must be at least 10 characters long"),t.dueDate||(s.dueDate="Due date is required"),(!t.priority||!["low","medium","high"].includes(t.priority))&&(s.priority="Priority must be low, medium, or high"),{isValid:Object.keys(s).length===0,errors:s}},xe=()=>({title:"",description:"",priority:"medium",status:"pending",dueDate:"",assignedToId:"",attachments:[],relatedTicketId:"",remarks:""}),Le=(t,s={})=>{const i={title:t.title?.trim(),description:t.description?.trim(),priority:t.priority,status:t.status,dueDate:t.dueDate||null,assignedToId:t.assignedToId||null,relatedTicketId:t.relatedTicketId||null,remarks:t.remarks?.trim(),...s};return Object.keys(i).forEach(m=>{(i[m]===""||i[m]===void 0)&&delete i[m]}),delete i.attachments,i},Ge=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"}],yt=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}],wt=[{value:"all",label:"All Status"},...Ge];n.memo(function({task:s,departmentUsers:i,canUpdateTask:m,selectedTasks:S,updatingStatus:_,updatingPriority:A,onSelectTask:v,onViewDetails:x,onEditTask:w,onDeleteTask:p,onUpdateStatus:y,onUpdatePriority:j}){const[T,d]=n.useState(null),[c,g]=n.useState(null),[F,k]=n.useState(null),b=R=>{switch(R){case"completed":return e.jsx(Pe,{});case"in_progress":return e.jsx(re,{});case"pending":return e.jsx(se,{});default:return e.jsx(G,{})}},I=R=>d(R.currentTarget),a=()=>d(null),u=()=>{x(s),a()},E=()=>{w(s),a()},z=()=>{p(s),a()},O=i.find(R=>R.id===s.assignedToId),W=je(O);return e.jsxs($e,{elevation:2,sx:{p:{xs:1,sm:1.5,md:2},borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.08)",display:"flex",flexDirection:"row",alignItems:"center",minHeight:{xs:64,sm:72,md:80},mb:1,background:{xs:"rgba(0,0,0,0.01)",sm:"rgba(0,0,0,0.01)",md:"inherit"},"&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.12)",transform:"translateY(-1px)",transition:"all 0.2s ease-in-out"}},tabIndex:0,"aria-label":`Task: ${s.title}`,children:[e.jsx(Qe,{checked:S.includes(s.id),onChange:()=>v(s.id),size:"small",sx:{mr:1,flexShrink:0}}),e.jsx(ze,{sx:{bgcolor:"primary.main",width:{xs:32,sm:36,md:40},height:{xs:32,sm:36,md:40},boxShadow:"0 1px 4px rgba(0,0,0,0.08)",flexShrink:0,mr:{xs:1,sm:1.5,md:2}},children:b(s.status)}),e.jsxs(o,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:{xs:"column",md:"row"},gap:{xs:.5,sm:.8,md:1},alignItems:{md:"center"}},children:[e.jsxs(o,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:{xs:.3,sm:.4,md:.5}},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx(f,{variant:"subtitle1",component:"div",sx:{fontWeight:700,fontSize:{xs:"0.98rem",sm:"1.05rem",md:"1.12rem",lg:"1.18rem"},letterSpacing:.1,lineHeight:1.2,color:"text.primary",wordBreak:"break-word",flex:1,minWidth:0},noWrap:!0,children:s.title}),e.jsx(V,{sx:{color:"text.secondary","&:hover":{color:"primary.main",background:"rgba(46,125,50,0.08)"},width:{xs:28,sm:32,md:36},height:{xs:28,sm:32,md:36},borderRadius:2,border:"1px solid",borderColor:"divider",bgcolor:"background.default",boxShadow:"0 1px 4px rgba(0,0,0,0.04)",fontSize:"1rem",ml:1,flexShrink:0,display:{xs:"flex",md:"none"}},onClick:I,size:"small","aria-label":"Task actions",children:e.jsx(Ye,{fontSize:"inherit"})})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.82rem",sm:"0.85rem",md:"0.88rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxHeight:{xs:16,sm:20,md:24},overflow:"hidden",textOverflow:"ellipsis",width:"100%",display:{xs:"block",md:"-webkit-box"},WebkitLineClamp:{xs:1,md:2},WebkitBoxOrient:{xs:"horizontal",md:"vertical"}},noWrap:!1,children:s.description})]}),e.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"flex-start",md:"center"},gap:{xs:.5,sm:.8,md:1.5},flexShrink:0,minWidth:{md:"fit-content"}},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:.6,md:.8},flexWrap:"wrap",order:{xs:1,md:1}},children:[e.jsx($,{label:s.priority,size:"small",color:ge(s.priority),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?R=>k(R.currentTarget):void 0,clickable:m,disabled:A===s.id}),e.jsx($,{label:(s.status||"").replace("_"," "),size:"small",color:fe(s.status),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?R=>g(R.currentTarget):void 0,clickable:m,disabled:_===s.id}),(_===s.id||A===s.id)&&e.jsx(Ve,{size:12,sx:{ml:.5}})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.7,sm:1,md:1.5},flexWrap:"wrap",order:{xs:2,md:2}},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(He,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(f,{variant:"caption",color:W!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontStyle:W!=="Unassigned"?"normal":"italic",whiteSpace:"nowrap"},component:"span",children:W})]}),s.dueDate&&e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(ue,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},whiteSpace:"nowrap"},component:"span",children:ie(s.dueDate)})]})]})]})]}),e.jsx(o,{sx:{display:{xs:"none",md:"flex"},alignItems:"center",gap:1,ml:2},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5,bgcolor:"background.paper",borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.07)",px:1,py:.5,border:"1px solid",borderColor:"grey.200"},children:[e.jsx(B,{title:"View Details",children:e.jsx(V,{sx:{color:"primary.main",bgcolor:"grey.100","&:hover":{bgcolor:"primary.light",color:"white"},width:32,height:32,borderRadius:2},onClick:u,size:"small",children:e.jsx(We,{fontSize:"small"})})}),e.jsx(B,{title:"Edit Task",children:e.jsx(V,{sx:{color:"info.main",bgcolor:"grey.100","&:hover":{bgcolor:"info.main",color:"white"},width:32,height:32,borderRadius:2},onClick:E,size:"small",children:e.jsx(De,{fontSize:"small"})})}),e.jsx(B,{title:"Delete Task",children:e.jsx(V,{sx:{color:"error.main",bgcolor:"grey.100","&:hover":{bgcolor:"error.main",color:"white"},width:32,height:32,borderRadius:2},onClick:z,size:"small",children:e.jsx(pe,{fontSize:"small"})})})]})}),e.jsxs(Ce,{anchorEl:T,open:!!T,onClose:a,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[e.jsx(P,{onClick:u,children:"View Details"}),e.jsx(P,{onClick:E,children:"Edit"}),e.jsx(P,{onClick:z,sx:{color:"error.main"},children:"Delete"})]}),e.jsxs(Ce,{anchorEl:c,open:!!c,onClose:()=>g(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(P,{onClick:()=>{y(s.id,"pending"),g(null)},disabled:s.status==="pending",children:"Pending"}),e.jsx(P,{onClick:()=>{y(s.id,"in_progress"),g(null)},disabled:s.status==="in_progress",children:"In Progress"}),e.jsx(P,{onClick:()=>{y(s.id,"completed"),g(null)},disabled:s.status==="completed",children:"Completed"})]}),e.jsxs(Ce,{anchorEl:F,open:!!F,onClose:()=>k(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(P,{onClick:()=>{j(s.id,"low"),k(null)},disabled:s.priority==="low",children:"Low"}),e.jsx(P,{onClick:()=>{j(s.id,"medium"),k(null)},disabled:s.priority==="medium",children:"Medium"}),e.jsx(P,{onClick:()=>{j(s.id,"high"),k(null)},disabled:s.priority==="high",children:"High"})]})]})});const Ne=({open:t,onClose:s,onSubmit:i,initialData:m=null,departmentUsers:S=[],pendingTickets:_=[],loading:A=!1,mode:v="create"})=>{const x=Ae(),w=he(x.breakpoints.down("sm")),[p,y]=n.useState(xe()),[j,T]=n.useState({}),[d,c]=n.useState("");n.useEffect(()=>{t&&(console.log("TaskForm opened with pendingTickets:",_),y(m&&v==="edit"?{...xe(),...m,title:m.title||"",description:m.description||"",priority:m.priority||"medium",status:m.status||"pending",dueDate:m.dueDate||"",assignedToId:m.assignedToId||"",relatedTicketId:m.relatedTicketId||"",attachments:m.attachments||[]}:xe()),T({}),c(""))},[t,m,v]);const g=a=>{const{name:u,value:E}=a.target;y(z=>({...z,[u]:E})),j[u]&&T(z=>({...z,[u]:""}))},F=a=>{const u=Array.from(a.target.files||[]);if(u.length===0)return;const E=["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"],z=[],O=[];if(u.forEach(W=>{E.includes(W.type)?W.size>10*1024*1024?O.push(`${W.name}: File size must be less than 10MB`):z.push(W):O.push(`${W.name}: Only PDF and image files are allowed`)}),O.length>0){c(O.join(", "));return}y(W=>({...W,attachments:[...W.attachments,...z]}))},k=a=>{y(u=>({...u,attachments:u.attachments.filter((E,z)=>z!==a)}))},b=async a=>{a&&a.preventDefault&&a.preventDefault(),c("");const u=bt(p);if(!u.isValid){T(u.errors);return}try{await i(p),I()}catch(E){c(E.message||"An error occurred while saving the task")}},I=()=>{y(xe()),T({}),c(""),s()};return e.jsxs(Fe,{open:t,onClose:I,maxWidth:"sm",fullWidth:!0,fullScreen:w,children:[e.jsx(Ee,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:v==="create"?"Create New Task":"Edit Task"}),e.jsx(Re,{sx:{pt:{xs:1,sm:2}},children:e.jsx(o,{component:"form",onSubmit:b,sx:{mt:1},children:e.jsxs(D,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(X,{fullWidth:!0,label:"Task Title",name:"title",value:p.title,onChange:g,error:!!j.title,helperText:j.title,required:!0,sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,children:e.jsx(X,{fullWidth:!0,label:"Description",name:"description",value:p.description,onChange:g,error:!!j.description,helperText:j.description,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,error:!!j.priority,children:[e.jsx(ee,{children:"Priority"}),e.jsx(te,{name:"priority",value:p.priority,label:"Priority",onChange:g,children:yt.map(a=>e.jsx(P,{value:a.value,children:a.label},a.value))})]})}),v==="edit"&&e.jsxs(e.Fragment,{children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(X,{fullWidth:!0,label:"Remarks (Required for updates)",name:"remarks",value:p.remarks||"",onChange:g,multiline:!0,rows:3,required:!0,helperText:"Please provide remarks explaining the changes made to this task",sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Status"}),e.jsx(te,{name:"status",value:p.status,label:"Status",onChange:g,children:Ge.map(a=>e.jsx(P,{value:a.value,children:a.label},a.value))})]})})]}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Assignee"}),e.jsxs(te,{name:"assignedToId",value:p.assignedToId,label:"Assignee",onChange:g,children:[e.jsx(P,{value:"",children:"Unassigned"}),S.filter(a=>a.role==="employee").map(a=>{const u=a.firstname&&a.lastname&&`${a.firstname} ${a.lastname}`||a.firstName&&a.lastName&&`${a.firstName} ${a.lastName}`||a.username||a.email||a.id;return e.jsx(P,{value:a.id,children:u},a.id)})]})]})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsx(X,{fullWidth:!0,label:"Due Date",name:"dueDate",type:"date",value:p.dueDate,onChange:g,error:!!j.dueDate,helperText:j.dueDate,InputLabelProps:{shrink:!0},required:!0})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Related Pending Ticket"}),e.jsxs(te,{name:"relatedTicketId",value:p.relatedTicketId||"",label:"Related Pending Ticket",onChange:g,children:[e.jsx(P,{value:"",children:"None"}),_.map(a=>e.jsxs(P,{value:a.id,children:[a.title," (#",a.id,")"]},a.id))]})]})}),e.jsxs(D,{item:!0,xs:12,children:[e.jsxs(q,{variant:"outlined",component:"label",startIcon:e.jsx(Ke,{}),fullWidth:!0,sx:{mb:1},children:[v==="create"?"Attach Files (PDF & Images Only)":"Upload Additional Files (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",onChange:F})]}),e.jsx(o,{sx:{mb:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"}),p.attachments&&p.attachments.length>0&&e.jsxs(o,{sx:{mt:1},children:[e.jsx(o,{sx:{fontSize:"0.875rem",fontWeight:600,mb:1,color:"text.primary"},children:v==="create"?"Files to upload:":"Additional files to upload:"}),p.attachments.map((a,u)=>e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5,p:1,bgcolor:"grey.50",borderRadius:1},children:[e.jsxs(o,{sx:{fontSize:"0.875rem",color:"text.secondary",flex:1},children:[a.name," (",(a.size/1024/1024).toFixed(2)," MB)"]}),e.jsx(q,{size:"small",color:"error",onClick:()=>k(u),startIcon:e.jsx(pe,{}),sx:{minWidth:"auto",px:1},children:"Remove"})]},u))]})]}),d&&e.jsx(D,{item:!0,xs:12,children:e.jsx(Je,{severity:"error",sx:{mt:1},children:d})})]})})}),e.jsxs(Ue,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(q,{onClick:I,disabled:A,children:"Cancel"}),e.jsx(q,{variant:"contained",onClick:b,disabled:A,sx:{minWidth:100},children:A?e.jsx(Ve,{size:22,color:"inherit"}):v==="create"?"Create Task":"Save Changes"})]})]})},Tt=({open:t,onClose:s,task:i,departmentUsers:m=[],user:S})=>{if(!i)return null;const _=i&&i.assignedToId&&m.find(x=>x.id===i.assignedToId),A=je(_),v=async x=>{const w=x.url||`/api/files/${x.id}/download`;try{const p=localStorage.getItem("token"),y=await fetch(w,{headers:p?{Authorization:`Bearer ${p}`}:{}});if(!y.ok)throw new Error("Failed to download file");const j=await y.blob(),T=window.URL.createObjectURL(j),d=document.createElement("a");d.href=T,d.download=x.file_name||x.name||"attachment",document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(T)}catch{alert("Failed to download file")}};return e.jsxs(Fe,{open:t,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ee,{children:"Task Details"}),e.jsxs(Re,{children:[e.jsxs(o,{sx:{mb:2},children:[e.jsx(f,{variant:"h6",sx:{fontWeight:700},children:i.title}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:1},children:i.description}),e.jsx(Xe,{sx:{my:1}}),e.jsxs(o,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:1},children:[e.jsx($,{label:i.priority,color:ge(i.priority),size:"small"}),e.jsx($,{label:(i.status||"").replace("_"," "),color:fe(i.status),size:"small"})]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Assigned To:"})," ",A]}),i.dueDate&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mt:1},children:[e.jsx(ue,{sx:{fontSize:16},color:"action"}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",ie(i.dueDate)]})]}),(()=>{const x=_e(i),w=Be(i);return!x||!w?null:e.jsx(o,{sx:{mt:1},children:e.jsx($,{label:w,size:"small",color:x,sx:{fontSize:"0.7rem",fontWeight:600,borderRadius:2,px:.5,height:18,boxShadow:1,minWidth:60,justifyContent:"center"}})})})()]}),i.relatedTicket&&e.jsxs(o,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Related Ticket"}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Title:"})," ",i.relatedTicket.title]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Description:"})," ",i.relatedTicket.description]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Status:"})," ",i.relatedTicket.status]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Priority:"})," ",i.relatedTicket.priority]}),i.relatedTicket.due_date&&e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",i.relatedTicket.due_date]}),Array.isArray(i.relatedTicket.attachments)&&i.relatedTicket.attachments.length>0&&e.jsxs(o,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",sx:{fontWeight:600,mb:.5},children:"Attachments:"}),i.relatedTicket.attachments.map(x=>e.jsx(o,{sx:{mb:.5},children:e.jsx("span",{style:{color:"primary.main",textDecoration:"underline",fontSize:"0.95em",cursor:"pointer"},onClick:()=>v(x),children:x.file_name||x.name})},x.id||x.file_name))]})]})]}),e.jsx(ut,{entityId:i.id,fetchComments:ve.fetchComments,addComment:ve.addComment,deleteComment:ve.deleteComment,user:S}),e.jsx(pt,{entityId:i.id,fetchFiles:x=>Ie.getByEntity("task",x),uploadFile:(x,w)=>Ie.upload(w,"task",x),deleteFile:(x,w)=>Ie.delete(w),entityType:"task"})]}),e.jsx(Ue,{children:e.jsx(q,{onClick:s,children:"Close"})})]})},St=({searchQuery:t,filter:s,onSearchChange:i,onFilterChange:m})=>e.jsx(qe,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsx(Ze,{sx:{p:{xs:2,sm:2.5,md:3}},children:e.jsxs(D,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(D,{item:!0,xs:12,sm:8,md:6,children:e.jsx(X,{fullWidth:!0,placeholder:"Search tasks...",value:t,onChange:S=>i(S.target.value),InputProps:{startAdornment:e.jsx(et,{position:"start",children:e.jsx(tt,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(D,{item:!0,xs:12,sm:4,md:3,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(ee,{children:"Status"}),e.jsx(te,{value:s,label:"Status",onChange:S=>m(S.target.value),sx:{borderRadius:2},children:wt.map(S=>e.jsx(P,{value:S.value,children:S.label},S.value))})]})})]})})}),kt=({tasks:t,departmentUsers:s,canUpdateTask:i,selectedTasks:m,updatingStatus:S,updatingPriority:_,onSelectTask:A,onViewDetails:v,onEditTask:x,onDeleteTask:w,onUpdateStatus:p,onUpdatePriority:y})=>{const j=Ae();he(j.breakpoints.down("sm"));const T=c=>{switch(c){case"completed":return e.jsx(Pe,{});case"in_progress":return e.jsx(re,{});case"pending":return e.jsx(se,{});default:return e.jsx(G,{})}},d=c=>{switch(c){case"high":return e.jsx(re,{});case"medium":return e.jsx(se,{});case"low":return e.jsx(G,{});default:return e.jsx(G,{})}};return e.jsx(o,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(st,{component:$e,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(rt,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(it,{children:e.jsxs(Me,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Assigned To"}),e.jsx(U,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(U,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(at,{children:t.map((c,g)=>{const F=s.find(b=>b.id===c.assignedToId),k=je(F);return e.jsxs(Me,{hover:!0,sx:{bgcolor:g%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(U,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(ze,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:T(c.status)})}),e.jsxs(U,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(B,{title:c.title,arrow:!0,children:e.jsx(f,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:c.title})}),e.jsx(B,{title:c.description,arrow:!0,children:e.jsx(f,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:c.description})})]}),e.jsx(U,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx($,{label:c.priority,size:"small",color:ge(c.priority),icon:d(c.priority),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})}),e.jsx(U,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx($,{label:(c.status||"").replace("_"," "),size:"small",color:fe(c.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})}),e.jsx(U,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(f,{variant:"caption",color:k!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:k!=="Unassigned"?"normal":"italic"},children:k})}),e.jsx(U,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[c.dueDate&&e.jsx(B,{title:ie(c.dueDate),arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ue,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:ie(c.dueDate)})]})}),(()=>{const b=_e(c),I=Be(c);return!b||!I?null:e.jsx(B,{title:`Maturity: ${I}`,arrow:!0,children:e.jsx("span",{children:e.jsx($,{label:I,size:"small",color:b,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(U,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(B,{title:"View Details",children:e.jsx("span",{children:e.jsx(V,{color:"primary",size:"small",onClick:()=>v(c),children:e.jsx(We,{fontSize:"small"})})})}),e.jsx(B,{title:"Edit Task",children:e.jsx("span",{children:e.jsx(V,{color:"secondary",size:"small",onClick:()=>x(c),children:e.jsx(De,{fontSize:"small"})})})}),e.jsx(B,{title:"Delete Task",children:e.jsx("span",{children:e.jsx(V,{color:"error",size:"small",onClick:()=>w(c),children:e.jsx(pe,{fontSize:"small"})})})})]})})]},c.id)})})]})})})},Ct=({tasks:t,departmentUsers:s,canUpdateTask:i,selectedTasks:m,updatingStatus:S,updatingPriority:_,onSelectTask:A,onViewDetails:v,onEditTask:x,onDeleteTask:w,onUpdateStatus:p,onUpdatePriority:y})=>{const j=d=>{switch(d){case"completed":return e.jsx(Pe,{});case"in_progress":return e.jsx(re,{});case"pending":return e.jsx(se,{});default:return e.jsx(G,{})}},T=d=>{switch(d){case"high":return e.jsx(re,{});case"medium":return e.jsx(se,{});case"low":return e.jsx(G,{});default:return e.jsx(G,{})}};return e.jsx(o,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(D,{container:!0,spacing:2,children:t.map(d=>{const c=s.find(F=>F.id===d.assignedToId),g=je(c);return e.jsx(D,{item:!0,xs:12,children:e.jsxs(qe,{sx:{borderRadius:3,boxShadow:3,p:2,bgcolor:"background.paper"},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(ze,{sx:{bgcolor:"primary.main",width:28,height:28,boxShadow:"0 1px 4px rgba(0,0,0,0.08)",mr:1},children:j(d.status)}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:700,fontSize:"1rem",wordBreak:"break-word"},children:d.title}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.92rem",lineHeight:1.4,wordBreak:"break-word"},children:d.description})]})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx($,{label:d.priority,size:"small",color:ge(d.priority),icon:T(d.priority),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),e.jsx($,{label:(d.status||"").replace("_"," "),size:"small",color:fe(d.status),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),(()=>{const F=_e(d),k=Be(d);return!F||!k?null:e.jsx($,{label:k,size:"small",color:F,sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}})})()]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx(He,{sx:{fontSize:16},color:"action"}),e.jsx(f,{variant:"caption",color:g!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:g!=="Unassigned"?"normal":"italic"},children:g}),d.dueDate&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{sx:{fontSize:16,ml:1},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.78rem"},children:ie(d.dueDate)})]})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5,justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(B,{title:"View Details",children:e.jsx("span",{children:e.jsx(V,{color:"primary",size:"small",onClick:()=>v(d),children:e.jsx(We,{})})})}),e.jsx(B,{title:"Edit Task",children:e.jsx("span",{children:e.jsx(V,{color:"secondary",size:"small",onClick:()=>x(d),children:e.jsx(De,{})})})}),e.jsx(B,{title:"Delete Task",children:e.jsx("span",{children:e.jsx(V,{color:"error",size:"small",onClick:()=>w(d),children:e.jsx(pe,{})})})})]})]})},d.id)})})})},vt=()=>{const{user:t}=dt(),{id:s}=gt(),i=ft(),[m,S]=n.useState([]),[_,A]=n.useState([]),[v,x]=n.useState([]),[w,p]=n.useState(!0),[y,j]=n.useState("all"),[T,d]=n.useState(""),[c,g]=n.useState(null),[F,k]=n.useState(!1),[b,I]=n.useState([]),[a,u]=n.useState(!1),[E,z]=n.useState(null),[O,W]=n.useState(null),[R,Q]=n.useState(!1),[be,H]=n.useState(""),C=n.useCallback(async()=>{p(!0);try{let r;t?.role==="department_head"&&t?.departmentId?r=await M.getAll({departmentId:t.departmentId}):r=await M.getAll(),S(r.data)}catch(r){console.error("Failed to load tasks:",r),S([])}finally{p(!1)}},[t?.role,t?.departmentId]),Y=n.useCallback(async()=>{if(t?.departmentId)try{const r=await ct.getDepartmentUsers(t.departmentId);A(r.data)}catch(r){console.error("Failed to load department users:",r),A([])}},[t?.departmentId]),ae=n.useCallback(async()=>{try{const r=await Oe.getAssignedTickets(),l=Array.isArray(r.data)?r.data:r.data||[];console.log("Assigned tickets loaded:",l.length,l);const h=l.filter(N=>N.status?.toLowerCase()==="pending");console.log("Pending tickets filtered:",h.length,h),x(h)}catch(r){console.error("Failed to load pending tickets:",r),x([])}},[]);n.useEffect(()=>{C(),Y()},[C,Y]),n.useEffect(()=>{if(s&&m.length>0){const r=m.find(l=>l.id===s);r&&(g(r),k(!0))}},[s,m]);const J=n.useCallback(async r=>{Q(!0);try{const l=Le(r,{departmentId:t.departmentId}),h=await M.create(l),N=h.data||h;if(r.attachments&&r.attachments.length>0)try{for(const me of r.attachments)await M.uploadAttachment(N.id,me)}catch(me){console.error("Error uploading files:",me)}return await C(),H("Task created successfully!"),{success:!0}}catch(l){console.error("Error creating task:",l);const h=l?.response?.data?.error||l.message||"Failed to create task. Please try again.";throw new Error(h)}finally{setTimeout(()=>Q(!1),1e3)}},[t.departmentId,C]),ye=n.useCallback(async(r,l)=>{try{if(!l?.remarks||l.remarks.trim()==="")throw new Error("Remarks are required when updating a task. Please provide remarks explaining the changes made.");const h=Le(l);if(await M.update(r,h),l.attachments&&l.attachments.length>0)try{for(const N of l.attachments)await M.uploadAttachment(r,N)}catch(N){console.error("Error uploading files during task update:",N)}return h.relatedTicketId&&h.status&&await Oe.updateStatus(h.relatedTicketId,h.status),await C(),H("Task updated successfully!"),{success:!0}}catch(h){console.error("Error updating task:",h);const N=h?.response?.data?.error||h.message||"Failed to update task";throw new Error(N)}},[C]),K=n.useCallback(async r=>{Q(!0);try{return await M.delete(r),await C(),H("Task deleted successfully!"),{success:!0}}catch(l){console.error("Error deleting task:",l);const h=l?.response?.data?.error||l.message||"Failed to delete task";throw new Error(h)}finally{setTimeout(()=>Q(!1),1e3)}},[C]),ne=n.useCallback(async(r,l)=>{z(r);try{await M.updateStatus(r,l),await C()}catch(h){console.error("Error updating task status:",h)}finally{z(null)}},[C]),le=n.useCallback(async(r,l)=>{W(r);try{await M.updatePriority(r,l),await C()}catch(h){console.error("Error updating task priority:",h)}finally{W(null)}},[C]),we=n.useCallback(r=>{if(Array.isArray(r)){I(r);return}const l=r;I(h=>h.includes(l)?h.filter(N=>N!==l):[...h,l])},[]),oe=n.useCallback(r=>{b.length===r.length?I([]):I(r.map(l=>l.id))},[b.length]),de=n.useCallback(async r=>{u(!0);try{await Promise.all(b.map(l=>M.updateStatus(l,r))),I([]),await C()}catch(l){console.error("Error updating bulk status:",l)}finally{u(!1)}},[b,C]),ce=n.useCallback(async r=>{u(!0);try{await Promise.all(b.map(l=>M.updatePriority(l,r))),I([]),await C()}catch(l){console.error("Error updating bulk priority:",l)}finally{u(!1)}},[b,C]),Te=n.useCallback(async()=>{if(window.confirm(`Are you sure you want to delete ${b.length} tasks?`)){u(!0);try{await Promise.all(b.map(r=>M.delete(r))),I([]),await C()}catch(r){console.error("Error deleting bulk tasks:",r)}finally{u(!1)}}},[b,C]),Se=m.filter(r=>{const l=y==="all"||r.status===y,h=r.title.toLowerCase().includes(T.toLowerCase())||r.description.toLowerCase().includes(T.toLowerCase());return l&&h}),ke=n.useCallback(r=>t&&(t.role==="admin"||t.role==="department_head"||r.createdBy===t.id||r.assignedToId===t.id),[t]),L=n.useCallback(()=>{k(!1),g(null),s&&i("/app/tasks",{replace:!0})},[s,i]);return{tasks:m,filteredTasks:Se,departmentUsers:_,pendingTickets:v,loadingState:w,filter:y,searchQuery:T,selectedTask:c,detailsOpen:F,selectedTasks:b,bulkUpdating:a,updatingStatus:E,updatingPriority:O,creatingTask:R,successMessage:be,setFilter:j,setSearchQuery:d,setSelectedTask:g,setDetailsOpen:k,setSuccessMessage:H,loadPendingTickets:ae,createTask:J,updateTask:ye,deleteTask:K,updateTaskStatus:ne,updateTaskPriority:le,selectTask:we,selectAllTasks:oe,bulkUpdateStatus:de,bulkUpdatePriority:ce,bulkDeleteTasks:Te,closeDetails:L,canUpdateTask:ke,user:t}},Ft=()=>{const t=Ae();he(t.breakpoints.down("sm")),he(t.breakpoints.between("sm","md"));const{filteredTasks:s,departmentUsers:i,pendingTickets:m,loadingState:S,filter:_,searchQuery:A,selectedTask:v,detailsOpen:x,selectedTasks:w,updatingStatus:p,updatingPriority:y,creatingTask:j,successMessage:T,setFilter:d,setSearchQuery:c,setSelectedTask:g,setDetailsOpen:F,setSuccessMessage:k,loadPendingTickets:b,createTask:I,updateTask:a,deleteTask:u,updateTaskStatus:E,updateTaskPriority:z,selectTask:O,closeDetails:W,canUpdateTask:R,user:Q}=vt(),[be,H]=n.useState(!1),[C,Y]=n.useState(!1),[ae,J]=n.useState(null),[ye,K]=n.useState(!1),[ne,le]=n.useState(null),we=()=>{b(),H(!0)},oe=L=>{J(L),b(),Y(!0)},de=L=>{le(L),K(!0)},ce=L=>{g(L),F(!0)},Te=async L=>{await I(L),H(!1)},Se=async L=>{await a(ae.id,L),Y(!1),J(null)},ke=async()=>{ne&&(await u(ne.id),K(!1),le(null))};return S?e.jsx(mt,{overlay:!0,message:"Loading tasks..."}):e.jsxs(o,{sx:{flexGrow:1,pt:{xs:7,sm:3,md:4},px:{xs:1,sm:2,md:3},display:"flex",flexDirection:"column",height:"100%"},children:[e.jsx(jt,{title:"Tasks",subtitle:"Manage and track your department's tasks efficiently",emoji:"âœ…",color:"success",actionButton:{text:"Add Task",icon:e.jsx(nt,{}),onClick:we}}),e.jsx(o,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(lt,{in:!0,timeout:800,children:e.jsxs(o,{children:[e.jsx(St,{searchQuery:A,filter:_,onSearchChange:c,onFilterChange:d}),e.jsxs(o,{sx:{mt:2,mb:2},children:[e.jsxs(f,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:["All Tasks (",s.length,")"]}),s.length===0?e.jsx(o,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(f,{variant:"body1",children:"No tasks found. Try adjusting your filters or add a new task."})}):e.jsxs(e.Fragment,{children:[e.jsx(o,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(kt,{tasks:s,departmentUsers:i,canUpdateTask:R,selectedTasks:w,updatingStatus:p,updatingPriority:y,onSelectTask:O,onViewDetails:ce,onEditTask:oe,onDeleteTask:de,onUpdateStatus:E,onUpdatePriority:z})}),e.jsx(o,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(Ct,{tasks:s,departmentUsers:i,canUpdateTask:R,selectedTasks:w,updatingStatus:p,updatingPriority:y,onSelectTask:O,onViewDetails:ce,onEditTask:oe,onDeleteTask:de,onUpdateStatus:E,onUpdatePriority:z})})]})]})]})})}),e.jsx(Ne,{open:be,onClose:()=>H(!1),onSubmit:Te,departmentUsers:i,pendingTickets:m,loading:j,mode:"create"}),e.jsx(Ne,{open:C,onClose:()=>{Y(!1),J(null)},onSubmit:Se,initialData:ae,departmentUsers:i,pendingTickets:m,loading:!1,mode:"edit"}),e.jsx(Tt,{open:x,onClose:W,task:v,departmentUsers:i,user:Q}),e.jsxs(Fe,{open:ye,onClose:()=>K(!1),children:[e.jsx(Ee,{children:"Delete Task"}),e.jsx(Re,{children:e.jsx(f,{children:"Are you sure you want to delete this task? This action cannot be undone."})}),e.jsxs(Ue,{children:[e.jsx(q,{onClick:()=>K(!1),children:"Cancel"}),e.jsx(q,{variant:"contained",color:"error",onClick:ke,disabled:j,children:"Delete"})]})]}),e.jsx(ot,{open:!!T,autoHideDuration:3e3,onClose:()=>k(""),message:T,anchorOrigin:{vertical:"top",horizontal:"center"},ContentProps:{sx:{backgroundColor:"success.main",color:"white",fontWeight:600}}})]})};export{Ft as default};
