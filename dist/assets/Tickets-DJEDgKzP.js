import{u as ve,j as e,a5 as jr,a6 as yr,E as Zr,G as He,a4 as C,as as te,ax as es,ay as rs,at as Q,au as Y,av as X,m as x,a1 as rr,az as ss,aj as ts,aA as as,aB as ns,aC as ur,aD as O,aE as os,k as wr,O as Ke,ai as Qe,ab as Ye,aq as Xe,b as y,h as $,d as ne,aG as je,aH as sr,aI as tr,B as _,an as Ze,I as oe,ao as br,ap as Ee,J as Re,aw as ar,y as V,aJ as is,t as de,v as ce,w as ue,a3 as ls,V as Se,x as xe,aK as Sr,aL as ds,aM as er,r as vr,n as Cr,p as Tr,aN as Fr,q as Dr,H as Wr,am as Oe,aF as cs,F as us}from"./mui-DaYlJXyD.js";import{r as t,b as Ar}from"./vendor-Cr2nE3UY.js";import{e as q,g as xs,h as ge,f as ms,i as qe,u as hs,L as fs}from"./index-xE_H2rg0.js";import{f as _e,g as zr,a as _r,b as ke,c as kr,d as ps,F as gs,C as js,e as ys,h as xr,i as mr,v as hr,p as fr,j as ws,k as $e,l as Ve,m as pr,n as Ge}from"./FileUploadSection-CpbjBRrf.js";import{P as bs}from"./PageHeader-DlP9MJR_.js";import{c as Ss,u as vs}from"./router-B4FNaIx_.js";const Cs=()=>{const[l,j]=t.useState([]),[r,h]=t.useState([]),[v,E]=t.useState([]),[I,P]=t.useState(!0),[M,w]=t.useState(!1),[D,z]=t.useState([]),[L,n]=t.useState([]),[g,s]=t.useState({}),[T,S]=t.useState(""),d=t.useCallback(async()=>{var i;try{const a=await q.getAll(),p=((i=a.data)==null?void 0:i.tickets)||a.tickets||a.data||a||[];if(!Array.isArray(p)){console.warn("Tickets data is not an array:",p),j([]);return}const m=p.sort((c,A)=>{const k=new Date(c.created_at||c.createdAt||0);return new Date(A.created_at||A.createdAt||0)-k});j(m)}catch(a){console.error("Error loading tickets:",a),j([])}},[]),W=t.useCallback(async()=>{try{const i=await q.getAssignedTickets(),a=i.data||i||[];if(!Array.isArray(a)){console.warn("Assigned tickets data is not an array:",a),h([]);return}const p=a.sort((m,c)=>{const A=new Date(m.created_at||m.createdAt||0);return new Date(c.created_at||c.createdAt||0)-A});h(p)}catch(i){console.error("Error loading assigned tickets:",i),h([])}},[]),f=t.useCallback(async()=>{var i;try{const[a,p]=await Promise.all([q.getAll(),q.getAssignedTickets()]),m=((i=a.data)==null?void 0:i.tickets)||a.tickets||a.data||a||[],c=p.data||p||[],A=[...Array.isArray(m)?m:[],...Array.isArray(c)?c:[]],k=JSON.parse(localStorage.getItem("user")||"{}"),G=k==null?void 0:k.id,Z=A.filter(B=>{var fe;const ae=B.forwarded_from_id||B.forwardedFromId||((fe=B.forwardedFrom)==null?void 0:fe.id),se=B.is_forwarded===!0||B.isForwarded===!0||typeof B.forward_chain_id<"u"||typeof B.forwardChainId<"u",We=ae&&G&&String(ae)===String(G);return se&&We}),H=new Set,De=Z.filter(B=>!B||!B.id||H.has(B.id)?!1:(H.add(B.id),!0)).sort((B,ae)=>{const se=new Date(B.created_at||B.createdAt||0);return new Date(ae.created_at||ae.createdAt||0)-se});E(De)}catch(a){console.error("Error loading forwarded-by-me tickets:",a),E([])}},[]),b=t.useCallback(async()=>{try{const i=await xs.getAll(),a=i.data||i||[];z(a)}catch(i){console.error("Error loading departments:",i),z([])}},[]),R=t.useCallback(async()=>{try{const i=await ge.getAll(),a=i.data||i||[];n(a)}catch(i){console.error("Error loading users:",i),n([])}},[]),J=t.useCallback(async()=>{try{P(!0),S(""),await Promise.all([d(),W(),f(),b(),R()])}catch(i){console.error("Error loading initial data:",i),S("Failed to load data. Please try again.")}finally{P(!1)}},[d,W,f,b,R]),me=t.useCallback(async(i,a=[])=>{var p,m;w(!0);try{const c=await q.create(i),A=c.data||c;if(a&&a.length>0)try{for(const k of a)k.file?await q.uploadAttachment(A.id,k.file):await q.uploadAttachment(A.id,k)}catch(k){console.error("Error uploading files:",k)}return j(k=>[A,...k]),{success:!0,ticket:A}}catch(c){return console.error("Error creating ticket:",c),{success:!1,error:((m=(p=c.response)==null?void 0:p.data)==null?void 0:m.message)||"Failed to create ticket."}}finally{w(!1)}},[]),Ie=t.useCallback(async i=>{var a,p;w(!0);try{const m=await q.update(i.id,i),c=m.data||m;return j(A=>A.map(k=>k.id===c.id?c:k)),{success:!0,ticket:c}}catch(m){return console.error("Error updating ticket:",m),{success:!1,error:((p=(a=m.response)==null?void 0:a.data)==null?void 0:p.message)||"Failed to update ticket."}}finally{w(!1)}},[]),Ce=t.useCallback(async i=>{var a,p;if(!i)return{success:!1,error:"Invalid ticket ID for deletion."};w(!0);try{return await q.delete(i),j(m=>m.filter(c=>c.id!==i)),{success:!0}}catch(m){return console.error("Error deleting ticket:",m),{success:!1,error:((p=(a=m.response)==null?void 0:a.data)==null?void 0:p.message)||"Failed to delete ticket."}}finally{w(!1)}},[]),Pe=t.useCallback(async(i,a)=>{var p,m,c;w(!0);try{const A=await q.forwardTicket(i,a);try{const k=JSON.parse(localStorage.getItem("user")||"{}"),G=k==null?void 0:k.id,Z=await q.getById(i),H=Z.data||Z||null;if(H&&G){const le=H.forwarded_from_id||H.forwardedFromId||((p=H.forwardedFrom)==null?void 0:p.id);(H.is_forwarded===!0||H.isForwarded===!0||typeof H.forward_chain_id<"u"||typeof H.forwardChainId<"u")&&le&&String(le)===String(G)&&E(B=>B.some(se=>se.id===H.id)?B:[H,...B])}}catch{}return await d(),await f(),{success:!0,data:A.data||A}}catch(A){return console.error("Error forwarding ticket:",A),{success:!1,error:((c=(m=A.response)==null?void 0:m.data)==null?void 0:c.message)||"Failed to forward ticket."}}finally{w(!1)}},[d,f]),Te=t.useCallback(async i=>{try{const a=await q.getAttachments(i),p=a.data||a||[];return s(m=>({...m,[i]:p})),p}catch(a){return console.error("Error loading ticket files:",a),s(p=>({...p,[i]:[]})),[]}},[]),Le=t.useCallback(async(i,a)=>{var p;try{const m=await q.uploadAttachment(a,i),c=m.data||m;return s(A=>({...A,[a]:[...A[a]||[],c]})),c}catch(m){if(console.error("File upload error:",m),((p=m.response)==null?void 0:p.status)===500){console.warn("Server returned 500 but file may have been uploaded successfully");try{const c=await q.getAttachments(a);if(c.data&&c.data.length>0)return s(A=>({...A,[a]:c.data})),c.data[c.data.length-1]}catch(c){console.error("Error refreshing file list:",c)}}throw new Error("Failed to upload file.")}},[]),ee=t.useCallback(async(i,a)=>{try{await q.deleteAttachment(i,a),s(p=>{var m;return{...p,[i]:((m=p[i])==null?void 0:m.filter(c=>c.id!==a))||[]}})}catch{throw new Error("Failed to delete file.")}},[]),Ne=t.useCallback(async(i,a)=>{try{const p=await ms.download(a),m=new Blob([p.data]),c=window.URL.createObjectURL(m),A=document.createElement("a");A.href=c;const k=p.headers["content-disposition"];let G="download";if(k){const Z=k.match(/filename="(.+)"/);Z&&(G=Z[1])}A.download=G,document.body.appendChild(A),A.click(),document.body.removeChild(A),window.URL.revokeObjectURL(c)}catch{throw new Error("Failed to download file.")}},[]),he=t.useCallback(i=>g[i]||[],[g]),Fe=t.useCallback(async(i,a)=>{var p,m;try{const c=await qe.addTicketComment(i,a);return{success:!0,comment:c.data||c}}catch(c){return console.error("Error adding comment:",c),{success:!1,error:((m=(p=c.response)==null?void 0:p.data)==null?void 0:m.message)||"Failed to add comment."}}},[]),re=t.useCallback(async i=>{try{const a=await qe.fetchTicketComments(i);return a.data||a||[]}catch(a){return console.error("useTickets: Error loading comments:",a),[]}},[]),ye=t.useCallback(async i=>{var a,p;try{return await qe.deleteComment(i),{success:!0}}catch(m){return console.error("Error deleting comment:",m),{success:!1,error:((p=(a=m.response)==null?void 0:a.data)==null?void 0:p.message)||"Failed to delete comment."}}},[]),ie=t.useCallback(async()=>{try{await Promise.all([d(),W(),f()])}catch(i){console.error("Error refreshing tickets:",i)}},[d,W,f]);return t.useEffect(()=>{J()},[J]),{tickets:l,assignedTickets:r,forwardedTickets:v,loading:I,actionLoading:M,departments:D,users:L,error:T,loadTickets:d,loadAssignedTickets:W,loadForwardedTickets:f,createTicket:me,updateTicket:Ie,deleteTicket:Ce,forwardTicket:Pe,loadTicketFiles:Te,uploadTicketFile:Le,deleteTicketFile:ee,downloadTicketFile:Ne,getTicketFiles:he,addComment:Fe,loadComments:re,deleteComment:ye,refreshTickets:ie,setError:S}},Ts=({activeTab:l,setActiveTab:j,searchQuery:r,setSearchQuery:h,filter:v,setFilter:E,priorityFilter:I,setPriorityFilter:P,isMobile:M})=>(ve(),e.jsx(jr,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsxs(yr,{sx:{p:{xs:2,sm:2.5,md:3}},children:[e.jsxs(Zr,{value:l,onChange:(w,D)=>j(D),variant:"fullWidth",sx:{mb:2,"& .MuiTab-root":{fontSize:{xs:"0.95rem",sm:"1.05rem"},fontWeight:600,textTransform:"none",minHeight:{xs:44,sm:52}},"& .Mui-selected":{color:"primary.main"}},children:[e.jsx(He,{label:M?"Sent":"Sent Tickets"}),e.jsx(He,{label:M?"Received":"Received Tickets"}),e.jsx(He,{label:M?"Forwarded":"Forwarded by Me"})]}),e.jsxs(C,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(C,{item:!0,xs:12,sm:6,md:4,children:e.jsx(te,{fullWidth:!0,placeholder:"Search tickets...",value:r,onChange:w=>h(w.target.value),InputProps:{startAdornment:e.jsx(es,{position:"start",children:e.jsx(rs,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{value:v,label:"Status",onChange:w=>E(w.target.value),sx:{borderRadius:2},children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:3,md:2,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{value:I,label:"Priority",onChange:w=>P(w.target.value),sx:{borderRadius:2},children:[e.jsx(x,{value:"all",children:"All Priority"}),e.jsx(x,{value:"high",children:"High"}),e.jsx(x,{value:"medium",children:"Medium"}),e.jsx(x,{value:"low",children:"Low"})]})]})})]})]})}));function Je({title:l,children:j,...r}){const h=t.useRef(null),[v,E]=t.useState(!1);return t.useEffect(()=>{const I=h.current;I&&E(I.scrollWidth>I.clientWidth)},[j,l]),v?e.jsx($,{title:l,arrow:!0,...r,children:e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:j})}):e.jsx("span",{ref:h,style:{display:"block",width:"100%"},children:j})}const Fs=({tickets:l,users:j,activeTab:r,onViewTicket:h,onEditTicket:v,onDeleteTicket:E,getStatusColor:I,getStatusIcon:P,getPriorityColor:M,getPriorityIcon:w})=>{const D=ve(),z=rr(D.breakpoints.down("sm")),[L,n]=t.useState({});t.useEffect(()=>{if(r!==2||!Array.isArray(l))return;const s=new Set((Array.isArray(j)?j:[]).map(d=>String(d.id))),T=new Set(Object.keys(L)),S=new Set;l.forEach(d=>{const W=d.forwardedTo||d.forwarded_to||d.forwarded_to_id||d.current_handler_id;if(W&&typeof W!="object"){const f=String(W);!s.has(f)&&!T.has(f)&&S.add(f)}}),S.size!==0&&(async()=>{const d=await Promise.all(Array.from(S).map(async W=>{try{const f=await ge.getById(W),b=f.data||f||null;return[W,b]}catch{return[W,null]}}));n(W=>{const f={...W};return d.forEach(([b,R])=>{f[b]=R}),f})})()},[r,l,j,L]);const g=s=>{if(!s)return"Unknown User";if(typeof s=="object")return ke(s);const T=String(s),S=j.find(d=>String(d.id)===T)||L[T];return S?ke(S):T};return z?null:e.jsx(ss,{component:ts,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(as,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(ns,{children:e.jsxs(ur,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(O,{padding:"checkbox",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(O,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(O,{align:"center",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:r===0?"Send To":r===1?"Sent By":r===2?"Forwarded To":"Created By"}),e.jsx(O,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(O,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(os,{children:l.map((s,T)=>e.jsxs(ur,{hover:!0,sx:{bgcolor:T%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(O,{padding:"checkbox",sx:{px:{md:.5,lg:2},width:{md:36,lg:48}}}),e.jsx(O,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(wr,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:(()=>{switch(P(s.status)){case"Schedule":return e.jsx(Xe,{sx:{fontSize:{md:14,lg:18}}});case"CheckCircle":return e.jsx(Ye,{sx:{fontSize:{md:14,lg:18}}});case"Error":return e.jsx(Qe,{sx:{fontSize:{md:14,lg:18}}});default:return e.jsx(Ke,{sx:{fontSize:{md:14,lg:18}}})}})()})}),e.jsxs(O,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(Je,{title:s.title,children:e.jsx(y,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.title})}),e.jsx(Je,{title:s.description,children:e.jsx(y,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200},overflow:"hidden",textOverflow:"ellipsis"},children:s.description})})]}),e.jsx(O,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx($,{title:`Priority: ${s.priority}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ne,{label:s.priority,size:"small",color:M(s.priority),icon:(()=>{switch(w(s.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:{md:12,lg:16}}});case"Remove":return e.jsx(je,{sx:{fontSize:{md:12,lg:16}}});case"LowPriority":return e.jsx(sr,{sx:{fontSize:{md:12,lg:16}}});default:return e.jsx(je,{sx:{fontSize:{md:12,lg:16}}})}})(),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})})})}),e.jsx(O,{align:"center",sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx($,{title:`Status: ${s.status.replace("_"," ")}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ne,{label:s.status.replace("_"," "),size:"small",color:I(s.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})})})}),e.jsx(O,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(Je,{title:(()=>{if(r===0)return g(s.ticketAssignee||s.assignedTo||s.assigned_to);if(r===1)return g(s.ticketCreator||s.createdBy||s.created_by);if(r===2){const S=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return g(S)}return g(s.ticketCreator||s.createdBy||s.created_by)})(),children:e.jsx(y,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:"0.78rem",overflow:"hidden",textOverflow:"ellipsis"},children:(()=>{if(r===0)return g(s.ticketAssignee||s.assignedTo||s.assigned_to);if(r===1)return g(s.ticketCreator||s.createdBy||s.created_by);if(r===2){const S=s.forwardedTo||s.forwarded_to||s.forwarded_to_id||s.current_handler_id;return g(S)}return g(s.ticketCreator||s.createdBy||s.created_by)})()})})}),e.jsx(O,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[s.due_date&&e.jsx($,{title:_e(s.due_date),arrow:!0,children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Ze,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(y,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:_e(s.due_date)})]})}),(()=>{const S=zr(s),d=_r(s);return!S||!d?null:e.jsx($,{title:`Maturity: ${d}`,arrow:!0,children:e.jsx("span",{children:e.jsx(ne,{label:d,size:"small",color:S,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(O,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsx(_,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx($,{title:"View Details",children:e.jsx("span",{children:e.jsx(oe,{color:"primary",size:"small",onClick:()=>h(s),children:e.jsx(br,{fontSize:"small"})})})}),e.jsx($,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"secondary",size:"small",onClick:()=>v(s),children:e.jsx(Ee,{fontSize:"small"})})})}),e.jsx($,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"error",size:"small",onClick:()=>E(s),children:e.jsx(Re,{fontSize:"small"})})})})]})})})]},s.id))})]})})},Ds=({ticket:l,departments:j,users:r,activeTab:h,onViewTicket:v,onEditTicket:E,onDeleteTicket:I,getPriorityColor:P,getPriorityIcon:M,getStatusColor:w,getTicketFiles:D})=>{const z=ve(),L=rr(z.breakpoints.down("sm")),n=g=>{if(!g)return"Unknown";if(typeof g=="object"&&g.firstname)return ke(g);const s=r.find(T=>T.id===g);return ke(s)};return L?e.jsx(jr,{sx:{borderRadius:3,boxShadow:2,overflow:"hidden"},children:e.jsxs(yr,{sx:{p:3},children:[e.jsx(_,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:e.jsxs(_,{sx:{flex:1,minWidth:0},children:[e.jsx(y,{variant:"h6",sx:{fontWeight:700,mb:1,wordBreak:"break-word"},children:l.title}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2,lineHeight:1.5},children:l.description})]})}),e.jsxs(_,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(ne,{label:l.priority,size:"small",color:P(l.priority),icon:(()=>{switch(M(l.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:14}});case"Remove":return e.jsx(je,{sx:{fontSize:14}});case"LowPriority":return e.jsx(sr,{sx:{fontSize:14}});default:return e.jsx(je,{sx:{fontSize:14}})}})(),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),e.jsx(ne,{label:l.status.replace("_"," "),size:"small",color:w(l.status),sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}}),(()=>{const g=zr(l),s=_r(l);return!g||!s?null:e.jsx(ne,{label:s,size:"small",color:g,sx:{fontSize:"0.75rem",fontWeight:600,borderRadius:2}})})()]}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",gap:1,mb:2},children:[e.jsxs(y,{variant:"body2",color:"text.secondary",children:[e.jsxs("strong",{children:[h===0?"Send To":h===1?"Sent By":h===2?"Forwarded To":"Created By",":"]})," ",n(h===0?l.ticketAssignee||l.assignedTo||l.assigned_to:h===1?l.ticketCreator||l.createdBy||l.created_by:h===2?l.forwarded_to_id:l.ticketCreator||l.createdBy||l.created_by)]}),l.due_date&&e.jsxs(y,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Due Date:"})," ",_e(l.due_date)]})]}),D(l.id).length>0&&e.jsxs(_,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(ar,{fontSize:"small",sx:{mr:1,color:"text.secondary"}}),e.jsxs(y,{variant:"caption",color:"text.secondary",children:[D(l.id).length," file(s) attached"]})]}),e.jsx(_,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx($,{title:"View Details",children:e.jsx("span",{children:e.jsx(oe,{color:"primary",size:"small",onClick:()=>v(l),children:e.jsx(br,{fontSize:"small"})})})}),e.jsx($,{title:"Edit Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"secondary",size:"small",onClick:()=>E(l),children:e.jsx(Ee,{fontSize:"small"})})})}),e.jsx($,{title:"Delete Ticket",children:e.jsx("span",{children:e.jsx(oe,{color:"error",size:"small",onClick:()=>I(l),children:e.jsx(Re,{fontSize:"small"})})})})]})})]})}):null},Ws=({ticket:l,onForward:j,disabled:r=!1})=>{const[h,v]=t.useState(!1),[E,I]=t.useState([]),[P,M]=t.useState(""),[w,D]=t.useState(""),[z,L]=t.useState(!1),[n,g]=t.useState("");t.useEffect(()=>{h&&s()},[h]);const s=async()=>{try{L(!0),g("");let d=[];try{const b=await ge.getAll({role:"department_head"}),R=await ge.getAll({role:"admin"}),J=b.data||b||[],me=R.data||R||[];d=[...J,...me],console.log("Department heads and admins fetched with role param:",d)}catch(b){console.log("Role-based fetch failed, trying all users:",b);const R=await ge.getAll();d=R.data||R||[],console.log("All users fetched:",d)}let W=d;d.length>0&&!d.some(b=>b.role==="department_head"||b.role==="admin")&&(W=d.filter(b=>{var J;const R=(J=b.role)==null?void 0:J.toLowerCase();return R==="admin"||R==="department_head"||R==="departmenthead"||R==="dept_head"||R==="head"||b.role&&b.role.includes("head")})),console.log("Eligible users found:",W);const f=W.map(b=>{const R=b.role==="admin"?"Admin":"Dept Head";return{...b,displayName:`${b.firstname||b.firstName||"Unknown"} ${b.lastname||b.lastName||"User"} (${R})`}});f.length===0?g("No department heads or admins found in the system. Please ensure there are users with appropriate roles."):(I(f),g(""))}catch(d){console.error("Error loading recipients:",d),g("Failed to load recipients. Please try again.")}finally{L(!1)}},T=async()=>{var d,W;if(!P||!w.trim()){g("Please select a recipient and provide a reason");return}L(!0),g("");try{await q.forwardTicket(l.id,{toUserId:P,reason:w.trim()}),j&&j(),v(!1),M(""),D("")}catch(f){console.error("Error forwarding ticket:",f),g(((W=(d=f.response)==null?void 0:d.data)==null?void 0:W.error)||"Failed to forward ticket")}finally{L(!1)}},S=()=>{v(!1),M(""),D(""),g("")};return e.jsxs(e.Fragment,{children:[e.jsx(V,{variant:"outlined",startIcon:e.jsx(is,{}),onClick:()=>v(!0),disabled:r,sx:{mr:1},children:"Forward"}),e.jsxs(de,{open:h,onClose:S,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ce,{children:["Forward Ticket #",l==null?void 0:l.id]}),e.jsxs(ue,{children:[n&&e.jsx(ls,{severity:"error",sx:{mb:2},children:n}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Forwarding ticket to a department head or admin"}),e.jsxs(Q,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Y,{children:"Forward To"}),e.jsx(X,{value:P,onChange:d=>M(d.target.value),label:"Forward To",disabled:z||E.length===0,children:z?e.jsx(x,{disabled:!0,children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Se,{size:16}),"Loading recipients..."]})}):E.length===0?e.jsx(x,{disabled:!0,children:"No recipients available"}):E.map(d=>e.jsx(x,{value:d.id,children:d.displayName},d.id))})]}),e.jsx(te,{fullWidth:!0,label:"Reason for Forwarding",value:w,onChange:d=>D(d.target.value),multiline:!0,rows:3,required:!0,disabled:z,sx:{mb:2}})]}),e.jsxs(xe,{children:[e.jsx(V,{onClick:S,disabled:z,children:"Cancel"}),e.jsx(V,{onClick:T,variant:"contained",disabled:!P||!w.trim()||z,children:z?e.jsx(Se,{size:20}):"Forward Ticket"})]})]})]})},As=({open:l,message:j,onClose:r})=>e.jsxs(de,{open:l,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ce,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(Sr,{color:"error",sx:{fontSize:32}}),"Error"]}),e.jsx(ue,{children:e.jsx(y,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:j})}),e.jsx(xe,{children:e.jsx(V,{onClick:r,variant:"contained",color:"error",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),zs=({open:l,message:j,onClose:r})=>e.jsxs(de,{open:l,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ce,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main",fontWeight:700},children:[e.jsx(ds,{color:"success",sx:{fontSize:32}}),"Success"]}),e.jsx(ue,{children:e.jsx(y,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:1},children:j})}),e.jsx(xe,{children:e.jsx(V,{onClick:r,variant:"contained",color:"success",sx:{minWidth:100,borderRadius:2},children:"OK"})})]}),_s=({open:l,ticket:j,onClose:r,onConfirm:h,loading:v})=>e.jsxs(de,{open:l,onClose:r,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(ce,{sx:{display:"flex",alignItems:"center",gap:1,color:"error.main",fontWeight:700},children:[e.jsx(Sr,{color:"error",sx:{fontSize:32}}),"Confirm Deletion"]}),e.jsxs(ue,{children:[e.jsx(y,{variant:"body1",sx:{color:"text.primary",fontSize:"1.1rem",mb:2},children:"Are you sure you want to delete this ticket? This action cannot be undone."}),e.jsx(y,{variant:"body1",sx:{fontWeight:"bold",color:"text.primary",bgcolor:"action.hover",p:2,borderRadius:1,fontSize:"1.1rem"},children:j==null?void 0:j.title})]}),e.jsxs(xe,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(V,{onClick:r,sx:{minWidth:100},children:"Cancel"}),e.jsx(V,{onClick:h,color:"error",variant:"contained",disabled:v,sx:{minWidth:100},children:v?e.jsx(Se,{size:20}):"Delete"})]})]}),ks=({open:l,onClose:j,newTicket:r,onTicketChange:h,newTicketFiles:v,onFileUpload:E,onFileDelete:I,departments:P,users:M,onSubmit:w,loading:D,isMobile:z,currentUserId:L})=>e.jsxs(de,{open:l,onClose:j,maxWidth:"sm",fullWidth:!0,fullScreen:z,children:[e.jsx(ce,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:"Create New Ticket"}),e.jsx(ue,{sx:{pt:{xs:1,sm:2}},children:e.jsx(_,{component:"form",onSubmit:n=>{n.preventDefault(),w()},sx:{mt:1},children:e.jsxs(C,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Ticket Title",name:"title",value:r.title,onChange:h,required:!0,sx:{mb:2}})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Description",name:"description",value:r.description,onChange:h,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Desired Action"}),e.jsxs(X,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,children:[e.jsx(x,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(x,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(x,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(x,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(x,{value:"Dispatch",children:"Dispatch"}),e.jsx(x,{value:"File",children:"File"}),e.jsx(x,{value:"Mis routed",children:"Mis routed"}),e.jsx(x,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(x,{value:"photocopy file",children:"Photocopy file"}),e.jsx(x,{value:"Study",children:"Study"}),e.jsx(x,{value:"Staff action",children:"Staff action"}),e.jsx(x,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{name:"priority",value:r.priority,label:"Priority",onChange:h,children:[e.jsx(x,{value:"Low",children:"Low"}),e.jsx(x,{value:"Medium",children:"Medium"}),e.jsx(x,{value:"High",children:"High"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{name:"status",value:r.status||"pending",label:"Status",onChange:h,children:[e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Send To"}),e.jsxs(X,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,children:[e.jsx(er,{children:"Admins"}),M.filter(n=>n.role==="admin").filter(n=>n.id!==L).map(n=>e.jsxs(x,{value:n.id,children:[n.firstname," ",n.lastname," (Admin)"]},n.id)),e.jsx(er,{children:"Department Heads"}),P.filter(n=>n.head).filter(n=>n.head.id!==L).map(n=>e.jsxs(x,{value:n.head.id,children:[n.head.firstname," ",n.head.lastname," (Dept Head, ",n.name,")"]},n.head.id))]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(te,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(_,{sx:{mt:3},children:[e.jsx(y,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),v.length===0&&e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),v.length>0&&e.jsx(vr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:v.map(n=>{const g=n.file_name||n.name||"Unknown File";return e.jsxs(Ar.Fragment,{children:[e.jsxs(Cr,{secondaryAction:e.jsx($,{title:"Delete file",arrow:!0,children:e.jsx(oe,{edge:"end",onClick:()=>I(n.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(Re,{fontSize:"small"})})}),children:[e.jsx(Tr,{children:e.jsx(Fr,{})}),e.jsx(Dr,{primary:e.jsx($,{title:"Click to download file",arrow:!0,children:e.jsx(y,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(n.file){const s=URL.createObjectURL(n.file),T=document.createElement("a");T.href=s,T.download=n.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(s)}},children:g})}),secondary:e.jsxs(y,{variant:"caption",color:"text.disabled",children:[n.uploadedAt?new Date(n.uploadedAt).toLocaleString():"—"," • ",kr(n.file_size||n.size||0)]})})]}),e.jsx(Wr,{variant:"inset",component:"li"})]},n.id)})}),e.jsxs(V,{variant:"outlined",component:"label",startIcon:e.jsx(ar,{}),disabled:D||v.length>=5,sx:{mt:1},children:[D?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:n=>{const g=n.target.files[0];g&&E(g)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:D||v.length>=5})]}),e.jsx(_,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(xe,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(V,{onClick:j,children:"Cancel"}),e.jsx(V,{variant:"contained",onClick:w,disabled:D,sx:{minWidth:100},children:D?e.jsx(Se,{size:20}):"Create Ticket"})]})]}),Es=({open:l,onClose:j,ticket:r,departments:h,users:v=[],getStatusColor:E,getStatusIcon:I,getPriorityColor:P,getPriorityIcon:M,onRefresh:w,getTicketFiles:D,onFileDelete:z,onEdit:L,isMobile:n,addComment:g,loadComments:s,deleteComment:T,activeTab:S=0})=>{ve();const d=f=>{if(!f)return"Unknown";if(typeof f=="object"&&f.firstname)return`${f.firstname} ${f.lastname}`.trim()||f.email||f.username||"Unknown";const b=v.find(R=>R.id===f);return b&&(`${b.firstname} ${b.lastname}`.trim()||b.email||b.username)||f},W=f=>{if(!f)return"N/A";const b=h.find(R=>R.id===f);return b?b.name:f};return r?e.jsxs(de,{open:l,onClose:j,maxWidth:"md",fullWidth:!0,fullScreen:n,children:[e.jsxs(ce,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2},display:"flex",alignItems:"center",gap:2},children:[e.jsx(wr,{sx:{bgcolor:`${E(r.status)}.light`,color:`${E(r.status)}.main`,width:{xs:32,sm:40},height:{xs:32,sm:40}},children:(()=>{switch(I(r.status)){case"Schedule":return e.jsx(Xe,{sx:{fontSize:{xs:16,sm:20}}});case"CheckCircle":return e.jsx(Ye,{sx:{fontSize:{xs:16,sm:20}}});case"Error":return e.jsx(Qe,{sx:{fontSize:{xs:16,sm:20}}});default:return e.jsx(Ke,{sx:{fontSize:{xs:16,sm:20}}})}})()}),e.jsxs(_,{sx:{flex:1},children:[e.jsx(y,{variant:"h6",sx:{fontWeight:600},children:r.title}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Ticket #",r.id]})]})]}),e.jsxs(ue,{sx:{pt:{xs:1,sm:2}},children:[e.jsxs(C,{container:!0,spacing:3,children:[e.jsxs(C,{item:!0,xs:12,children:[e.jsx(y,{variant:"h6",sx:{mb:2,fontWeight:600},children:"Description"}),e.jsx(_,{sx:{mb:3},children:e.jsx(y,{variant:"body1",children:r.description})})]}),(r.desired_action||r.desiredAction)&&e.jsxs(C,{item:!0,xs:12,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Desired Action"}),e.jsx(y,{variant:"body1",children:r.desired_action||r.desiredAction})]}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Priority"}),e.jsx(ne,{label:r.priority,color:P(r.priority),icon:(()=>{switch(M(r.priority)){case"PriorityHigh":return e.jsx(tr,{sx:{fontSize:16}});case"Remove":return e.jsx(je,{sx:{fontSize:16}});case"LowPriority":return e.jsx(sr,{sx:{fontSize:16}});default:return e.jsx(je,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsx(ne,{label:r.status.replace("_"," "),color:E(r.status),icon:(()=>{switch(I(r.status)){case"Schedule":return e.jsx(Xe,{sx:{fontSize:16}});case"CheckCircle":return e.jsx(Ye,{sx:{fontSize:16}});case"Error":return e.jsx(Qe,{sx:{fontSize:16}});default:return e.jsx(Ke,{sx:{fontSize:16}})}})(),sx:{fontWeight:500}})]})}),e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created By"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Oe,{sx:{fontSize:20},color:"action"}),d(r.ticketCreator||r.createdBy||r.created_by)]})]}),e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Department"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Oe,{sx:{fontSize:20},color:"action"}),W(r.departmentId||r.department_id)]})]}),(r.ticketAssignee||r.assignedTo||r.assigned_to)&&e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Assigned To"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Oe,{sx:{fontSize:20},color:"action"}),d(r.ticketAssignee||r.assignedTo||r.assigned_to)]})]}),r.due_date&&e.jsxs(C,{item:!0,xs:12,sm:6,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Due Date"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ze,{sx:{fontSize:20},color:"action"}),_e(r.due_date)]})]}),e.jsxs(C,{item:!0,xs:12,children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",sx:{mb:1},children:"Created"}),e.jsxs(y,{variant:"body1",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ze,{sx:{fontSize:20},color:"action"}),ps(r.created_at||r.createdAt)]})]})]}),D(r.id).length>0&&e.jsx(_,{sx:{mt:3},children:e.jsx(gs,{entityId:r.id,fetchFiles:async()=>({data:D(r.id)}),uploadFile:()=>{},deleteFile:z,maxFiles:5,maxFileSize:10*1024*1024,acceptedTypes:["*/*"],disabled:!1,readOnly:!0})}),e.jsx(js,{entityId:r==null?void 0:r.id,user:JSON.parse(localStorage.getItem("user")||"{}"),users:v,fetchComments:s,addComment:g,deleteComment:T})]}),e.jsxs(xe,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(V,{onClick:j,children:"Close"}),e.jsx(Ws,{ticket:r,disabled:(()=>{const f=S===2,b=S===1&&!!(r!=null&&r.forwarded_to_id||r!=null&&r.is_forwarded||r!=null&&r.forwardedToId),R=f||b;return console.log("Forward button logic:",{activeTab:S,ticketId:r==null?void 0:r.id,forwarded_to_id:r==null?void 0:r.forwarded_to_id,is_forwarded:r==null?void 0:r.is_forwarded,forwardedToId:r==null?void 0:r.forwardedToId,isTab2:f,isTab1AndForwarded:b,shouldDisable:R}),R})(),onForward:()=>{j(),typeof w=="function"&&w()}}),e.jsx(V,{variant:"contained",startIcon:e.jsx(Ee,{}),onClick:()=>{j(),L(r)},sx:{minWidth:100},children:"Edit Ticket"})]})]}):null},Rs=({open:l,onClose:j,ticket:r,onTicketChange:h,editingTicketFiles:v,onFileUpload:E,onFileDelete:I,departments:P,onSubmit:M,loading:w,fileOperationsCount:D=0})=>{var z,L;return r?e.jsxs(de,{open:l,onClose:j,maxWidth:"md",fullWidth:!0,children:[e.jsx(ce,{children:e.jsxs(_,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ee,{color:"primary"}),e.jsx(y,{variant:"h6",children:"Edit Ticket"})]})}),e.jsx(ue,{dividers:!0,children:r&&e.jsx(_,{sx:{pt:1},children:e.jsxs(C,{container:!0,spacing:3,children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Title",name:"title",value:r.title||"",onChange:h,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:"Description",name:"description",value:r.description||"",onChange:h,multiline:!0,rows:4,required:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Desired Action"}),e.jsxs(X,{name:"desired_action",value:r.desired_action||"",label:"Desired Action",onChange:h,sx:{borderRadius:2},children:[e.jsx(x,{value:"Approval/Signature",children:"Approval/Signature"}),e.jsx(x,{value:"Comments/Recommendation",children:"Comments/Recommendation"}),e.jsx(x,{value:"Re-Write/Re-Draft",children:"Re-Write/Re-Draft"}),e.jsx(x,{value:"Information/Notation",children:"Information/Notation"}),e.jsx(x,{value:"Dispatch",children:"Dispatch"}),e.jsx(x,{value:"File",children:"File"}),e.jsx(x,{value:"Mis routed",children:"Mis routed"}),e.jsx(x,{value:"return to office of origin",children:"Return to office of origin"}),e.jsx(x,{value:"photocopy file",children:"Photocopy file"}),e.jsx(x,{value:"Study",children:"Study"}),e.jsx(x,{value:"Staff action",children:"Staff action"}),e.jsx(x,{value:"See me/ Call me",children:"See me/ Call me"})]})]})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(te,{fullWidth:!0,label:D!==0?"Remarks (Required - File operations performed)":"Remarks (Required for updates)",name:"remarks",value:(r==null?void 0:r.remarks)||"",onChange:h,multiline:!0,rows:3,required:!0,error:D!==0&&!((z=r==null?void 0:r.remarks)!=null&&z.trim()),helperText:D!==0?"Remarks are required when file operations are performed":"Please provide remarks explaining the changes made to this ticket",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Priority"}),e.jsxs(X,{name:"priority",value:r.priority||"Medium",label:"Priority",onChange:h,sx:{borderRadius:2},children:[e.jsx(x,{value:"Low",children:"Low"}),e.jsx(x,{value:"Medium",children:"Medium"}),e.jsx(x,{value:"High",children:"High"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(Y,{children:"Status"}),e.jsxs(X,{name:"status",value:r.status||"pending",label:"Status",onChange:h,sx:{borderRadius:2},children:[e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"declined",children:"Declined"})]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(Q,{fullWidth:!0,required:!0,children:[e.jsx(Y,{children:"Send To"}),e.jsxs(X,{name:"sendTo",value:r.sendTo||"",label:"Send To",onChange:h,sx:{borderRadius:2},children:[e.jsx(er,{children:"Department Heads"}),P.filter(n=>n.head).map(n=>e.jsxs(x,{value:n.head.id,children:[n.head.firstname," ",n.head.lastname," (Dept Head, ",n.name,")"]},n.head.id))]})]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(te,{fullWidth:!0,label:"Due Date",name:"due_date",type:"date",value:r.due_date||"",onChange:h,InputLabelProps:{shrink:!0},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(C,{item:!0,xs:12,children:e.jsxs(_,{sx:{mt:3},children:[e.jsx(y,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Attachments"}),v.length===0&&e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"No attachments yet."}),v.length>0&&e.jsx(vr,{dense:!0,sx:{maxHeight:200,overflowY:"auto",mb:2,scrollbarWidth:"none",msOverflowStyle:"none","&::-webkit-scrollbar":{display:"none"}},children:v.map(n=>{const g=n.file_name||n.name||"Unknown File";return e.jsxs(Ar.Fragment,{children:[e.jsxs(Cr,{secondaryAction:e.jsx($,{title:"Delete file",arrow:!0,children:e.jsx(oe,{edge:"end",onClick:()=>I(n.id),color:"error",size:"small",sx:{"&:hover":{backgroundColor:"error.light",color:"error.contrastText"}},children:e.jsx(Re,{fontSize:"small"})})}),children:[e.jsx(Tr,{children:e.jsx(Fr,{})}),e.jsx(Dr,{primary:e.jsx($,{title:"Click to download file",arrow:!0,children:e.jsx(y,{component:"span",sx:{cursor:"pointer",color:"primary.main",textDecoration:"underline","&:hover":{textDecoration:"none"}},onClick:()=>{if(n.file){const s=URL.createObjectURL(n.file),T=document.createElement("a");T.href=s,T.download=n.name,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(s)}else{const s=localStorage.getItem("token"),T=`/api/files/${n.id}/download`;fetch(T,{headers:{Authorization:`Bearer ${s}`}}).then(S=>{if(S.ok)return S.blob();throw new Error("Download failed")}).then(S=>{const d=URL.createObjectURL(S),W=document.createElement("a");W.href=d,W.download=n.name,document.body.appendChild(W),W.click(),document.body.removeChild(W),URL.revokeObjectURL(d)}).catch(S=>{console.error("Download error:",S)})}},children:g})}),secondary:e.jsxs(y,{variant:"caption",color:"text.disabled",children:[n.uploadedAt?new Date(n.uploadedAt).toLocaleString():"—"," • ",kr(n.file_size||n.size||0)]})})]}),e.jsx(Wr,{variant:"inset",component:"li"})]},n.id)})}),e.jsxs(V,{variant:"outlined",component:"label",startIcon:e.jsx(ar,{}),disabled:w||v.length>=5,sx:{mt:1},children:[w?"Uploading...":"Upload File (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,onChange:n=>{const g=n.target.files[0];g&&E(g)},accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",disabled:w||v.length>=5})]}),e.jsx(_,{sx:{mt:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"})]})})]})})}),e.jsxs(xe,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(V,{onClick:j,disabled:D!==0,children:"Cancel"}),e.jsx(V,{variant:"contained",onClick:M,disabled:w||D!==0&&!((L=r==null?void 0:r.remarks)!=null&&L.trim()),sx:{minWidth:100},children:w?e.jsx(Se,{size:20}):"Update Ticket"})]})]}):null},gr={title:"",description:"",priority:"Medium",status:"pending",sendTo:"",due_date:"",departmentId:"",desired_action:"",remarks:""},Us=()=>{const l=ve(),j=rr(l.breakpoints.down("sm")),{user:r}=hs(),{id:h}=Ss(),v=vs(),{tickets:E,assignedTickets:I,forwardedTickets:P,loading:M,actionLoading:w,departments:D,users:z,createTicket:L,updateTicket:n,deleteTicket:g,loadTicketFiles:s,uploadTicketFile:T,deleteTicketFile:S,downloadTicketFile:d,getTicketFiles:W,addComment:f,loadComments:b,deleteComment:R,refreshTickets:J}=Cs(),[me,Ie]=t.useState(""),[Ce,Pe]=t.useState("all"),[Te,Le]=t.useState("all"),[ee,Ne]=t.useState(0),[he,Fe]=t.useState(gr),[re,ye]=t.useState([]),[ie,i]=t.useState(null),[a,p]=t.useState(null),[m,c]=t.useState([]),[A,k]=t.useState(0),[G,Z]=t.useState(null),[H,le]=t.useState(!1),[De,B]=t.useState(z),[ae,se]=t.useState(!1),[We,fe]=t.useState(!1),[Er,Be]=t.useState(!1),[nr,N]=t.useState({open:!1,message:""}),[or,we]=t.useState({open:!1,message:""}),Ae=(r==null?void 0:r.role)==="department_head"||(r==null?void 0:r.role)==="Department Head",be=r==null?void 0:r.id,ze=ys(E,I,P,me,Ce,Te,ee,be);t.useEffect(()=>{if(h&&(E.length>0||I.length>0||P.length>0)){const u=[...E,...I,...P].find(F=>F.id===h);u?(i(u),se(!0)):v("/app/tickets")}},[h,E,I,P,v]),t.useEffect(()=>{H&&(async()=>{try{const u=Array.isArray(z)?z:[];let F=[];try{F=(await ge.getAll({role:"admin"})).data||[]}catch{F=u.filter(Ue=>(Ue.role||"").toLowerCase()==="admin")}const U=[...u];F.forEach(pe=>{U.some(Ue=>Ue.id===pe.id)||U.push(pe)});const K=U.filter(pe=>pe.id!==be);B(K)}catch{const u=Array.isArray(z)?z:[];B(u.filter(F=>F.id!==be))}})()},[H,z,be]);const ir=t.useCallback(()=>{Fe(gr),ye([])},[]),Rr=t.useCallback(o=>{const{name:u,value:F}=o.target;Fe(U=>({...U,[u]:F}))},[]),Ir=t.useCallback(async o=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(o.type)){N({open:!0,message:"Only PDF and image files are allowed."});return}const F=10*1024*1024;if(o.size>F){N({open:!0,message:"File size must be less than 10MB."});return}if(re.length>=5){N({open:!0,message:"Maximum 5 files allowed."});return}const U=xr(o,r);ye(K=>[...K,U])}catch{N({open:!0,message:"Failed to prepare file for upload."})}},[r,re.length]),Pr=t.useCallback(async o=>{try{ye(u=>u.filter(F=>F.id!==o))}catch{N({open:!0,message:"Failed to remove file."})}},[]),Lr=t.useCallback(async o=>{try{const u=re.find(F=>F.id===o);mr(u)}catch{N({open:!0,message:"Failed to download file."})}},[re]),Nr=t.useCallback(async()=>{const o=hr(he,!1);if(o.length>0){N({open:!0,message:o[0]});return}try{const u=fr(he,Ae,r),F=await L(u,re);F.success?(ir(),le(!1),we({open:!0,message:"Ticket created successfully!"})):N({open:!0,message:F.error})}catch(u){N({open:!0,message:u.message||"Failed to create ticket. Please try again."})}},[he,re,Ae,r,L,ir]),Br=t.useCallback(async o=>{try{const u=await g(o);u.success?(Be(!1),Z(null),we({open:!0,message:"Ticket deleted successfully!"})):N({open:!0,message:u.error||"Failed to delete ticket"})}catch(u){console.error("Delete ticket error:",u),N({open:!0,message:u.message||"Failed to delete ticket. Please try again."})}},[g]),lr=t.useCallback(async o=>{i(o),await s(o.id),se(!0)},[s]),Me=t.useCallback(async o=>{const u=ws(o);p(u),k(0);try{const F=await s(o.id);c(Array.isArray(F)?F:[])}catch(F){console.error("Error loading ticket files:",F),c([])}fe(!0)},[s]),Mr=t.useCallback(o=>{const{name:u,value:F}=o.target;p(U=>({...U,[u]:F}))},[]),Ur=t.useCallback(async()=>{const o=hr(a,!0);if(o.length>0){N({open:!0,message:o[0]});return}try{const u=fr(a,Ae,r),F=await n(u);if(F.success){const U=m.filter(K=>K.id.startsWith("temp-"));if(U.length>0&&(a!=null&&a.id))try{for(const K of U)await T(K.file,a.id)}catch(K){console.error("Error uploading temp files:",K)}fe(!1),p(null),c([]),we({open:!0,message:"Ticket updated successfully!"})}else N({open:!0,message:F.error})}catch(u){N({open:!0,message:u.message||"Failed to update ticket. Please try again."})}},[a,m,Ae,r,n,T]),dr=t.useCallback(async()=>{try{await J()}catch(o){console.error("Error refreshing tickets:",o)}},[J]),Hr=t.useCallback(async o=>{try{if(!["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"].includes(o.type)){N({open:!0,message:"Only PDF and image files are allowed."});return}const F=10*1024*1024;if(o.size>F){N({open:!0,message:"File size must be less than 10MB."});return}if(m.length>=5){N({open:!0,message:"Maximum 5 files allowed."});return}if(a!=null&&a.id){await T(o,a.id);const U=await s(a.id);c(Array.isArray(U)?U:[])}else{const U=xr(o,r);c(K=>[...K,U])}k(U=>U+1)}catch(u){console.error("Error uploading file:",u),N({open:!0,message:"Failed to upload file."})}},[a,m.length,r,T,s]),Or=t.useCallback(async o=>{try{if(a!=null&&a.id){await S(a.id,o);const u=await s(a.id);c(Array.isArray(u)?u:[])}else c(u=>u.filter(F=>F.id!==o));k(u=>u-1)}catch(u){console.error("Error deleting file:",u),N({open:!0,message:"Failed to delete file."})}},[a,S,s]),qr=t.useCallback(async o=>{try{if(a!=null&&a.id)await d(a.id,o);else{const u=m.find(F=>F.id===o);mr(u)}}catch(u){console.error("Error downloading file:",u),N({open:!0,message:"Failed to download file."})}},[a,m,d]),$r=t.useCallback(async o=>{try{await S(ie.id,o),we({open:!0,message:"File deleted successfully!"})}catch{N({open:!0,message:"Failed to delete file."})}},[ie,S]),Vr=t.useCallback(async o=>{try{await d(ie.id,o)}catch{N({open:!0,message:"Failed to download file."})}},[ie,d]),cr=t.useCallback(o=>{Z(o),Be(!0)},[]),Gr=t.useCallback(()=>{N({open:!1,message:""})},[]),Jr=t.useCallback(()=>{we({open:!1,message:""})},[]),Kr=t.useCallback(()=>{Be(!1)},[]),Qr=t.useCallback(()=>{le(!1)},[]),Yr=t.useCallback(()=>{se(!1),i(null),h&&v("/app/tickets")},[h,v]),Xr=t.useCallback(()=>{fe(!1),k(0)},[]);return t.useEffect(()=>{const o=()=>{J()};return window.addEventListener("ticket_update",o),window.addEventListener("new_comment",o),window.addEventListener("notification",o),window.addEventListener("user_update",o),window.addEventListener("task_update",o),()=>{window.removeEventListener("ticket_update",o),window.removeEventListener("new_comment",o),window.removeEventListener("notification",o),window.removeEventListener("user_update",o),window.removeEventListener("task_update",o)}},[J]),M?e.jsx(fs,{message:"Loading tickets...",size:"large"}):e.jsxs(_,{sx:{p:{xs:2,md:4},backgroundColor:l.palette.background.default,minHeight:"100vh"},children:[e.jsx(bs,{title:"Tickets Management",subtitle:"Track and manage support tickets and requests for your department",emoji:"🎫",color:"primary",onRefresh:dr,actionButton:{text:"New Ticket",icon:e.jsx(cs,{}),onClick:()=>le(!0),disabled:w}}),e.jsx(As,{open:nr.open,message:nr.message,onClose:Gr}),e.jsx(zs,{open:or.open,message:or.message,onClose:Jr}),e.jsx(_,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(us,{in:!0,timeout:800,children:e.jsxs(_,{children:[e.jsx(Ts,{activeTab:ee,setActiveTab:Ne,searchQuery:me,setSearchQuery:Ie,filter:Ce,setFilter:Pe,priorityFilter:Te,setPriorityFilter:Le,isMobile:j}),e.jsxs(_,{sx:{mt:2,mb:2},children:[e.jsxs(y,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:[ee===0?"Sent Tickets":ee===1?"Received Tickets":"Forwarded by Me"," (",ze.length,")"]}),ze.length===0?e.jsx(_,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(y,{variant:"body1",children:E.length===0?"No tickets found. Create your first ticket to get started.":"No tickets match your current filters. Try adjusting your search criteria."})}):e.jsxs(e.Fragment,{children:[e.jsx(_,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(Fs,{tickets:ze,departments:D,users:z,activeTab:ee,onViewTicket:lr,onEditTicket:Me,onDeleteTicket:cr,getStatusColor:Ge,getStatusIcon:pr,getPriorityColor:Ve,getPriorityIcon:$e})}),e.jsx(_,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(C,{container:!0,spacing:2,children:ze.map(o=>e.jsx(C,{item:!0,xs:12,children:e.jsx(Ds,{ticket:o,departments:D,users:z,activeTab:ee,onViewTicket:lr,onEditTicket:Me,onDeleteTicket:cr,getPriorityColor:Ve,getPriorityIcon:$e,getStatusColor:Ge,getTicketFiles:W})},o.id))})})]})]})]})})}),e.jsx(_s,{open:Er,ticket:G,onClose:Kr,onConfirm:()=>Br(G==null?void 0:G.id),loading:w}),e.jsx(ks,{open:H,onClose:Qr,newTicket:he,onTicketChange:Rr,newTicketFiles:re,onFileUpload:Ir,onFileDelete:Pr,onFileDownload:Lr,departments:D,users:De,onSubmit:Nr,loading:w,isMobile:j,currentUserId:be}),e.jsx(Es,{open:ae,onClose:Yr,ticket:ie,departments:D,users:z,getStatusColor:Ge,getStatusIcon:pr,getPriorityColor:Ve,getPriorityIcon:$e,getTicketFiles:W,onRefresh:dr,onFileDelete:$r,onFileDownload:Vr,onEdit:Me,isMobile:j,addComment:f,loadComments:b,deleteComment:R,activeTab:ee}),e.jsx(Rs,{open:We,onClose:Xr,ticket:a,onTicketChange:Mr,editingTicketFiles:m,onFileUpload:Hr,onFileDelete:Or,onFileDownload:qr,departments:D,users:z,onSubmit:Ur,loading:w,fileOperationsCount:A})]})};export{Us as default};
