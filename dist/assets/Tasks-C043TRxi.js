import{r as n,j as e,am as Oe,an as Qe,k as ve,B as c,b as f,I as $,ao as Ye,d as N,Z as Ne,ap as Le,aq as xe,h as _,ar as Ie,as as ze,P as ue,l as Se,m as P,Y as q,at as re,au as ie,ae as We,u as $e,a4 as Ve,v as De,w as Pe,x as Ae,a7 as D,av as Z,aw as ee,ax as te,ay as se,z as H,az as Ke,a6 as Je,y as Fe,J as Xe,a8 as He,a9 as Ze,aA as et,aB as tt,aC as st,aD as rt,aE as it,aF as Ue,aG as R,aH as at,aI as nt,F as lt,a5 as ot}from"./mui-DmyK1VYO.js";import{c as ke,f as Ce,u as dt,t as M,b as ct,d as _e,L as mt}from"./index-DFirrH-V.js";import{g as xt,a as ut,f as ae,C as ht,F as pt}from"./FileUploadSection-s95ZT1pL.js";import{c as gt,u as ft}from"./router-ViNET1Ki.js";import{P as jt}from"./PageHeader-DsP3YEjW.js";import"./vendor-Ckhrjn13.js";const he=t=>{switch(t){case"high":return"error";case"medium":return"warning";case"low":return"success";default:return"default"}},pe=t=>{switch(t){case"completed":return"success";case"in_progress":return"primary";case"pending":return"warning";default:return"default"}},ge=t=>t?t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:t.firstname&&t.lastname?`${t.firstname} ${t.lastname}`:t.username||t.email||t.id:"Unassigned",Ee=t=>xt({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),Re=t=>ut({...t,due_date:t.dueDate||t.due_date,created_at:t.createdAt||t.created_at}),bt=t=>{const s={};return(!t.title||t.title.trim().length<3)&&(s.title="Title must be at least 3 characters long"),(!t.description||t.description.trim().length<10)&&(s.description="Description must be at least 10 characters long"),t.dueDate||(s.dueDate="Due date is required"),(!t.priority||!["low","medium","high"].includes(t.priority))&&(s.priority="Priority must be low, medium, or high"),{isValid:Object.keys(s).length===0,errors:s}},me=()=>({title:"",description:"",priority:"medium",status:"pending",dueDate:"",assignedToId:"",attachments:[],relatedTicketId:"",remarks:""}),Be=(t,s={})=>{const a={title:t.title?.trim(),description:t.description?.trim(),priority:t.priority,status:t.status,dueDate:t.dueDate||null,assignedToId:t.assignedToId||null,relatedTicketId:t.relatedTicketId||null,remarks:t.remarks?.trim(),...s};return Object.keys(a).forEach(m=>{(a[m]===""||a[m]===void 0)&&delete a[m]}),delete a.attachments,a},qe=[{value:"pending",label:"Pending"},{value:"in_progress",label:"In Progress"},{value:"completed",label:"Completed"}],yt=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}],wt=[{value:"all",label:"All Status"},...qe];n.memo(function({task:s,departmentUsers:a,canUpdateTask:m,selectedTasks:k,updatingStatus:B,updatingPriority:A,onSelectTask:v,onViewDetails:x,onEditTask:T,onDeleteTask:h,onUpdateStatus:b,onUpdatePriority:j}){const[C,l]=n.useState(null),[o,p]=n.useState(null),[F,S]=n.useState(null),y=U=>{switch(U){case"completed":return e.jsx(We,{});case"in_progress":return e.jsx(ie,{});case"pending":return e.jsx(re,{});default:return e.jsx(q,{})}},I=U=>l(U.currentTarget),i=()=>l(null),u=()=>{x(s),i()},E=()=>{T(s),i()},W=()=>{h(s),i()},L=a.find(U=>U.id===s.assignedToId),z=ge(L);return e.jsxs(Oe,{elevation:2,sx:{p:{xs:1,sm:1.5,md:2},borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.08)",display:"flex",flexDirection:"row",alignItems:"center",minHeight:{xs:64,sm:72,md:80},mb:1,background:{xs:"rgba(0,0,0,0.01)",sm:"rgba(0,0,0,0.01)",md:"inherit"},"&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.12)",transform:"translateY(-1px)",transition:"all 0.2s ease-in-out"}},tabIndex:0,"aria-label":`Task: ${s.title}`,children:[e.jsx(Qe,{checked:k.includes(s.id),onChange:()=>v(s.id),size:"small",sx:{mr:1,flexShrink:0}}),e.jsx(ve,{sx:{bgcolor:"primary.main",width:{xs:32,sm:36,md:40},height:{xs:32,sm:36,md:40},boxShadow:"0 1px 4px rgba(0,0,0,0.08)",flexShrink:0,mr:{xs:1,sm:1.5,md:2}},children:y(s.status)}),e.jsxs(c,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:{xs:"column",md:"row"},gap:{xs:.5,sm:.8,md:1},alignItems:{md:"center"}},children:[e.jsxs(c,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:{xs:.3,sm:.4,md:.5}},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx(f,{variant:"subtitle1",component:"div",sx:{fontWeight:700,fontSize:{xs:"0.98rem",sm:"1.05rem",md:"1.12rem",lg:"1.18rem"},letterSpacing:.1,lineHeight:1.2,color:"text.primary",wordBreak:"break-word",flex:1,minWidth:0},noWrap:!0,children:s.title}),e.jsx($,{sx:{color:"text.secondary","&:hover":{color:"primary.main",background:"rgba(46,125,50,0.08)"},width:{xs:28,sm:32,md:36},height:{xs:28,sm:32,md:36},borderRadius:2,border:"1px solid",borderColor:"divider",bgcolor:"background.default",boxShadow:"0 1px 4px rgba(0,0,0,0.04)",fontSize:"1rem",ml:1,flexShrink:0,display:{xs:"flex",md:"none"}},onClick:I,size:"small","aria-label":"Task actions",children:e.jsx(Ye,{fontSize:"inherit"})})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.82rem",sm:"0.85rem",md:"0.88rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxHeight:{xs:16,sm:20,md:24},overflow:"hidden",textOverflow:"ellipsis",width:"100%",display:{xs:"block",md:"-webkit-box"},WebkitLineClamp:{xs:1,md:2},WebkitBoxOrient:{xs:"horizontal",md:"vertical"}},noWrap:!1,children:s.description})]}),e.jsxs(c,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"flex-start",md:"center"},gap:{xs:.5,sm:.8,md:1.5},flexShrink:0,minWidth:{md:"fit-content"}},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:{xs:.5,sm:.6,md:.8},flexWrap:"wrap",order:{xs:1,md:1}},children:[e.jsx(N,{label:s.priority,size:"small",color:he(s.priority),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?U=>S(U.currentTarget):void 0,clickable:m,disabled:A===s.id}),e.jsx(N,{label:(s.status||"").replace("_"," "),size:"small",color:pe(s.status),sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:{xs:.6,sm:.8,md:1},height:{xs:18,sm:20,md:22}},onClick:m?U=>p(U.currentTarget):void 0,clickable:m,disabled:B===s.id}),(B===s.id||A===s.id)&&e.jsx(Ne,{size:12,sx:{ml:.5}})]}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:{xs:.7,sm:1,md:1.5},flexWrap:"wrap",order:{xs:2,md:2}},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(Le,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(f,{variant:"caption",color:z!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},fontStyle:z!=="Unassigned"?"normal":"italic",whiteSpace:"nowrap"},component:"span",children:z})]}),s.dueDate&&e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:{xs:.2,sm:.3,md:.4},minWidth:"fit-content"},children:[e.jsx(xe,{sx:{fontSize:{xs:13,sm:14,md:16}},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.7rem",sm:"0.72rem",md:"0.75rem",lg:"0.78rem"},whiteSpace:"nowrap"},component:"span",children:ae(s.dueDate)})]})]})]})]}),e.jsx(c,{sx:{display:{xs:"none",md:"flex"},alignItems:"center",gap:1,ml:2},children:e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:.5,bgcolor:"background.paper",borderRadius:3,boxShadow:"0 2px 8px rgba(0,0,0,0.07)",px:1,py:.5,border:"1px solid",borderColor:"grey.200"},children:[e.jsx(_,{title:"View Details",children:e.jsx($,{sx:{color:"primary.main",bgcolor:"grey.100","&:hover":{bgcolor:"primary.light",color:"white"},width:32,height:32,borderRadius:2},onClick:u,size:"small",children:e.jsx(Ie,{fontSize:"small"})})}),e.jsx(_,{title:"Edit Task",children:e.jsx($,{sx:{color:"info.main",bgcolor:"grey.100","&:hover":{bgcolor:"info.main",color:"white"},width:32,height:32,borderRadius:2},onClick:E,size:"small",children:e.jsx(ze,{fontSize:"small"})})}),e.jsx(_,{title:"Delete Task",children:e.jsx($,{sx:{color:"error.main",bgcolor:"grey.100","&:hover":{bgcolor:"error.main",color:"white"},width:32,height:32,borderRadius:2},onClick:W,size:"small",children:e.jsx(ue,{fontSize:"small"})})})]})}),e.jsxs(Se,{anchorEl:C,open:!!C,onClose:i,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[e.jsx(P,{onClick:u,children:"View Details"}),e.jsx(P,{onClick:E,children:"Edit"}),e.jsx(P,{onClick:W,sx:{color:"error.main"},children:"Delete"})]}),e.jsxs(Se,{anchorEl:o,open:!!o,onClose:()=>p(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(P,{onClick:()=>{b(s.id,"pending"),p(null)},disabled:s.status==="pending",children:"Pending"}),e.jsx(P,{onClick:()=>{b(s.id,"in_progress"),p(null)},disabled:s.status==="in_progress",children:"In Progress"}),e.jsx(P,{onClick:()=>{b(s.id,"completed"),p(null)},disabled:s.status==="completed",children:"Completed"})]}),e.jsxs(Se,{anchorEl:F,open:!!F,onClose:()=>S(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:[e.jsx(P,{onClick:()=>{j(s.id,"low"),S(null)},disabled:s.priority==="low",children:"Low"}),e.jsx(P,{onClick:()=>{j(s.id,"medium"),S(null)},disabled:s.priority==="medium",children:"Medium"}),e.jsx(P,{onClick:()=>{j(s.id,"high"),S(null)},disabled:s.priority==="high",children:"High"})]})]})});const Me=({open:t,onClose:s,onSubmit:a,initialData:m=null,departmentUsers:k=[],pendingTickets:B=[],loading:A=!1,mode:v="create"})=>{const x=$e(),T=Ve(x.breakpoints.down("sm")),[h,b]=n.useState(me()),[j,C]=n.useState({}),[l,o]=n.useState("");n.useEffect(()=>{t&&(b(m&&v==="edit"?{...me(),...m,title:m.title||"",description:m.description||"",priority:m.priority||"medium",status:m.status||"pending",dueDate:m.dueDate||"",assignedToId:m.assignedToId||"",relatedTicketId:m.relatedTicketId||"",attachments:m.attachments||[]}:me()),C({}),o(""))},[t,m,v]);const p=i=>{const{name:u,value:E}=i.target;b(W=>({...W,[u]:E})),j[u]&&C(W=>({...W,[u]:""}))},F=i=>{const u=Array.from(i.target.files||[]);if(u.length===0)return;const E=["application/pdf","image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp"],W=[],L=[];if(u.forEach(z=>{E.includes(z.type)?z.size>10*1024*1024?L.push(`${z.name}: File size must be less than 10MB`):W.push(z):L.push(`${z.name}: Only PDF and image files are allowed`)}),L.length>0){o(L.join(", "));return}b(z=>({...z,attachments:[...z.attachments,...W]}))},S=i=>{b(u=>({...u,attachments:u.attachments.filter((E,W)=>W!==i)}))},y=async i=>{i&&i.preventDefault&&i.preventDefault(),o("");const u=bt(h);if(!u.isValid){C(u.errors);return}try{await a(h),I()}catch(E){o(E.message||"An error occurred while saving the task")}},I=()=>{b(me()),C({}),o(""),s()};return e.jsxs(De,{open:t,onClose:I,maxWidth:"sm",fullWidth:!0,fullScreen:T,children:[e.jsx(Pe,{sx:{fontSize:{xs:"1.25rem",sm:"1.5rem"},pb:{xs:1,sm:2}},children:v==="create"?"Create New Task":"Edit Task"}),e.jsx(Ae,{sx:{pt:{xs:1,sm:2}},children:e.jsx(c,{component:"form",onSubmit:y,sx:{mt:1},children:e.jsxs(D,{container:!0,spacing:{xs:1.5,sm:2},children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(Z,{fullWidth:!0,label:"Task Title",name:"title",value:h.title,onChange:p,error:!!j.title,helperText:j.title,required:!0,sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,children:e.jsx(Z,{fullWidth:!0,label:"Description",name:"description",value:h.description,onChange:p,error:!!j.description,helperText:j.description,multiline:!0,rows:3,sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(ee,{fullWidth:!0,error:!!j.priority,children:[e.jsx(te,{children:"Priority"}),e.jsx(se,{name:"priority",value:h.priority,label:"Priority",onChange:p,children:yt.map(i=>e.jsx(P,{value:i.value,children:i.label},i.value))})]})}),v==="edit"&&e.jsxs(e.Fragment,{children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(Z,{fullWidth:!0,label:"Remarks (Required for updates)",name:"remarks",value:h.remarks||"",onChange:p,multiline:!0,rows:3,required:!0,helperText:"Please provide remarks explaining the changes made to this task",sx:{mb:2}})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(ee,{fullWidth:!0,children:[e.jsx(te,{children:"Status"}),e.jsx(se,{name:"status",value:h.status,label:"Status",onChange:p,children:qe.map(i=>e.jsx(P,{value:i.value,children:i.label},i.value))})]})})]}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(ee,{fullWidth:!0,children:[e.jsx(te,{children:"Assignee"}),e.jsxs(se,{name:"assignedToId",value:h.assignedToId,label:"Assignee",onChange:p,children:[e.jsx(P,{value:"",children:"Unassigned"}),k.filter(i=>i.role==="employee").map(i=>{const u=i.firstname&&i.lastname&&`${i.firstname} ${i.lastname}`||i.firstName&&i.lastName&&`${i.firstName} ${i.lastName}`||i.username||i.email||i.id;return e.jsx(P,{value:i.id,children:u},i.id)})]})]})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsx(Z,{fullWidth:!0,label:"Due Date",name:"dueDate",type:"date",value:h.dueDate,onChange:p,error:!!j.dueDate,helperText:j.dueDate,InputLabelProps:{shrink:!0},required:!0})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(ee,{fullWidth:!0,children:[e.jsx(te,{children:"Related Pending Ticket"}),e.jsxs(se,{name:"relatedTicketId",value:h.relatedTicketId||"",label:"Related Pending Ticket",onChange:p,children:[e.jsx(P,{value:"",children:"None"}),B.map(i=>e.jsxs(P,{value:i.id,children:[i.title," (#",i.id,")"]},i.id))]})]})}),e.jsxs(D,{item:!0,xs:12,children:[e.jsxs(H,{variant:"outlined",component:"label",startIcon:e.jsx(Ke,{}),fullWidth:!0,sx:{mb:1},children:[v==="create"?"Attach Files (PDF & Images Only)":"Upload Additional Files (PDF & Images Only)",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,application/pdf,image/*",onChange:F})]}),e.jsx(c,{sx:{mb:1,fontSize:"0.75rem",color:"text.secondary"},children:"Allowed file types: PDF, JPG, PNG, GIF, WebP, BMP (Max 10MB each)"}),h.attachments&&h.attachments.length>0&&e.jsxs(c,{sx:{mt:1},children:[e.jsx(c,{sx:{fontSize:"0.875rem",fontWeight:600,mb:1,color:"text.primary"},children:v==="create"?"Files to upload:":"Additional files to upload:"}),h.attachments.map((i,u)=>e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5,p:1,bgcolor:"grey.50",borderRadius:1},children:[e.jsxs(c,{sx:{fontSize:"0.875rem",color:"text.secondary",flex:1},children:[i.name," (",(i.size/1024/1024).toFixed(2)," MB)"]}),e.jsx(H,{size:"small",color:"error",onClick:()=>S(u),startIcon:e.jsx(ue,{}),sx:{minWidth:"auto",px:1},children:"Remove"})]},u))]})]}),l&&e.jsx(D,{item:!0,xs:12,children:e.jsx(Je,{severity:"error",sx:{mt:1},children:l})})]})})}),e.jsxs(Fe,{sx:{p:{xs:1.5,sm:2}},children:[e.jsx(H,{onClick:I,disabled:A,children:"Cancel"}),e.jsx(H,{variant:"contained",onClick:y,disabled:A,sx:{minWidth:100},children:A?e.jsx(Ne,{size:22,color:"inherit"}):v==="create"?"Create Task":"Save Changes"})]})]})},Tt=({open:t,onClose:s,task:a,departmentUsers:m=[],user:k})=>{if(!a)return null;const B=a&&a.assignedToId&&m.find(x=>x.id===a.assignedToId),A=ge(B),v=async x=>{const T=x.url||`/api/files/${x.id}/download`;try{const h=localStorage.getItem("token"),b=await fetch(T,{headers:h?{Authorization:`Bearer ${h}`}:{}});if(!b.ok)throw new Error("Failed to download file");const j=await b.blob(),C=window.URL.createObjectURL(j),l=document.createElement("a");l.href=C,l.download=x.file_name||x.name||"attachment",document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(C)}catch{alert("Failed to download file")}};return e.jsxs(De,{open:t,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Pe,{children:"Task Details"}),e.jsxs(Ae,{children:[e.jsxs(c,{sx:{mb:2},children:[e.jsx(f,{variant:"h6",sx:{fontWeight:700},children:a.title}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:1},children:a.description}),e.jsx(Xe,{sx:{my:1}}),e.jsxs(c,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:1},children:[e.jsx(N,{label:a.priority,color:he(a.priority),size:"small"}),e.jsx(N,{label:(a.status||"").replace("_"," "),color:pe(a.status),size:"small"})]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Assigned To:"})," ",A]}),a.dueDate&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mt:1},children:[e.jsx(xe,{sx:{fontSize:16},color:"action"}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",ae(a.dueDate)]})]}),(()=>{const x=Ee(a),T=Re(a);return!x||!T?null:e.jsx(c,{sx:{mt:1},children:e.jsx(N,{label:T,size:"small",color:x,sx:{fontSize:"0.7rem",fontWeight:600,borderRadius:2,px:.5,height:18,boxShadow:1,minWidth:60,justifyContent:"center"}})})})()]}),a.relatedTicket&&e.jsxs(c,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:600,mb:1},children:"Related Ticket"}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Title:"})," ",a.relatedTicket.title]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Description:"})," ",a.relatedTicket.description]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Status:"})," ",a.relatedTicket.status]}),e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Priority:"})," ",a.relatedTicket.priority]}),a.relatedTicket.due_date&&e.jsxs(f,{variant:"body2",children:[e.jsx("b",{children:"Due Date:"})," ",a.relatedTicket.due_date]}),Array.isArray(a.relatedTicket.attachments)&&a.relatedTicket.attachments.length>0&&e.jsxs(c,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",sx:{fontWeight:600,mb:.5},children:"Attachments:"}),a.relatedTicket.attachments.map(x=>e.jsx(c,{sx:{mb:.5},children:e.jsx("span",{style:{color:"primary.main",textDecoration:"underline",fontSize:"0.95em",cursor:"pointer"},onClick:()=>v(x),children:x.file_name||x.name})},x.id||x.file_name))]})]})]}),e.jsx(ht,{entityId:a.id,fetchComments:ke.fetchComments,addComment:ke.addComment,deleteComment:ke.deleteComment,user:k}),e.jsx(pt,{entityId:a.id,fetchFiles:x=>Ce.getByEntity("task",x),uploadFile:(x,T)=>Ce.upload(T,"task",x),deleteFile:(x,T)=>Ce.delete(T),entityType:"task"})]}),e.jsx(Fe,{children:e.jsx(H,{onClick:s,children:"Close"})})]})},St=({searchQuery:t,filter:s,onSearchChange:a,onFilterChange:m})=>e.jsx(He,{sx:{mb:{xs:3,sm:4,md:5},borderRadius:3,boxShadow:"0 2px 12px rgba(0,0,0,0.08)"},children:e.jsx(Ze,{sx:{p:{xs:2,sm:2.5,md:3}},children:e.jsxs(D,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(D,{item:!0,xs:12,sm:8,md:6,children:e.jsx(Z,{fullWidth:!0,placeholder:"Search tasks...",value:t,onChange:k=>a(k.target.value),InputProps:{startAdornment:e.jsx(et,{position:"start",children:e.jsx(tt,{color:"action"})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(D,{item:!0,xs:12,sm:4,md:3,children:e.jsxs(ee,{fullWidth:!0,children:[e.jsx(te,{children:"Status"}),e.jsx(se,{value:s,label:"Status",onChange:k=>m(k.target.value),sx:{borderRadius:2},children:wt.map(k=>e.jsx(P,{value:k.value,children:k.label},k.value))})]})})]})})}),kt=({tasks:t,departmentUsers:s,canUpdateTask:a,selectedTasks:m,updatingStatus:k,updatingPriority:B,onSelectTask:A,onViewDetails:v,onEditTask:x,onDeleteTask:T,onUpdateStatus:h,onUpdatePriority:b})=>{const j=$e();Ve(j.breakpoints.down("sm"));const C=o=>{switch(o){case"completed":return e.jsx(We,{});case"in_progress":return e.jsx(ie,{});case"pending":return e.jsx(re,{});default:return e.jsx(q,{})}},l=o=>{switch(o){case"high":return e.jsx(ie,{});case"medium":return e.jsx(re,{});case"low":return e.jsx(q,{});default:return e.jsx(q,{})}};return e.jsx(c,{sx:{display:{xs:"none",md:"block"}},children:e.jsx(st,{component:Oe,sx:{borderRadius:3,boxShadow:3,overflowX:"auto",width:"100%",maxWidth:"100vw",bgcolor:"background.paper"},children:e.jsxs(rt,{size:"medium",sx:{minWidth:{md:0,lg:900},width:"100%",tableLayout:"fixed"},children:[e.jsx(it,{children:e.jsxs(Ue,{sx:{position:"sticky",top:0,zIndex:2,bgcolor:"background.paper",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:[e.jsx(R,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:56,lg:80}},children:"Status"}),e.jsx(R,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:120,lg:220},minWidth:80},children:"Title"}),e.jsx(R,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Priority"}),e.jsx(R,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:"Status"}),e.jsx(R,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Assigned To"}),e.jsx(R,{sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},maxWidth:{md:80,lg:160}},children:"Due Date"}),e.jsx(R,{align:"right",sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},borderBottom:"2px solid",borderColor:"divider",px:{md:.5,lg:2},minWidth:{md:60,lg:80}},children:"Actions"})]})}),e.jsx(at,{children:t.map((o,p)=>{const F=s.find(y=>y.id===o.assignedToId),S=ge(F);return e.jsxs(Ue,{hover:!0,sx:{bgcolor:p%2===0?"background.default":"background.paper",transition:"background 0.2s","&:hover":{bgcolor:"action.hover"}},children:[e.jsx(R,{sx:{px:{md:.5,lg:2},width:{md:56,lg:80}},children:e.jsx(ve,{sx:{bgcolor:"primary.main",width:{md:22,lg:32},height:{md:22,lg:32},boxShadow:"0 1px 4px rgba(0,0,0,0.08)"},children:C(o.status)})}),e.jsxs(R,{sx:{maxWidth:{md:120,lg:220},minWidth:80,px:{md:.5,lg:2}},children:[e.jsx(_,{title:o.title,arrow:!0,children:e.jsx(f,{variant:"subtitle1",noWrap:!0,sx:{fontWeight:700,fontSize:{md:"0.92rem",lg:"1rem"},wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:o.title})}),e.jsx(_,{title:o.description,arrow:!0,children:e.jsx(f,{variant:"body2",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.8rem",lg:"0.92rem"},lineHeight:1.4,wordBreak:"break-word",maxWidth:{md:110,lg:200}},children:o.description})})]}),e.jsx(R,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(N,{label:o.priority,size:"small",color:he(o.priority),icon:l(o.priority),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:70},justifyContent:"center"}})}),e.jsx(R,{sx:{px:{md:.5,lg:2},width:{md:60,lg:120},maxWidth:{md:80,lg:160}},children:e.jsx(N,{label:(o.status||"").replace("_"," "),size:"small",color:pe(o.status),sx:{fontSize:{md:"0.65rem",lg:"0.78rem"},fontWeight:600,borderRadius:2,px:1,height:{md:16,lg:22},boxShadow:1,minWidth:{lg:90},justifyContent:"center"}})}),e.jsx(R,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsx(f,{variant:"caption",color:S!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:S!=="Unassigned"?"normal":"italic"},children:S})}),e.jsx(R,{sx:{maxWidth:{md:80,lg:160},px:{md:.5,lg:2}},children:e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[o.dueDate&&e.jsx(_,{title:ae(o.dueDate),arrow:!0,children:e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(xe,{sx:{fontSize:{md:13,lg:16}},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:{md:"0.7rem",lg:"0.78rem"},maxWidth:{md:60,lg:70}},children:ae(o.dueDate)})]})}),(()=>{const y=Ee(o),I=Re(o);return!y||!I?null:e.jsx(_,{title:`Maturity: ${I}`,arrow:!0,children:e.jsx("span",{children:e.jsx(N,{label:I,size:"small",color:y,sx:{fontSize:{md:"0.6rem",lg:"0.7rem"},fontWeight:600,borderRadius:2,px:.5,height:{md:14,lg:18},boxShadow:1,minWidth:{lg:60},justifyContent:"center"}})})})})()]})}),e.jsx(R,{align:"right",sx:{minWidth:{md:60,lg:80},px:{md:.5,lg:2}},children:e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:.2,flexWrap:"wrap",justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(_,{title:"View Details",children:e.jsx("span",{children:e.jsx($,{color:"primary",size:"small",onClick:()=>v(o),children:e.jsx(Ie,{fontSize:"small"})})})}),e.jsx(_,{title:"Edit Task",children:e.jsx("span",{children:e.jsx($,{color:"secondary",size:"small",onClick:()=>x(o),children:e.jsx(ze,{fontSize:"small"})})})}),e.jsx(_,{title:"Delete Task",children:e.jsx("span",{children:e.jsx($,{color:"error",size:"small",onClick:()=>T(o),children:e.jsx(ue,{fontSize:"small"})})})})]})})]},o.id)})})]})})})},Ct=({tasks:t,departmentUsers:s,canUpdateTask:a,selectedTasks:m,updatingStatus:k,updatingPriority:B,onSelectTask:A,onViewDetails:v,onEditTask:x,onDeleteTask:T,onUpdateStatus:h,onUpdatePriority:b})=>{const j=l=>{switch(l){case"completed":return e.jsx(We,{});case"in_progress":return e.jsx(ie,{});case"pending":return e.jsx(re,{});default:return e.jsx(q,{})}},C=l=>{switch(l){case"high":return e.jsx(ie,{});case"medium":return e.jsx(re,{});case"low":return e.jsx(q,{});default:return e.jsx(q,{})}};return e.jsx(c,{sx:{display:{xs:"block",md:"none"}},children:e.jsx(D,{container:!0,spacing:2,children:t.map(l=>{const o=s.find(F=>F.id===l.assignedToId),p=ge(o);return e.jsx(D,{item:!0,xs:12,children:e.jsxs(He,{sx:{borderRadius:3,boxShadow:3,p:2,bgcolor:"background.paper"},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(ve,{sx:{bgcolor:"primary.main",width:28,height:28,boxShadow:"0 1px 4px rgba(0,0,0,0.08)",mr:1},children:j(l.status)}),e.jsxs(c,{sx:{flex:1},children:[e.jsx(f,{variant:"subtitle1",sx:{fontWeight:700,fontSize:"1rem",wordBreak:"break-word"},children:l.title}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.92rem",lineHeight:1.4,wordBreak:"break-word"},children:l.description})]})]}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx(N,{label:l.priority,size:"small",color:he(l.priority),icon:C(l.priority),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),e.jsx(N,{label:(l.status||"").replace("_"," "),size:"small",color:pe(l.status),sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}}),(()=>{const F=Ee(l),S=Re(l);return!F||!S?null:e.jsx(N,{label:S,size:"small",color:F,sx:{fontSize:"0.78rem",fontWeight:600,borderRadius:2,px:1,height:20}})})()]}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:1},children:[e.jsx(Le,{sx:{fontSize:16},color:"action"}),e.jsx(f,{variant:"caption",color:p!=="Unassigned"?"text.secondary":"text.disabled",sx:{fontSize:"0.78rem",fontStyle:p!=="Unassigned"?"normal":"italic"},children:p}),l.dueDate&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{fontSize:16,ml:1},color:"action"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.78rem"},children:ae(l.dueDate)})]})]}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:.5,justifyContent:"flex-end",bgcolor:"action.selected",borderRadius:2,px:1,py:.5,boxShadow:1},children:[e.jsx(_,{title:"View Details",children:e.jsx("span",{children:e.jsx($,{color:"primary",size:"small",onClick:()=>v(l),children:e.jsx(Ie,{})})})}),e.jsx(_,{title:"Edit Task",children:e.jsx("span",{children:e.jsx($,{color:"secondary",size:"small",onClick:()=>x(l),children:e.jsx(ze,{})})})}),e.jsx(_,{title:"Delete Task",children:e.jsx("span",{children:e.jsx($,{color:"error",size:"small",onClick:()=>T(l),children:e.jsx(ue,{})})})})]})]})},l.id)})})})},vt=()=>{const{user:t}=dt(),{id:s}=gt(),a=ft(),[m,k]=n.useState([]),[B,A]=n.useState([]),[v,x]=n.useState([]),[T,h]=n.useState(!0),[b,j]=n.useState("all"),[C,l]=n.useState(""),[o,p]=n.useState(null),[F,S]=n.useState(!1),[y,I]=n.useState([]),[i,u]=n.useState(!1),[E,W]=n.useState(null),[L,z]=n.useState(null),[U,G]=n.useState(!1),[K,Q]=n.useState(""),w=n.useCallback(async()=>{h(!0);try{let r;t?.role==="department_head"&&t?.departmentId?r=await M.getAll({departmentId:t.departmentId}):r=await M.getAll(),k(r.data)}catch(r){console.error("Failed to load tasks:",r),k([])}finally{h(!1)}},[t?.role,t?.departmentId]),J=n.useCallback(async()=>{if(t?.departmentId)try{const r=await ct.getDepartmentUsers(t.departmentId);A(r.data)}catch(r){console.error("Failed to load department users:",r),A([])}},[t?.departmentId]),X=n.useCallback(async()=>{if(t?.departmentId)try{const r=await _e.getAll({departmentId:t.departmentId,status:"pending"});x(Array.isArray(r.data)?r.data:r.data.tickets||[])}catch(r){console.error("Failed to load pending tickets:",r),x([])}},[t?.departmentId]);n.useEffect(()=>{w(),J()},[w,J]),n.useEffect(()=>{if(s&&m.length>0){const r=m.find(d=>d.id===s);r&&(p(r),S(!0))}},[s,m]);const fe=n.useCallback(async r=>{G(!0);try{const d=Be(r,{departmentId:t.departmentId}),g=await M.create(d),V=g.data||g;if(r.attachments&&r.attachments.length>0)try{for(const Te of r.attachments)await M.uploadAttachment(V.id,Te)}catch(Te){console.error("Error uploading files:",Te)}return await w(),Q("Task created successfully!"),{success:!0}}catch(d){console.error("Error creating task:",d);const g=d?.response?.data?.error||d.message||"Failed to create task. Please try again.";throw new Error(g)}finally{setTimeout(()=>G(!1),1e3)}},[t.departmentId,w]),Y=n.useCallback(async(r,d)=>{try{if(!d?.remarks||d.remarks.trim()==="")throw new Error("Remarks are required when updating a task. Please provide remarks explaining the changes made.");const g=Be(d);if(await M.update(r,g),d.attachments&&d.attachments.length>0)try{for(const V of d.attachments)await M.uploadAttachment(r,V)}catch(V){console.error("Error uploading files during task update:",V)}return g.relatedTicketId&&g.status&&await _e.updateStatus(g.relatedTicketId,g.status),await w(),Q("Task updated successfully!"),{success:!0}}catch(g){console.error("Error updating task:",g);const V=g?.response?.data?.error||g.message||"Failed to update task";throw new Error(V)}},[w]),ne=n.useCallback(async r=>{G(!0);try{return await M.delete(r),await w(),Q("Task deleted successfully!"),{success:!0}}catch(d){console.error("Error deleting task:",d);const g=d?.response?.data?.error||d.message||"Failed to delete task";throw new Error(g)}finally{setTimeout(()=>G(!1),1e3)}},[w]),le=n.useCallback(async(r,d)=>{W(r);try{await M.updateStatus(r,d),await w()}catch(g){console.error("Error updating task status:",g)}finally{W(null)}},[w]),je=n.useCallback(async(r,d)=>{z(r);try{await M.updatePriority(r,d),await w()}catch(g){console.error("Error updating task priority:",g)}finally{z(null)}},[w]),oe=n.useCallback(r=>{if(Array.isArray(r)){I(r);return}const d=r;I(g=>g.includes(d)?g.filter(V=>V!==d):[...g,d])},[]),de=n.useCallback(r=>{y.length===r.length?I([]):I(r.map(d=>d.id))},[y.length]),ce=n.useCallback(async r=>{u(!0);try{await Promise.all(y.map(d=>M.updateStatus(d,r))),I([]),await w()}catch(d){console.error("Error updating bulk status:",d)}finally{u(!1)}},[y,w]),be=n.useCallback(async r=>{u(!0);try{await Promise.all(y.map(d=>M.updatePriority(d,r))),I([]),await w()}catch(d){console.error("Error updating bulk priority:",d)}finally{u(!1)}},[y,w]),ye=n.useCallback(async()=>{if(window.confirm(`Are you sure you want to delete ${y.length} tasks?`)){u(!0);try{await Promise.all(y.map(r=>M.delete(r))),I([]),await w()}catch(r){console.error("Error deleting bulk tasks:",r)}finally{u(!1)}}},[y,w]),we=m.filter(r=>{const d=b==="all"||r.status===b,g=r.title.toLowerCase().includes(C.toLowerCase())||r.description.toLowerCase().includes(C.toLowerCase());return d&&g}),O=n.useCallback(r=>t&&(t.role==="admin"||t.role==="department_head"||r.createdBy===t.id||r.assignedToId===t.id),[t]),Ge=n.useCallback(()=>{S(!1),p(null),s&&a("/app/tasks",{replace:!0})},[s,a]);return{tasks:m,filteredTasks:we,departmentUsers:B,pendingTickets:v,loadingState:T,filter:b,searchQuery:C,selectedTask:o,detailsOpen:F,selectedTasks:y,bulkUpdating:i,updatingStatus:E,updatingPriority:L,creatingTask:U,successMessage:K,setFilter:j,setSearchQuery:l,setSelectedTask:p,setDetailsOpen:S,setSuccessMessage:Q,loadPendingTickets:X,createTask:fe,updateTask:Y,deleteTask:ne,updateTaskStatus:le,updateTaskPriority:je,selectTask:oe,selectAllTasks:de,bulkUpdateStatus:ce,bulkUpdatePriority:be,bulkDeleteTasks:ye,closeDetails:Ge,canUpdateTask:O,user:t}},Ft=()=>{const{filteredTasks:t,departmentUsers:s,pendingTickets:a,loadingState:m,filter:k,searchQuery:B,selectedTask:A,detailsOpen:v,selectedTasks:x,updatingStatus:T,updatingPriority:h,creatingTask:b,successMessage:j,setFilter:C,setSearchQuery:l,setSelectedTask:o,setDetailsOpen:p,setSuccessMessage:F,loadPendingTickets:S,createTask:y,updateTask:I,deleteTask:i,updateTaskStatus:u,updateTaskPriority:E,selectTask:W,closeDetails:L,canUpdateTask:z,user:U}=vt(),[G,K]=n.useState(!1),[Q,w]=n.useState(!1),[J,X]=n.useState(null),[fe,Y]=n.useState(!1),[ne,le]=n.useState(null),je=()=>{S(),K(!0)},oe=O=>{X(O),S(),w(!0)},de=O=>{le(O),Y(!0)},ce=O=>{o(O),p(!0)},be=async O=>{await y(O),K(!1)},ye=async O=>{await I(J.id,O),w(!1),X(null)},we=async()=>{ne&&(await i(ne.id),Y(!1),le(null))};return m?e.jsx(mt,{overlay:!0,message:"Loading tasks..."}):e.jsxs(c,{sx:{flexGrow:1,pt:{xs:7,sm:3,md:4},px:{xs:1,sm:2,md:3},display:"flex",flexDirection:"column",height:"100%"},children:[e.jsx(jt,{title:"Tasks",subtitle:"Manage and track your department's tasks efficiently",emoji:"âœ…",color:"success",actionButton:{text:"Add Task",icon:e.jsx(nt,{}),onClick:je}}),e.jsx(c,{sx:{flexGrow:1,minHeight:0,overflowY:"auto"},children:e.jsx(lt,{in:!0,timeout:800,children:e.jsxs(c,{children:[e.jsx(St,{searchQuery:B,filter:k,onSearchChange:l,onFilterChange:C}),e.jsxs(c,{sx:{mt:2,mb:2},children:[e.jsxs(f,{variant:"h6",sx:{fontWeight:700,mb:2,px:1},children:["All Tasks (",t.length,")"]}),t.length===0?e.jsx(c,{sx:{p:4,textAlign:"center",color:"text.secondary"},children:e.jsx(f,{variant:"body1",children:"No tasks found. Try adjusting your filters or add a new task."})}):e.jsxs(e.Fragment,{children:[e.jsx(kt,{tasks:t,departmentUsers:s,canUpdateTask:z,selectedTasks:x,updatingStatus:T,updatingPriority:h,onSelectTask:W,onViewDetails:ce,onEditTask:oe,onDeleteTask:de,onUpdateStatus:u,onUpdatePriority:E}),e.jsx(Ct,{tasks:t,departmentUsers:s,canUpdateTask:z,selectedTasks:x,updatingStatus:T,updatingPriority:h,onSelectTask:W,onViewDetails:ce,onEditTask:oe,onDeleteTask:de,onUpdateStatus:u,onUpdatePriority:E})]})]})]})})}),e.jsx(Me,{open:G,onClose:()=>K(!1),onSubmit:be,departmentUsers:s,pendingTickets:a,loading:b,mode:"create"}),e.jsx(Me,{open:Q,onClose:()=>{w(!1),X(null)},onSubmit:ye,initialData:J,departmentUsers:s,pendingTickets:a,loading:!1,mode:"edit"}),e.jsx(Tt,{open:v,onClose:L,task:A,departmentUsers:s,user:U}),e.jsxs(De,{open:fe,onClose:()=>Y(!1),children:[e.jsx(Pe,{children:"Delete Task"}),e.jsx(Ae,{children:e.jsx(f,{children:"Are you sure you want to delete this task? This action cannot be undone."})}),e.jsxs(Fe,{children:[e.jsx(H,{onClick:()=>Y(!1),children:"Cancel"}),e.jsx(H,{variant:"contained",color:"error",onClick:we,disabled:b,children:"Delete"})]})]}),e.jsx(ot,{open:!!j,autoHideDuration:3e3,onClose:()=>F(""),message:j,anchorOrigin:{vertical:"top",horizontal:"center"},ContentProps:{sx:{backgroundColor:"success.main",color:"white",fontWeight:600}}})]})};export{Ft as default};
