import{u as Pe,r as a,j as e,B as P,bd as Se,S as Re,am as Ce,F as C,G as Ie,H as ie,b as T,av as p,aA as d,be as G,I as U,b9 as V,ar as Y,ba as Z,an as Le,bf as ke,a6 as S,al as J,ae as K,z as E,Z as Q,a7 as h,ap as le,aw as Te,ax as Ee,ay as Ae,m as De,e as Fe,v as We,w as Me,x as qe,y as ze}from"./mui-BfuGcMOQ.js";import{u as Be,L as Oe,m as He,l as A}from"./index-C96xgESD.js";import{R as de,P as _e,r as g,h as ce}from"./PasswordStrengthIndicator-BB1K_etI.js";import{u as $e}from"./router-DwSTIDLU.js";import"./vendor-Ckhrjn13.js";const Ze=()=>{const me=$e(),o=Pe(),{login:ue,user:D}=Be(),[f,X]=a.useState(0),[F,pe]=a.useState(!1),[I,u]=a.useState(""),[b,L]=a.useState(!1),[R,ee]=a.useState(!1),[W,j]=a.useState(null),[x,ge]=a.useState({email:"",password:"",rememberMe:!1}),[w,te]=a.useState(!1),[M,l]=a.useState(""),[c,q]=a.useState(!1),[m,z]=a.useState(!1),[B,y]=a.useState(null),[O,xe]=a.useState([]),[n,re]=a.useState({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),[he,H]=a.useState(!1),[_,fe]=a.useState(""),[k,se]=a.useState(!1),[ae,$]=a.useState(""),[oe,ne]=a.useState("");a.useEffect(()=>{D&&D.isAuthenticated&&localStorage.removeItem("loginTab")},[D]),a.useEffect(()=>{const r=setTimeout(()=>L(!1),800);return()=>clearTimeout(r)},[]),a.useEffect(()=>{f===1&&O.length===0&&(async()=>{try{const i=await A.getDepartments();xe(i.data)}catch{}})()},[f,O.length]);const N=r=>{const{name:i,value:s}=r.target;ge(t=>({...t,[i]:s})),I&&u("")},be=async r=>{if(r.preventDefault(),!x.email||!x.password){u("Please fill in all fields");return}if(!g.canRetry("login")){const s=g.getRemainingRetryTime("login");u(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}L(!0),u(""),ee(!1),j(null);const i=setTimeout(()=>{L(!1)},3e4);try{const s=await A.login(x),{data:t}=s;if(t&&t.token){clearTimeout(i),ee(!0),g.clearRetryTimer("login");const ve={user:t.user,token:t.token};ue(ve,x.rememberMe),setTimeout(()=>{me("/app/dashboard")},1e3)}else throw new Error("Invalid response from server")}catch(s){console.error("Login error:",s),console.log("Error response:",s.response),console.log("Error data:",s.response?.data),clearTimeout(i),L(!1);try{const t=ce(s);console.log("Error info from handleApiError:",t),t.type==="rate_limit"?(j(t.rateLimitData),g.setRetryTimer("login",t.retryTime||900*1e3),u("")):(u(t.message),j(null))}catch(t){console.error("Error handling failed:",t),u("An error occurred. Please try again later."),j(null)}}},v=r=>{const{name:i,value:s}=r.target;re(t=>({...t,[i]:s})),M&&l("")},je=()=>!n.firstname||!n.lastname||!n.email||!n.password||!n.confirmPassword||!n.departmentId?(l("Please fill in all fields"),!1):n.password!==n.confirmPassword?(l("Passwords do not match"),!1):n.password.length<8?(l("Password must be at least 8 characters long"),!1):!0,we=async r=>{if(r.preventDefault(),!je())return;if(!g.canRetry("register")){const s=g.getRemainingRetryTime("register");l(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}q(!0),l(""),z(!1),y(null);const i=setTimeout(()=>{q(!1)},3e4);try{const s={...n};delete s.confirmPassword,(await A.register(s)).data&&(clearTimeout(i),z(!0),g.clearRetryTimer("register"),re({firstname:"",lastname:"",email:"",password:"",confirmPassword:"",departmentId:"",role:"department_head"}),setTimeout(()=>{X(0),z(!1),l("")},2e3))}catch(s){console.error("Registration error:",s),console.log("Registration error response:",s.response),console.log("Registration error data:",s.response?.data),clearTimeout(i),q(!1);try{const t=ce(s);console.log("Registration error info from handleApiError:",t),t.type==="rate_limit"?(y(t.rateLimitData),g.setRetryTimer("register",t.retryTime||900*1e3),l("")):(l(t.message),y(null))}catch(t){console.error("Registration error handling failed:",t),l("An error occurred. Please try again later."),y(null)}}},ye=(r,i)=>{X(i),u(""),l("")};return b&&!I?e.jsx(Oe,{overlay:!0,message:"Loading login..."}):e.jsxs(P,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",background:o.palette.mode==="dark"?o.palette.background.default:`linear-gradient(to right bottom, ${o.palette.primary.light}, ${o.palette.primary.main})`,py:8,position:"relative",overflow:"hidden"},children:[e.jsx(Se,{component:"main",maxWidth:"sm",children:e.jsx(Re,{direction:"up",in:!0,timeout:800,children:e.jsxs(Ce,{elevation:o.palette.mode==="dark"?2:8,sx:{p:{xs:3,sm:6},display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:o.palette.mode==="dark"?o.palette.background.paper:o.palette.common.white,borderRadius:3,position:"relative",backdropFilter:"blur(10px)",border:`1px solid ${o.palette.mode==="dark"?"rgba(255,255,255,0.1)":"rgba(255,255,255,0.2)"}`,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"},children:[e.jsx(C,{in:!0,timeout:1200,children:e.jsx(P,{sx:{width:80,height:80,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",mb:2,boxShadow:"0 4px 20px rgba(0,0,0,0.1)"},children:e.jsx(P,{component:"img",src:He,alt:"Mito Logo",sx:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover"}})})}),e.jsxs(Ie,{value:f,onChange:ye,sx:{mb:3},centered:!0,children:[e.jsx(ie,{label:"Sign In"}),e.jsx(ie,{label:"Sign Up"})]}),f===0&&e.jsxs(P,{sx:{textAlign:"center",mb:2},children:[e.jsx(T,{variant:"h4",color:"primary",sx:{fontWeight:"bold",fontSize:24,mt:.75},children:"Welcome Back"}),e.jsx(T,{variant:"body1",color:"text.secondary",sx:{fontSize:14,mt:.25},children:"Sign in to continue"})]}),f===0&&e.jsxs("form",{onSubmit:be,style:{width:"100%"},children:[e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:x.email,onChange:N,disabled:b||R,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}}),e.jsx(p,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:F?"text":"password",id:"password",autoComplete:"current-password",value:x.password,onChange:N,disabled:b||R,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Z,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>pe(!F),edge:"end",disabled:b||R,children:F?e.jsx(V,{}):e.jsx(Y,{})})})}}),e.jsxs(P,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:1,mb:2},children:[e.jsxs(P,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Le,{checked:x.rememberMe,onChange:r=>N({target:{name:"rememberMe",value:r.target.checked}}),color:"primary",size:"small"}),e.jsx(T,{variant:"body2",sx:{color:o.palette.text.secondary},children:"Remember me"})]}),e.jsx(ke,{component:"button",type:"button",variant:"body2",underline:"hover",onClick:r=>{r.preventDefault(),r.stopPropagation(),H(!0)},sx:{border:"none",background:"none",cursor:"pointer",color:o.palette.primary.main,"&:hover":{color:o.palette.primary.dark}},children:"Forgot password?"})]}),e.jsx(de,{isOpen:!!W,onClose:()=>j(null),rateLimitData:W,endpoint:"login",onRetry:()=>{j(null),u("")}}),I&&!W&&e.jsx(C,{in:!0,children:e.jsx(S,{severity:"error",sx:{width:"100%",mb:2},icon:e.jsx(J,{}),children:I})}),R&&e.jsx(C,{in:!0,children:e.jsx(S,{severity:"success",sx:{width:"100%",mb:2},icon:e.jsx(K,{}),children:"Login successful! Redirecting..."})}),e.jsx(E,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:b||R,children:b?e.jsx(Q,{size:24,color:"inherit"}):"Sign In"})]}),f===1&&e.jsxs("form",{onSubmit:we,style:{width:"100%"},children:[e.jsxs(h,{container:!0,spacing:2,children:[e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"firstname",label:"First Name",name:"firstname",autoComplete:"given-name",value:n.firstname,onChange:v,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,id:"lastname",label:"Last Name",name:"lastname",autoComplete:"family-name",value:n.lastname,onChange:v,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(le,{color:"action"})})}})}),e.jsx(h,{item:!0,xs:12,children:e.jsx(p,{required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",value:n.email,onChange:v,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}})}),e.jsx(h,{item:!0,xs:12,children:e.jsxs(Te,{fullWidth:!0,required:!0,children:[e.jsx(Ee,{id:"department-label",children:"Department"}),e.jsx(Ae,{labelId:"department-label",id:"departmentId",name:"departmentId",value:n.departmentId,label:"Department",onChange:v,disabled:c||m,startAdornment:e.jsx(d,{position:"start",children:e.jsx(Fe,{color:"action"})}),children:O.map(r=>e.jsx(De,{value:r.id,children:r.name},r.id))})]})}),e.jsxs(h,{item:!0,xs:12,sm:6,children:[e.jsx(p,{required:!0,fullWidth:!0,name:"password",label:"Password",type:w?"text":"password",id:"register-password",autoComplete:"new-password",value:n.password,onChange:v,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Z,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>te(!w),edge:"end",disabled:c||m,children:w?e.jsx(V,{}):e.jsx(Y,{})})})}}),e.jsx(_e,{password:n.password})]}),e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsx(p,{required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:w?"text":"password",id:"register-confirm-password",autoComplete:"new-password",value:n.confirmPassword,onChange:v,disabled:c||m,InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(Z,{color:"action"})}),endAdornment:e.jsx(d,{position:"end",children:e.jsx(U,{"aria-label":"toggle password visibility",onClick:()=>te(!w),edge:"end",disabled:c||m,children:w?e.jsx(V,{}):e.jsx(Y,{})})})}})})]}),e.jsx(de,{isOpen:!!B,onClose:()=>y(null),rateLimitData:B,endpoint:"register",onRetry:()=>{y(null),l("")}}),M&&!B&&e.jsx(C,{in:!0,children:e.jsx(S,{severity:"error",sx:{width:"100%",mt:2},icon:e.jsx(J,{}),children:M})}),m&&e.jsx(C,{in:!0,children:e.jsx(S,{severity:"success",sx:{width:"100%",mt:2},icon:e.jsx(K,{}),children:"Registration successful! You will be redirected to login in a few seconds..."})}),e.jsx(E,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.2},disabled:c||m,children:c?e.jsx(Q,{size:24,color:"inherit"}):"Register"})]})]})})}),e.jsxs(We,{open:he,onClose:()=>H(!1),maxWidth:"xs",fullWidth:!0,PaperProps:{sx:{borderRadius:3,boxShadow:o.palette.mode==="dark"?"0 8px 32px rgba(0,0,0,0.3)":"0 8px 32px rgba(0,0,0,0.1)"}},children:[e.jsx(Me,{sx:{pb:1,fontWeight:600,color:o.palette.text.primary},children:"Forgot Password"}),e.jsxs(qe,{sx:{pt:2},children:[e.jsx(T,{variant:"body2",sx:{mb:3,color:o.palette.text.secondary},children:"Enter your email address and we'll send you a link to reset your password."}),e.jsx(p,{label:"Email Address",type:"email",fullWidth:!0,margin:"normal",value:_,onChange:r=>fe(r.target.value),disabled:k,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(d,{position:"start",children:e.jsx(G,{color:"action"})})}}),ae&&e.jsx(S,{severity:"error",sx:{mt:2},icon:e.jsx(J,{}),children:ae}),oe&&e.jsx(S,{severity:"success",sx:{mt:2},icon:e.jsx(K,{}),children:oe})]}),e.jsxs(ze,{sx:{px:3,pb:3},children:[e.jsx(E,{onClick:()=>H(!1),disabled:k,sx:{color:o.palette.text.secondary,"&:hover":{color:o.palette.text.primary}},children:"Cancel"}),e.jsx(E,{onClick:async()=>{if($(""),ne(""),!_){$("Please enter your email address.");return}se(!0);try{await A.forgotPassword({email:_}),ne("If an account with that email exists, a reset link has been sent.")}catch(r){$(r.response?.data?.error||"Failed to send reset email.")}finally{se(!1)}},variant:"contained",color:"primary",disabled:k,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:600,px:3,minWidth:"120px",height:"36px"},children:k?e.jsx(Q,{size:20,color:"inherit"}):"Send Reset Link"})]})]})]})};export{Ze as default};
