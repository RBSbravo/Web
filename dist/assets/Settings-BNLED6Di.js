import{r as o,j as e,B as l,a6 as v,a8 as ne,a9 as oe,G as ie,H as $,ap as le,b6 as Z,a7 as i,k as de,b as p,J as ce,z as C,as as ue,E as me,b7 as xe,av as d,aA as f,I as W,b8 as D,ar as B,b9 as H,Z as we}from"./mui-BvrjgOXm.js";import{h as he,l as _}from"./index-KPmqbX5J.js";import{P as pe}from"./PageHeader-DWvGCfo2.js";import{R as fe,P as ge,r as S,h as je,p as Pe}from"./PasswordStrengthIndicator-CS6JG6kF.js";import{u as be}from"./router-D0O_2iby.js";import"./vendor-Ckhrjn13.js";const K=I=>{const{children:g,value:j,index:m,...P}=I;return e.jsx("div",{role:"tabpanel",hidden:j!==m,id:`settings-tabpanel-${m}`,"aria-labelledby":`settings-tab-${m}`,...P,children:j===m&&e.jsx(l,{sx:{py:4,px:1,minHeight:"400px",width:"100%"},children:g})})},Te=()=>{const I=be(),[g,j]=o.useState(0),[m,P]=o.useState(!1),[r,Q]=o.useState(JSON.parse(localStorage.getItem("user")||"{}")),[c,A]=o.useState(!1),[x,F]=o.useState({firstname:r.firstname||"",lastname:r.lastname||"",email:r.email||""}),[U,V]=o.useState(!1),[T,b]=o.useState(""),[n,z]=o.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[w,q]=o.useState({current:!1,new:!1,confirm:!1}),[u,G]=o.useState({}),[R,J]=o.useState(!1),[Y,E]=o.useState(!1),[L,h]=o.useState(""),[M,y]=o.useState(null),X=(s,t)=>{j(t)},O=(s,t)=>{F(a=>({...a,[s]:t})),T&&b("")},ee=()=>{A(!0)},se=()=>{F({firstname:r.firstname||"",lastname:r.lastname||"",email:r.email||""}),A(!1),b("")},re=async()=>{V(!0),b("");try{const s={firstname:(x.firstname||"").trim(),lastname:(x.lastname||"").trim(),email:(x.email||"").trim()};await he.update(r.id,s);const t={...r,...s};Q(t),localStorage.setItem("user",JSON.stringify(t)),A(!1),P(!0),setTimeout(()=>P(!1),3e3)}catch(s){b(s.response?.data?.error||"Failed to update profile")}finally{V(!1)}},k=(s,t)=>{z(a=>({...a,[s]:t})),u[s]&&G(a=>({...a,[s]:""})),Y&&E(!1),L&&h("")},te=()=>{const s={};if(n.currentPassword||(s.currentPassword="Current password is required"),!n.newPassword)s.newPassword="New password is required";else{const t=Pe.validate(n.newPassword);t.isValid||(s.newPassword=t.errors[0])}return n.confirmPassword?n.newPassword!==n.confirmPassword&&(s.confirmPassword="Passwords do not match"):s.confirmPassword="Please confirm your new password",n.currentPassword===n.newPassword&&(s.newPassword="New password must be different from current password"),G(s),Object.keys(s).length===0},ae=async()=>{if(!S.canRetry("changePassword")){const s=S.getRemainingRetryTime("changePassword");h(`Please wait ${Math.ceil(s/1e3)} seconds before trying again.`);return}if(te()){J(!0),h(""),y(null);try{await _.changePassword({currentPassword:n.currentPassword,newPassword:n.newPassword}),E(!0),S.clearRetryTimer("changePassword"),z({currentPassword:"",newPassword:"",confirmPassword:""}),q({current:!1,new:!1,confirm:!1}),setTimeout(async()=>{E(!1);try{await _.logout()}catch{console.warn("Logout API call failed, but continuing with local cleanup")}localStorage.removeItem("user"),localStorage.removeItem("token"),I("/login")},3e3)}catch(s){const t=je(s);if(t.type==="rate_limit")y(s.rateLimitData||{error:s.message}),S.setRetryTimer("changePassword",t.retryTime),h(t.message);else{let a=t.message;a.toLowerCase().includes("incorrect")?a="Your current password is incorrect.":a.toLowerCase().includes("at least 6 characters")?a="New password must be at least 6 characters.":a.toLowerCase().includes("not found")?a="User not found. Please re-login.":a.toLowerCase().includes("required")?a="Please fill in all password fields.":a.toLowerCase().includes("server error")?a="A server error occurred. Please try again later.":a.toLowerCase().includes("same as current")&&(a="New password must be different from the current password."),h(a)}}finally{J(!1)}}},N=s=>{q(t=>({...t,[s]:!t[s]}))};return e.jsxs(l,{sx:{flexGrow:1,pt:{xs:7,sm:3,md:4},px:{xs:1,sm:2,md:3},display:"flex",flexDirection:"column",minHeight:"100vh",height:"auto",overflowY:"auto"},children:[e.jsx(pe,{title:"Settings",subtitle:"Customize your application preferences",emoji:"⚙️",color:"warning"}),m&&e.jsx(v,{severity:"success",sx:{mb:3},children:"Settings saved successfully!"}),e.jsx(ne,{sx:{minHeight:"500px"},children:e.jsxs(oe,{sx:{p:0},children:[e.jsx(l,{sx:{px:3,pt:2},children:e.jsxs(ie,{value:g,onChange:X,variant:"scrollable",scrollButtons:"auto",sx:{borderBottom:1,borderColor:"divider","& .MuiTab-root":{textTransform:"uppercase",fontWeight:600,fontSize:"0.875rem",letterSpacing:"0.5px",minHeight:48,"&.Mui-selected":{color:"primary.main"}},"& .MuiTabs-indicator":{backgroundColor:"primary.main",height:3}},children:[e.jsx($,{icon:e.jsx(le,{}),label:"Account"}),e.jsx($,{icon:e.jsx(Z,{}),label:"Security"})]})}),e.jsx(K,{value:g,index:0,children:e.jsx(l,{sx:{px:{xs:2,md:4},py:{xs:2,md:3}},children:e.jsx(i,{container:!0,spacing:4,children:e.jsxs(i,{item:!0,xs:12,children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:4},children:[e.jsxs(de,{sx:{width:80,height:80,bgcolor:"primary.main",fontSize:"2rem",mr:3,fontWeight:"bold"},children:[r.firstname?.[0]?.toUpperCase(),r.lastname?.[0]?.toUpperCase()]}),e.jsxs(l,{children:[e.jsxs(p,{variant:"h6",sx:{fontWeight:600,mb:.5},children:[r.firstname," ",r.lastname]}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:.5},children:r.role}),e.jsx(p,{variant:"body2",color:"text.secondary",children:r.email})]})]}),e.jsx(ce,{sx:{my:4}}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsx(p,{variant:"h6",sx:{fontWeight:600},children:"Account Information"}),c?e.jsxs(l,{sx:{display:"flex",gap:1},children:[e.jsx(C,{onClick:se,startIcon:e.jsx(me,{}),children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:re,disabled:U,startIcon:e.jsx(xe,{}),children:U?"Saving...":"Save"})]}):e.jsx(C,{variant:"outlined",onClick:ee,startIcon:e.jsx(ue,{}),children:"Edit"})]}),T&&e.jsx(v,{severity:"error",sx:{mb:2},children:T}),e.jsxs(i,{container:!0,spacing:3,children:[e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(d,{fullWidth:!0,label:"First Name",value:c?x.firstname:r.firstname||"",onChange:s=>O("firstname",s.target.value),disabled:!c,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(d,{fullWidth:!0,label:"Last Name",value:c?x.lastname:r.lastname||"",onChange:s=>O("lastname",s.target.value),disabled:!c,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(d,{fullWidth:!0,label:"Email",value:c?x.email:r.email||"",onChange:s=>O("email",s.target.value),disabled:!c,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(d,{fullWidth:!0,label:"Role",value:r.role||"",disabled:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(d,{fullWidth:!0,label:"Department",value:r.department?.name||r.department||"N/A",disabled:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:2}}})})]})]})})})}),e.jsx(K,{value:g,index:1,children:e.jsx(l,{sx:{px:{xs:2,md:4},py:{xs:2,md:3}},children:e.jsx(i,{container:!0,spacing:4,children:e.jsxs(i,{item:!0,xs:12,children:[e.jsx(p,{variant:"h6",gutterBottom:!0,children:"Change Password"}),Y&&e.jsx(v,{severity:"success",sx:{mb:2},children:"Password changed successfully! You will be logged out for security."}),e.jsx(fe,{isOpen:!!M,onClose:()=>y(null),rateLimitData:M,endpoint:"changePassword",onRetry:()=>{y(null),h("")}}),L&&!M&&e.jsx(v,{severity:"error",sx:{mb:2},children:L}),e.jsx(d,{fullWidth:!0,type:w.current?"text":"password",label:"Current Password",variant:"outlined",value:n.currentPassword,onChange:s=>k("currentPassword",s.target.value),error:!!u.currentPassword,helperText:u.currentPassword,sx:{mb:2,"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(f,{position:"start",children:e.jsx(H,{color:"action"})}),endAdornment:e.jsx(f,{position:"end",children:e.jsx(W,{onClick:()=>N("current"),edge:"end",children:w.current?e.jsx(D,{}):e.jsx(B,{})})})}}),e.jsx(d,{fullWidth:!0,type:w.new?"text":"password",label:"New Password",variant:"outlined",value:n.newPassword,onChange:s=>k("newPassword",s.target.value),error:!!u.newPassword,helperText:u.newPassword,sx:{mb:2,"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(f,{position:"start",children:e.jsx(H,{color:"action"})}),endAdornment:e.jsx(f,{position:"end",children:e.jsx(W,{onClick:()=>N("new"),edge:"end",children:w.new?e.jsx(D,{}):e.jsx(B,{})})})}}),e.jsx(ge,{password:n.newPassword}),e.jsx(d,{fullWidth:!0,type:w.confirm?"text":"password",label:"Confirm New Password",variant:"outlined",value:n.confirmPassword,onChange:s=>k("confirmPassword",s.target.value),error:!!u.confirmPassword,helperText:u.confirmPassword,sx:{mb:2,"& .MuiOutlinedInput-root":{borderRadius:2}},InputProps:{startAdornment:e.jsx(f,{position:"start",children:e.jsx(H,{color:"action"})}),endAdornment:e.jsx(f,{position:"end",children:e.jsx(W,{onClick:()=>N("confirm"),edge:"end",children:w.confirm?e.jsx(D,{}):e.jsx(B,{})})})}}),e.jsx(C,{variant:"contained",color:"primary",onClick:ae,disabled:R,startIcon:R?e.jsx(we,{size:20}):e.jsx(Z,{}),children:R?"Changing Password...":"Update Password"}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"After changing your password, you will be automatically logged out for security purposes."})]})})})})]})})]})};export{Te as default};
